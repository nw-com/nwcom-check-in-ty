<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿åŒ—å‹¤å‹™æ‰“å¡ç³»çµ±</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/ficons/6148f9_bb3f0e3c08bd4a3e83840553497fd866~mv2.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- è‡ªå®šç¾©è…³æœ¬ -->
    <script src="js/dashboard-functions.js"></script>
    <script src="js/features.js" defer></script>
    <script src="js/other.js" defer></script>
    <script src="js/calendar.js" defer></script>
    
    <!-- å·²ç§»é™¤ Firebase compat SDK èˆ‡åˆå§‹åŒ–ï¼›çµ±ä¸€ä½¿ç”¨ä¸‹æ–¹ v10 æ¨¡çµ„æ®µ -->
    
    <script src="clock-in-functions.js?v=20251006" defer></script>
    <script src="reset-points.js?v=20251006" defer></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1f2937; /* æ·±ç°è‰²èƒŒæ™¯ */
        }
        .main-container {
            width: 400px;
            height: calc(100vh - 100px); /* é€²ä¸€æ­¥ç¸®æ¸›å®¹å™¨é«˜åº¦ */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
            margin: 50px 10px 50px 10px; /* ä¸Š50 ä¸‹50 å·¦10 å³10 */
        }
        .header {
            height: 70px;
        }
        .footer {
            height: 70px;
        }
        .content-area {
            height: calc(100% - 140px);
            overflow-y: auto;
        }
        .hide { display: none !important; }
        .tab-btn.active {
            color: #dc2626; /* red-600 */
            border-top-color: #dc2626; /* red-600 */
        }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sub-tab-btn.active {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626; /* red-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px; /* åŸºæœ¬å®‰å…¨å…§è· */
            overflow: auto; /* é¿å…å…§å®¹éé•·é€ æˆé®ç½©é˜»æ“‹äº’å‹• */
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-height: calc(100vh - 40px);
            overflow-y: auto; /* å…§å®¹å¯æ²å‹• */
            -webkit-overflow-scrolling: touch; /* iOS æ²å‹•å„ªåŒ– */
            margin-top: 12px; /* èˆ‡é ‚éƒ¨ä¿æŒè·é›¢ï¼Œé¿å…è¢«åœ°å€åˆ—é®ä½ */
        }
        /* iOS/ç€è¦½å™¨å®‰å…¨å€æ”¯æ´ */
        @supports (padding: env(safe-area-inset-top)) {
            .modal-backdrop {
                padding-top: calc(env(safe-area-inset-top) + 12px);
                padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
                padding-left: calc(env(safe-area-inset-left) + 12px);
                padding-right: calc(env(safe-area-inset-right) + 12px);
            }
            .modal-content {
                max-height: calc(100vh - 40px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                margin-top: calc(env(safe-area-inset-top) + 12px);
            }
        }
        /* Ensure map canvas is visible */
        .map-canvas {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* Gray background as a fallback */
        }
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 9999px;
            color: white;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            opacity: 1;
            bottom: 110px;
        }
        /* Capture shutter button interactions */
        #capture-btn {
            cursor: pointer;
            outline: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15);
            transition: transform 120ms ease, box-shadow 120ms ease, background-color 120ms ease, border-color 120ms ease;
        }
        #capture-btn:hover {
            box-shadow: 0 10px 18px rgba(0,0,0,0.25);
        }
        #capture-btn:active {
            transform: scale(0.96);
            background-color: #f9fafb; /* hover: æ›´æ·¡çš„èƒŒæ™¯ */
            border-color: #6b7280; /* ç°è‰² 600 */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 6px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- API Key Warning -->
    <div id="api-key-warning" class="hide fixed inset-0 bg-red-100 z-[9999] p-8 text-red-800 flex flex-col items-center justify-center text-center">
        <i data-lucide="alert-triangle" class="w-16 h-16 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">è«‹å®Œæˆæœ€å¾Œçš„è¨­å®šæ­¥é©Ÿ</h2>
        <p class="max-w-md">
            ç³»çµ±åµæ¸¬åˆ°æ‚¨å°šæœªè¨­å®š Firebase æˆ– Google Maps çš„ API é‡‘é‘°ã€‚
            <br><br>
            <strong class="text-red-900">é€™ä¸æ˜¯ç¨‹å¼éŒ¯èª¤ï¼Œè€Œæ˜¯å¿…è¦çš„è¨­å®šã€‚</strong> åŸºæ–¼å®‰å…¨è€ƒé‡ï¼Œæˆ‘ç„¡æ³•ç‚ºæ‚¨ç”¢ç”Ÿé‡‘é‘°ï¼Œæ‚¨å¿…é ˆè¦ªè‡ªå®Œæˆæ­¤è¨­å®šã€‚
            <br><br>
            è«‹æ‰“é–‹ <code>index.html</code> æª”æ¡ˆï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹çš„ <code>&lt;script type="module"&gt;</code> å€å¡Šï¼Œä¸¦ä¾ç…§è¨»è§£æŒ‡ç¤ºå¡«å…¥æ‚¨è‡ªå·±çš„é‡‘é‘°ã€‚è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒ <code>README.md</code> æª”æ¡ˆã€‚
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">è¥¿åŒ—å‹¤å‹™æ‰“å¡ç³»çµ±</h1>
            <p class="text-gray-500">é›²ç«¯æ¸¬è©¦ç‰ˆV2.2.8</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                 <div class="flex justify-between items-center mb-1">
                    <label for="email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                    <div class="flex items-center">
                        <input id="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">è¨˜ä½æˆ‘</label>
                    </div>
                </div>
                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                <div class="relative">
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 pr-10" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                ç™»å…¥
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="main-container bg-white flex flex-col hide">
        <!-- Header -->
        <header class="h-[70px] flex items-center justify-between px-4 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <span class="text-lg font-bold text-gray-800">è¥¿åŒ—å‹¤å‹™æ‰“å¡ç³»çµ±</span>
                <span id="welcome-message" class="text-sm text-gray-600 ml-2"></span>
            </div>
            <button id="profile-avatar-btn">
                <img id="header-avatar" src="https://placehold.co/40x40/EFEFEF/333333?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col overflow-hidden bg-gray-50">
            <!-- This will be dynamically populated -->
        </main>

        <!-- Footer Navigation -->
        <footer class="h-[70px] border-t border-gray-200 flex-shrink-0 bg-white">
            <nav id="main-nav" class="flex justify-around h-full items-center">
                <button data-tab="dashboard" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 active">
                    <i data-lucide="layout-dashboard"></i><span class="text-xs mt-1">å„€è¡¨æ¿</span>
                </button>
                <button data-tab="clock-in" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="fingerprint"></i><span class="text-xs mt-1">æ‰“å¡</span>
                </button>
                <button id="nav-other" data-tab="other" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="ellipsis"></i><span class="text-xs mt-1">å…¶ä»–</span>
                </button>
                <button id="nav-tracking" data-tab="tracking" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="map-pin"></i><span class="text-xs mt-1">è¿½è¹¤</span>
                </button>
                <button id="nav-hr" data-tab="hr" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="users"></i><span class="text-xs mt-1">äººäº‹</span>
                </button>
                <button id="nav-features" data-tab="features" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="layers"></i><span class="text-xs mt-1">åŠŸèƒ½</span>
                </button>
                <button id="nav-calendar" data-tab="calendar" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="calendar"></i><span class="text-xs mt-1">è¡Œäº‹æ›†</span>
                </button>
                <button id="nav-settings" data-tab="settings" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="settings"></i><span class="text-xs mt-1">è¨­å®š</span>
                </button>
                <button id="nav-group" data-tab="group" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="git-branch"></i><span class="text-xs mt-1">ç¾¤çµ„</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>


    <script type="module">
        // --- ğŸš¨ é‡è¦è¨­å®šï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨è‡ªå·±çš„ API é‡‘é‘° ğŸš¨ ---
        const firebaseConfig = {
          apiKey: "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg",
          authDomain: "nw-check-in.firebaseapp.com",
          projectId: "nw-check-in",
          storageBucket: "nw-check-in.appspot.com",
          messagingSenderId: "1060821780559",
          appId: "1:1060821780559:web:2638d630526d54f1a5023a",
          measurementId: "G-61Q1QNNRD2"
        };
        const GOOGLE_MAPS_API_KEY = "AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY";
        // Icon library fallback: prevent ReferenceError if lucide not loaded
        if (!window.lucide || typeof window.lucide.createIcons !== 'function') {
            window.lucide = window.lucide || {};
            window.lucide.createIcons = function() {};
            try { console.warn('Lucide æœªè¼‰å…¥ï¼Œå·²ä½¿ç”¨å¾Œå‚™ç©ºå‡½å¼é¿å…éŒ¯èª¤'); } catch (e) {}
        }
        // --- ğŸš¨ è¨­å®šçµæŸ ğŸš¨ ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential,
            EmailAuthProvider, sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot,
            query, where, getDocs, serverTimestamp, orderBy, limit, GeoPoint, Timestamp, writeBatch,
            enableIndexedDbPersistence, arrayUnion, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // æš´éœ²å¿…è¦çš„ helper ä¾›éæ¨¡çµ„è…³æœ¬ä½¿ç”¨ï¼ˆéæ¸¡æœŸï¼‰
        window.__fs = {
            collection,
            getDocs,
            writeBatch,
            doc,
            serverTimestamp,
            addDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            query,
            where,
            onSnapshot,
            orderBy,
            limit,
            Timestamp,
            GeoPoint,
            arrayUnion,
            arrayRemove,
        };
        window.__authHelpers = { onAuthStateChanged };

        // å…¨åŸŸç®¡ç†å“¡æª¢æŸ¥å‡½æ•¸ï¼ˆé¿å…å€åŸŸä½œç”¨åŸŸé€ æˆæœªå®šç¾©ï¼‰
        window.checkAdminStatus = async function() {
            try {
                const user = window.__auth?.currentUser;
                if (!user) return false;
                const db = window.__db; const { doc, getDoc } = window.__fs || {};
                if (!db || !doc || !getDoc) return false;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                return !!(userDoc.exists() && userDoc.data().role === 'admin');
            } catch (error) {
                console.warn('checkAdminStatus å¤±æ•—:', error);
                return false;
            }
        };

        // å…¨åŸŸå¯©æ ¸æ¬Šé™æª¢æŸ¥ï¼šç®¡ç†å“¡ã€äººäº‹ã€é«˜éšä¸»ç®¡çš†å¯
        window.checkReviewerStatus = async function() {
            try {
                const user = window.__auth?.currentUser;
                if (!user) return false;
                const db = window.__db; const { doc, getDoc } = window.__fs || {};
                if (!db || !doc || !getDoc) return false;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) return false;
                const role = userDoc.data().role;
                return ['admin','hr','manager'].includes(role);
            } catch (error) {
                console.warn('checkReviewerStatus å¤±æ•—:', error);
                return false;
            }
        };

        // Global State
        const state = {
            currentUser: null,
            currentUserData: null,
            googleMapsLoaded: false,
            activeListeners: [],
            currentLocation: null,
            currentPage: null,
            users: [],
            trackingMap: null,
            trackingMarkers: [],
            // ä¾›ã€Œå®šä½æ‰“å¡ã€å­é é¢ä½¿ç”¨çš„åœ°åœ–èˆ‡æ¨™è¨˜å¼•ç”¨ï¼Œä»¥åŠå®šä½ç›£è½ID
            clockInMap: null,
            clockInMarker: null,
            geoWatchId: null,
        };
        
        // åˆå§‹åŒ–æœ¬æ©Ÿè£ç½®IDï¼ˆç”¨æ–¼æ‰“å¡ç´€éŒ„èˆ‡é¦–æ¬¡æ‰“å¡è£ç½®æ¨™è¨˜ï¼‰
        (function initDeviceId(){
            try {
                const key = 'device_id';
                let id = localStorage.getItem(key);
                if (!id) {
                    const bytes = new Uint8Array(16);
                    crypto.getRandomValues(bytes);
                    id = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                    localStorage.setItem(key, id);
                }
                state.deviceId = id;
            } catch (e) {
                console.warn('åˆå§‹åŒ–è£ç½®IDå¤±æ•—', e);
                state.deviceId = 'unknown-device';
            }
        })();

        // è§’è‰²å°æ‡‰ä¸­æ–‡æ¨™ç±¤
        function roleLabel(role) {
            switch (role) {
                case 'field': return 'å¤–å‹¤';
                case 'user': return 'å…§å‹¤';
                case 'junior_manager': return 'åˆéšä¸»ç®¡';
                case 'manager': return 'é«˜éšä¸»ç®¡';
                case 'hr': return 'äººäº‹';
                case 'admin': return 'ç®¡ç†å“¡';
                default: return role || 'å…§å‹¤';
            }
        }

        // è§’è‰²å¾½ç« é¡è‰²æ¨£å¼
        function roleBadgeClass(role) {
            switch (role) {
                case 'admin': return 'bg-red-100 text-red-700';
                case 'manager': return 'bg-purple-100 text-purple-700';
                case 'junior_manager': return 'bg-violet-100 text-violet-700';
                case 'hr': return 'bg-amber-100 text-amber-700';
                case 'field': return 'bg-green-100 text-green-700';
                default: return 'bg-blue-100 text-blue-700'; // user / å…¶ä»–
            }
        }
        
        const loadingScreen = document.getElementById('loading-screen');
        
        function showLoading(show) {
            if(loadingScreen) loadingScreen.classList.toggle('hide', !show);
        }

        function initializeAppLogic() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // å·²åœç”¨é›¢ç·šæŒä¹…åŒ–ä»¥é¿å…ä¸åŒ SDK ç‰ˆæœ¬è¡çª
            // è‹¥éœ€å•Ÿç”¨ï¼Œè«‹åƒ…ä¿ç•™å–®ä¸€ SDK ç‰ˆæœ¬ä¸¦æ¸¬è©¦ç€è¦½å™¨æ”¯æ´
            
            const storage = getStorage(app);

            // æš«æ›åˆ° window ä¾›éæ¸¡æœŸè…³æœ¬ï¼ˆå¦‚ reset-points.jsï¼‰ä½¿ç”¨
            window.__app = app;
        window.__auth = auth;
        window.__db = db;
        // é€šçŸ¥å…¶ä»–è…³æœ¬ Firebase èˆ‡å…¨åŸŸ helpers å·²å°±ç·’
        try { window.dispatchEvent(new Event('firebase-ready')); } catch (e) { /* noop */ }
            window.__storage = storage;

            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const mainContent = document.getElementById('main-content');
            const mainNav = document.getElementById('main-nav');
            const profileAvatarBtn = document.getElementById('profile-avatar-btn');
            const modalContainer = document.getElementById('modal-container');
            const toast = document.getElementById('toast');
            const loginForm = document.getElementById('login-form');
            const bodyEl = document.body;
            
            // Login page specific elements
            const rememberMeCheckbox = document.getElementById('remember-me');
            const emailInput = document.getElementById('email');
            const togglePasswordBtn = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');

            // Remember me logic
            const savedEmail = localStorage.getItem('rememberedEmail');
            if (savedEmail) {
                emailInput.value = savedEmail;
                rememberMeCheckbox.checked = true;
            }
            
            // Password visibility toggle
            togglePasswordBtn.addEventListener('click', () => {
                const passwordIcon = document.getElementById('password-icon');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye" class="w-5 h-5"></i>';
                } else {
                    passwordInput.type = 'password';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>';
                }
                lucide.createIcons();
            });


            // --- Authentication Logic ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const email = emailInput.value;
                const password = passwordInput.value;
                const loginError = document.getElementById('login-error');
                loginError.textContent = '';

                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚';
                } finally {
                    showLoading(false);
                }
            });
            
            onAuthStateChanged(auth, (user) => {
                cleanupListeners();
                if (user) {
                    bodyEl.classList.remove('bg-red-600');
                    bodyEl.classList.add('bg-gray-100');
                    state.currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const wasNotInitialized = !state.currentUserData;
                            state.currentUserData = { id: user.uid, ...docSnap.data() };
                            // è‹¥æ¨™è¨˜ç‚ºé›¢è·ï¼Œç«‹å³ç™»å‡ºä¸¦æç¤º
                            if (state.currentUserData && state.currentUserData.resigned === true) {
                                try {
                                    openInfoModal('ç™»å…¥æç¤º', 'æ‚¨å·²é›¢è·ã€ç„¡æ³•ç™»å…¥');
                                } catch (e) {
                                    // å¾Œå‚™ï¼šè‹¥ modal å»ºç«‹å¤±æ•—ï¼Œä½¿ç”¨ toast æˆ– alert
                                    if (typeof showToast === 'function') showToast('æ‚¨å·²é›¢è·ã€ç„¡æ³•ç™»å…¥', true);
                                    else alert('æ‚¨å·²é›¢è·ã€ç„¡æ³•ç™»å…¥');
                                }
                                signOut(window.__auth);
                                return;
                            }
                            if (wasNotInitialized) {
                                initializeAppUI();
                            } else {
                                updateHeaderAvatar();
                            }
                        } else { signOut(window.__auth); }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        signOut(window.__auth);
                    });
                    state.activeListeners.push(unsubscribe);
                } else {
                    bodyEl.classList.remove('bg-gray-100');
                    bodyEl.classList.add('bg-red-600');
                    state.currentUser = null;
                    state.currentUserData = null;
                    loginPage.classList.remove('hide');
                    appContainer.classList.add('hide');
                    showLoading(false);
                }
            });

            // --- UI Initialization and Navigation ---
            function initializeAppUI() {
                loadGoogleMapsScript();
                updateHeaderAvatar();
                
                const navTracking = document.getElementById('nav-tracking');
                const navSettings = document.getElementById('nav-settings');
                const navHr = document.getElementById('nav-hr');
                const navGroup = document.getElementById('nav-group');
                const navFeatures = document.getElementById('nav-features');
                const navCalendar = document.getElementById('nav-calendar');
                const navOther = document.getElementById('nav-other');
                const navDashboard = document.querySelector('.tab-btn[data-tab="dashboard"]');
                const navClockIn = document.querySelector('.tab-btn[data-tab="clock-in"]');

                // å°è¦½é¡¯ç¤ºæ¬Šé™ï¼ˆæ“´å……è§’è‰²ï¼šadmin, manager(é«˜éšä¸»ç®¡), junior_manager(åˆéšä¸»ç®¡), hr, user, fieldï¼‰
                const role = state.currentUserData.role;
                [navTracking, navSettings, navHr, navGroup].forEach(el => el && el.classList.add('hide'));

                if (role === 'field') {
                    // å¤–å‹¤ï¼šåƒ…é¡¯ç¤ºã€Œæ‰“å¡ã€èˆ‡ã€Œå…¶ä»–ã€åˆ†é 
                    [navDashboard, navFeatures, navCalendar, navTracking, navSettings, navHr, navGroup].forEach(el => el && el.classList.add('hide'));
                    if (navClockIn) navClockIn.classList.remove('hide');
                    if (navOther) navOther.classList.remove('hide');
                } else if (role === 'admin') {
                    // ç®¡ç†å“¡ï¼šé¡¯ç¤ºè¿½è¹¤ã€è¨­å®šã€äººäº‹
                    navTracking.classList.remove('hide');
                    navSettings.classList.remove('hide');
                    if (navHr) navHr.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else if (role === 'manager') {
                    // é«˜éšä¸»ç®¡ï¼šé¡¯ç¤ºè¿½è¹¤
                    navTracking.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else if (role === 'junior_manager') {
                    // åˆéšä¸»ç®¡ï¼šä¸é¡¯ç¤ºè¿½è¹¤ï¼›åƒ…é¡¯ç¤ºç¾¤çµ„
                    // navTracking ä¿æŒéš±è—
                    navGroup.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else if (role === 'hr') {
                    // äººäº‹è§’è‰²ï¼šé¡¯ç¤ºè¿½è¹¤èˆ‡äººäº‹
                    navTracking.classList.remove('hide');
                    if (navHr) navHr.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else {
                    // å…§å‹¤/ä¸€èˆ¬ä½¿ç”¨è€…ï¼šä¸é¡¯ç¤ºè¿½è¹¤ã€è¨­å®šã€HRã€ç¾¤çµ„ï¼›ä¸é¡¯ç¤ºã€Œå…¶ä»–ã€åˆ†é 
                    if (navOther) navOther.classList.add('hide');
                }
                
                loginPage.classList.add('hide');
                appContainer.classList.remove('hide');
                
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                if (role === 'field') {
                    // å¤–å‹¤é è¨­é€²å…¥ã€Œæ‰“å¡ã€é 
                    const clockBtn = document.querySelector('.tab-btn[data-tab="clock-in"]');
                    if (clockBtn) clockBtn.classList.add('active');
                    showPage('clock-in');
                } else {
                    document.querySelector('.tab-btn[data-tab="dashboard"]').classList.add('active');
                    showPage('dashboard');
                }
                showLoading(false);
            }

            function updateHeaderAvatar() {
                const headerAvatar = document.getElementById('header-avatar');
                if (state.currentUserData?.avatarUrl) {
                    headerAvatar.src = state.currentUserData.avatarUrl;
                } else {
                    headerAvatar.src = `https://placehold.co/40x40/EFEFEF/333333?text=${state.currentUserData?.name?.charAt(0) || 'U'}`;
                }
                const welcomeMessage = document.getElementById('welcome-message');
                if(welcomeMessage) {
                    welcomeMessage.textContent = `æ­¡è¿~ ${state.currentUserData.name}`;
                }
            }
            
            function renderTrackingDevices(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <h2 class="text-lg font-bold mb-4">æ‰“å¡è£ç½®ç›£æ§</h2>
                        <div class="mb-4 flex items-center gap-4">
                            <div>
                                <label for="device-date-filter" class="block text-sm font-medium text-gray-700">æŸ¥è©¢æ—¥æœŸ</label>
                                <input type="date" id="device-date-filter" class="mt-1 px-3 py-2 border rounded-md">
                            </div>
                            <div class="flex items-end">
                                <button id="device-search-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">æŸ¥è©¢</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‰“å¡æ—¥æœŸ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‰“å¡æ™‚çš„è£ç½®ID</th>
                                    </tr>
                                </thead>
                                <tbody id="device-records-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“ŠæŸ¥è©¢</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
                const dateFilter = document.getElementById('device-date-filter');
                const today = new Date();
                dateFilter.value = today.toISOString().split('T')[0];
                
                const searchBtn = document.getElementById('device-search-btn');
                searchBtn.addEventListener('click', loadDeviceRecords);
                
                // è¼‰å…¥æ‰“å¡è£ç½®è¨˜éŒ„
                async function loadDeviceRecords() {
                    const selectedDate = new Date(dateFilter.value);
                    if (isNaN(selectedDate.getTime())) {
                        showToast('è«‹é¸æ“‡æœ‰æ•ˆæ—¥æœŸ', true);
                        return;
                    }
                    
                    const deviceRecordsList = document.getElementById('device-records-list');
                    deviceRecordsList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                    <span class="ml-2">è¼‰å…¥ä¸­...</span>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    try {
                        // å–å¾—æ—¥æœŸç¯„åœ (ç•¶æ—¥ 00:00 åˆ° 23:59)
                        const startDate = new Date(selectedDate);
                        startDate.setHours(0, 0, 0, 0);
                        const endDate = new Date(selectedDate);
                        endDate.setHours(23, 59, 59, 999);
                        
                        // æŸ¥è©¢æ‰“å¡è¨˜éŒ„ï¼ˆå‰ç«¯ä¾æ—¥æœŸéæ¿¾ï¼Œé¿å…è¤‡åˆç´¢å¼•éœ€æ±‚ï¼‰
                        const clockInRef = collection(db, 'clockInRecords');
                        const q = query(clockInRef);
                        const qs = await getDocs(q);
                        
                        const records = [];
                        qs.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                        
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startDate && ts <= endDate;
                        }).sort((a, b) => {
                            const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return tb - ta;
                        });
                        
                        // å–å¾—æ‰€æœ‰ç”¨æˆ¶è³‡æ–™ä»¥é¡¯ç¤ºå§“å
                        const usersRef = collection(db, 'users');
                        const usersSnapshot = await getDocs(usersRef);
                        const usersData = {};
                        usersSnapshot.forEach(doc => { usersData[doc.id] = doc.data(); });
                        
                        // ä»¥ä½¿ç”¨è€…ç‚ºå–®ä½åˆ†çµ„
                        const grouped = {};
                        filtered.forEach(r => {
                            const uid = r.userId;
                            if (!grouped[uid]) grouped[uid] = [];
                            grouped[uid].push(r);
                        });
                        
                        let html = '';
                        Object.keys(grouped).forEach(uid => {
                            const user = usersData[uid];
                            if (!user) return;
                            const recs = grouped[uid];
                            const deviceIds = [...new Set(recs.map(r => r.deviceId).filter(Boolean))];
                            const hasAnomalies = deviceIds.length > 1;
                            
                            recs.forEach(r => {
                                const rowClass = hasAnomalies ? 'bg-red-50' : '';
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : new Date());
                                const locName = typeof r.locationName === 'string' ? r.locationName : (r.location?.address || null);
                                const statusText = getStatusDisplayText(r.type || 'æœªçŸ¥', locName, r.dutyType || null);
                                const statusColorClass = getStatusColor(statusText);
                                html += `
                                    <tr class="${rowClass}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.name||'U').charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                                <div class="text-sm font-medium text-gray-900">${user.name || 'æœªçŸ¥'}</div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">${statusText}</span>
                                            ${hasAnomalies ? '<div class="text-xs text-red-600 mt-1">ç•°å¸¸</div>' : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ts.toLocaleString('zh-TW')}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.deviceId || 'æœªçŸ¥'}</td>
                                    </tr>
                                `;
                            });
                        });
                        
                        document.getElementById('device-records-list').innerHTML = html || `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td>
                            </tr>
                        `;
                        
                    } catch (error) {
                        console.error('è¼‰å…¥è£ç½®è¨˜éŒ„å¤±æ•—:', error);
                        document.getElementById('device-records-list').innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</td>
                            </tr>
                        `;
                    }
                }
                
                function getStatusColor(status) {
                    if (typeof status !== 'string') return 'bg-gray-100 text-gray-800';
                    if (status.includes('ä¸Šç­')) return 'bg-green-100 text-green-800';
                    if (status.includes('å·²ä¸‹ç­-æœªæ‰“å¡')) return 'bg-yellow-100 text-yellow-800';
                    if (status.includes('ä¸‹ç­') || status.includes('å·²ä¸‹ç­')) return 'bg-red-100 text-red-800';
                    if (status.includes('å¤–å‡º') || status.includes('æŠµé”') || status.includes('é›¢é–‹')) return 'bg-blue-100 text-blue-800';
                    if (status.includes('è¿”å›')) return 'bg-green-100 text-green-800';
                    if (status.includes('è«‹å‡') || status.includes('è‡¨æ™‚è«‹å‡')) return 'bg-orange-100 text-orange-800';
                    if (status.includes('ç‰¹æ®Šå‹¤å‹™') || status.includes('å‡ºå‹¤')) return 'bg-indigo-100 text-indigo-800';
                    return 'bg-gray-100 text-gray-800';
                }
            }

            mainNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-btn');
                if (tabButton && !tabButton.classList.contains('active')) {
                    showPage(tabButton.dataset.tab);
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    tabButton.classList.add('active');
                }
            });

            // ç¢ºä¿åœ¨ä»»ä½•æ™‚å€™é»æ“Šé ­åƒæŒ‰éˆ•éƒ½èƒ½æ‰“é–‹å€‹äººè³‡æ–™
            document.getElementById('profile-avatar-btn').addEventListener('click', renderProfileModal);

            function showPage(pageName, subPage = null, params = {}) {
                const prevPage = state.currentPage;
                // åƒ…åœ¨é›¢é–‹è¡Œäº‹æ›†é é¢æ™‚æ¸…ç†å…¶å³æ™‚ç›£è½
                try {
                    if (prevPage === 'calendar' && pageName !== 'calendar' && window.__calendarCleanup) {
                        window.__calendarCleanup();
                    }
                } catch (e) {
                    console.warn('Calendar cleanup failed:', e);
                }
                cleanupListeners();
                state.currentLocation = null;
                state.trackingMap = null;
                state.trackingMarkers = [];
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const router = {
                    'dashboard': renderDashboard,
                    'clock-in': () => renderClockIn(subPage || 'location'),
                    'tracking': () => ['admin','manager','hr'].includes(state.currentUserData.role) ? renderTracking(subPage || 'map') : renderAccessDenied(),
                    'features': () => renderFeatures(subPage || 'news'),
                    'other': () => state.currentUserData.role === 'field' ? renderOther(subPage || 'news') : renderAccessDenied(),
                    'calendar': () => renderCalendar(subPage || 'overview'),
                    'settings': () => state.currentUserData.role === 'admin' ? renderSettings(subPage || 'accounts') : renderAccessDenied(),
                    'group': () => state.currentUserData.role === 'junior_manager' ? renderGroup(subPage || 'map') : renderAccessDenied(),
                    'hr': () => ['admin','hr'].includes(state.currentUserData.role) ? renderHR(subPage || 'print') : renderAccessDenied()
                };
                const renderFunction = router[pageName] || renderAccessDenied;
                try {
                    renderFunction(params);
                    state.currentPage = pageName;
                } catch(e) {
                    console.error("Failed to render page:", e);
                    mainContent.innerHTML = `<div class="p-4 text-red-500">é é¢è¼‰å…¥å¤±æ•—ã€‚</div>`;
                }
                lucide.createIcons();
            }
            // è®“å…¶ä»–å€å¡Šå¯å®‰å…¨å‘¼å«ï¼ˆä¾‹å¦‚æ‰“å¡æµç¨‹çµæŸå¾Œï¼‰
            window.showPage = showPage;

            function renderAccessDenied() {
                mainContent.innerHTML = `
                    <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <i data-lucide="ban" class="w-16 h-16 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold">æ¬Šé™ä¸è¶³</h2>
                        <p>æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ã€‚</p>
                    </div>
                `;
            }

            // --- Page Render Functions ---
            
            function renderDashboard() {
                 mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-center border-b border-gray-200 bg-white">
                         <p id="current-time" class="text-lg font-semibold text-gray-700"></p>
                    </div>
                    <div class="p-4 overflow-y-auto" style="height: calc(100% - 50px);">
                        <div class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                            <h3 class="font-bold text-red-800 mb-2 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i>æˆ‘çš„ç‹€æ…‹</h3>
                            <div id="my-status" class="text-gray-600">è®€å–ä¸­...</div>
                        </div>
                        <div id="all-users-summary-card" class="bg-white p-4 rounded-lg mb-4 shadow-sm border cursor-pointer">
                           <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i>æ‰€æœ‰åŒä»ç‹€æ…‹</h3>
                           <div class="grid grid-cols-2 gap-2 text-gray-700">
                                <div><span class="text-green-600">ä¸Šç­</span> : <span id="count-work">0</span> äºº</div>
                                <div><span class="text-blue-600">å¤–å‡º</span> : <span id="count-outbound">0</span> äºº</div>
                                <div><span class="text-red-600">ä¸‹ç­</span> : <span id="count-off">0</span> äºº</div>
                                <div><span class="text-orange-600">è«‹å‡</span> : <span id="count-leave">0</span> äºº</div>
                           </div>
                           <div class="text-xs text-gray-500 mt-2">é»æ“ŠæŸ¥çœ‹æ‰€æœ‰åŒä»ç‹€æ…‹</div>
                       </div>
                        <div id="community-status-row" class="mb-4">
                            <button id="community-status-btn" class="w-full bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-md hover:bg-red-200 border border-red-200 flex items-center justify-center shadow-sm">
                                <i data-lucide="activity" class="w-4 h-4 mr-2"></i>ç¤¾å€äººå“¡ç‹€æ³
                            </button>
                        </div>
                        <div id="dashboard-notifications" class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                           <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="bell" class="w-4 h-4 mr-2"></i>é€šçŸ¥</h3>
                           <div id="pinned-notifications" class="space-y-2 mb-2">
                              <a href="https://docs.google.com/document/d/1qdb2aouFOgkP5WY9XqkAhenJe--yyN5V/edit" target="_blank" rel="noopener" class="block p-3 rounded-md border bg-blue-50 border-blue-200 text-blue-800 hover:bg-blue-100">
                                <span class="font-medium">ã€å…¬å¸ç¸½éƒ¨ã€‘å‹¤å‹™æ‰“å¡ç³»çµ±ä½¿ç”¨è¦ç¯„</span>
                                <span class="ml-2 text-xs align-middle bg-blue-200 text-blue-800 px-1.5 py-0.5 rounded">ç½®é ‚</span>
                              </a>
                           </div>
                           <div id="dashboard-notifications-list" class="space-y-2 text-gray-700">
                             <div class="text-gray-500">è®€å–ä¸­...</div>
                           </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                const timeEl = document.getElementById('current-time');
                const timerInterval = setInterval(() => {
                    if(timeEl){ timeEl.textContent = new Date().toLocaleString('zh-TW', { dateStyle: 'long', timeStyle: 'medium' }); }
                }, 1000);
                state.activeListeners.push(() => clearInterval(timerInterval));

                // ç¤¾å€äººå“¡ç‹€æ³æŒ‰éˆ•é–‹å•Ÿæ–°è¦–çª—
                const communityBtn = document.getElementById('community-status-btn');
                if (communityBtn) {
                    communityBtn.addEventListener('click', () => {
                        try { window.open('https://nw-com.github.io/nw-checkin-all/', '_blank', 'noopener'); } catch(e) {}
                    });
                }
                
                // æª¢æŸ¥æ˜¯å¦é¡¯ç¤ºå“¡å·¥ç‹€æ…‹
                // å®šç¾©é»˜èªè¨­ç½®
                const defaultSettings = {
                    showEmployeeStatus: true,
                    communityStatusAllowedUsers: []
                };
                
                // å˜—è©¦å¾æœ¬åœ°å­˜å„²ç²å–è¨­ç½®
                let localSettings;
                try {
                    const savedSettings = localStorage.getItem('app_general_settings');
                    localSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
                } catch (e) {
                    console.warn("Could not load settings from local storage:", e);
                    localSettings = defaultSettings;
                }
                
                // æ‡‰ç”¨æœ¬åœ°è¨­ç½®
                if (localSettings.showEmployeeStatus === false) {
                    const container = document.getElementById('all-users-summary-card');
                    if (container) container.style.display = 'none';
                }

                // æ§åˆ¶ã€Œç¤¾å€äººå“¡ç‹€æ³ã€æŒ‰éˆ•å¯è¦‹æ€§
                try {
                    const rowEl = document.getElementById('community-status-row');
                    const myId = state.currentUserData?.id;
                    const allowed = Array.isArray(localSettings.communityStatusAllowedUsers) && myId
                        ? localSettings.communityStatusAllowedUsers.includes(myId)
                        : false;
                    if (rowEl) rowEl.style.display = allowed ? 'block' : 'none';
                } catch(_) {}
                
                // å˜—è©¦å¾Firebaseç²å–æœ€æ–°è¨­ç½®ï¼Œä½†ä¸é˜»å¡UI
                try {
                    const settingsRef = doc(db, "settings", "general");
                    getDoc(settingsRef).then((docSnap) => {
                        if (docSnap.exists()) {
                            const settings = docSnap.data();
                            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ä»¥ä¾›å°‡ä¾†ä½¿ç”¨
                            localStorage.setItem('app_general_settings', JSON.stringify(settings));
                            
                            // å¦‚æœè¨­ç½®èˆ‡æœ¬åœ°ä¸åŒï¼Œç«‹å³æ‡‰ç”¨
                            if (settings.showEmployeeStatus !== localSettings.showEmployeeStatus) {
                                const container = document.getElementById('all-users-summary-card');
                                if (container) {
                                    container.style.display = settings.showEmployeeStatus ? 'block' : 'none';
                                }
                            }
                            // æ›´æ–°ç¤¾å€äººå“¡ç‹€æ³æŒ‰éˆ•å¯è¦‹æ€§
                            const rowEl = document.getElementById('community-status-row');
                            const myId = state.currentUserData?.id;
                            const allowed = Array.isArray(settings.communityStatusAllowedUsers) && myId
                                ? settings.communityStatusAllowedUsers.includes(myId)
                                : false;
                            if (rowEl) rowEl.style.display = allowed ? 'block' : 'none';
                    }
                }).catch(error => {
                    console.warn("Could not fetch latest settings, using local settings instead:", error);
                });
            } catch (error) {
                console.warn("Error in settings fetch attempt:", error);
            }

            // é»æ“Šæ‘˜è¦å¡é–‹å•Ÿæ‰€æœ‰åŒä»ç‹€æ…‹å½ˆçª—
            const summaryCard = document.getElementById('all-users-summary-card');
            if (summaryCard) {
                summaryCard.addEventListener('click', () => {
                    openAllUsersStatusModal();
                });
            }
            
            // å„€éŒ¶æ¿é€šçŸ¥ï¼ˆé€±äº”å€¼ç­æé†’ï¼‰
            (async () => {
                try {
                    const fs = window.__fs || {};
                    const db = window.__db;
                    const user = window.__auth?.currentUser;
                    const listEl = document.getElementById('dashboard-notifications-list');
                    if (!db || !user || !listEl) return;

                    const { doc, getDoc, collection, query, where, onSnapshot, Timestamp } = fs;

                    function formatYMD(date) {
                        const y = date.getFullYear();
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        const d = String(date.getDate()).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    }

                    function getWeekFriday(date) {
                        const d = new Date(date);
                        const day = d.getDay();
                        // èª¿æ•´åˆ°æœ¬é€±çš„æ˜ŸæœŸä¸€
                        const diffToMonday = day === 0 ? -6 : (1 - day);
                        const monday = new Date(d);
                        monday.setDate(d.getDate() + diffToMonday);
                        const friday = new Date(monday);
                        friday.setDate(monday.getDate() + 4);
                        return friday;
                    }

                    async function renderDutyReminder() {
                        const now = new Date();
                        const day = now.getDay(); // 1=Mon, 5=Fri
                        const friday = getWeekFriday(now);
                        const isoFriday = formatYMD(friday);

                        const settingsRef = doc(db, 'settings', 'general');
                        const s = await getDoc(settingsRef);
                        const roster = s.exists() ? (s.data().fridayDutyRoster || {}) : {};
                        const ids = roster[isoFriday] || [];
                        // å°‡ UID è½‰ç‚ºå§“åé¡¯ç¤º
                        let nameMap = {};
                        try {
                            const snap = await getDocs(collection(db, 'users'));
                            snap.forEach(d => {
                                const data = d.data();
                                nameMap[d.id] = data?.displayName || data?.name || data?.email || d.id;
                            });
                        } catch(e) {}
                        const names = Array.isArray(ids) ? ids.map(id => nameMap[id] || id) : [];

                        const clearedKey = `dutyReminderCleared-${isoFriday}-${user.uid}`;
                        const cleared = localStorage.getItem(clearedKey) === '1';

                        const inWeek = day >= 1 && day <= 5; // é€±ä¸€åˆ°é€±äº”
                        const shouldShow = (inWeek && names.length > 0 && !(day === 5 && cleared));
                        if (shouldShow) {
                            listEl.innerHTML = `
                                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                  <div class="flex items-center justify-between">
                                    <div class="flex items-center"><i data-lucide="alert-circle" class="w-4 h-4 mr-2 text-yellow-600"></i><span class="font-medium text-yellow-800">æœ¬é€±äº”å€¼ç­</span></div>
                                    <button id="view-calendar" class="text-blue-600 hover:underline text-sm">æŸ¥çœ‹æœˆæ›†</button>
                                  </div>
                                  <div class="mt-2 text-sm text-gray-700">å€¼ç­äººå“¡ï¼š${names.join('ã€')}</div>
                                  <div class="mt-1 text-xs text-gray-500">æ˜ŸæœŸäº”ï¼ˆ${isoFriday}ï¼‰å€¼ç­æé†’</div>
                                </div>`;
                            const btn = document.getElementById('view-calendar');
                            btn?.addEventListener('click', () => {
                                try {
                                    // æ›´æ–°ä¸»åˆ†é æŒ‰éˆ•é¸å–ç‹€æ…‹è‡³ã€Œè¡Œäº‹æ›†ã€
                                    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                                    const calTab = document.querySelector('.tab-btn[data-tab="calendar"]');
                                    calTab?.classList.add('active');
                                } catch (e) {
                                    console.warn('æ›´æ–°åˆ†é é¸å–ç‹€æ…‹å¤±æ•—', e);
                                }
                                showPage('calendar', 'overview');
                            });
                            lucide.createIcons();
                        } else {
                            listEl.innerHTML = '<div class="text-gray-500">æš«ç„¡é€šçŸ¥</div>';
                        }

                        // é€±äº”ç•¶å¤©ç›£è½æ‰“å¡ç´€éŒ„ä»¥æ¸…é™¤æé†’
                        if (day === 5 && names.length > 0 && !cleared) {
                            const start = new Date(friday.getFullYear(), friday.getMonth(), friday.getDate());
                            const end = new Date(friday.getFullYear(), friday.getMonth(), friday.getDate(), 23, 59, 59, 999);
                            const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                            const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                            const q = query(
                                collection(db, 'clockInRecords'),
                                where('userId', '==', user.uid),
                                where('timestamp', '>=', tsStart),
                                where('timestamp', '<=', tsEnd)
                            );
                            const unsubDuty = onSnapshot(q, (snap) => {
                                let clearedNow = false;
                                snap.forEach(d => {
                                    const r = d.data();
                                    if (r.type === 'ä¸‹ç­' || r.type === 'è‡ªå‹•ä¸‹ç­') {
                                        clearedNow = true;
                                    }
                                });
                                if (clearedNow) {
                                    localStorage.setItem(clearedKey, '1');
                                    listEl.innerHTML = '<div class="text-gray-500">æš«ç„¡é€šçŸ¥</div>';
                                }
                            });
                            state.activeListeners.push(unsubDuty);
                        }
                    }

                    renderDutyReminder();
                } catch (e) {
                    console.warn('åˆå§‹åŒ–å„€éŒ¶æ¿é€šçŸ¥å¤±æ•—', e);
                }
            })();
                
                const usersRef = collection(db, "users");
                const unsubscribe = onSnapshot(query(usersRef), (querySnapshot) => {
                    const countWorkEl = document.getElementById('count-work');
                    const countOutboundEl = document.getElementById('count-outbound');
                    const countOffEl = document.getElementById('count-off');
                    const countLeaveEl = document.getElementById('count-leave');
                    let myStatusFound = false;
                    // å„ªå…ˆè¼‰å…¥ä¸¦æ›´æ–°ã€Œæˆ‘çš„ç‹€æ…‹ã€ï¼Œé¿å… fallback é¡¯ç¤ºç„¡æ³•å–å¾—
                    (async () => {
                        try {
                            const uid = state.currentUser?.uid;
                            if (!uid) return;
                            const q = query(collection(db, 'clockInRecords'), where('userId', '==', uid), orderBy('timestamp', 'desc'), limit(1));
                            const snap = await getDocs(q);
                            let innerHTML = '';
                            if (!snap.empty) {
                                const r = snap.docs[0].data();
                                const statusTextLast = getStatusDisplayText(r.type || 'æœªçŸ¥', r.locationName || null, r.dutyType || null);
                                const statusColorLast = getStatusColor(statusTextLast);
                                const ts = r.timestamp && r.timestamp.toDate ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                                innerHTML = `
                                    <div class=\"flex items-center justify-between\">
                                        <span class=\"font-semibold text-lg ${statusColorLast}\">${statusTextLast}</span>
                                    </div>
                                    <div class=\"text-sm text-gray-500 mt-1\">
                                        ${ts ? 'æ‰“å¡ ' + ts.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'}) : ''}
                                    </div>`;
                            } else {
                                const statusTextLast = 'å°šæœªæ‰“å¡';
                                const statusColorLast = getStatusColor(statusTextLast);
                                innerHTML = `
                                    <div class=\"flex items-center justify-between\">
                                        <span class=\"font-semibold text-lg ${statusColorLast}\">${statusTextLast}</span>
                                    </div>`;
                            }
                            const myStatusEl = document.getElementById('my-status');
                            if (myStatusEl) myStatusEl.innerHTML = innerHTML;
                            myStatusFound = true;
                        } catch (err) {
                            console.error('è®€å–æœ€æ–°æ‰“å¡ç´€éŒ„å¤±æ•—', err);
                        }
                    })();
                    const users = [];
                    querySnapshot.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                    
                    // ç²å–è¨­å®šä¸­çš„å¯è¦‹ä½¿ç”¨è€…è¨­å®š
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn("Could not load user visibility settings:", e);
                    }
                    
                    // éæ¿¾æ‰ä¸é¡¯ç¤ºçš„ä½¿ç”¨è€…
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    
                    

                   // ä»¥æœ€æ–°æ‰“å¡ç´€éŒ„è¨ˆç®—æ‘˜è¦äººæ•¸ï¼Œèˆ‡å½ˆçª—ä¸€è‡´
                   (async () => {
                       try {
                           const latestMap = {};
                           await Promise.all(visibleUsersList.map(async (u) => {
                               try {
                                   const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                   const latestSnap = await getDocs(qLatest);
                                   latestMap[u.id] = latestSnap.empty ? null : latestSnap.docs[0].data();
                               } catch (e) {
                                   console.warn('è¼‰å…¥ä½¿ç”¨è€…æœ€æ–°æ‰“å¡å¤±æ•—:', e);
                                   latestMap[u.id] = null;
                               }
                           }));

                           let countWork = 0, countOutbound = 0, countOff = 0, countLeave = 0;
                           const now = new Date();
                           const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                           const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                           visibleUsersList.forEach(u => {
                               const latest = latestMap[u.id];
                               const type = latest?.type || u.clockInStatus || '';
                               const leave = u.leaveStatus || '';
                               let isLeave = false;
                               if (latest && (type === 'è‡¨æ™‚è«‹å‡' || String(type).includes('è«‹å‡'))) {
                                   isLeave = true;
                               } else if (leave === 'approved' || leave === 'pending') {
                                   if (u.leaveStartTime && u.leaveEndTime) {
                                       const leaveStart = u.leaveStartTime.toDate ? u.leaveStartTime.toDate() : new Date(u.leaveStartTime);
                                       const leaveEnd = u.leaveEndTime.toDate ? u.leaveEndTime.toDate() : new Date(u.leaveEndTime);
                                       isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                   }
                               }
                               if (isLeave) {
                                   countLeave++;
                                   return;
                               }
                               if (type === 'ä¸Šç­' || type === 'è¿”å›') countWork++;
                               else if (type === 'å¤–å‡º' || type === 'æŠµé”' || type === 'é›¢é–‹') countOutbound++;
                               else if (type === 'ä¸‹ç­' || type === 'è‡ªå‹•ä¸‹ç­' || type === 'å·²ä¸‹ç­-æœªæ‰“å¡') countOff++;
                           });
                           if (countWorkEl) countWorkEl.textContent = countWork;
                           if (countOutboundEl) countOutboundEl.textContent = countOutbound;
                           if (countOffEl) countOffEl.textContent = countOff;
                           if (countLeaveEl) countLeaveEl.textContent = countLeave;
                       } catch (e) {
                           console.warn('æ›´æ–°å„€éŒ¶æ¿æ‘˜è¦äººæ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                       } finally {
                           if(!myStatusFound && document.getElementById('my-status')){
                               document.getElementById('my-status').textContent = 'ç„¡æ³•å–å¾—æ‚¨çš„ç‹€æ…‹';
                           }
                       }
                   })();
                    
                });
                state.activeListeners.push(unsubscribe);
            }

            // æ‰€æœ‰åŒä»ç‹€æ…‹å½ˆçª—
            function openAllUsersStatusModal() {
                // èƒŒæ™¯
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                backdrop.id = 'all-users-modal-backdrop';
                // å®¹å™¨
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
                modal.id = 'all-users-modal';
                const box = document.createElement('div');
                box.className = 'bg-white rounded-lg shadow-lg w-11/12 max-w-2xl p-4 border';
                box.innerHTML = `
                    <div class=\"flex items-center justify-between mb-2\">
                        <h3 class=\"font-bold text-lg flex items-center\"><i data-lucide=\"users\" class=\"w-5 h-5 mr-2\"></i>æ‰€æœ‰åŒä»ç‹€æ…‹</h3>
                        <button id=\"close-all-users-modal\" class=\"text-gray-600 hover:text-gray-800\"><i data-lucide=\"x\" class=\"w-5 h-5\"></i></button>
                    </div>
                    <div id=\"all-users-modal-list\" class=\"space-y-2 max-h-[60vh] overflow-y-auto\">
                        <div class=\"text-center p-4 text-gray-500\">è®€å–ä¸­...</div>
                    </div>
                `;
                modal.appendChild(box);
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);
                lucide.createIcons();
                
                const usersRef = collection(db, 'users');
                const unsub = onSnapshot(query(usersRef), (querySnapshot) => {
                    const listEl = document.getElementById('all-users-modal-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                    
                    // é¡¯ç¤ºè¨­å®šéæ¿¾
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn('Could not load user visibility settings:', e);
                    }
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    
                    // æ’åºï¼šè‡ªè¨‚ç‹€æ…‹å„ªå…ˆç´š + æœ€è¿‘æ›´æ–°æ™‚é–“ï¼ˆæ–°è‡³èˆŠï¼‰ + å§“å
                    const statusPriority = (user) => {
                            const isOutRelated = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(user.clockInStatus);
                            const locationText = isOutRelated && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null);
                        const display = getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locationText, user.dutyType);
                        let isLeave = (user.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (display.includes('è«‹å‡'));
                        if (!isLeave) {
                            const leave = user.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (user.leaveStartTime && user.leaveEndTime) {
                                    const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                    const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }

                        if (display.includes('ä¸Šç­') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 1;
                        if (display.includes('è¿”å›') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 2;
                        if (display.startsWith('å¤–å‡º-')) return 3;
                        if (display.startsWith('æŠµé”-')) return 4;
                        if (display.startsWith('é›¢é–‹-')) return 5;
                        if (isLeave) return 6;
                        if (display.includes('å·²ä¸‹ç­')) return 7;
                        return 8;
                    };

                    (async () => {
                        const latestMap = {};
                        try {
                            await Promise.all(visibleUsersList.map(async (u) => {
                                try {
                                    const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                    const latestSnap = await getDocs(qLatest);
                                    if (!latestSnap.empty) {
                                        // å„²å­˜æ•´ç­†æœ€æ–°ç´€éŒ„è³‡æ–™ä»¥ä¾¿å–å¾— type/locationName/dutyType/timestamp
                                        latestMap[u.id] = latestSnap.docs[0].data();
                                    } else {
                                        latestMap[u.id] = null;
                                    }
                                } catch (e) {
                                    console.warn('è¼‰å…¥ä½¿ç”¨è€…æœ€æ–°æ‰“å¡å¤±æ•—:', e);
                                    latestMap[u.id] = null;
                                }
                            }));
                        } catch (e) {
                            console.warn('å»ºç«‹æœ€æ–°æ‰“å¡æ™‚é–“å°æ‡‰è¡¨å¤±æ•—:', e);
                        }

                    visibleUsersList.sort((a, b) => {
                            const latestA = latestMap[a.id] || null;
                            const latestB = latestMap[b.id] || null;
                            const locA = latestA?.locationName || ((['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(a.clockInStatus) && a.outboundLocation) ? a.outboundLocation : (a.lastLocation?.address || null));
                            const locB = latestB?.locationName || ((['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(b.clockInStatus) && b.outboundLocation) ? b.outboundLocation : (b.lastLocation?.address || null));
                            const displayA = latestA ? getStatusDisplayText(latestA.type || 'æœªçŸ¥', latestA.locationName || null, latestA.dutyType || null)
                                                     : getStatusDisplayText(a.clockInStatus || 'æœªæ‰“å¡', locA, a.dutyType);
                            const displayB = latestB ? getStatusDisplayText(latestB.type || 'æœªçŸ¥', latestB.locationName || null, latestB.dutyType || null)
                                                     : getStatusDisplayText(b.clockInStatus || 'æœªæ‰“å¡', locB, b.dutyType);

                            // åˆ¤æ–·è«‹å‡ï¼ˆè‡¨æ™‚è«‹å‡æˆ–ç•¶å¤©æœ‰æ•ˆç”³è«‹ï¼‰
                            let isLeaveA = (a.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (displayA.includes('è«‹å‡'));
                            if (!isLeaveA) {
                                const leaveA = a.leaveStatus || '';
                                if (leaveA === 'approved' || leaveA === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (a.leaveStartTime && a.leaveEndTime) {
                                        const leaveStartA = a.leaveStartTime.toDate ? a.leaveStartTime.toDate() : new Date(a.leaveStartTime);
                                        const leaveEndA = a.leaveEndTime.toDate ? a.leaveEndTime.toDate() : new Date(a.leaveEndTime);
                                        isLeaveA = leaveStartA <= todayEnd && leaveEndA >= todayStart;
                                    }
                                }
                            }
                            let isLeaveB = (b.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (displayB.includes('è«‹å‡'));
                            if (!isLeaveB) {
                                const leaveB = b.leaveStatus || '';
                                if (leaveB === 'approved' || leaveB === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (b.leaveStartTime && b.leaveEndTime) {
                                        const leaveStartB = b.leaveStartTime.toDate ? b.leaveStartTime.toDate() : new Date(b.leaveStartTime);
                                        const leaveEndB = b.leaveEndTime.toDate ? b.leaveEndTime.toDate() : new Date(b.leaveEndTime);
                                        isLeaveB = leaveStartB <= todayEnd && leaveEndB >= todayStart;
                                    }
                                }
                            }

                            const prioOf = (display, isLeave) => {
                                if (display.includes('ä¸Šç­') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 1;
                                if (display.includes('è¿”å›') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 2;
                                if (display.startsWith('å¤–å‡º-')) return 3;
                                if (display.startsWith('æŠµé”-')) return 4;
                                if (display.startsWith('é›¢é–‹-')) return 5;
                                if (isLeave) return 6;
                                if (display.includes('å·²ä¸‹ç­')) return 7;
                                return 8;
                            };

                            const prA = prioOf(displayA, isLeaveA);
                            const prB = prioOf(displayB, isLeaveB);
                            if (prA !== prB) return prA - prB;

                            const tA = latestA?.timestamp?.toDate?.() ? latestA.timestamp.toDate()
                                      : (a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0));
                            const tB = latestB?.timestamp?.toDate?.() ? latestB.timestamp.toDate()
                                      : (b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0));
                            if (tA.getTime() !== tB.getTime()) return tB - tA;
                            return a.name.localeCompare(b.name, 'zh-Hant');
                        }).forEach(user => {
                            const latest = latestMap[user.id] || null;
                            const locText = latest?.locationName || ((['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(user.clockInStatus) && user.outboundLocation) ? user.outboundLocation : (user.lastLocation?.address || null));
                            const statusText = latest ? getStatusDisplayText(latest.type || 'æœªçŸ¥', latest.locationName || null, latest.dutyType || null)
                                                      : getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locText, user.dutyType);
                            const statusColor = getStatusColor(statusText);
                            const clockInTime = latest?.timestamp?.toDate?.() ? latest.timestamp.toDate() : (latest?.timestamp ? new Date(latest.timestamp) : null);
                            const timeFormatted = clockInTime ? clockInTime.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}) : 'N/A';
                            listEl.innerHTML += `
                                <div class=\"flex items-center justify-between bg-white p-3 rounded-md shadow-sm border\">
                                    <div class=\"flex items-center\">
                                        <img src=\"${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name?.charAt(0) || 'U'}`}\" class=\"w-8 h-8 rounded-full mr-3 object-cover\">
                                        <div>
                                            <span class=\"font-medium text-gray-700\">${user.name || user.displayName || 'æœªå‘½å'}</span>
                                            <div class=\"flex items-center mt-1\">
                                                <span class=\"text-sm font-semibold ${statusColor} mr-2\">${statusText}</span>
                                                <span class=\"text-xs text-gray-500\" id=\"clock-time-${user.id}\">${timeFormatted}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class=\"flex space-x-2\">
                                        ${user.lastPhotoUrl ? `<button class=\"view-photo-btn p-2 bg-blue-100 rounded-md\" data-photo=\"${user.lastPhotoUrl}\" data-desc=\"${user.lastLocation || ''}\"><i data-lucide=\"image\" class=\"w-6 h-6 text-blue-600\"></i></button>` : ''}
                                    </div>
                                    
                                </div>`;

                            // è‹¥æ˜¯ç•¶å‰ä½¿ç”¨è€…ï¼Œæ›´æ–°ã€Œæˆ‘çš„ç‹€æ…‹ã€å€å¡Šä¸¦æ¨™ç¤ºå·²æ‰¾åˆ°
                            if (user.id === state.currentUser?.uid) {
                                try { myStatusFound = true; } catch (e) {}
                                (async () => {
                                    try {
                                        const recordsRef = collection(db, 'clockInRecords');
                                        const q = query(recordsRef, where('userId', '==', state.currentUser.uid), orderBy('timestamp', 'desc'), limit(1));
                                        const snap = await getDocs(q);
                                        let innerHTML = '';
                                        if (!snap.empty) {
                                            const r = snap.docs[0].data();
                                            const statusTextLast = getStatusDisplayText(r.type || 'æœªçŸ¥', r.locationName || null, r.dutyType || null);
                                            const statusColorLast = getStatusColor(statusTextLast);
                                            const ts = r.timestamp && r.timestamp.toDate ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                                            innerHTML = `
                                                <div class="flex items-center justify-between">
                                                    <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                                </div>
                                                <div class="text-sm text-gray-500 mt-1">
                                                    ${ts ? 'æ‰“å¡ ' + ts.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'}) : ''}
                                                </div>`;
                                        } else {
                                            const statusTextLast = 'å°šæœªæ‰“å¡';
                                            const statusColorLast = getStatusColor(statusTextLast);
                                            innerHTML = `
                                                <div class="flex items-center justify-between">
                                                    <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                                </div>`;
                                        }
                                        const myStatusEl = document.getElementById('my-status');
                                        if (myStatusEl) myStatusEl.innerHTML = innerHTML;
                                    } catch (err) {
                                        console.error('è®€å–æœ€æ–°æ‰“å¡ç´€éŒ„å¤±æ•—', err);
                                    }
                                })();
                            }
                        });
                        // é‡æ–°ä»¥æœ€æ–° clockInRecords æ›´æ–°æ¯ä½ä½¿ç”¨è€…çš„æ™‚é–“ï¼ˆé¿å…å¿«ç…§æ™‚åºä¸åŒæ­¥ï¼‰
                        try {
                            Promise.all(visibleUsersList.map(async (u) => {
                                try {
                                    const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                    const latestSnap = await getDocs(qLatest);
                                    let dt = null;
                                    if (!latestSnap.empty) {
                                        const rec = latestSnap.docs[0].data();
                                        const ts = rec.timestamp;
                                        dt = ts?.toDate?.() ? ts.toDate() : (ts ? new Date(ts) : null);
                                    }
                                    const el = document.querySelector(`#clock-time-${u.id}`);
                                    if (el) {
                                        el.textContent = dt ? dt.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}) : 'N/A';
                                    }
                                } catch (e) {
                                    console.warn('è¼‰å…¥ä½¿ç”¨è€…æœ€æ–°æ‰“å¡å¤±æ•—:', e);
                                }
                            }));
                        } catch (e) {
                            console.warn('æ›´æ–°æœ€æ–°æ‰“å¡æ™‚é–“æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                        }
                    })();
                    try { lucide.createIcons(); } catch (e) {}
                    // ç¶å®šç…§ç‰‡èˆ‡åœ°åœ–æŒ‰éˆ•
                    document.querySelectorAll('#all-users-modal .view-photo-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const photoUrl = e.currentTarget.dataset.photo;
                            const description = e.currentTarget.dataset.desc;
                            if(photoUrl) openPhotoModal([photoUrl], [description]);
                            else showToast('ç„¡ç…§ç‰‡å¯é¡¯ç¤º', true);
                        });
                    });
                    
                });
                
                function closeModal() {
                    try { unsub(); } catch {}
                    const m = document.getElementById('all-users-modal');
                    const b = document.getElementById('all-users-modal-backdrop');
                    if (m) document.body.removeChild(m);
                    if (b) document.body.removeChild(b);
                }
                document.getElementById('close-all-users-modal').addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            }

            function renderClockIn(subPage) {
                // è‹¥æœ‰èˆŠé€£çµå°åˆ°å·²ç§»é™¤çš„ scheduleï¼Œæ”¹å°è‡³ location
                if (subPage === 'schedule') subPage = 'location';
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="location" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'location' ? 'active' : ''}">å®šä½æ‰“å¡</button>
                        <button data-subtab="records" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'records' ? 'active' : ''}">æ‰“å¡ç´€éŒ„</button>
                        <button data-subtab="leaves" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'leaves' ? 'active' : ''}">è«‹å‡ç´€éŒ„</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'location') {
                    renderClockInLocation(subPageContent);
                } else if (subPage === 'records') {
                    renderClockInRecords(subPageContent);
                } else if (subPage === 'leaves') {
                    renderMyLeaveRecords(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('clock-in', btn.dataset.subtab)));
            }

            function renderClockInLocation(container) {
                container.innerHTML = `
                    <div class="p-4 h-full flex flex-col">
                        <button id="relocate-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 flex items-center justify-center mb-4">
                            <i data-lucide="locate-fixed" class="w-4 h-4 mr-2"></i>é‡æ–°å®šä½
                        </button>
                        <div id="map-container" class="flex-grow rounded-lg overflow-hidden border border-gray-300 relative">
                             <div id="map" class="map-canvas"></div>
                             <div id="map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
                        </div>
                        <div id="status-display" class="mt-3 text-center font-semibold text-lg text-gray-700">
                            <span id="status-text">å°šæœªæ‰“å¡</span>
                        </div>
                        <div id="clock-in-buttons" class="grid grid-cols-2 gap-2 pt-4">
                            <!-- ç¬¬ä¸€åˆ—ï¼šä¸Šç­/ä¸‹ç­åˆ‡æ› èˆ‡ å¤–å‡ºå¾ªç’° -->
                            <button id="work-toggle-btn" data-type="ä¸Šç­" class="clock-in-btn bg-green-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-green-600">ä¸Šç­æ‰“å¡</button>
                            <button id="outbound-cycle-btn" data-type="å¤–å‡º" class="clock-in-btn bg-blue-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-600">å¤–å‡ºæ‰“å¡</button>
                            <!-- ç¬¬äºŒåˆ—ï¼šè¿”å›æ‰“å¡ èˆ‡ è«‹å‡ç”³è«‹ï¼ˆå¯¬åº¦èˆ‡å¤–å‡ºä¸€è‡´ï¼Œé å³ï¼‰ -->
                            <button id="return-btn" data-type="è¿”å›" class="clock-in-btn bg-gray-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-gray-600">è¿”å›æ‰“å¡</button>
                            <div class="flex">
                                <button data-type="è‡¨æ™‚è«‹å‡" id="temp-leave-btn" class="clock-in-btn w-full bg-orange-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-orange-600">è«‹å‡ç”³è«‹</button>
                            </div>
                        </div>
                    </div>`;
                lucide.createIcons();
                initClockInMap();

                document.getElementById('relocate-btn').addEventListener('click', initClockInMap);
                
                // åˆå§‹åŒ–æ‰“å¡ç‹€æ…‹ï¼ˆåœ¨å®šä½æ‰“å¡å­é æ¸²æŸ“å®Œæˆå¾Œï¼‰
                initClockInButtonStatus();
                updateStatusDisplay();
                
                // æ‰“å¡æŒ‰éˆ•é»æ“Šäº‹ä»¶
                document.querySelectorAll('.clock-in-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (btn.classList.contains('disabled')) {
                            return;
                        }
                        
                        if (!state.currentLocation) {
                            alert("ç„¡æ³•å–å¾—ç›®å‰ä½ç½®ï¼Œè«‹ç¨å¾Œå†è©¦");
                            return;
                        }
                        
                        const type = e.target.dataset.type;
                        
                        // å¤–å‡ºæ‰“å¡éœ€è¦å…ˆè¼¸å…¥åœ°é»
                        if (type === "å¤–å‡º") {
                            // ç›´æ¥æ‰“é–‹åœ°é»è¼¸å…¥å½ˆçª—
                            const backdrop = document.createElement('div');
                            backdrop.id = 'modal-backdrop';
                            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                            backdrop.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // å‰µå»ºå½ˆçª—
                            const modal = document.createElement('div');
                            modal.id = 'location-input-modal';
                            modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 z-50 w-80';
                            
                            // å‰µå»ºæ¨™é¡Œ
                            const title = document.createElement('h3');
                            title.className = 'text-lg font-semibold mb-4';
                            title.textContent = 'è«‹é¸æ“‡å‹¤å‹™é …ç›®ä¸¦è¼¸å…¥å¤–å‡ºåœ°é»';

                            // å‹¤å‹™é …ç›®é¸å–®
                            const dutyContainer = document.createElement('div');
                            dutyContainer.className = 'mb-4';
                            const dutyLabel = document.createElement('label');
                            dutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            dutyLabel.textContent = 'å‹¤å‹™é …ç›®';
                            const dutySelect = document.createElement('select');
                            dutySelect.id = 'outbound-duty-type';
                            dutySelect.className = 'w-full border border-gray-300 rounded-md p-2';
                            ['ä¾‹è¡Œç£å¯Ÿ','ä¾‹æœƒ','å€å¤§','è‡¨æ™‚æœƒ','ç°¡å ±','å…¶ä»–'].forEach(opt => {
                                const o = document.createElement('option');
                                o.value = opt;
                                o.textContent = opt;
                                dutySelect.appendChild(o);
                            });
                            dutyContainer.appendChild(dutyLabel);
                            dutyContainer.appendChild(dutySelect);

                            // å…¶ä»–å‹¤å‹™é …ç›®è¼¸å…¥æ¡†ï¼ˆé è¨­éš±è—ï¼‰
                            const otherDutyContainer = document.createElement('div');
                            otherDutyContainer.id = 'outbound-other-duty-container';
                            otherDutyContainer.className = 'mb-4 hidden';
                            const otherDutyLabel = document.createElement('label');
                            otherDutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            otherDutyLabel.textContent = 'å…¶ä»–å‹¤å‹™é …ç›®';
                            const otherDutyInput = document.createElement('input');
                            otherDutyInput.id = 'outbound-other-duty';
                            otherDutyInput.type = 'text';
                            otherDutyInput.className = 'w-full border border-gray-300 rounded-md p-2';
                            otherDutyInput.placeholder = 'è«‹è¼¸å…¥å‹¤å‹™é …ç›®';
                            otherDutyContainer.appendChild(otherDutyLabel);
                            otherDutyContainer.appendChild(otherDutyInput);
                            
                            // å‰µå»ºè¼¸å…¥æ¡†
                            const input = document.createElement('input');
                            input.id = 'outbound-location';
                            input.type = 'text';
                            input.className = 'w-full border border-gray-300 rounded-md p-2 mb-4';
                            input.placeholder = 'ä¾‹å¦‚ï¼šå®¢æˆ¶å…¬å¸ã€é†«é™¢ç­‰';
                            
                            // å‰µå»ºæŒ‰éˆ•å®¹å™¨
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'flex justify-end space-x-2';
                            
                            // å‹¤å‹™é …ç›®åˆ‡æ›äº‹ä»¶ï¼ˆé¡¯ç¤º/éš±è—å…¶ä»–è¼¸å…¥æ¡†ï¼‰
                            dutySelect && dutySelect.addEventListener('change', () => {
                                if (dutySelect.value === 'å…¶ä»–') {
                                    otherDutyContainer.classList.remove('hidden');
                                } else {
                                    otherDutyContainer.classList.add('hidden');
                                }
                            });
                            // å‰µå»ºå–æ¶ˆæŒ‰éˆ•
                            const cancelButton = document.createElement('button');
                            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md';
                            cancelButton.textContent = 'å–æ¶ˆ';
                            cancelButton.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // å‰µå»ºç¢ºèªæŒ‰éˆ•
                            const confirmButton = document.createElement('button');
                            confirmButton.className = 'px-4 py-2 bg-blue-500 text-white rounded-md';
                            confirmButton.textContent = 'ç¢ºèª';
                            confirmButton.addEventListener('click', () => {
                                const dutyTypeEl = document.getElementById('outbound-duty-type');
                                const dutyType = dutyTypeEl ? dutyTypeEl.value : '';
                                let dutyName = dutyType;
                                if (dutyType === 'å…¶ä»–') {
                                    const otherDuty = document.getElementById('outbound-other-duty').value.trim();
                                    if (!otherDuty) {
                                        alert('è«‹è¼¸å…¥å‹¤å‹™é …ç›®');
                                        return;
                                    }
                                    dutyName = otherDuty;
                                }
                                const locationText = document.getElementById('outbound-location').value.trim();
                                if (locationText) {
                                    state.outboundLocation = locationText;
                                    state.dutyType = dutyName;
                                    // ä¿å­˜åœ°é»åˆ°è¨­å®šçš„ savedLocationsï¼ˆæœ€å¤š10ç­†ï¼‰
                                    try {
                                        if (!state.savedLocations) {
                                            state.savedLocations = [];
                                        }
                                        const exists = state.savedLocations.some(loc => loc === locationText);
                                        if (!exists) {
                                            state.savedLocations.push(locationText);
                                            if (state.savedLocations.length > 10) {
                                                state.savedLocations.shift();
                                            }
                                            // åƒ…ç®¡ç†å“¡å¯å¯«å…¥ Firestoreï¼›ä¸€èˆ¬ä½¿ç”¨è€…æ”¹å­˜ localStorage
                                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                            const user = window.__auth?.currentUser;
                                            if (isAdmin && user) {
                                                const { updateDoc, doc } = window.__fs; const db = window.__db;
                                                updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations })
                                                    .catch(err => console.warn('ä¿å­˜åœ°å€åˆ°è¨­å®šå¤±æ•—', err));
                                            } else {
                                                try {
                                                    const key = `saved_locations_${window.__auth?.currentUser?.uid || 'guest'}`;
                                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                                } catch (e) { console.warn('ä¿å­˜åœ°å€åˆ°æœ¬æ©Ÿå¤±æ•—', e); }
                                            }
                                        }
                                    } catch (e) {
                                        console.warn('è™•ç† savedLocations å¤±æ•—', e);
                                    }
                                    // ä¿å­˜å¤–å‡ºåœ°é»åˆ°ç³»çµ±ä½ç½®è¨­å®šï¼ˆotherLocationsï¼‰ï¼Œåƒ…ç®¡ç†å“¡å…·æœ‰å¯«å…¥æ¬Šé™
                                    try {
                                        const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                        const user = window.__auth?.currentUser; const db = window.__db; const { doc, getDoc, setDoc, arrayUnion, serverTimestamp } = window.__fs;
                                        if (isAdmin && user) {
                                            const settingsRef = doc(db, 'settings', 'location');
                                            // æ§‹å»ºä½ç½®ç‰©ä»¶
                                            const locEntry = {
                                                name: locationText,
                                                lat: (state.currentLocation && typeof state.currentLocation.lat === 'number') ? state.currentLocation.lat : null,
                                                lng: (state.currentLocation && typeof state.currentLocation.lng === 'number') ? state.currentLocation.lng : null,
                                                radius: 100
                                            };
                                            // å…ˆè®€å–ï¼Œé¿å…é‡è¤‡åç¨±
                                            getDoc(settingsRef).then(docSnap => {
                                                const settings = docSnap.exists() ? docSnap.data() : {};
                                                const otherLocations = Array.isArray(settings.otherLocations) ? settings.otherLocations : [];
                                                const nameExists = otherLocations.some(l => (l && l.name) === locationText);
                                                if (!nameExists) {
                                                    setDoc(settingsRef, {
                                                        otherLocations: arrayUnion(locEntry),
                                                        updatedAt: serverTimestamp()
                                                    }, { merge: true }).catch(err => console.warn('ä¿å­˜å…¶ä»–ä½ç½®å¤±æ•—', err));
                                                }
                                            }).catch(err => console.warn('è®€å–ä½ç½®è¨­å®šå¤±æ•—', err));
                                        }
                                    } catch (e) {
                                        console.warn('è™•ç† otherLocations å¤±æ•—', e);
                                    }
                                    document.body.removeChild(backdrop);
                                    document.body.removeChild(modal);
                                    // æ‰“é–‹ç›¸æ©Ÿï¼Œå‚³éç•¶å‰ä½ç½®å’Œå¤–å‡ºåœ°é»åç¨±ï¼›è‹¥å®šä½å¤±æ•—å‰‡ä½¿ç”¨å¾Œå‚™åº§æ¨™
                                    if (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') {
                                        openCameraModal(type, { ...state.currentLocation, name: locationText });
                                    } else {
                                        showToast('å®šä½é€¾æ™‚ï¼Œå°‡ä»¥æœªçŸ¥ä½ç½®ç¹¼çºŒæ‰“å¡ï¼ˆç¨å¾Œå¯åŒæ­¥ï¼‰');
                                        openCameraModal(type, { lat: 0, lng: 0, name: locationText, isFallback: true });
                                    }
                                } else {
                                    alert('è«‹è¼¸å…¥å¤–å‡ºåœ°é»');
                                }
                            });
                            
                            // çµ„è£å½ˆçª—
                            buttonContainer.appendChild(cancelButton);
                            buttonContainer.appendChild(confirmButton);
                            modal.appendChild(title);
                            // æ’å…¥å‹¤å‹™é …ç›®é¸å–®èˆ‡å…¶ä»–è¼¸å…¥
                            modal.appendChild(dutyContainer);
                            modal.appendChild(otherDutyContainer);
                            modal.appendChild(input);
                            modal.appendChild(buttonContainer);
                            
                            // æ·»åŠ åˆ°é é¢
                            document.body.appendChild(backdrop);
                            document.body.appendChild(modal);
                        } else if (type === "æŠµé”" || type === "é›¢é–‹" || type === "è¿”å›") {
                            // æŠµé”ã€é›¢é–‹ã€è¿”å›æ‰“å¡ä¹Ÿéœ€è¦æ‹ç…§
                            openCameraModal(type, state.currentLocation);
                        } else if (type === "è‡¨æ™‚è«‹å‡") {
                            // ä¸åŸ·è¡Œç›¸æ©Ÿæ“ä½œ
                        } else {
                            openCameraModal(type, state.currentLocation);
                        }
                    });
                });
                
                // è‡¨æ™‚è«‹å‡æŒ‰éˆ•
                document.getElementById('temp-leave-btn').addEventListener('click', () => {
                    openTempLeaveModal();
                });
                
                // å·²ç§»é™¤ç‰¹æ®Šå‹¤å‹™æŒ‰éˆ•
            }

            // ä¸Šç­æ—¥æœŸå­åˆ†é ï¼šä»¥æœˆç‚ºå–®ä½ï¼ˆåªè®€ï¼‰ï¼Œå¾ Firestore è®€å–
            function renderWorkDatesMonthView(container) {
                let year, month; // 0-based month
                const trgY = localStorage.getItem('__workdays_target_year');
                const trgM = localStorage.getItem('__workdays_target_month');
                if (trgY && trgM) {
                    year = parseInt(trgY, 10);
                    month = parseInt(trgM, 10);
                    localStorage.removeItem('__workdays_target_year');
                    localStorage.removeItem('__workdays_target_month');
                } else {
                    const now = new Date();
                    year = now.getFullYear();
                    month = now.getMonth();
                }
                const ymKey = `${year}-${String(month + 1).padStart(2, '0')}`;

                // è®€å–å‡æ—¥è¨­å®šä»¥æ±ºå®šé è¨­æ˜¯å¦ç‚ºå·¥ä½œæ—¥
                const holidaySettings = window.__holidaySettingsCache || { weekendIsHoliday: false, holidays: [] };
                const holidaysSet = new Set(holidaySettings.holidays || []);
                const isHoliday = (date) => {
                    const ymd = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                    const weekend = date.getDay() === 0 || date.getDay() === 6;
                    return holidaysSet.has(ymd) || (holidaySettings.weekendIsHoliday && weekend);
                };

                container.innerHTML = `
                    <div class="p-4 space-y-4 h-full">
                        <div class="bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold text-gray-800">ä¸Šç­æ—¥æœŸï¼ˆ${year}å¹´${month+1}æœˆï¼‰</h2>
                                <div class="space-x-2">
                                    <span class="text-sm text-gray-500">åƒ…ä¾›æŸ¥çœ‹ï¼Œè«‹è‡³è¨­å®šé èª¿æ•´</span>
                                    <button id="prev-workdays-month" class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200">ä¸Šå€‹æœˆ</button>
                                    <button id="next-workdays-month" class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200">ä¸‹å€‹æœˆ</button>
                                </div>
                            </div>
                            <div id="workdays-list" class="space-y-2 overflow-y-auto" style="max-height: calc(100vh - 220px);"></div>
                        </div>
                    </div>`;

                const listEl = document.getElementById('workdays-list');
                listEl.innerHTML = `<div class="p-4 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>è¼‰å…¥ä¸Šç­è¨­å®š...</div></div>`;
                lucide.createIcons();

                // ç”Ÿæˆæœ¬æœˆæ¯æ—¥åˆ—ï¼ˆåªè®€ï¼‰
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                const renderRows = (daysMap) => {
                    listEl.innerHTML = '';
                    for (let d = 1; d <= lastDay.getDate(); d++) {
                        const date = new Date(year, month, d);
                        const weekdayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                        const weekday = weekdayNames[date.getDay()];
                        const ymd = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const defaultIsWorkday = !isHoliday(date) && (date.getDay() >= 1 && date.getDay() <= 5);
                        const existing = daysMap && daysMap[ymd] ? daysMap[ymd] : null;
                        const startDefault = existing?.start || (defaultIsWorkday ? '09:00' : '');
                        const endDefault = existing?.end || (defaultIsWorkday ? '17:30' : '');
                        const isGray = holidaysSet.has(ymd) || (holidaySettings.weekendIsHoliday && (date.getDay()===0 || date.getDay()===6));

                        const row = document.createElement('div');
                        row.className = `flex items-center justify-between p-2 rounded border ${isGray ? 'bg-gray-100' : 'bg-white'}`;
                        row.innerHTML = `
                            <div class="w-40">
                                <div class="font-medium">${ymd}</div>
                                <div class="text-xs text-gray-500">æ˜ŸæœŸ${weekday}</div>
                            </div>
                            <div class="flex items-center space-x-2 flex-1 justify-end">
                                <label class="text-sm text-gray-600">é–‹å§‹</label>
                                <input type="time" class="border border-gray-300 rounded-md p-1 bg-gray-50" id="start-${ymd}" value="${startDefault}" placeholder="--:--" disabled>
                                <label class="text-sm text-gray-600 ml-2">çµæŸ</label>
                                <input type="time" class="border border-gray-300 rounded-md p-1 bg-gray-50" id="end-${ymd}" value="${endDefault}" placeholder="--:--" disabled>
                            </div>
                        `;
                        listEl.appendChild(row);
                    }
                };

                const fetchWorkdays = async () => {
                    const db = window.__db; const { doc, getDoc } = window.__fs;
                    let daysMap = {};
                    try {
                        // å…¨åŸŸè¨­å®šï¼šsettings/workdays_YYYY-MM
                        const settingsDocSnap = await getDoc(doc(db, 'settings', `workdays_${ymKey}`));
                        if (settingsDocSnap.exists()) {
                            const sd = settingsDocSnap.data();
                            if (sd && sd.days && typeof sd.days === 'object') {
                                daysMap = { ...sd.days };
                            }
                        }
                    } catch (e) {
                        console.warn('è®€å–å…¨åŸŸä¸Šç­è¨­å®šå¤±æ•—', e);
                    }
                    try {
                        // å€‹äººè¦†è“‹ï¼šusers/{uid}/workdays/{YYYY-MM}
                        const user = window.__auth?.currentUser;
                        if (user) {
                            const userDocSnap = await getDoc(doc(db, 'users', user.uid, 'workdays', ymKey));
                            if (userDocSnap.exists()) {
                                const ud = userDocSnap.data();
                                if (ud && ud.days && typeof ud.days === 'object') {
                                    daysMap = { ...daysMap, ...ud.days };
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('è®€å–å€‹äººä¸Šç­è¨­å®šå¤±æ•—', e);
                    }
                    return daysMap;
                };

                fetchWorkdays()
                    .then((daysMap) => { renderRows(daysMap); lucide.createIcons(); })
                    .catch(() => { renderRows({}); lucide.createIcons(); });

                // æœˆä»½åˆ‡æ›ï¼šé‡å°è‡³ clock-in/workdays å°è¦½ï¼Œå¸¶ç›®æ¨™æœˆä»½
                const navigateWorkdays = (offset) => {
                    const base = new Date(year, month, 1);
                    base.setMonth(base.getMonth() + offset);
                    // å°‡ç›®æ¨™å¹´æœˆæš«å­˜ï¼ŒrenderWorkDatesMonthView è®€å–
                    localStorage.setItem('__workdays_target_year', String(base.getFullYear()));
                    localStorage.setItem('__workdays_target_month', String(base.getMonth()));
                    showPage('clock-in', 'workdays');
                };
                document.getElementById('prev-workdays-month').addEventListener('click', () => navigateWorkdays(-1));
                document.getElementById('next-workdays-month').addEventListener('click', () => navigateWorkdays(1));
            }

            // å€‹äººè«‹å‡ç´€éŒ„å­é ç±¤
            function renderMyLeaveRecords(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-status-filter" class="text-sm font-medium">å¯©æ ¸ç‹€æ…‹:</label>
                                <select id="my-leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>å…¨éƒ¨</option>
                                    <option value="pending">å¾…å¯©æ ¸</option>
                                    <option value="approved">å·²æ ¸å‡†</option>
                                    <option value="rejected">å·²æ‹’çµ•</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-date-filter" class="text-sm font-medium">æ—¥æœŸ:</label>
                                <input type="date" id="my-leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <button id="my-leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>æœå°‹
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äº‹ç”±</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é–‹å§‹æ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çµæŸæ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    è¼‰å…¥ä¸­...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="no-my-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è«‹å‡è¨˜éŒ„</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();

                const statusFilter = document.getElementById('my-leave-status-filter');
                const dateFilter = document.getElementById('my-leave-date-filter');
                const searchBtn = document.getElementById('my-leave-search-btn');

                // åˆå§‹åŠ è¼‰
                loadMyLeaveRecords();

                searchBtn.addEventListener('click', loadMyLeaveRecords);

                function getStatusBadge(status) {
                    switch (status) {
                        case 'pending':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">å¾…å¯©æ ¸</span>';
                        case 'approved':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">å·²æ ¸å‡†</span>';
                        case 'rejected':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">å·²æ‹’çµ•</span>';
                        case 'canceled':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">å·²å–æ¶ˆ</span>';
                        default:
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">æœªçŸ¥</span>';
                    }
                }

                function loadMyLeaveRecords() {
                    const recordsList = document.getElementById('my-leave-records-list');
                    const noRecordsMsg = document.getElementById('no-my-leave-records');

                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    è¼‰å…¥ä¸­...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();

                    const status = statusFilter.value;
                    const date = dateFilter.value;

                    const user = window.__auth?.currentUser;
                    if (!user) {
                        recordsList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹è«‹å‡ç´€éŒ„</td></tr>';
                        return;
                    }
                    const db = window.__db; const { collection, where, query, getDocs } = window.__fs;
                    let q = query(collection(db, 'leaves'), where('userId', '==', user.uid));
                    if (status !== 'all') { q = query(q, where('status', '==', status)); }
                    // ç§»é™¤æ’åºä»¥é¿å… Firestore ç´¢å¼•éœ€æ±‚ï¼Œæ”¹ç”¨å‰ç«¯æ’åºï¼ˆè‹¥éœ€è¦ï¼‰

                    getDocs(q).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }

                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';

                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }

                        let hasRecords = false;
                        const leaves = [];

                        querySnapshot.forEach((docSnap) => {
                            const leave = { id: docSnap.id, ...docSnap.data() };
                            leaves.push(leave);
                        });

                        // å‰ç«¯éæ¿¾èˆ‡æ’åº
                        const filtered = leaves.filter(leave => {
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                return (startTime < nextDay && endTime > selectedDate);
                            }
                            return true;
                        }).sort((a, b) => {
                            const aTs = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                            const bTs = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                            return bTs - aTs;
                        });

                        filtered.forEach(leave => {
                            hasRecords = true;
                            const startTimeText = leave.startTime.toDate().toLocaleString('zh-TW');
                            const endTimeText = leave.endTime.toDate().toLocaleString('zh-TW');

                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || 'ç„¡äº‹ç”±'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${getStatusBadge(leave.status)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${leave.status === 'pending' ? '<button class="cancel-leave-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded text-xs" data-id="'+(leave.id||'')+'">å–æ¶ˆ</button>' : ''}
                                </td>
                            `;
                            recordsList.appendChild(row);
                        });

                        lucide.createIcons();

                        // ç¶å®šå–æ¶ˆäº‹ä»¶ï¼ˆåƒ…é¡¯ç¤ºæ–¼å¾…å¯©æ ¸ï¼‰
                        recordsList.querySelectorAll('.cancel-leave-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = e.currentTarget.dataset.id;
                                if (!id) {
                                    showToast('ç„¡æ³•è­˜åˆ¥å‡å–®ID', true);
                                    return;
                                }
                                if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†å‡å–®å—ï¼Ÿ')) return;
                                try {
                                    const db = window.__db; const { updateDoc, doc, serverTimestamp, Timestamp } = window.__fs; const user = window.__auth?.currentUser;
                                    await updateDoc(doc(db, 'leaves', id), { status: 'canceled', canceledAt: Timestamp.fromDate(new Date()) });
                                    if (user) {
                                        await updateDoc(doc(db, 'users', user.uid), {
                                            leaveStatus: 'canceled',
                                            status: 'æœªæ‰“å¡',
                                            lastUpdated: serverTimestamp()
                                        });
                                    }
                                    showToast('å·²å–æ¶ˆå‡å–®');
                                    loadMyLeaveRecords();
                                } catch (err) {
                                    console.error('å–æ¶ˆå‡å–®å¤±æ•—', err);
                                    showToast('å–æ¶ˆå¤±æ•—ï¼š'+ (err.message||''), true);
                                }
                            });
                        });

                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                    }).catch(error => {
                        console.error('ç²å–è«‹å‡è¨˜éŒ„å¤±æ•—:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">
                                    è®€å–è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            // è‡¨æ™‚è«‹å‡è¡¨å–®
            function openTempLeaveModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.id = 'temp-leave-modal';
                
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const currentHour = now.getHours();
                const defaultEndHour = Math.min(currentHour + 2, 23);
                
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md mx-auto overflow-hidden">
                        <div class="modal-header bg-orange-500 text-white px-4 py-3 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">è«‹å‡ç”³è«‹</h3>
                            <button class="modal-close text-white hover:text-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="leave-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="leave-reason-type" class="block text-sm font-medium text-gray-700 mb-1">è«‹å‡äº‹ç”±</label>
                                    <select id="leave-reason-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="ç—…å‡">ç—…å‡</option>
                                        <option value="äº‹å‡">äº‹å‡</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                                
                                <div id="other-reason-container" class="form-group hidden">
                                    <label for="other-reason" class="block text-sm font-medium text-gray-700 mb-1">å…¶ä»–äº‹ç”±</label>
                                    <input type="text" id="other-reason" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="è«‹è¼¸å…¥è«‹å‡äº‹ç”±">
                                </div>
                                
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="form-group">
                                        <label for="leave-start-dt" class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“</label>
                                        <input type="datetime-local" id="leave-start-dt" step="600" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${(function(){const now=new Date();const y=now.getFullYear();const m=String(now.getMonth()+1).padStart(2,'0');const d=String(now.getDate()).padStart(2,'0');return `${y}-${m}-${d}T09:00`;})()}">
                                    </div>
                                    <div class="form-group">
                                        <label for="leave-end-dt" class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ™‚é–“</label>
                                        <input type="datetime-local" id="leave-end-dt" step="600" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${(function(){const now=new Date();const y=now.getFullYear();const m=String(now.getMonth()+1).padStart(2,'0');const d=String(now.getDate()).padStart(2,'0');return `${y}-${m}-${d}T17:30`;})()}">
                                        <p class="text-xs text-gray-500 mt-1">æ™‚é–“æ ¼å¼ï¼šYYYY-MM-DD hh:mmï¼ˆ24 å°æ™‚åˆ¶ï¼›è‹¥é¡¯ç¤ºä¸Šåˆ/ä¸‹åˆï¼Œè«‹é¸æ“‡æ­£ç¢ºæ™‚æ®µæˆ–è¼¸å…¥ 17:00 è¡¨ç¤ºä¸‹åˆ 5:00ï¼‰</p>
                                    </div>
                                    <div class="text-xs text-gray-600" id="workhours-hint">ç•¶æ—¥ä¸Šç­æ™‚é–“ï¼š09:00 ~ 17:30</div>
                                </div>
                                
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" id="leave-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button type="submit" id="leave-submit-btn" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">æäº¤ç”³è«‹</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // äº‹ç”±é¸æ“‡è®Šæ›´äº‹ä»¶
                const reasonTypeSelect = document.getElementById('leave-reason-type');
                const otherReasonContainer = document.getElementById('other-reason-container');
                
                reasonTypeSelect.addEventListener('change', () => {
                    if (reasonTypeSelect.value === 'å…¶ä»–') {
                        otherReasonContainer.classList.remove('hidden');
                    } else {
                        otherReasonContainer.classList.add('hidden');
                    }
                });
                
                // é—œé–‰æŒ‰éˆ•äº‹ä»¶
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
                document.getElementById('leave-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // è¡¨å–®æäº¤äº‹ä»¶
                document.getElementById('leave-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const reasonType = reasonTypeSelect.value;
                    let reason = reasonType;
                    
                    if (reasonType === 'å…¶ä»–') {
                        const otherReason = document.getElementById('other-reason').value.trim();
                        if (!otherReason) {
                            showToast('è«‹è¼¸å…¥è«‹å‡äº‹ç”±', true);
                            return;
                        }
                        reason = otherReason;
                    }
                    // å–å¾—é–‹å§‹/çµæŸã€Œæ—¥æœŸæ™‚é–“ã€ï¼Œæ¯ 10 åˆ†é˜ä¸€æ ¼
                    const startVal = (document.getElementById('leave-start-dt').value || '').trim();
                    const endVal = (document.getElementById('leave-end-dt').value || '').trim();

                    if (!startVal || !endVal || !startVal.includes('T') || !endVal.includes('T')) {
                        showToast('è«‹é¸æ“‡æœ‰æ•ˆçš„é–‹å§‹èˆ‡çµæŸæ™‚é–“', true);
                        return;
                    }
                    const parseFlexibleLocalDT = (s) => {
                        const str = (s || '').trim();
                        if (!str) return new Date(NaN);
                        // æ¨™æº– datetime-localï¼šYYYY-MM-DDTHH:mm
                        if (str.includes('T')) {
                            const [datePart, timePart] = str.split('T');
                            const [yy, mm, dd] = datePart.split('-').map(n => parseInt(n, 10));
                            const [HH, MM] = timePart.split(':').map(n => parseInt(n, 10));
                            return new Date(yy, (mm || 1) - 1, dd || 1, HH || 0, MM || 0, 0);
                        }
                        // å½ˆæ€§è§£æï¼šå…è¨± YYYY-MM-DD/YY-MM-DD æˆ– YYYY/MM/DDï¼Œä¸¦å¸¶æœ‰ ä¸Šåˆ/ä¸‹åˆ HH:mm
                        // ä¾‹å¦‚ï¼š2025-10-30 ä¸‹åˆ 05:00 æˆ– 2025/10/30 ä¸Šåˆ 11:10
                        const ampmMatch = str.match(/(ä¸Šåˆ|ä¸‹åˆ)/);
                        const hasPM = ampmMatch?.[1] === 'ä¸‹åˆ';
                        const norm = str.replace(/[å¹´\/]/g, '-').replace(/\s+/g, ' ').trim();
                        // ç§»é™¤ ä¸Šåˆ/ä¸‹åˆ æ¨™è¨˜å†è§£ææ™‚é–“
                        const cleaned = norm.replace(/\s*(ä¸Šåˆ|ä¸‹åˆ)\s*/g, ' ');
                        const parts = cleaned.split(' ');
                        const datePart = parts[0] || '';
                        const timePart = parts[1] || '';
                        const [yy, mm, dd] = datePart.split('-').map(n => parseInt(n, 10));
                        let [h, m] = timePart.split(':').map(n => parseInt(n, 10));
                        if (isNaN(h)) h = 0; if (isNaN(m)) m = 0;
                        // 12->24 è½‰æ›è¦å‰‡
                        if (ampmMatch) {
                            if (hasPM && h < 12) h += 12;           // ä¸‹åˆ 1..11 -> 13..23
                            if (!hasPM && h === 12) h = 0;          // ä¸Šåˆ 12 -> 00:00
                        }
                        return new Date(yy, (mm || 1) - 1, dd || 1, h, m, 0, 0);
                    };
                    const startTime = parseFlexibleLocalDT(startVal);
                    const endTime = parseFlexibleLocalDT(endVal);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        showToast('è«‹é¸æ“‡æœ‰æ•ˆçš„æ™‚é–“', true);
                        return;
                    }
                    
                    if (startTime >= endTime) {
                        showToast('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“', true);
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        
                        const db = window.__db; const { addDoc, collection, serverTimestamp, Timestamp, updateDoc, doc } = window.__fs; const user = window.__auth?.currentUser;
                        if (!user) throw new Error('å°šæœªç™»å…¥');
                        // å‰µå»ºè«‹å‡è¨˜éŒ„ï¼ˆåˆä½µæ—¥æœŸ+æ™‚é–“ï¼‰ï¼Œä¸¦å¯«å…¥ç›¸å®¹æ¬„ä½
                        await addDoc(collection(db, 'leaves'), {
                            userId: user.uid,
                            userName: state.currentUserData?.name || '',
                            reason: reason,
                            reasonType: reasonType,
                            startTime: Timestamp.fromDate(startTime),
                            endTime: Timestamp.fromDate(endTime),
                            leaveStartTime: Timestamp.fromDate(startTime),
                            leaveEndTime: Timestamp.fromDate(endTime),
                            status: 'pending',
                            createdAt: serverTimestamp()
                        });
                        
                        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                        await updateDoc(doc(db, 'users', user.uid), {
                            status: 'è«‹å‡ä¸­',
                            leaveStatus: 'pending',
                            lastUpdated: serverTimestamp()
                        });
                        
                        showToast('è«‹å‡ç”³è«‹å·²æäº¤ï¼Œç­‰å¾…å¯©æ ¸');
                        updateStatusDisplay();
                        document.body.removeChild(modal);
                    } catch (error) {
                        console.error('æäº¤è«‹å‡ç”³è«‹å¤±æ•—:', error);
                        showToast('æäº¤è«‹å‡ç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                    } finally {
                        showLoading(false);
                    }
                });

                // å‹•æ…‹é¡¯ç¤ºç•¶æ—¥ä¸Šç­æ™‚é–“ï¼ˆé€±ä¸€~é€±å››ç‚ºä¸Šç­æ—¥ï¼›é€±äº”ä¾å€¼ç­åå–®ï¼›å‡æ—¥é¡¯ç¤ºéä¸Šç­æ—¥ï¼‰
                const workhoursHintEl = document.getElementById('workhours-hint');
                const parseLocalDateOnly = (s) => {
                    if (!s || !s.includes('T')) return new Date();
                    const [datePart] = s.split('T');
                    const [yy, mm, dd] = datePart.split('-').map(n => parseInt(n, 10));
                    return new Date(yy, (mm || 1) - 1, dd || 1);
                };
                async function updateWorkhoursHint() {
                    try {
                        const startVal = (document.getElementById('leave-start-dt').value || '').trim();
                        const dt = parseLocalDateOnly(startVal);
                        const year = dt.getFullYear();
                        const month = dt.getMonth();
                        const day = dt.getDate();
                        const dow = dt.getDay();
                        let isHolidayFlag = false;
                        try {
                            if (typeof fetchHolidaySettingsOnce === 'function') await fetchHolidaySettingsOnce();
                            const hs = window.__holidaySettingsCache || { weekendIsHoliday: false, holidays: [] };
                            const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                            const weekend = dow === 0 || dow === 6;
                            const holidaysSet = new Set(hs.holidays || []);
                            isHolidayFlag = holidaysSet.has(iso) || (hs.weekendIsHoliday && weekend);
                        } catch (e) { /* ignore */ }

                        const hourText = '09:00 ~ 17:30';
                        let label = 'éä¸Šç­æ—¥';
                        let isWork = false;
                        if (!isHolidayFlag && dow >= 1 && dow <= 4) {
                            isWork = true; label = 'ä¸Šç­æ—¥';
                        } else if (!isHolidayFlag && dow === 5) {
                            try {
                                const fs = window.__fs; const db = window.__db;
                                if (fs && db) {
                                    const { doc, getDoc } = fs;
                                    const settingsRef = doc(db, 'settings', 'general');
                                    const snap = await getDoc(settingsRef);
                                    const roster = snap.exists() ? (snap.data().fridayDutyRoster || {}) : {};
                                    const auth = window.__auth;
                                    const myUid = auth?.currentUser?.uid || '';
                                    const myName = auth?.currentUser?.displayName || auth?.currentUser?.email || '';
                                    const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                    const arr = roster[iso] || [];
                                    const normalize = (s) => (s || '').trim();
                                    isWork = Array.isArray(arr) && ((myUid && arr.includes(myUid)) || (myName && arr.some(n => normalize(n) === normalize(myName))));
                                    if (isWork) label = 'å€¼ç­æ—¥';
                                }
                            } catch (e) { /* ignore */ }
                        }
                        workhoursHintEl.textContent = isWork ? `ç•¶æ—¥ä¸Šç­æ™‚é–“ï¼š${hourText}ï¼ˆ${label}ï¼‰` : `ç•¶æ—¥ä¸Šç­æ™‚é–“ï¼šéä¸Šç­æ—¥`;
                    } catch (e) {
                        workhoursHintEl.textContent = 'ç•¶æ—¥ä¸Šç­æ™‚é–“ï¼š09:00 ~ 17:30';
                    }
                }
                document.getElementById('leave-start-dt').addEventListener('change', updateWorkhoursHint);
                updateWorkhoursHint();
            }
            
            // ç‰¹æ®Šå‹¤å‹™è¡¨å–®
            function openSpecialDutyModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.id = 'special-duty-modal';
                
                const now = new Date();
                const formattedNow = now.toISOString().slice(0, 16); // æ ¼å¼ç‚º YYYY-MM-DDTHH:MM
                const twoHoursLater = new Date(now);
                twoHoursLater.setHours(twoHoursLater.getHours() + 2);
                const formattedTwoHoursLater = twoHoursLater.toISOString().slice(0, 16);
                
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md mx-auto overflow-hidden">
                        <div class="modal-header bg-purple-500 text-white px-4 py-3 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">ç‰¹æ®Šå‹¤å‹™ç™»è¨˜</h3>
                            <button class="modal-close text-white hover:text-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="duty-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="duty-type" class="block text-sm font-medium text-gray-700 mb-1">å‹¤å‹™é …ç›®åç¨±</label>
                                    <select id="duty-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="ä¾‹è¡Œç£å¯Ÿ">ä¾‹è¡Œç£å¯Ÿ</option>
                                        <option value="ç°¡å ±">ç°¡å ±</option>
                                        <option value="ä¾‹æœƒ">ä¾‹æœƒ</option>
                                        <option value="å€å¤§">å€å¤§</option>
                                        <option value="è‡¨æ™‚æœƒ">è‡¨æ™‚æœƒ</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                                
                                <div id="other-duty-container" class="form-group hidden">
                                    <label for="other-duty" class="block text-sm font-medium text-gray-700 mb-1">å…¶ä»–å‹¤å‹™é …ç›®</label>
                                    <input type="text" id="other-duty" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="è«‹è¼¸å…¥å‹¤å‹™é …ç›®åç¨±">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-location" class="block text-sm font-medium text-gray-700 mb-1">åœ°é»</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="duty-location" class="flex-grow border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="è«‹è¼¸å…¥åœ°é»">
                                        <button type="button" id="map-location-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-start-time" class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“</label>
                                    <input type="datetime-local" id="duty-start-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedNow}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-end-time" class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ™‚é–“</label>
                                    <input type="datetime-local" id="duty-end-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedTwoHoursLater}">
                                </div>
                                
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" id="duty-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button type="submit" id="duty-submit-btn" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">æäº¤ç™»è¨˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // å‹¤å‹™é …ç›®é¸æ“‡è®Šæ›´äº‹ä»¶
                const dutyTypeSelect = document.getElementById('duty-type');
                const otherDutyContainer = document.getElementById('other-duty-container');
                
                dutyTypeSelect.addEventListener('change', () => {
                    if (dutyTypeSelect.value === 'å…¶ä»–') {
                        otherDutyContainer.classList.remove('hidden');
                    } else {
                        otherDutyContainer.classList.add('hidden');
                    }
                });
                
                // åœ°åœ–ä½ç½®æŒ‰éˆ•äº‹ä»¶
                document.getElementById('map-location-btn').addEventListener('click', () => {
                    if (state.currentLocation) {
                        // ä½¿ç”¨åå‘åœ°ç†ç·¨ç¢¼ç²å–åœ°å€
                        const geocoder = new google.maps.Geocoder();
                        const latlng = { lat: state.currentLocation.lat, lng: state.currentLocation.lng };
                        
                        geocoder.geocode({ location: latlng }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                document.getElementById('duty-location').value = results[0].formatted_address;
                            } else {
                                document.getElementById('duty-location').value = `${state.currentLocation.lat}, ${state.currentLocation.lng}`;
                            }
                        });
                    } else {
                        showToast('ç„¡æ³•ç²å–ç•¶å‰ä½ç½®', true);
                    }
                });
                
                // é—œé–‰æŒ‰éˆ•äº‹ä»¶
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
                document.getElementById('duty-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // è¡¨å–®æäº¤äº‹ä»¶
                document.getElementById('duty-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const dutyType = dutyTypeSelect.value;
                    let dutyName = dutyType;
                    
                    if (dutyType === 'å…¶ä»–') {
                        const otherDuty = document.getElementById('other-duty').value.trim();
                        if (!otherDuty) {
                            showToast('è«‹è¼¸å…¥å‹¤å‹™é …ç›®åç¨±', true);
                            return;
                        }
                        dutyName = otherDuty;
                    }
                    
                    const location = document.getElementById('duty-location').value.trim();
                    if (!location) {
                        showToast('è«‹è¼¸å…¥åœ°é»', true);
                        return;
                    }
                    
                    const startTime = new Date(document.getElementById('duty-start-time').value);
                    const endTime = new Date(document.getElementById('duty-end-time').value);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        showToast('è«‹é¸æ“‡æœ‰æ•ˆçš„æ™‚é–“', true);
                        return;
                    }
                    
                    if (startTime >= endTime) {
                        showToast('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“', true);
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        
                        const db = window.__db; const { addDoc, collection, Timestamp, serverTimestamp, updateDoc, doc } = window.__fs; const user = window.__auth?.currentUser;
                        if (!user) throw new Error('å°šæœªç™»å…¥');
                        // å‰µå»ºç‰¹æ®Šå‹¤å‹™è¨˜éŒ„
                        await addDoc(collection(db, 'specialDuties'), {
                            userId: user.uid,
                            userName: state.currentUserData?.name || '',
                            dutyName: dutyName,
                            dutyType: dutyType,
                            location: location,
                            startTime: Timestamp.fromDate(startTime),
                            endTime: Timestamp.fromDate(endTime),
                            createdAt: serverTimestamp()
                        });
                        
                        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                        await updateDoc(doc(db, 'users', user.uid), {
                            status: `å‡ºå‹¤-${dutyName}`,
                            lastUpdated: serverTimestamp()
                        });
                        
                        // ä¿å­˜åœ°é»åˆ°è¨­å®š
                        if (!state.savedLocations) {
                            state.savedLocations = [];
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåœ°é»
                        const locationExists = state.savedLocations.some(loc => loc === location);
                        if (!locationExists) {
                            state.savedLocations.push(location);
                            // æœ€å¤šä¿å­˜10å€‹åœ°é»
                            if (state.savedLocations.length > 10) {
                                state.savedLocations.shift();
                            }
                            
                            // åƒ…ç®¡ç†å“¡å¯å¯«å…¥ Firestoreï¼›ä¸€èˆ¬ä½¿ç”¨è€…æ”¹å­˜ localStorage
                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                            if (isAdmin && user) {
                                await updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations });
                            } else {
                                try {
                                    const key = `saved_locations_${user?.uid || 'guest'}`;
                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                } catch (e) { console.warn('ä¿å­˜åœ°å€åˆ°æœ¬æ©Ÿå¤±æ•—', e); }
                            }
                        }
                        
                        showToast('ç‰¹æ®Šå‹¤å‹™å·²ç™»è¨˜');
                        updateStatusDisplay();
                        document.body.removeChild(modal);
                    } catch (error) {
                        console.error('æäº¤ç‰¹æ®Šå‹¤å‹™ç™»è¨˜å¤±æ•—:', error);
                        showToast('æäº¤ç‰¹æ®Šå‹¤å‹™ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderClockInRecords(container) {
                const today = new Date().toISOString().split('T')[0];
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="record-date" class="text-sm font-medium">ç¯©é¸æ—¥æœŸ:</label>
                            <input type="date" id="record-date" value="${today}" class="border border-gray-300 rounded-md px-2 py-1">
                            <button id="open-month-report" class="ml-2 px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">æœˆå ±è¡¨</button>
                        </div>
                        <div id="records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>
                        </div>
                    </div>
                `;

                const dateInput = document.getElementById('record-date');
                // æ”¯æ´å¾ç­è¡¨å¿«æ·é€£çµå¸¶å…¥æ—¥æœŸ
                try {
                    const prefill = localStorage.getItem('__records_target_date');
                    if (prefill) {
                        dateInput.value = prefill;
                        localStorage.removeItem('__records_target_date');
                    }
                } catch (e) { /* ignore */ }
                const loadRecords = () => {
                    const fs = window.__fs || {};
                    const db = window.__db;
                    const { collection, query, where, onSnapshot, Timestamp } = fs;
                    if (!db || typeof onSnapshot !== 'function' || typeof collection !== 'function') {
                        const recordsListEl = document.getElementById('records-list');
                        if (recordsListEl) {
                            recordsListEl.innerHTML = `<div class="text-center p-4 text-gray-500">ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œæ­£åœ¨æº–å‚™è³‡æ–™...</div>`;
                        }
                        return;
                    }
                    const selectedDate = new Date(dateInput.value);
                    const startOfDay = new Date(selectedDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(selectedDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    
                    const recordsRef = collection(db, "clockInRecords");
                    // Firestore ç«¯æ—¥æœŸç¯„åœæŸ¥è©¢ä»¥é¿å…æ™‚å€é‚Šç•Œèª¤å·®ï¼ˆä¿ç•™å‰ç«¯éæ¿¾ä½œç‚ºä¿éšªï¼‰
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                    const q = query(
                        recordsRef,
                        where("userId", "==", state.currentUser.uid),
                        where("timestamp", ">=", startTS),
                        where("timestamp", "<=", endTS)
                    );

                    const unsubscribe = onSnapshot(q, (querySnapshot) => {
                        const recordsListEl = document.getElementById('records-list');
                        if (!recordsListEl) return;
                        
                        if (querySnapshot.empty) {
                            recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æ—¥ç„¡æ‰“å¡ç´€éŒ„</p>`;
                            return;
                        }
                        
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // å‰ç«¯æ—¥æœŸéæ¿¾èˆ‡æ™‚é–“é™åºæ’åº
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startOfDay && ts <= endOfDay;
                        }).sort((a, b) => {
                            const timeA = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const timeB = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return timeB - timeA;
                        });
                        
                        recordsListEl.innerHTML = '';
                        filtered.forEach(record => {
                            const card = document.createElement('div');
                            card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
                            const statusText = getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null);
                            const statusColor = getStatusColor(statusText);
                            card.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                        <p class="text-sm text-gray-600">${formatDate(record.timestamp)}</p>
                                    </div>
                                </div>
                                <div class="mt-2 flex space-x-2 overflow-x-auto">
                                    <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> ç…§ç‰‡ (${(record.photoUrls?.length || 0)})
                                    </button>
                                    <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                        <i data-lucide="map-pin"></i> åœ°åœ–
                                    </button>
                                    <button class="apply-mod-btn bg-orange-500 text-white px-2 py-1 rounded text-sm"
                                        data-id="${record.id}"
                                        data-type="${record.type || ''}"
                                        data-ts="${(record.timestamp?.toMillis ? record.timestamp.toMillis() : (record.timestamp?.seconds ? record.timestamp.seconds * 1000 : (record.timestamp ? (new Date(record.timestamp)).getTime() : Date.now())))}"
                                        data-locationname="${record.locationName || ''}">
                                        <i data-lucide="edit"></i> ç”³è«‹ä¿®æ”¹
                                    </button>
                                </div>
                            `;
                            recordsListEl.appendChild(card);
                        });
                         
                        lucide.createIcons();
                        
                        document.querySelectorAll('.map-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const lat = parseFloat(e.currentTarget.dataset.lat);
                                const lng = parseFloat(e.currentTarget.dataset.lng);
                                if(lat && lng) openMapModal(lat, lng);
                                else showToast("ç„¡ä½ç½®è³‡è¨Šå¯é¡¯ç¤º", true);
                            });
                        });

                        // ç”³è«‹ä¿®æ”¹æŒ‰éˆ•äº‹ä»¶ï¼ˆæäº¤è‡³ retroClockRequestsï¼Œä½¿ç”¨ä¸­æ–‡æ¬„ä½ï¼‰
                        document.querySelectorAll('.apply-mod-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const d = e.currentTarget.dataset;
                                const tsMillis = parseInt(d.ts || '0', 10);
                                const ts = Number.isFinite(tsMillis) && tsMillis > 0 ? new Date(tsMillis) : new Date();
                                const recTypeRaw = d.type || '';
                                const recLocationName = d.locationname || '';
                                const typeMap = { clock_in: 'ä¸Šç­', clock_out: 'ä¸‹ç­', out: 'å¤–å‡º', arrive: 'æŠµé”', leave: 'é›¢é–‹', return: 'è¿”å›' };
                                const recType = typeMap[recTypeRaw] || recTypeRaw;
                                const backdrop = document.createElement('div');
                                backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                                const modal = document.createElement('div');
                                modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[92%] max-w-[560px]';
                                modal.innerHTML = `
                                    <h3 class="text-lg font-bold mb-3">ç”³è«‹ä¿®æ”¹æ‰“å¡è³‡æ–™</h3>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium">æ—¥æœŸ</label>
                                                <input type="date" id="mod-date" class="w-full border border-gray-300 rounded-md p-2" value="${ts.toISOString().split('T')[0]}" />
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium">æ™‚é–“</label>
                                                <input type="time" id="mod-time" class="w-full border border-gray-300 rounded-md p-2" value="${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}" />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium">é …ç›®</label>
                                            <select id="mod-type" class="w-full border border-gray-300 rounded-md p-2">
                                                <option value="ä¸Šç­" ${recType==='ä¸Šç­' ? 'selected' : ''}>ä¸Šç­</option>
                                                <option value="ä¸‹ç­" ${recType==='ä¸‹ç­' ? 'selected' : ''}>ä¸‹ç­</option>
                                                <option value="å¤–å‡º" ${recType==='å¤–å‡º' ? 'selected' : ''}>å¤–å‡º</option>
                                                <option value="æŠµé”" ${recType==='æŠµé”' ? 'selected' : ''}>æŠµé”</option>
                                                <option value="é›¢é–‹" ${recType==='é›¢é–‹' ? 'selected' : ''}>é›¢é–‹</option>
                                                <option value="è¿”å›" ${recType==='è¿”å›' ? 'selected' : ''}>è¿”å›</option>
                                            </select>
                                        </div>
                                        <div id="mod-extra" class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium">äº‹ç”±</label>
                                                <input type="text" id="mod-reason" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹è¼¸å…¥äº‹ç”±" />
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium">åœ°é»</label>
                                                <input type="text" id="mod-location" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹è¼¸å…¥åœ°é»" value="${recLocationName}" />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium">å‚™è¨»</label>
                                            <input type="text" id="mod-note" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹å¡«å¯«ç”³è«‹åŸå› /èªªæ˜" />
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-4">
                                        <button id="mod-cancel" class="px-3 py-2 border rounded-md">å–æ¶ˆ</button>
                                        <button id="mod-submit" class="px-3 py-2 bg-orange-600 text-white rounded-md">é€å‡ºå¯©æ ¸</button>
                                    </div>
                                `;
                                document.body.appendChild(backdrop);
                                document.body.appendChild(modal);
                                const typeSelect = modal.querySelector('#mod-type');
                                const reasonInput = modal.querySelector('#mod-reason');
                                const locInput = modal.querySelector('#mod-location');
                                const toggle = () => {
                                    const need = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(typeSelect.value);
                                    modal.querySelector('#mod-extra').style.display = need ? 'grid' : 'none';
                                };
                                typeSelect.addEventListener('change', toggle); toggle();
                                modal.querySelector('#mod-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                modal.querySelector('#mod-submit').addEventListener('click', async () => {
                                    try {
                                        const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                                        if (!user) { showToast('å°šæœªç™»å…¥', true); return; }
                                        const dateStr = modal.querySelector('#mod-date').value;
                                        const timeStr = modal.querySelector('#mod-time').value;
                                        const type = typeSelect.value;
                                        const reason = (reasonInput.value || '').trim();
                                        const locationName = (locInput.value || '').trim();
                                        if (!dateStr || !timeStr) { showToast('è«‹å¡«å¯«æ—¥æœŸèˆ‡æ™‚é–“', true); return; }
                                        if (['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) && (!reason || !locationName)) { showToast('å¤–å‡º/æŠµé”/é›¢é–‹éœ€å¡«å¯«äº‹ç”±èˆ‡åœ°é»', true); return; }
                                        const dt = new Date(`${dateStr}T${timeStr}:00`);
                                        const payload = {
                                            userId: user.uid,
                                            type,
                                            reason: reason || '',
                                            locationName: locationName || '',
                                            requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                                            targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                                            originalRecordId: d.id || null,
                                            status: 'pending'
                                        };
                                        await addDoc(collection(db, 'retroClockRequests'), payload);
                                        showToast('å·²é€å‡ºä¿®æ”¹ç”³è«‹');
                                        backdrop.remove(); modal.remove();
                                    } catch (err) {
                                        console.error('é€å‡ºç”³è«‹å¤±æ•—', err);
                                        showToast('é€å‡ºç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                                    }
                                });
                            });
                        });
                        
                        document.querySelectorAll('.photo-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                openPhotoModal(photos, descriptions);
                            });
                        });
                    }, (error) => {
                        console.error("Error fetching records: ", error);
                        const recordsListEl = document.getElementById('records-list');
                        if (recordsListEl) {
                            const hint = (error?.code === 'failed-precondition') ? 'å¯èƒ½éœ€è¦å»ºç«‹è¤‡åˆç´¢å¼•ï¼ˆuserId + timestampï¼‰ã€‚' : 'è«‹ç¢ºèª Firestore è¦å‰‡èˆ‡ç¶²è·¯ç‹€æ³ã€‚';
                            recordsListEl.innerHTML = `<div class="text-center text-red-500 p-4">è®€å–ç´€éŒ„å¤±æ•—ã€‚${hint}</div>`;
                        }
                    });

                    state.activeListeners.push(unsubscribe);
                };

                dateInput.addEventListener('change', loadRecords);
                if (!(window.__db && window.__fs && typeof window.__fs.onSnapshot === 'function')) {
                    const recordsListEl = document.getElementById('records-list');
                    if (recordsListEl) {
                        recordsListEl.innerHTML = `<div class="text-center p-4 text-gray-500">ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...</div>`;
                    }
                    window.addEventListener('firebase-ready', () => setTimeout(loadRecords, 0), { once: true });
                } else {
                    loadRecords();
                }

                // æœˆå ±è¡¨ï¼šé¸æ“‡æœˆä»½å½ˆçª—
                const monthBtn = document.getElementById('open-month-report');
                monthBtn?.addEventListener('click', () => openMonthReportModal());

                function openMonthReportModal() {
                    const now = new Date();
                    const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md overflow-hidden">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between">
                                <h3 class="font-semibold">é¸æ“‡æœˆä»½</h3>
                                <button class="close-month-modal">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="p-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">æœˆä»½</label>
                                    <input type="month" id="month-input" value="${ym}" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button class="close-month-modal px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button id="gen-month-report" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ç”Ÿæˆæœˆå ±è¡¨</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    try { lucide.createIcons(); } catch(e) {}
                    modal.querySelectorAll('.close-month-modal').forEach(btn => btn.addEventListener('click', () => document.body.removeChild(modal)));
                    document.getElementById('gen-month-report').addEventListener('click', async () => {
                        const mi = document.getElementById('month-input').value;
                        if (!mi) { showToast('è«‹é¸æ“‡æœˆä»½', true); return; }
                        document.body.removeChild(modal);
                        await generateMonthlyReport(mi);
                    });
                }

                async function generateMonthlyReport(ymStr) {
                    // ymStr: YYYY-MM
                    const [yearStr, monthStr] = ymStr.split('-');
                    const year = parseInt(yearStr, 10); const monthIndex = parseInt(monthStr, 10) - 1; // 0-based
                    const start = new Date(year, monthIndex, 1, 0, 0, 0, 0);
                    const end = new Date(year, monthIndex + 1, 0, 23, 59, 59, 999);

                    // è®€å–è©²æœˆæ‰“å¡ç´€éŒ„ï¼ˆæœ¬äººï¼‰
                    const { collection, where, query, getDocs, Timestamp } = window.__fs; const db = window.__db;
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex, 1)) : start;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex + 1, 0, 23, 59, 59, 999)) : end;
                    const q = query(
                        collection(db, 'clockInRecords'),
                        where('userId', '==', state.currentUser.uid),
                        where('timestamp', '>=', startTS),
                        where('timestamp', '<=', endTS)
                    );
                    const snap = await getDocs(q);
                    const allRecords = [];
                    snap.forEach(d => allRecords.push({ id: d.id, ...d.data() }));

                    // è«‹å‡è³‡æ–™ï¼ˆè¦†è“‹è©²æœˆä»»ä½•ä¸€å¤©ï¼‰
                    let leaves = [];
                    try {
                        const lq = query(collection(db, 'leaves'), where('userId','==', state.currentUser.uid));
                        const ls = await getDocs(lq);
                        ls.forEach(doc => leaves.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('è®€å–è«‹å‡å¤±æ•—', e); }

                    // ç‰¹æ®Šå‹¤å‹™ï¼ˆå€¼ç­ï¼‰è³‡æ–™
                    let duties = [];
                    try {
                        const dq = query(collection(db, 'specialDuties'), where('userId','==', state.currentUser.uid));
                        const ds = await getDocs(dq);
                        ds.forEach(doc => duties.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('è®€å–ç‰¹æ®Šå‹¤å‹™å¤±æ•—', e); }

                    // è®€å–é€±äº”å€¼ç­åå–®ï¼ˆè¨­å®šï¼‰ï¼Œç”¨æ–¼åˆ¤æ–·æœ¬äººçš„å€¼ç­æ—¥
                    let fridayDutyRoster = {};
                    try {
                        const { doc, getDoc } = window.__fs || {};
                        if (doc && getDoc && db) {
                            const settingsRef = doc(db, 'settings', 'general');
                            const settingsSnap = await getDoc(settingsRef);
                            fridayDutyRoster = settingsSnap.exists() ? (settingsSnap.data().fridayDutyRoster || {}) : {};
                        }
                    } catch (e) { console.warn('è®€å–å€¼ç­åå–®å¤±æ•—', e); }

                    // æº–å‚™åˆ—å°å®¹å™¨
                    const old = document.getElementById('monthly-report-container');
                    if (old) old.remove();
                    const container = document.createElement('div');
                    container.id = 'monthly-report-container';
                    container.className = 'fixed inset-0 z-50 bg-white';
                    const name = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                    const ymTag = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                    const titleText = `${ymTag}å‡ºå‹¤ç´€éŒ„-${name}`;
                    container.innerHTML = `
                        <div class="bg-white w-full h-full flex flex-col">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between shrink-0">
                                <h3 class="font-semibold">${titleText}</h3>
                                <div class="space-x-2">
                                    <button id="print-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">åˆ—å°</button>
                                    <button id="close-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">é—œé–‰</button>
                                </div>
                            </div>
                            <div class="p-4 flex-1 overflow-auto">
                                <div id="month-report-content" class="mx-auto" style="width:190mm">
                                    <div id="month-report-inner" style="transform-origin: top left;">
                                        <h2 class="text-xl font-bold mb-2 text-center">${titleText}</h2>
                                        <table class="w-full border border-gray-300 text-sm">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border px-2 py-1">æ—¥æœŸ</th>
                                                    <th class="border px-2 py-1">æ˜ŸæœŸå¹¾</th>
                                                    <th class="border px-2 py-1">ç•¶æ—¥ä¸Šç­ç‹€æ…‹+æ‰“å¡æ™‚é–“</th>
                                                    <th class="border px-2 py-1">ç•¶æ—¥ä¸‹ç­ç‹€æ…‹+æ‰“å¡æ™‚é–“</th>
                                                    <th class="border px-2 py-1">ç¸½æ™‚æ•¸</th>
                                                    <th class="border px-2 py-1">å¤–å‡ºæ¬¡æ•¸</th>
                                                    <th class="border px-2 py-1">å‡æ—¥/è«‹å‡æ—¥/å€¼ç­</th>
                                                </tr>
                                            </thead>
                                            <tbody id="month-report-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(container);

                    // å¡«å……è¡¨æ ¼
                    const weekdayZh = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    const bodyEl = container.querySelector('#month-report-body');
                    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dayStart = new Date(year, monthIndex, d, 0, 0, 0, 0);
                        const dayEnd = new Date(year, monthIndex, d, 23, 59, 59, 999);
                        const w = dayStart.getDay();
                        const dateLabel = `${year}-${String(monthIndex+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                        const records = allRecords.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= dayStart && ts <= dayEnd;
                        }).sort((a,b) => {
                            const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return ta - tb;
                        });

                        // ä¸Šç­ç‹€æ…‹/æ™‚é–“ï¼šå„ªå…ˆã€Œä¸Šç­ã€ï¼Œè‹¥ç„¡å‰‡å–ç¬¬ä¸€å€‹ã€Œå¤–å‡ºã€
                        let startRecord = records.find(r => (r.type === 'ä¸Šç­')) || records.find(r => (r.type === 'å¤–å‡º')) || null;
                        let endRecord = records.slice().reverse().find(r => (r.type === 'ä¸‹ç­')) || null;
                        const fmt = (dt) => dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
                        const startTime = startRecord ? (startRecord.timestamp?.toDate?.() || new Date(startRecord.timestamp)) : null;
                        const endTime = endRecord ? (endRecord.timestamp?.toDate?.() || new Date(endRecord.timestamp)) : null;
                        const startText = startRecord ? `${startRecord.type}${startTime ? ' '+fmt(startTime) : ''}` : '';
                        const endText = endRecord ? `${endRecord.type}${endTime ? ' '+fmt(endTime) : ''}` : '';

                        // ç¸½æ™‚æ•¸
                        let totalHours = '';
                        if (startTime && endTime && endTime > startTime) {
                            const diffMs = endTime - startTime;
                            totalHours = (diffMs / 3600000).toFixed(2);
                        }

                        // å¤–å‡ºæ¬¡æ•¸
                        const outboundCount = records.filter(r => r.type === 'å¤–å‡º').length;

                        // è®€å–ä½¿ç”¨è€…æœ¬æœˆä¸Šç­è¨­å®šä»¥åˆ¤æ–·å‡æ—¥ï¼ˆè‹¥ç‚ºå€¼ç­æ—¥å‰‡ä¸æ¨™ç¤ºå‡æ—¥ï¼‰
                        let indicators = [];
                        try {
                            const ymId = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                            const { doc, getDoc } = window.__fs || {};
                            const db = window.__db;
                            if (doc && getDoc && db) {
                                const ref = doc(db, 'users', state.currentUser.uid, 'workdays', ymId);
                                const snap = await getDoc(ref);
                                const days = snap.exists() ? (snap.data().days || []) : [];
                                const set = new Set(days.map(n => Number(n)));
                                // å€¼ç­åˆ¤å®šï¼ˆç‰¹æ®Šå‹¤å‹™æˆ–åœ¨é€±äº”å€¼ç­åå–®å…§ï¼‰
                                const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                const isDutyBySpecial = duties.some(di => {
                                    const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                    const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                    if (!s || !e) return false;
                                    return s < nextDay && e > dayStart;
                                });
                                const myUid = state.currentUser.uid;
                                const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                                const arr = fridayDutyRoster[dateLabel] || [];
                                const normalize = (s) => (s || '').trim();
                                const isRosterDuty = Array.isArray(arr) && (arr.includes(myUid) || arr.some(n => normalize(n) === normalize(myName)));
                                const isDuty = isDutyBySpecial || isRosterDuty;
                                // éå€¼ç­ä¸”ä¸åœ¨ä½¿ç”¨è€…è‡ªè¨‚å·¥ä½œæ—¥ï¼Œä¸”æ²’æœ‰æ‰“å¡ç´€éŒ„ï¼Œæ‰æ¨™ç¤ºå‡æ—¥
                                if (!isDuty && !set.has(d) && records.length === 0) indicators.push('å‡æ—¥');
                            } else {
                                // å¾Œå‚™åˆ¤æ–·ï¼šé€±æœ«ç‚ºå‡æ—¥
                                // è‹¥ç‚ºå€¼ç­å‰‡ä¸æ¨™ç¤ºå‡æ—¥
                                const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                const isDutyBySpecial = duties.some(di => {
                                    const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                    const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                    if (!s || !e) return false;
                                    return s < nextDay && e > dayStart;
                                });
                                const myUid = state.currentUser.uid;
                                const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                                const arr = fridayDutyRoster[dateLabel] || [];
                                const normalize = (s) => (s || '').trim();
                                const isRosterDuty = Array.isArray(arr) && (arr.includes(myUid) || arr.some(n => normalize(n) === normalize(myName)));
                                const isDuty = isDutyBySpecial || isRosterDuty;
                                if (!isDuty && (w === 6 || w === 0) && records.length === 0) indicators.push('å‡æ—¥');
                            }
                        } catch(e) {
                            // è®€å–å¤±æ•—ï¼Œç¶­æŒé€±æœ«ç‚ºå‡æ—¥ï¼Œä½†ä»å˜—è©¦ä»¥ UID/å§“ååˆ¤æ–·å€¼ç­
                            const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                            const isDutyBySpecial = duties.some(di => {
                                const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay && e > dayStart;
                            });
                            const myUid = state.currentUser?.uid;
                            const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                            const arr = fridayDutyRoster[dateLabel] || [];
                            const normalize = (s) => (s || '').trim();
                            const isRosterDuty = Array.isArray(arr) && ((myUid && arr.includes(myUid)) || arr.some(n => normalize(n) === normalize(myName)));
                            const isDuty = isDutyBySpecial || isRosterDuty;
                            if (!isDuty && (w === 6 || w === 0) && records.length === 0) indicators.push('å‡æ—¥');
                        }
                        // è«‹å‡æ—¥ï¼ˆæ™‚é–“ç¯„åœç›¸äº¤ï¼‰
                        const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                        const isLeave = leaves.some(l => {
                            const s = l.startTime?.toDate?.() || (l.startTime ? new Date(l.startTime) : null);
                            const e = l.endTime?.toDate?.() || (l.endTime ? new Date(l.endTime) : null);
                            if (!s || !e) return false;
                            return s < nextDay && e > dayStart; // overlap
                        });
                        if (isLeave) indicators.push('è«‹å‡æ—¥');
                        // å€¼ç­ï¼ˆæœ‰ç•¶æ—¥ç‰¹æ®Šå‹¤å‹™ï¼‰
                        const isDutyBySpecial = duties.some(di => {
                            const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                            const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                            if (!s || !e) return false;
                            return s < nextDay && e > dayStart; // overlap
                        });
                            const myUid = state.currentUser.uid;
                            const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                            const rosterNames = fridayDutyRoster[dateLabel] || [];
                            const normalizeName = (s) => (s || '').trim();
                            const isRosterDuty = Array.isArray(rosterNames) && (rosterNames.includes(myUid) || rosterNames.some(n => normalizeName(n) === normalizeName(myName)));
                        const isDutyFinal = isDutyBySpecial || isRosterDuty;
                        if (isDutyFinal) indicators.push('å€¼ç­');

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="border px-2 py-1">${dateLabel}</td>
                            <td class="border px-2 py-1">${weekdayZh[w]}</td>
                            <td class="border px-2 py-1">${startText}</td>
                            <td class="border px-2 py-1">${endText}</td>
                            <td class="border px-2 py-1">${totalHours}</td>
                            <td class="border px-2 py-1 text-center">${outboundCount}</td>
                            <td class="border px-2 py-1">${indicators.join('ã€')}</td>`;
                        bodyEl.appendChild(tr);
                    }

                    // æ³¨å…¥åˆ—å°æ¨£å¼ï¼ˆA4ã€é ä¸Šå°é½Šã€æ°´å¹³ç½®ä¸­ï¼Œåƒ…é¡¯ç¤ºå ±è¡¨å…§å®¹ï¼‰
                    if (!document.getElementById('monthly-report-print-style')) {
                        const style = document.createElement('style');
                        style.id = 'monthly-report-print-style';
                        style.textContent = `
                        @page { size: A4; margin: 10mm; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            body > * { display: none !important; }
                            #monthly-report-container { display: block !important; position: static !important; }
                            #monthly-report-container > div { display: block !important; height: auto !important; }
                            #monthly-report-container .px-4.py-3.bg-indigo-600 { display: none !important; }
                            #monthly-report-container .p-4.flex-1 { padding: 0 !important; }
                            #month-report-content { width: 190mm !important; margin: 0 auto 0 auto !important; }
                            #month-report-inner { margin-top: 0 !important; }
                            table { border-collapse: collapse; }
                            th, td { font-size: 11px; line-height: 1.2; padding: 2px 4px; }
                        }
                        `;
                        document.head.appendChild(style);
                    }

                    container.querySelector('#close-month-report').addEventListener('click', () => container.remove());
                    container.querySelector('#print-month-report').addEventListener('click', () => {
                        window.print();
                    });
                    // å·²å–æ¶ˆ PDF åŒ¯å‡ºåŠŸèƒ½
                }

                // å…±äº«ï¼šä»¥æŒ‡å®šä½¿ç”¨è€…èˆ‡æœˆä»½ç”Ÿæˆã€Œå€‹äººæœˆå ±è¡¨ã€çš„è¦†è“‹è¦–çª—ï¼ˆèˆ‡å€‹äººæ‰“å¡ç´€éŒ„æœˆå ±è¡¨ç›¸åŒæ–¹å¼ï¼‰
                window.renderPersonalMonthlyReport = async function(userId, userName, ymStr) {
                    try {
                        const { collection, where, query, getDocs, Timestamp, doc, getDoc } = window.__fs || {};
                        const db = window.__db;
                        if (!db || !collection || !query || !getDocs) {
                            console.error('Firestore æœªåˆå§‹åŒ–');
                            showToast && showToast('ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œé‡è©¦', true);
                            return;
                        }
                        const [yearStr, monthStr] = ymStr.split('-');
                        const year = parseInt(yearStr, 10);
                        const monthIndex = parseInt(monthStr, 10) - 1; // 0-based

                        const startTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex, 1)) : new Date(year, monthIndex, 1);
                        const endTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex + 1, 0, 23, 59, 59, 999)) : new Date(year, monthIndex + 1, 0, 23, 59, 59, 999);

                        // è©²ä½¿ç”¨è€…è©²æœˆçš„æ‰“å¡ç´€éŒ„
                        const q = query(
                            collection(db, 'clockInRecords'),
                            where('userId', '==', userId),
                            where('timestamp', '>=', startTS),
                            where('timestamp', '<=', endTS)
                        );
                        const snap = await getDocs(q);
                        const allRecords = [];
                        snap.forEach(d => allRecords.push({ id: d.id, ...d.data() }));

                        // è«‹å‡è³‡æ–™ï¼ˆè¦†è“‹è©²æœˆä»»ä½•ä¸€å¤©ï¼‰
                        let leaves = [];
                        try {
                            const lq = query(collection(db, 'leaves'), where('userId','==', userId));
                            const ls = await getDocs(lq);
                            ls.forEach(docu => leaves.push({ id: docu.id, ...docu.data() }));
                        } catch(e) { console.warn('è®€å–è«‹å‡å¤±æ•—', e); }

                        // ç‰¹æ®Šå‹¤å‹™ï¼ˆå€¼ç­ï¼‰è³‡æ–™
                        let duties = [];
                        try {
                            const dq = query(collection(db, 'specialDuties'), where('userId','==', userId));
                            const ds = await getDocs(dq);
                            ds.forEach(docu => duties.push({ id: docu.id, ...docu.data() }));
                        } catch(e) { console.warn('è®€å–ç‰¹æ®Šå‹¤å‹™å¤±æ•—', e); }

                        // é€±äº”å€¼ç­åå–®
                        let fridayDutyRoster = {};
                        try {
                            if (doc && getDoc && db) {
                                const settingsRef = doc(db, 'settings', 'general');
                                const settingsSnap = await getDoc(settingsRef);
                                fridayDutyRoster = settingsSnap.exists() ? (settingsSnap.data().fridayDutyRoster || {}) : {};
                            }
                        } catch (e) { console.warn('è®€å–å€¼ç­åå–®å¤±æ•—', e); }

                        // æº–å‚™è¦†è“‹è¦–çª—
                        const old = document.getElementById('monthly-report-container');
                        if (old) old.remove();
                        const container = document.createElement('div');
                        container.id = 'monthly-report-container';
                        container.className = 'fixed inset-0 z-50 bg-white';
                        const ymTag = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                        const titleText = `${ymTag}å‡ºå‹¤ç´€éŒ„-${userName || ''}`;
                        container.innerHTML = `
                            <div class="bg-white w-full h-full flex flex-col">
                                <div class="px-4 py-3 bg-indigo-600 text-white flex itemsä¸­å¿ƒ justify-between shrink-0">
                                    <h3 class="font-semibold">${titleText}</h3>
                                    <div class="space-x-2">
                                        <button id="print-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">åˆ—å°</button>
                                        <button id="close-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">é—œé–‰</button>
                                    </div>
                                </div>
                                <div class="p-4 flex-1 overflow-auto">
                                    <div id="month-report-content" class="mx-auto" style="width:190mm">
                                        <div id="month-report-inner" style="transform-origin: top left;">
                                            <h2 class="text-xl font-bold mb-2 text-center">${titleText}</h2>
                                            <table class="w-full border border-gray-300 text-sm">
                                                <thead>
                                                    <tr class="bg-gray-100">
                                                        <th class="border px-2 py-1">æ—¥æœŸ</th>
                                                        <th class="border px-2 py-1">æ˜ŸæœŸå¹¾</th>
                                                        <th class="border px-2 py-1">ç•¶æ—¥ä¸Šç­ç‹€æ…‹+æ‰“å¡æ™‚é–“</th>
                                                        <th class="border px-2 py-1">ç•¶æ—¥ä¸‹ç­ç‹€æ…‹+æ‰“å¡æ™‚é–“</th>
                                                        <th class="border px-2 py-1">ç¸½æ™‚æ•¸</th>
                                                        <th class="border px-2 py-1">å¤–å‡ºæ¬¡æ•¸</th>
                                                        <th class="border px-2 py-1">å‡æ—¥/è«‹å‡æ—¥/å€¼ç­</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="month-report-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        document.body.appendChild(container);

                        // å¡«å……è¡¨æ ¼
                        const weekdayZh = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                        const bodyEl = container.querySelector('#month-report-body');
                        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                        for (let d = 1; d <= daysInMonth; d++) {
                            const dayStart = new Date(year, monthIndex, d, 0, 0, 0, 0);
                            const dayEnd = new Date(year, monthIndex, d, 23, 59, 59, 999);
                            const w = dayStart.getDay();
                            const dateLabel = `${year}-${String(monthIndex+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                            const records = allRecords.filter(r => {
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                                if (!ts) return false;
                                return ts >= dayStart && ts <= dayEnd;
                            }).sort((a,b) => {
                                const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                                const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                                return ta - tb;
                            });

                            let startRecord = records.find(r => (r.type === 'ä¸Šç­')) || records.find(r => (r.type === 'å¤–å‡º')) || null;
                            let endRecord = records.slice().reverse().find(r => (r.type === 'ä¸‹ç­')) || null;
                            const fmt = (dt) => dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
                            const startTime = startRecord ? (startRecord.timestamp?.toDate?.() || new Date(startRecord.timestamp)) : null;
                            const endTime = endRecord ? (endRecord.timestamp?.toDate?.() || new Date(endRecord.timestamp)) : null;
                            const startText = startRecord ? `${startRecord.type}${startTime ? ' '+fmt(startTime) : ''}` : '';
                            const endText = endRecord ? `${endRecord.type}${endTime ? ' '+fmt(endTime) : ''}` : '';

                            let totalHours = '';
                            if (startTime && endTime && endTime > startTime) {
                                const diffMs = endTime - startTime;
                                totalHours = (diffMs / 3600000).toFixed(2);
                            }

                            const outboundCount = records.filter(r => r.type === 'å¤–å‡º').length;

                            let indicators = [];
                            try {
                                const ymId = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                                if (doc && getDoc && db) {
                                    const ref = doc(db, 'users', userId, 'workdays', ymId);
                                    const snap2 = await getDoc(ref);
                                    const days = snap2.exists() ? (snap2.data().days || []) : [];
                                    const set = new Set(days.map(n => Number(n)));
                                    const hasWorkdayConfig = Array.isArray(days) && days.length > 0;
                                    const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                    const isDutyBySpecial = duties.some(di => {
                                        const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                        const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                        if (!s || !e) return false;
                                        return s < nextDay && e > dayStart;
                                    });
                                    const arr = fridayDutyRoster[dateLabel] || [];
                                    const normalize = (s) => (s || '').trim();
                                    const isRosterDuty = Array.isArray(arr) && (arr.includes(userId) || arr.some(n => normalize(n) === normalize(userName || '')));
                                    const isDuty = isDutyBySpecial || isRosterDuty;
                                    if (!isDuty && records.length === 0) {
                                        if (hasWorkdayConfig) {
                                            if (!set.has(d)) indicators.push('å‡æ—¥');
                                        } else {
                                            if (w === 6 || w === 0) indicators.push('å‡æ—¥');
                                        }
                                    }
                                } else {
                                    const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                    const isDutyBySpecial = duties.some(di => {
                                        const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                        const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                        if (!s || !e) return false;
                                        return s < nextDay && e > dayStart;
                                    });
                                    const arr = fridayDutyRoster[dateLabel] || [];
                                    const normalize = (s) => (s || '').trim();
                                    const isRosterDuty = Array.isArray(arr) && (arr.includes(userId) || arr.some(n => normalize(n) === normalize(userName || '')));
                                    const isDuty = isDutyBySpecial || isRosterDuty;
                                    if (!isDuty && (w === 6 || w === 0) && records.length === 0) indicators.push('å‡æ—¥');
                                }
                            } catch(e) {
                                const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                const isDutyBySpecial = duties.some(di => {
                                    const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                    const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                    if (!s || !e) return false;
                                    return s < nextDay && e > dayStart;
                                });
                                const arr = fridayDutyRoster[dateLabel] || [];
                                const normalize = (s) => (s || '').trim();
                                const isRosterDuty = Array.isArray(arr) && (arr.includes(userId) || arr.some(n => normalize(n) === normalize(userName || '')));
                                const isDuty = isDutyBySpecial || isRosterDuty;
                                if (!isDuty && (w === 6 || w === 0) && records.length === 0) indicators.push('å‡æ—¥');
                            }
                            const nextDay2 = new Date(dayStart); nextDay2.setDate(nextDay2.getDate()+1);
                            const isLeave = leaves.some(l => {
                                const s = l.startTime?.toDate?.() || (l.startTime ? new Date(l.startTime) : null);
                                const e = l.endTime?.toDate?.() || (l.endTime ? new Date(l.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay2 && e > dayStart;
                            });
                            if (isLeave) indicators.push('è«‹å‡æ—¥');
                            const isDutyBySpecial2 = duties.some(di => {
                                const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay2 && e > dayStart;
                            });
                            const arr2 = fridayDutyRoster[dateLabel] || [];
                            const normalize2 = (s) => (s || '').trim();
                            const isRosterDuty2 = Array.isArray(arr2) && (arr2.includes(userId) || arr2.some(n => normalize2(n) === normalize2(userName || '')));
                            const isDuty2 = isDutyBySpecial2 || isRosterDuty2;
                            if (isDuty2) indicators.push('å€¼ç­');

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="border px-2 py-1">${dateLabel}</td>
                                <td class="border px-2 py-1">${weekdayZh[w]}</td>
                                <td class="border px-2 py-1">${startText}</td>
                                <td class="border px-2 py-1">${endText}</td>
                                <td class="border px-2 py-1">${totalHours}</td>
                                <td class="border px-2 py-1 text-center">${outboundCount}</td>
                                <td class="border px-2 py-1">${indicators.join('ã€')}</td>`;
                            bodyEl.appendChild(tr);
                        }

                        // åˆ—å°æ¨£å¼
                        if (!document.getElementById('monthly-report-print-style')) {
                            const style = document.createElement('style');
                            style.id = 'monthly-report-print-style';
                            style.textContent = `
                            @page { size: A4; margin: 10mm; }
                            @media print {
                                body { -webkit-print-color-adjust: exact; }
                                body > * { display: none !important; }
                                #monthly-report-container { display: block !important; position: static !important; }
                                #monthly-report-container > div { display: block !important; height: auto !important; }
                                #monthly-report-container .px-4.py-3.bg-indigo-600 { display: none !important; }
                                #monthly-report-container .p-4.flex-1 { padding: 0 !important; }
                                #month-report-content { width: 190mm !important; margin: 0 auto 0 auto !important; }
                                #month-report-inner { margin-top: 0 !important; }
                                table { border-collapse: collapse; }
                                th, td { font-size: 11px; line-height: 1.2; padding: 2px 4px; }
                            }
                            `;
                            document.head.appendChild(style);
                        }

                        container.querySelector('#close-month-report').addEventListener('click', () => container.remove());
                        container.querySelector('#print-month-report').addEventListener('click', () => { window.print(); });
                    } catch (err) {
                        console.error('renderPersonalMonthlyReport å¤±æ•—', err);
                        showToast && showToast('ç”Ÿæˆå€‹äººæœˆå ±è¡¨å¤±æ•—', true);
                    }
                }
            }

            // å…±äº«ï¼šä»¥æŒ‡å®šæœˆä»½ç”Ÿæˆã€Œå…¨å“¡æœˆå ±è¡¨ã€çš„è¦†è“‹è¦–çª—ï¼ˆèˆ‡å€‹äººæ‰“å¡ç´€éŒ„æœˆå ±è¡¨ç›¸åŒè¡¨æ ¼ï¼Œé€äººé¡¯ç¤ºï¼‰
            window.renderAllMonthlyReports = async function(ymStr) {
                try {
                    const { collection, where, query, getDocs, Timestamp, doc, getDoc } = window.__fs || {};
                    const db = window.__db;
                    if (!db || !collection || !query || !getDocs) {
                        console.error('Firestore æœªåˆå§‹åŒ–');
                        showToast && showToast('ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œé‡è©¦', true);
                        return;
                    }
                    const [yearStr, monthStr] = ymStr.split('-');
                    const year = parseInt(yearStr, 10);
                    const monthIndex = parseInt(monthStr, 10) - 1;
                    const ymTag = `${year}-${String(monthIndex+1).padStart(2,'0')}`;

                    // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…ï¼ˆå„ªå…ˆ Firestoreï¼Œå›é€€å¿«å–ï¼‰
                    let users = [];
                    try {
                        const us = await getDocs(collection(db, 'users'));
                        us.forEach(d => users.push({ id: d.id, ...d.data() }));
                    } catch (e) {
                        console.warn('è®€å– users å¤±æ•—ï¼Œæ”¹ç”¨å¿«å–', e);
                        try {
                            if (typeof window.fetchUsersOnce === 'function') {
                                const cached = await window.fetchUsersOnce();
                                users = Array.isArray(cached) ? cached : [];
                            }
                        } catch (e2) { console.warn('å¿«å– users å¤±æ•—', e2); }
                    }
                    // å»é‡èˆ‡æ’åº
                    const map = new Map();
                    users.forEach(u => { if (!map.has(u.id)) map.set(u.id, u); });
                    users = Array.from(map.values()).sort((a,b) => (a.name || '').localeCompare(b.name || '', 'zh-Hant'));
                    if (!users.length) {
                        showToast && showToast('æ²’æœ‰ä½¿ç”¨è€…å¯ç”Ÿæˆæœˆå ±è¡¨', true);
                        return;
                    }

                    // æº–å‚™è¦†è“‹è¦–çª—
                    const old = document.getElementById('monthly-all-report-container');
                    if (old) old.remove();
                    const container = document.createElement('div');
                    container.id = 'monthly-all-report-container';
                    container.className = 'fixed inset-0 z-50 bg-white';
                    const titleText = `${ymTag}å‡ºå‹¤ç´€éŒ„-å…¨éƒ¨å¸³è™Ÿ`;
                    container.innerHTML = `
                        <div class="bg-white w-full h-full flex flex-col">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between shrink-0">
                                <h3 class="font-semibold">${titleText}</h3>
                                <div class="space-x-2">
                                    <button id="print-all-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">åˆ—å°</button>
                                    <button id="close-all-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">é—œé–‰</button>
                                </div>
                            </div>
                            <div class="p-4 flex-1 overflow-auto">
                                <div id="month-all-report-content" class="mx-auto space-y-6" style="max-width: 200mm">
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(container);

                    const contentEl = container.querySelector('#month-all-report-content');
                    const exportRows = [];
                    const exportSheets = [];

                    // é€±äº”å€¼ç­åå–®ï¼ˆä¸€æ¬¡è®€å–ï¼‰
                    let fridayDutyRoster = {};
                    try {
                        if (doc && getDoc && db) {
                            const settingsRef = doc(db, 'settings', 'general');
                            const settingsSnap = await getDoc(settingsRef);
                            fridayDutyRoster = settingsSnap.exists() ? (settingsSnap.data().fridayDutyRoster || {}) : {};
                        }
                    } catch (e) { console.warn('è®€å–å€¼ç­åå–®å¤±æ•—', e); }

                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex, 1)) : new Date(year, monthIndex, 1);
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex + 1, 0, 23, 59, 59, 999)) : new Date(year, monthIndex + 1, 0, 23, 59, 59, 999);

                    const weekdayZh = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

                    // é€äººç”Ÿæˆè¡¨æ ¼
                    for (const user of users) {
                        const userId = user.id;
                        const userName = user.name || userId;

                        // è©²ä½¿ç”¨è€…è©²æœˆçš„æ‰“å¡ç´€éŒ„
                        let allRecords = [];
                        try {
                            const q = query(
                                collection(db, 'clockInRecords'),
                                where('userId', '==', userId),
                                where('timestamp', '>=', startTS),
                                where('timestamp', '<=', endTS)
                            );
                            const snap = await getDocs(q);
                            snap.forEach(d => allRecords.push({ id: d.id, ...d.data() }));
                        } catch (e) { console.warn('è®€å–æ‰“å¡å¤±æ•—', e); }

                        // è©²ä½¿ç”¨è€…è«‹å‡
                        let leaves = [];
                        try {
                            const lq = query(collection(db, 'leaves'), where('userId','==', userId));
                            const ls = await getDocs(lq);
                            ls.forEach(docu => leaves.push({ id: docu.id, ...docu.data() }));
                        } catch(e) { /* ignore */ }

                        // è©²ä½¿ç”¨è€…ç‰¹æ®Šå‹¤å‹™
                        let duties = [];
                        try {
                            const dq = query(collection(db, 'specialDuties'), where('userId','==', userId));
                            const ds = await getDocs(dq);
                            ds.forEach(docu => duties.push({ id: docu.id, ...docu.data() }));
                        } catch(e) { /* ignore */ }

                        const section = document.createElement('div');
                        section.className = 'all-month-person mb-6';
                        section.innerHTML = `
                            <div>
                                <h2 class="text-lg font-bold mb-2 text-center">${ymTag}å‡ºå‹¤ç´€éŒ„-${userName}</h2>
                                <table class="w-full border border-gray-300 text-sm">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border px-2 py-1">æ—¥æœŸ</th>
                                            <th class="border px-2 py-1">æ˜ŸæœŸå¹¾</th>
                                            <th class="border px-2 py-1">ç•¶æ—¥ä¸Šç­ç‹€æ…‹+æ‰“å¡æ™‚é–“</th>
                                            <th class="border px-2 py-1">ç•¶æ—¥ä¸‹ç­ç‹€æ…‹+æ‰“å¡æ™‚é–“</th>
                                            <th class="border px-2 py-1">ç¸½æ™‚æ•¸</th>
                                            <th class="border px-2 py-1">å¤–å‡ºæ¬¡æ•¸</th>
                                            <th class="border px-2 py-1">å‡æ—¥/è«‹å‡æ—¥/å€¼ç­</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>`;
                        const tbody = section.querySelector('tbody');
                        const personRows = [];

                        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                        for (let d = 1; d <= daysInMonth; d++) {
                            const dayStart = new Date(year, monthIndex, d, 0, 0, 0, 0);
                            const dayEnd = new Date(year, monthIndex, d, 23, 59, 59, 999);
                            const w = dayStart.getDay();
                            const dateLabel = `${year}-${String(monthIndex+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                            const records = allRecords.filter(r => {
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                                if (!ts) return false;
                                return ts >= dayStart && ts <= dayEnd;
                            }).sort((a,b) => {
                                const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                                const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                                return ta - tb;
                            });

                            let startRecord = records.find(r => (r.type === 'ä¸Šç­')) || records.find(r => (r.type === 'å¤–å‡º')) || null;
                            let endRecord = records.slice().reverse().find(r => (r.type === 'ä¸‹ç­')) || null;
                            const fmt = (dt) => dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
                            const startTime = startRecord ? (startRecord.timestamp?.toDate?.() || new Date(startRecord.timestamp)) : null;
                            const endTime = endRecord ? (endRecord.timestamp?.toDate?.() || new Date(endRecord.timestamp)) : null;
                            const startText = startRecord ? `${startRecord.type}${startTime ? ' '+fmt(startTime) : ''}` : '';
                            const endText = endRecord ? `${endRecord.type}${endTime ? ' '+fmt(endTime) : ''}` : '';

                            let totalHours = '';
                            if (startTime && endTime && endTime > startTime) {
                                const diffMs = endTime - startTime;
                                totalHours = (diffMs / 3600000).toFixed(2);
                            }

                            const outboundCount = records.filter(r => r.type === 'å¤–å‡º').length;

                            let indicators = [];
                            try {
                                const ymId = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                                if (doc && getDoc && db) {
                                    const ref = doc(db, 'users', userId, 'workdays', ymId);
                                    const snap2 = await getDoc(ref);
                                    const days = snap2.exists() ? (snap2.data().days || []) : [];
                                    const set = new Set(days.map(n => Number(n)));
                                    const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                    const isDutyBySpecial = duties.some(di => {
                                        const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                        const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                        if (!s || !e) return false;
                                        return s < nextDay && e > dayStart;
                                    });
                                    const arr = fridayDutyRoster[dateLabel] || [];
                                    const normalize = (s) => (s || '').trim();
                                    const isRosterDuty = Array.isArray(arr) && (arr.includes(userId) || arr.some(n => normalize(n) === normalize(userName || '')));
                                    const isDuty = isDutyBySpecial || isRosterDuty;
                                    if (!isDuty && records.length === 0) {
                                        if (hasWorkdayConfig) {
                                            if (!set.has(d)) indicators.push('å‡æ—¥');
                                        } else {
                                            if (w === 6 || w === 0) indicators.push('å‡æ—¥');
                                        }
                                    }
                                } else {
                                    const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                    const isDutyBySpecial = duties.some(di => {
                                        const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                        const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                        if (!s || !e) return false;
                                        return s < nextDay && e > dayStart;
                                    });
                                    const arr = fridayDutyRoster[dateLabel] || [];
                                    const normalize = (s) => (s || '').trim();
                                    const isRosterDuty = Array.isArray(arr) && (arr.includes(userId) || arr.some(n => normalize(n) === normalize(userName || '')));
                                    const isDuty = isDutyBySpecial || isRosterDuty;
                                    if (!isDuty && (w === 6 || w === 0)) indicators.push('å‡æ—¥');
                                }
                            } catch(e) {
                                const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                                const isDutyBySpecial = duties.some(di => {
                                    const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                    const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                    if (!s || !e) return false;
                                    return s < nextDay && e > dayStart;
                                });
                                const arr = fridayDutyRoster[dateLabel] || [];
                                const normalize = (s) => (s || '').trim();
                                const isRosterDuty = Array.isArray(arr) && (arr.includes(userId) || arr.some(n => normalize(n) === normalize(userName || '')));
                                const isDuty = isDutyBySpecial || isRosterDuty;
                                if (!isDuty && (w === 6 || w === 0)) indicators.push('å‡æ—¥');
                            }
                            const nextDay2 = new Date(dayStart); nextDay2.setDate(nextDay2.getDate()+1);
                            const isLeave = leaves.some(l => {
                                const s = l.startTime?.toDate?.() || (l.startTime ? new Date(l.startTime) : null);
                                const e = l.endTime?.toDate?.() || (l.endTime ? new Date(l.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay2 && e > dayStart;
                            });
                            if (isLeave) indicators.push('è«‹å‡æ—¥');
                            const isDutyBySpecial2 = duties.some(di => {
                                const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay2 && e > dayStart;
                            });
                            const arr2 = fridayDutyRoster[dateLabel] || [];
                            const normalize2 = (s) => (s || '').trim();
                            const isRosterDuty2 = Array.isArray(arr2) && (arr2.includes(userId) || arr2.some(n => normalize2(n) === normalize2(userName || '')));
                            const isDuty2 = isDutyBySpecial2 || isRosterDuty2;
                            if (isDuty2) indicators.push('å€¼ç­');

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="border px-2 py-1">${dateLabel}</td>
                                <td class="border px-2 py-1">${weekdayZh[w]}</td>
                                <td class="border px-2 py-1">${startText}</td>
                                <td class="border px-2 py-1">${endText}</td>
                                <td class="border px-2 py-1">${totalHours}</td>
                                <td class="border px-2 py-1 text-center">${outboundCount}</td>
                                <td class="border px-2 py-1">${indicators.join('ã€')}</td>`;
                            tbody.appendChild(tr);

                            // åŒ¯å‡ºè³‡æ–™åˆ—ï¼ˆå½™ç¸½ CSV ç”¨ï¼‰
                            exportRows.push([
                                userName,
                                dateLabel,
                                weekdayZh[w],
                                startText,
                                endText,
                                totalHours,
                                outboundCount,
                                indicators.join('ã€')
                            ]);

                            // åŒ¯å‡ºè³‡æ–™åˆ—ï¼ˆæ¯äººå·¥ä½œè¡¨ç”¨ï¼‰
                            personRows.push([
                                dateLabel,
                                weekdayZh[w],
                                startText,
                                endText,
                                totalHours,
                                outboundCount,
                                indicators.join('ã€')
                            ]);
                        }

                        // ç”Ÿæˆæ¯äººä¸€å€‹å·¥ä½œè¡¨çš„ AOA
                        const rawName = String(userName || userId);
                        const safeName = rawName.replace(/[\\\/?*\[\]:]/g, ' ').slice(0, 31) || 'å·¥ä½œè¡¨';
                        exportSheets.push({
                            name: safeName,
                            aoa: [
                                ['ä½¿ç”¨è€…', userName],
                                ['æœˆä»½', ymTag],
                                ['æ—¥æœŸ','æ˜ŸæœŸ','ä¸Šç­','ä¸‹ç­','ç¸½æ™‚æ•¸','å¤–å‡ºæ¬¡æ•¸','æŒ‡æ¨™'],
                                ...personRows
                            ]
                        });

                        contentEl.appendChild(section);
                    }

                    // åˆ—å°æ¨£å¼ï¼ˆè¦†è“‹å…¨å“¡å®¹å™¨ï¼‰
                    if (!document.getElementById('monthly-all-report-print-style')) {
                        const style = document.createElement('style');
                        style.id = 'monthly-all-report-print-style';
                        style.textContent = `
                        @page { size: A4 portrait; margin: 10mm; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            body > * { display: none !important; }
                            #monthly-all-report-container { display: block !important; position: static !important; }
                            #monthly-all-report-container > div { display: block !important; height: auto !important; }
                            #monthly-all-report-container .px-4.py-3.bg-indigo-600 { display: none !important; }
                            #monthly-all-report-container .p-4.flex-1 { padding: 0 !important; }
                            #month-all-report-content { width: 190mm !important; margin: 0 auto 0 auto !important; }
                            #month-all-report-content > .all-month-person { break-after: page; page-break-after: always; }
                            #month-all-report-content > .all-month-person:last-child { break-after: auto; page-break-after: auto; }
                            table { border-collapse: collapse; }
                            th, td { font-size: 11px; line-height: 1.2; padding: 2px 4px; }
                        }
                        `;
                        document.head.appendChild(style);
                    }

                    container.querySelector('#close-all-month-report').addEventListener('click', () => container.remove());
                    container.querySelector('#print-all-month-report').addEventListener('click', () => { window.print(); });

                    // åŒ¯å‡º Excel/CSV åŠŸèƒ½
                    const exportBtn = container.querySelector('#export-all-month-report');
                    if (!exportBtn) {
                        const headerActions = container.querySelector('.px-4.py-3.bg-indigo-600 .space-x-2');
                        if (headerActions) {
                            const btn = document.createElement('button');
                            btn.id = 'export-all-month-report';
                            btn.className = 'px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100';
                            btn.textContent = 'åŒ¯å‡ºExcel';
                            headerActions.insertBefore(btn, headerActions.querySelector('#close-all-month-report'));
                        }
                    }
                    container.querySelector('#export-all-month-report')?.addEventListener('click', () => {
                        try {
                            const XLSX = window.XLSX;
                            if (XLSX && XLSX.utils && XLSX.writeFile) {
                                // ä»¥æ¯äººä¸€å€‹å·¥ä½œè¡¨è¼¸å‡º .xlsx
                                const wb = XLSX.utils.book_new();
                                for (const sheet of exportSheets) {
                                    const ws = XLSX.utils.aoa_to_sheet(sheet.aoa);
                                    XLSX.utils.book_append_sheet(wb, ws, sheet.name);
                                }
                                XLSX.writeFile(wb, `å…¨å“¡æœˆå ±è¡¨_${ymTag}.xlsx`);
                            } else {
                                const header = 'ä½¿ç”¨è€…,æ—¥æœŸ,æ˜ŸæœŸ,ä¸Šç­,ä¸‹ç­,ç¸½æ™‚æ•¸,å¤–å‡ºæ¬¡æ•¸,æŒ‡æ¨™';
                                const csv = [header, ...exportRows.map(r => r.map(v => {
                                    const s = String(v ?? '');
                                    const escaped = s.replace(/"/g, '""');
                                    return `"${escaped}"`;
                                }).join(','))].join('\r\n');
                                const blob = new Blob(['\uFEFF'+csv], { type: 'text/csv;charset=utf-8;' });
                                const a = document.createElement('a');
                                a.href = URL.createObjectURL(blob);
                                a.download = `å…¨å“¡æœˆå ±è¡¨_${ymTag}.csv`;
                                a.click();
                                setTimeout(() => URL.revokeObjectURL(a.href), 1000);
                            }
                        } catch (e) {
                            console.error('åŒ¯å‡ºå…¨å“¡æœˆå ±è¡¨å¤±æ•—', e);
                            showToast && showToast('åŒ¯å‡ºå…¨å“¡æœˆå ±è¡¨å¤±æ•—', true);
                        }
                    });
                } catch (err) {
                    console.error('renderAllMonthlyReports å¤±æ•—', err);
                    showToast && showToast('ç”Ÿæˆå…¨å“¡æœˆå ±è¡¨å¤±æ•—', true);
                }
            }

            async function initClockInMap() {
                const mapLoader = document.getElementById('map-loader');
                const mapDiv = document.getElementById('map');
                if(!mapDiv || !mapLoader) return;
                
                mapLoader.classList.remove('hide');
                state.currentLocation = null;
                
                // Geolocation requires secure context in modern browsers
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('éå®‰å…¨ä¾†æºï¼Œå¯èƒ½å°è‡´ geolocation æˆ–åœ°åœ–ç„¡æ³•ä½¿ç”¨');
                    const tip = document.createElement('div');
                    tip.className = 'p-2 text-yellow-700 text-xs';
                    tip.textContent = 'æç¤ºï¼šè«‹ä»¥ https æˆ– localhost é–‹å•Ÿä»¥ä½¿ç”¨å®šä½åŠŸèƒ½';
                    mapDiv.parentElement?.insertBefore(tip, mapDiv);
                }

                if (!window.google || !window.google.maps) {
                    setTimeout(initClockInMap, 100);
                    return;
                }
                
                try {
                    // è‹¥å·²æœ‰ç›£è½ï¼Œå…ˆæ¸…é™¤é¿å…é‡è¤‡
                    if (state.geoWatchId) {
                        try { navigator.geolocation.clearWatch(state.geoWatchId); } catch (e) { console.warn('æ¸…é™¤èˆŠçš„ geolocation ç›£è½å¤±æ•—', e); }
                        state.geoWatchId = null;
                    }

                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 0 
                        });
                    });
                    
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    state.currentLocation = coords;
                    
                    if (mapDiv.offsetWidth === 0 || mapDiv.offsetHeight === 0) {
                        mapDiv.style.width = '100%';
                        mapDiv.style.height = '300px';
                    }
                    
                    const map = new google.maps.Map(mapDiv, { 
                        center: coords, 
                        zoom: 17, 
                        disableDefaultUI: true 
                    });
                    
                    const marker = new google.maps.Marker({ 
                        position: coords, 
                        map: map 
                    });

                    // å„²å­˜å¼•ç”¨ä»¥ä¾¿å¾ŒçºŒæ›´æ–°
                    state.clockInMap = map;
                    state.clockInMarker = marker;

                    // ä½ç½®æ›´æ–°èˆ‡åœ°åœ–è‡ªå‹•ç½®ä¸­
                    const updatePos = (p) => {
                        const c = { lat: p.coords.latitude, lng: p.coords.longitude };
                        state.currentLocation = c;
                        if (state.clockInMarker) state.clockInMarker.setPosition(c);
                        if (state.clockInMap) state.clockInMap.panTo(c);
                    };

                    // å•Ÿå‹•æŒçºŒç›£è½ä½ç½®
                    state.geoWatchId = navigator.geolocation.watchPosition(updatePos, (err) => {
                        console.warn('watchPosition éŒ¯èª¤', err);
                    }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 });

                    // ç•«é¢å›åˆ°å¯è¦‹æ™‚ï¼Œç«‹å³æŠ“ä¸€æ¬¡ç•¶å‰ä½ç½®ä»¥é˜²ç€è¦½å™¨ç¯€æµ
                    const visHandler = () => {
                        if (!document.hidden) {
                            navigator.geolocation.getCurrentPosition(updatePos, (err) => console.warn('visibility getCurrentPosition éŒ¯èª¤', err), { enableHighAccuracy: true, timeout: 10000 });
                        }
                    };
                    const focusHandler = () => {
                        navigator.geolocation.getCurrentPosition(updatePos, (err) => console.warn('focus getCurrentPosition éŒ¯èª¤', err), { enableHighAccuracy: true, timeout: 10000 });
                    };
                    document.addEventListener('visibilitychange', visHandler);
                    window.addEventListener('focus', focusHandler);
                    // äº¤ç”±å…¨åŸŸæ¸…ç†æ©Ÿåˆ¶ç§»é™¤
                    state.activeListeners.push(() => document.removeEventListener('visibilitychange', visHandler));
                    state.activeListeners.push(() => window.removeEventListener('focus', focusHandler));
                    state.activeListeners.push(() => { if (state.geoWatchId) { try { navigator.geolocation.clearWatch(state.geoWatchId); } catch{} state.geoWatchId = null; } });
                    
                    mapLoader.classList.add('hide');
                } catch (error) {
                    console.error("åˆå§‹åŒ–åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    mapDiv.innerHTML = `<div class="p-4 text-center text-red-500">ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™ã€‚</div>`;
                    mapLoader.classList.add('hide');
                    showToast("ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™", true);
                }
            }
            
            function renderTracking(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="map" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'map' || !subPage ? 'active' : ''}">äººå“¡åœ°åœ–</button>
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">å‡ºå‹¤ç´€éŒ„</button>
                        <button data-subtab="leave" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'leave' ? 'active' : ''}">å‡å–®å¯©æ ¸</button>
                        <button data-subtab="retro" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'retro' ? 'active' : ''}">ä¿®æ”¹ç”³è«‹</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'attendance') {
                    renderTrackingAttendance(subPageContent);
                } else if (subPage === 'leave') {
                    renderTrackingLeave(subPageContent);
                } else if (subPage === 'retro') {
                    renderRetroApprovals(subPageContent);
                } else {
                    renderTrackingMap(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('tracking', btn.dataset.subtab)));
            }

            // è£œæ‰“å¡ç”³è«‹è¡¨å–®
            function renderRetroClockRequestForm(container) {
                const todayStr = new Date().toISOString().split('T')[0];
                container.innerHTML = `
                    <div class="p-4 h-full">
                        <div class="bg-white rounded-lg shadow-sm border p-4 space-y-4">
                            <h2 class="text-lg font-bold">è£œæ‰“å¡ç”³è«‹</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">æ—¥æœŸ</label>
                                    <input type="date" id="retro-date" value="${todayStr}" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">æ™‚é–“</label>
                                    <input type="time" id="retro-time" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">é …ç›®</label>
                                    <select id="retro-type" class="w-full border border-gray-300 rounded-md p-2">
                                        <option value="ä¸Šç­">ä¸Šç­</option>
                                        <option value="ä¸‹ç­">ä¸‹ç­</option>
                                        <option value="å¤–å‡º">å¤–å‡º</option>
                                        <option value="æŠµé”">æŠµé”</option>
                                        <option value="é›¢é–‹">é›¢é–‹</option>
                                        <option value="è¿”å›">è¿”å›</option>
                                    </select>
                                </div>
                            </div>
                            <div id="retro-extra" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">äº‹ç”±</label>
                                    <input type="text" id="retro-reason" placeholder="è«‹è¼¸å…¥äº‹ç”±" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">åœ°é»</label>
                                    <input type="text" id="retro-location" placeholder="è«‹è¼¸å…¥åœ°é»" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button id="retro-submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">é€å‡ºç”³è«‹</button>
                            </div>
                        </div>
                        <div id="retro-submit-status" class="mt-3 text-sm text-gray-500"></div>
                        <div class="mt-4 bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold">æˆ‘çš„ç”³è«‹åˆ—è¡¨</h3>
                                <span class="text-sm text-gray-500">é¡¯ç¤ºæœ¬äººå·²æäº¤è£œæ‰“å¡</span>
                            </div>
                            <div id="my-retro-list" class="space-y-3"></div>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch (e) {}
                const typeEl = document.getElementById('retro-type');
                const reasonEl = document.getElementById('retro-reason');
                const locEl = document.getElementById('retro-location');
                const toggleExtra = () => {
                    const t = typeEl.value;
                    const needExtra = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(t);
                    reasonEl.parentElement.style.display = needExtra ? 'block' : 'none';
                    locEl.parentElement.style.display = needExtra ? 'block' : 'none';
                };
                typeEl.addEventListener('change', toggleExtra);
                toggleExtra();

                document.getElementById('retro-submit').addEventListener('click', async () => {
                    const dateStr = document.getElementById('retro-date').value;
                    const timeStr = document.getElementById('retro-time').value;
                    const type = typeEl.value;
                    const reason = reasonEl.value.trim();
                    const locationName = locEl.value.trim();
                    if (!dateStr || !timeStr) { showToast('è«‹å¡«å¯«æ—¥æœŸèˆ‡æ™‚é–“', true); return; }
                    if (['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type)) {
                        if (!reason || !locationName) { showToast('å¤–å‡º/æŠµé”/é›¢é–‹éœ€å¡«å¯«äº‹ç”±èˆ‡åœ°é»', true); return; }
                    }
                    const dt = new Date(`${dateStr}T${timeStr}:00`);
                    const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                    if (!user) { showToast('å°šæœªç™»å…¥', true); return; }
                    const payload = {
                        userId: user.uid,
                        type,
                        reason: reason || '',
                        locationName: locationName || '',
                        requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                        targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                        status: 'pending'
                    };
                    try {
                        await addDoc(collection(db, 'retroClockRequests'), payload);
                        showToast('å·²é€å‡ºè£œæ‰“å¡ç”³è«‹');
                        document.getElementById('retro-submit-status').textContent = 'ç”³è«‹å·²é€å‡ºï¼Œå¾…ç®¡ç†å“¡å¯©æ ¸';
                        try { await renderMyRetroRequests(); } catch (e) {}
                    } catch (e) {
                        console.error('é€å‡ºè£œæ‰“å¡ç”³è«‹å¤±æ•—', e);
                        showToast('é€å‡ºç”³è«‹å¤±æ•—', true);
                    }
                });

                // æˆ‘çš„ç”³è«‹åˆ—è¡¨ï¼ˆæœ¬äººï¼‰
                async function renderMyRetroRequests() {
                    const listEl = document.getElementById('my-retro-list');
                    if (!listEl) return;
                    listEl.innerHTML = `<div class="p-2 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>è¼‰å…¥ä¸­...</div></div>`;
                    try {
                        const { collection, query, where, orderBy, getDocs } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                        if (!user) { listEl.innerHTML = '<p class="text-sm text-red-600">è«‹å…ˆç™»å…¥</p>'; return; }
                        const qs = await getDocs(query(collection(db, 'retroClockRequests'), where('userId','==', user.uid), orderBy('requestedAt', 'desc')));
                        if (qs.empty) { listEl.innerHTML = '<p class="text-sm text-gray-500">å°šç„¡ç”³è«‹</p>'; return; }
                        listEl.innerHTML = '';
                        qs.forEach(docSnap => {
                            const r = { id: docSnap.id, ...docSnap.data() };
                            const when = r.targetTime?.toDate?.() ? r.targetTime.toDate() : (r.targetTime ? new Date(r.targetTime) : null);
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded-md bg-white flex items-center justify-between';
                            item.innerHTML = `
                                <div>
                                    <p class=\"font-medium text-gray-800\">${r.type}</p>
                                    <p class=\"text-sm text-gray-600\">${when ? when.toLocaleString('zh-TW') : ''}</p>
                                    ${r.locationName ? `<p class=\"text-xs text-gray-500\">åœ°é»ï¼š${r.locationName}</p>` : ''}
                                    ${r.reason ? `<p class=\"text-xs text-gray-500\">äº‹ç”±ï¼š${r.reason}</p>` : ''}
                                </div>
                                <span class=\"text-sm ${r.status==='approved' ? 'text-green-600' : (r.status==='rejected' ? 'text-red-600' : 'text-gray-500')}\">${r.status || 'pending'}</span>`;
                            listEl.appendChild(item);
                        });
                    } catch (e) {
                        console.error('è¼‰å…¥ç”³è«‹åˆ—è¡¨å¤±æ•—', e);
                        listEl.innerHTML = '<p class="text-sm text-red-600">è¼‰å…¥å¤±æ•—</p>';
                    } finally { try { lucide.createIcons(); } catch(e) {} }
                }
                try { renderMyRetroRequests(); } catch(e) {}
            }

            // è£œæ‰“ç”³è«‹å¯©æ ¸é é¢
            async function renderRetroApprovals(container) {
                container.innerHTML = `
                    <div class="p-4 h-full">
                        <div class="bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-bold">ä¿®æ”¹ç”³è«‹å¯©æ ¸</h2>
                                <button id="manual-add-record" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">æ–°å¢äººå“¡æ‰“å¡ç´€éŒ„</button>
                            </div>
                            <div class="mb-3 flex items-center gap-2">
                                <input type="date" id="retro-filter-date" class="border border-gray-300 rounded-md p-2">
                                <select id="retro-filter-user" class="border border-gray-300 rounded-md p-2 min-w-[180px]">
                                    <option value="">å…¨éƒ¨äººå“¡</option>
                                </select>
                            </div>
                            <div id="retro-requests-list" class="space-y-3"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm border p-4 mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-bold">ä¿®æ”¹ç´€éŒ„</h2>
                                <span class="text-sm text-gray-500">é¡¯ç¤ºã€ä¿®æ”¹ç”³è«‹å¯©æ ¸ã€èˆ‡ã€æ‰‹å‹•æ–°å¢ã€æ‰€ç”¢ç”Ÿçš„ç´€éŒ„</span>
                            </div>
                            <div id="retro-mod-list" class="space-y-3"></div>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch(e) {}
                const { collection, query, where, orderBy, limit, getDocs, addDoc, updateDoc, doc, Timestamp, GeoPoint } = window.__fs; const db = window.__db;
                const listEl = document.getElementById('retro-requests-list');
                const filterDateEl = document.getElementById('retro-filter-date');
                const filterUserEl = document.getElementById('retro-filter-user');
                const modListEl = document.getElementById('retro-mod-list');

                // è¼‰å…¥äººå“¡ä¸‹æ‹‰
                try {
                    const us = await getDocs(collection(db, 'users'));
                    us.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id; opt.textContent = d.data().name || d.id;
                        filterUserEl.appendChild(opt);
                    });
                } catch(e) {}

                async function renderList() {
                    listEl.innerHTML = `<div class="p-4 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>è¼‰å…¥ç”³è«‹...</div></div>`;
                    try {
                        const qs = await getDocs(query(collection(db, 'retroClockRequests'), where('status','==','pending'), orderBy('requestedAt','desc')));
                        const selectedUser = filterUserEl.value || '';
                        const selectedDate = filterDateEl.value || '';
                        const items = [];
                        qs.forEach(docSnap => {
                            const req = { id: docSnap.id, ...docSnap.data() };
                            const when = req.targetTime?.toDate?.() ? req.targetTime.toDate() : (req.targetTime ? new Date(req.targetTime) : null);
                            const dateStr = when ? when.toISOString().split('T')[0] : '';
                            if (selectedUser && req.userId !== selectedUser) return;
                            if (selectedDate && dateStr !== selectedDate) return;
                            items.push({ ...req, when });
                        });
                        if (items.length === 0) { listEl.innerHTML = `<p class="text-center text-gray-500 p-4">ç„¡ç¬¦åˆæ¢ä»¶çš„ç”³è«‹</p>`; return; }
                        // è¼‰å…¥ä½¿ç”¨è€…åç¨±æ˜ å°„
                        const userMap = {};
                        try {
                            const us = await getDocs(collection(db, 'users'));
                            us.forEach(d => userMap[d.id] = d.data().name || d.id);
                        } catch(e) {}
                        listEl.innerHTML = '';
                        items.forEach(req => {
                            const userName = userMap[req.userId] || req.userId;
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded-md bg-white flex items-center justify-between';
                            item.innerHTML = `
                                <div>
                                    <p class=\"font-medium text-gray-800\">${userName}</p>
                                    <p class=\"text-sm text-gray-600\">${req.type} Â· ${req.when ? req.when.toLocaleString('zh-TW') : ''}</p>
                                    ${req.locationName ? `<p class=\"text-xs text-gray-500\">åœ°é»ï¼š${req.locationName}</p>` : ''}
                                    ${req.reason ? `<p class=\"text-xs text-gray-500\">äº‹ç”±ï¼š${req.reason}</p>` : ''}
                                </div>
                                <div class=\"flex items-center space-x-2\">
                                    <button class=\"approve-btn px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700\" data-id=\"${req.id}\">åŒæ„</button>
                                    <button class=\"reject-btn px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700\" data-id=\"${req.id}\">ä¸åŒæ„</button>
                                </div>`;
                            listEl.appendChild(item);
                        });
                        try { lucide.createIcons(); } catch(e) {}
                        // ç¶å®šäº‹ä»¶
                        const canReview = await (window.checkReviewerStatus ? window.checkReviewerStatus() : (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)));
                        const handleApprove = async (id) => {
                            if (!canReview) { showToast('åƒ…ç®¡ç†å“¡/äººäº‹/é«˜éšä¸»ç®¡å¯å¯©æ ¸', true); return; }
                            try {
                                const reqDoc = await window.__fs.getDoc(window.__fs.doc(db, 'retroClockRequests', id));
                                if (!reqDoc.exists()) { showToast('ç”³è«‹ä¸å­˜åœ¨', true); return; }
                                const r = reqDoc.data();
                                const ts = r.targetTime?.toDate?.() ? r.targetTime.toDate() : (r.targetTime ? new Date(r.targetTime) : new Date());
                                let replaced = false;
                                // è‹¥ç”³è«‹åŒ…å«åŸå§‹ç´€éŒ„ IDï¼Œå„ªå…ˆè¦†å¯«åŸç´€éŒ„
                                if (r.originalRecordId) {
                                    try {
                                        const origRef = doc(db, 'clockInRecords', r.originalRecordId);
                                        const origSnap = await window.__fs.getDoc(origRef);
                                        if (origSnap.exists()) {
                                            const updatePayload = {
                                                type: r.type,
                                                timestamp: Timestamp?.fromDate ? Timestamp.fromDate(ts) : ts,
                                                locationName: r.locationName || null,
                                                isAutomatic: false
                                            };
                                            await updateDoc(origRef, updatePayload);
                                            replaced = true;
                                        }
                                    } catch (err) {
                                        console.warn('è¦†å¯«åŸç´€éŒ„å¤±æ•—ï¼Œæ”¹ç‚ºæ–°å¢', err);
                                    }
                                }
                                // è‹¥ç„¡æ³•è¦†å¯«æˆ–æ²’æœ‰ originalRecordIdï¼Œå‰‡ä¿ç•™èˆŠè¡Œç‚ºæ–°å¢ä¸€ç­†ï¼ˆç›¸å®¹èˆŠç”³è«‹ï¼‰
                                if (!replaced) {
                                    await addDoc(collection(db, 'clockInRecords'), {
                                        userId: r.userId,
                                        type: r.type,
                                        timestamp: Timestamp?.fromDate ? Timestamp.fromDate(ts) : ts,
                                        location: GeoPoint ? new GeoPoint(0,0) : { latitude: 0, longitude: 0 },
                                        photoUrls: [],
                                        descriptions: [],
                                        deviceId: 'retro',
                                        locationName: r.locationName || null,
                                        dutyType: null,
                                        isAutomatic: false
                                    });
                                }
                                // åŒæ­¥æ›´æ–° users ç‹€æ…‹ï¼Œè®“å„€éŒ¶æ¿èˆ‡å®šä½æ‰“å¡æŒ‰éˆ•æ­£ç¢ºé¡¯ç¤º
                                try {
                                    const newStatus = r.type; // å¯èƒ½ç‚ºï¼šä¸Šç­/ä¸‹ç­/å¤–å‡º/æŠµé”/é›¢é–‹/è¿”å›
                                    const updatePayload = {
                                        status: newStatus,
                                        clockInStatus: newStatus,
                                        lastUpdated: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                    };
                                    // æ ¸å‡†ã€Œä¸Šç­ã€è£œæ‰“å¡æ™‚ï¼Œæ›´æ–° lastClockInTime ä¾›æ’åºèˆ‡é¡¯ç¤º
                                    if (newStatus === 'ä¸Šç­') {
                                        updatePayload.lastClockInTime = Timestamp?.fromDate ? Timestamp.fromDate(ts) : ts;
                                    }
                                    // å¤–å‡º/æŠµé”/é›¢é–‹å¯æ›´æ–°å¤–å‡ºåœ°é»æ–‡å­—ï¼ˆè‹¥æœ‰ï¼‰
                                    if (newStatus === 'å¤–å‡º' || newStatus === 'æŠµé”' || newStatus === 'é›¢é–‹') {
                                        updatePayload.outboundLocation = r.locationName || '';
                                    }
                                    await updateDoc(doc(db, 'users', r.userId), updatePayload);
                                } catch (e) {
                                    console.warn('æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—ï¼ˆå·²æ–°å¢æ‰“å¡ç´€éŒ„ï¼Œä½† users ç‹€æ…‹æœªåŒæ­¥ï¼‰', e);
                                }
                                await updateDoc(doc(db, 'retroClockRequests', id), {
                                    status: 'approved',
                                    reviewerId: window.__auth?.currentUser?.uid || null,
                                    reviewedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                });
                                showToast(replaced ? 'å·²æ ¸å‡†ä¸¦è¦†å¯«æ‰“å¡ç´€éŒ„' : 'å·²æ ¸å‡†ä¸¦æ–°å¢æ‰“å¡ç´€éŒ„');
                                renderList();
                            } catch (e) {
                                console.error('æ ¸å‡†å¤±æ•—', e);
                                showToast('æ ¸å‡†å¤±æ•—', true);
                            }
                        };
                        const handleReject = async (id) => {
                            if (!canReview) { showToast('åƒ…ç®¡ç†å“¡/äººäº‹/é«˜éšä¸»ç®¡å¯å¯©æ ¸', true); return; }
                            try {
                                await updateDoc(doc(db, 'retroClockRequests', id), {
                                    status: 'rejected',
                                    reviewerId: window.__auth?.currentUser?.uid || null,
                                    reviewedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                });
                                showToast('å·²é€€å›ç”³è«‹');
                                renderList();
                            } catch (e) {
                                console.error('é€€å›å¤±æ•—', e);
                                showToast('é€€å›å¤±æ•—', true);
                            }
                        };
                        container.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', (e) => handleApprove(e.currentTarget.dataset.id)));
                        container.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', (e) => handleReject(e.currentTarget.dataset.id)));
                    } catch (e) {
                        console.error('è®€å–è£œæ‰“ç”³è«‹å¤±æ•—', e);
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">è®€å–å¤±æ•—</p>`;
                    }
                }

                filterDateEl.addEventListener('change', renderList);
                filterUserEl.addEventListener('change', renderList);

                // ä¿®æ”¹ç´€éŒ„åˆ—è¡¨æ¸²æŸ“
                async function renderModList() {
                    if (!modListEl) return;
                    modListEl.innerHTML = `<div class="p-4 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>è¼‰å…¥ä¿®æ”¹ç´€éŒ„...</div></div>`;
                    try {
                        const qs = await getDocs(query(collection(db, 'clockInRecords'), orderBy('timestamp','desc'), limit(200)));
                        const selectedUser = filterUserEl.value || '';
                        const selectedDate = filterDateEl.value || '';
                        const items = [];
                        qs.forEach(docSnap => {
                            const rec = { id: docSnap.id, ...docSnap.data() };
                            const deviceId = rec.deviceId || '';
                            // åƒ…é¡¯ç¤ºç”±å¯©æ ¸æˆ–æ‰‹å‹•æ–°å¢çš„ç´€éŒ„
                            if (!['retro','retro-approval','manual-admin'].includes(deviceId)) return;
                            const when = rec.timestamp?.toDate?.() ? rec.timestamp.toDate() : (rec.timestamp ? new Date(rec.timestamp) : null);
                            const dateStr = when ? when.toISOString().split('T')[0] : '';
                            if (selectedUser && rec.userId !== selectedUser) return;
                            if (selectedDate && dateStr !== selectedDate) return;
                            items.push({ ...rec, when });
                        });
                        if (items.length === 0) { modListEl.innerHTML = `<p class="text-center text-gray-500 p-4">ç„¡ç¬¦åˆæ¢ä»¶çš„ä¿®æ”¹ç´€éŒ„</p>`; return; }
                        // è¼‰å…¥ä½¿ç”¨è€…åç¨±æ˜ å°„
                        const userMap = {};
                        try {
                            const us = await getDocs(collection(db, 'users'));
                            us.forEach(d => userMap[d.id] = d.data().name || d.id);
                        } catch(e) {}
                        modListEl.innerHTML = '';
                        items.forEach(rec => {
                            const userName = userMap[rec.userId] || rec.userId;
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded-md bg-white flex items-center justify-between';
                            const locText = rec.locationName ? `åœ°é»ï¼š${rec.locationName}` : (typeof rec.location === 'string' ? `åœ°é»ï¼š${rec.location}` : '');
                            item.innerHTML = `
                                <div>
                                    <p class="font-medium text-gray-800">${userName}</p>
                                    <p class="text-sm text-gray-600">${rec.type} Â· ${rec.when ? rec.when.toLocaleString('zh-TW') : ''}</p>
                                    ${locText ? `<p class=\"text-xs text-gray-500\">${locText}</p>` : ''}
                                    ${rec.descriptions && rec.descriptions.length ? `<p class=\"text-xs text-gray-500\">æè¿°ï¼š${rec.descriptions.join('ã€')}</p>` : ''}
                                </div>
                                <span class="text-xs text-gray-500">ä¾†æºï¼š${rec.deviceId}</span>`;
                            modListEl.appendChild(item);
                        });
                        try { lucide.createIcons(); } catch(e) {}
                    } catch (e) {
                        console.error('è®€å–ä¿®æ”¹ç´€éŒ„å¤±æ•—', e);
                        modListEl.innerHTML = `<p class="text-center text-gray-500 p-4">è®€å–å¤±æ•—</p>`;
                    }
                }

                filterDateEl.addEventListener('change', renderModList);
                filterUserEl.addEventListener('change', renderModList);

                // æ‰‹å‹•æ–°å¢äººå“¡æ‰“å¡ç´€éŒ„ï¼ˆå½ˆçª—ï¼‰
                document.getElementById('manual-add-record').addEventListener('click', () => {
                    const backdrop = document.createElement('div');
                    backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                    const modal = document.createElement('div');
                    modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[90%] max-w-[520px]';
                    modal.innerHTML = `
                        <h3 class=\"text-lg font-bold mb-3\">æ–°å¢äººå“¡æ‰“å¡ç´€éŒ„</h3>
                        <div class=\"space-y-3\">
                            <div>
                                <label class=\"text-sm font-medium\">äººå“¡å§“å</label>
                                <select id=\"manual-user\" class=\"w-full border border-gray-300 rounded-md p-2\"></select>
                            </div>
                            <div class=\"grid grid-cols-2 gap-3\">
                                <div>
                                    <label class=\"text-sm font-medium\">æ—¥æœŸ</label>
                                    <input type=\"date\" id=\"manual-date\" class=\"w-full border border-gray-300 rounded-md p-2\" />
                                </div>
                                <div>
                                    <label class=\"text-sm font-medium\">æ™‚é–“</label>
                                    <input type=\"time\" id=\"manual-time\" class=\"w-full border border-gray-300 rounded-md p-2\" />
                                </div>
                            </div>
                            <div>
                                <label class=\"text-sm font-medium\">é …ç›®</label>
                                <select id=\"manual-type\" class=\"w-full border border-gray-300 rounded-md p-2\">
                                    <option value=\"ä¸Šç­\">ä¸Šç­</option>
                                    <option value=\"ä¸‹ç­\">ä¸‹ç­</option>
                                    <option value=\"å¤–å‡º\">å¤–å‡º</option>
                                    <option value=\"æŠµé”\">æŠµé”</option>
                                    <option value=\"é›¢é–‹\">é›¢é–‹</option>
                                    <option value=\"è¿”å›\">è¿”å›</option>
                                </select>
                            </div>
                            <div id=\"manual-extra\" class=\"grid grid-cols-2 gap-3\">
                                <div>
                                    <label class=\"text-sm font-medium\">äº‹ç”±</label>
                                    <input type=\"text\" id=\"manual-reason\" class=\"w-full border border-gray-300 rounded-md p-2\" placeholder=\"è«‹è¼¸å…¥äº‹ç”±\" />
                                </div>
                                <div>
                                    <label class=\"text-sm font-medium\">åœ°é»</label>
                                    <input type=\"text\" id=\"manual-location\" class=\"w-full border border-gray-300 rounded-md p-2\" placeholder=\"è«‹è¼¸å…¥åœ°é»\" />
                                </div>
                            </div>
                        </div>
                        <div class=\"flex justify-end gap-2 mt-4\">
                            <button id=\"manual-cancel\" class=\"px-3 py-2 border rounded-md\">å–æ¶ˆ</button>
                            <button id=\"manual-submit\" class=\"px-3 py-2 bg-indigo-600 text-white rounded-md\">æ–°å¢</button>
                        </div>
                    `;
                    document.body.appendChild(backdrop);
                    document.body.appendChild(modal);
                    // å¡«å…¥äººå“¡
                    filterUserEl.querySelectorAll('option').forEach(opt => {
                        if (!opt.value) return;
                        const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.textContent;
                        modal.querySelector('#manual-user').appendChild(o);
                    });
                    const typeSelect = modal.querySelector('#manual-type');
                    const reasonInput = modal.querySelector('#manual-reason');
                    const locInput = modal.querySelector('#manual-location');
                    const toggle = () => {
                        const need = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(typeSelect.value);
                        modal.querySelector('#manual-extra').style.display = need ? 'grid' : 'none';
                    };
                    typeSelect.addEventListener('change', toggle); toggle();
                    modal.querySelector('#manual-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                    backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                    modal.querySelector('#manual-submit').addEventListener('click', async () => {
                        try {
                            const userId = modal.querySelector('#manual-user').value;
                            const dateStr = modal.querySelector('#manual-date').value;
                            const timeStr = modal.querySelector('#manual-time').value;
                            const type = typeSelect.value;
                            const reason = (reasonInput.value || '').trim();
                            const locationName = (locInput.value || '').trim();
                            if (!userId || !dateStr || !timeStr) { showToast('è«‹å®Œæ•´å¡«å¯«äººå“¡èˆ‡æ—¥æœŸæ™‚é–“', true); return; }
                            if (['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) && (!reason || !locationName)) { showToast('å¤–å‡º/æŠµé”/é›¢é–‹éœ€å¡«å¯«äº‹ç”±èˆ‡åœ°é»', true); return; }
                            const tsDate = new Date(`${dateStr}T${timeStr}:00`);
                            await addDoc(collection(db, 'clockInRecords'), {
                                userId,
                                type,
                                timestamp: Timestamp?.fromDate ? Timestamp.fromDate(tsDate) : tsDate,
                                location: GeoPoint ? new GeoPoint(0,0) : { latitude: 0, longitude: 0 },
                                photoUrls: [],
                                descriptions: [],
                                deviceId: 'manual-admin',
                                locationName: ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) ? `${locationName}${reason ? 'ï½œ'+reason : ''}` : (locationName || null),
                                dutyType: null,
                                isAutomatic: false
                            });
                            showToast('å·²æ–°å¢æ‰“å¡ç´€éŒ„');
                            backdrop.remove(); modal.remove();
                        } catch (err) {
                            console.error('æ–°å¢æ‰“å¡å¤±æ•—', err);
                            showToast('æ–°å¢å¤±æ•—', true);
                        }
                    });
                });

                await renderList();
            }

            // äººäº‹åˆ†é ï¼šåƒ…åˆ—å°å ±è¡¨
            function renderHR(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="print" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'print' || !subPage ? 'active' : ''}">åˆ—å°å ±è¡¨</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                renderHRPrintReport(subPageContent);

                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('hr', btn.dataset.subtab)));
            }

            // äººäº‹ > åˆ—å°å ±è¡¨ï¼šæœˆå ±è¡¨ï¼ˆæ”¯æ´å…¨éƒ¨äººå“¡æˆ–å–®ä¸€äººå“¡ã€åˆ—å°èˆ‡åŒ¯å‡ºï¼‰
            function renderHRPrintReport(container) {
                const db = window.__db;
                const { collection, getDocs, query, where, Timestamp } = window.__fs || {};
                if (!db || !collection || !getDocs) {
                    container.innerHTML = '<div class="p-4 text-red-600">ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
                    return;
                }

                const today = new Date();
                const defaultMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="monthly-user-select" class="text-sm font-medium">é¸æ“‡äººå“¡:</label>
                                <div class="flex items-center gap-2">
                                    <input id="select-all-users" type="checkbox" class="h-4 w-4">
                                    <label for="select-all-users" class="text-xs text-gray-600">å…¨é¸</label>
                                    <select id="monthly-user-select" multiple class="border border-gray-300 rounded-md px-2 py-1 min-w-[180px]" title="å¯æŒ‰ä½ Ctrl/Command å¤šé¸">
                                    </select>
                                </div>
                                <div id="selected-users-label" class="text-xs text-gray-500 ml-2">å…¨éƒ¨äººå“¡</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="monthly-month" class="text-sm font-medium">é¸æ“‡æœˆä»½:</label>
                                <input type="month" id="monthly-month" value="${defaultMonth}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                            <div class="flex items-center space-x-2 ml-auto">
                                <button id="btn-print-monthly" class="bg-gray-700 text-white px-3 py-1 rounded flex items-center">
                                    <i data-lucide="printer" class="w-4 h-4 mr-1"></i> åˆ—å°
                                </button>
                                <button id="btn-export-excel" class="bg-blue-600 text-white px-3 py-1 rounded flex items-center">
                                    <i data-lucide="download" class="w-4 h-4 mr-1"></i> åŒ¯å‡ºExcel
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <table id="attendance-monthly-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50" id="attendance-monthly-thead"></thead>
                                <tbody id="attendance-monthly-tbody" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="32" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex items-center justify-center">
                                            <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                            è¼‰å…¥ä¸­...
                                        </div>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}

                const usersRef = collection(db, 'users');
                const userSelect = document.getElementById('monthly-user-select');
                const monthInput = document.getElementById('monthly-month');
                const theadEl = document.getElementById('attendance-monthly-thead');
                const tbodyEl = document.getElementById('attendance-monthly-tbody');

                let usersArr = [];
                let usersMap = {};

                const fmtHM = (d) => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                const weekdayZh = (d) => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];

                const renderHeader = (year, monthIndex, daysInMonth) => {
                    const cols = ['<tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äººå“¡</th>'];
                    for (let i = 1; i <= daysInMonth; i++) {
                        const wd = weekdayZh(new Date(year, monthIndex, i));
                        cols.push(`<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${String(i).padStart(2,'0')}(${wd})</th>`);
                    }
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">å‡ºå‹¤æ—¥æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½å·¥æ™‚(å°æ™‚)</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">é²åˆ°æ¬¡æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">é²åˆ°æ™‚æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ—©é€€æ¬¡æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ—©é€€æ™‚æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">è«‹å‡æ—¥æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ç—…å‡æ—¥æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">äº‹å‡æ—¥æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">å…¶ä»–è«‹å‡æ—¥æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ç‰¹æ®Šå‹¤å‹™æ—¥æ•¸</th>');
                    cols.push('</tr>');
                    theadEl.innerHTML = cols.join('');
                };

                const loadMonthlyReport = async () => {
                    const ymStr = monthInput.value || defaultMonth;
                    const [yStr, mStr] = ymStr.split('-');
                    const year = Number(yStr);
                    const month = Number(mStr) - 1; // 0-based
                    const startOfMonth = new Date(year, month, 1, 0, 0, 0, 0);
                    const endOfMonth = new Date(year, month + 1, 0, 23, 59, 59, 999);
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    renderHeader(year, month, daysInMonth);

                    const getSelectedUserIds = () => {
                        const ids = Array.from(userSelect.selectedOptions).map(o => o.value);
                        return ids;
                    };
                    const recordsRef = collection(db, 'clockInRecords');
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfMonth) : startOfMonth;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfMonth) : endOfMonth;
                    const selectedIds = getSelectedUserIds();
                    // ç›´æ¥å–æœˆä»½ç¯„åœè³‡æ–™ï¼Œå†åœ¨å‰ç«¯ä¾ä½¿ç”¨è€…éæ¿¾ï¼Œé¿å… Firestore IN é™åˆ¶
                    const q = query(recordsRef, where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));

                    tbodyEl.innerHTML = `<tr><td colspan="32" class="px-6 py-4 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>è¼‰å…¥ä¸­...</div></td></tr>`;

                    try {
                        const snap = await getDocs(q);
                        const byUser = new Map();
                        snap.forEach(d => {
                            const r = d.data();
                            const uid = r.userId;
                            const dt = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!uid || !dt) return;
                            if (selectedIds.length && !selectedIds.includes(uid)) return;
                            const day = dt.getDate();
                            const entry = byUser.get(uid) || { days: new Map() };
                            const dayObj = entry.days.get(day) || { start: null, end: null };
                            if (r.type === 'ä¸Šç­') { if (!dayObj.start || dt < dayObj.start) dayObj.start = dt; }
                            if (r.type === 'ä¸‹ç­' || r.type === 'è‡ªå‹•ä¸‹ç­') { if (!dayObj.end || dt > dayObj.end) dayObj.end = dt; }
                            entry.days.set(day, dayObj);
                            byUser.set(uid, entry);
                        });

                        const dayNumbersInRange = (start, end) => {
                            if (!start || !end) return [];
                            const cs = new Date(Math.max(start.getTime(), startOfMonth.getTime()));
                            const ce = new Date(Math.min(end.getTime(), endOfMonth.getTime()));
                            cs.setHours(12,0,0,0); ce.setHours(12,0,0,0);
                            const out = [];
                            for (let d = new Date(cs); d <= ce; d.setDate(d.getDate() + 1)) { out.push(d.getDate()); }
                            return out;
                        };

                        const leaveDaySetMap = new Map();
                        try {
                            const leavesRef = collection(db, 'leaves');
                            const qLeaves = query(leavesRef, where('status','==','approved'));
                            const leavesSnap = await getDocs(qLeaves);
                            const leaveReasonDaysMap = new Map();
                            leavesSnap.forEach(doc => {
                                const lv = doc.data();
                                const uid = lv.userId || lv.uid || (lv.user && lv.user.id);
                                if (!uid) return;
                                if (selectedIds.length && !selectedIds.includes(uid)) return;
                                const s = (lv.startTime && lv.startTime.toDate?.()) || (lv.startTime ? new Date(lv.startTime) : (lv.leaveStartTime && lv.leaveStartTime.toDate?.()) || (lv.leaveStartTime ? new Date(lv.leaveStartTime) : null));
                                const e = (lv.endTime && lv.endTime.toDate?.()) || (lv.endTime ? new Date(lv.endTime) : (lv.leaveEndTime && lv.leaveEndTime.toDate?.()) || (lv.leaveEndTime ? new Date(lv.leaveEndTime) : null));
                                if (!s || !e) return;
                                const days = dayNumbersInRange(s, e);
                                if (!days.length) return;
                                const set = leaveDaySetMap.get(uid) || new Set();
                                days.forEach(n => set.add(n));
                                leaveDaySetMap.set(uid, set);
                                const reason = (lv.reason || lv.reasonType || lv.leaveReason || '').trim();
                                const cat = reason === 'ç—…å‡' ? 'sick' : (reason === 'äº‹å‡' ? 'personal' : 'other');
                                const catMap = leaveReasonDaysMap.get(uid) || { sick: new Set(), personal: new Set(), other: new Set() };
                                days.forEach(n => catMap[cat].add(n));
                                leaveReasonDaysMap.set(uid, catMap);
                            });
                            // æš«å­˜æ–¼å¤–å±¤ä»¥ä¾¿ buildRow ä½¿ç”¨
                            window.__hr_leave_reason_days_map = leaveReasonDaysMap;
                        } catch (e) {}

                        const specialDutyDaySetMap = new Map();
                        try {
                            const sdRef = collection(db, 'specialDuties');
                            const startTS2 = Timestamp?.fromDate ? Timestamp.fromDate(startOfMonth) : startOfMonth;
                            const endTS2 = Timestamp?.fromDate ? Timestamp.fromDate(endOfMonth) : endOfMonth;
                            const q1 = query(sdRef, where('startTime','>=', startTS2), where('startTime','<=', endTS2));
                            const q2 = query(sdRef, where('endTime','>=', startTS2), where('endTime','<=', endTS2));
                            const sdDocs = new Map();
                            for (const qq of [q1, q2]) { const sSnap = await getDocs(qq); sSnap.forEach(doc => { sdDocs.set(doc.id, doc.data()); }); }
                            sdDocs.forEach(sd => {
                                const uid = sd.userId;
                                const s = sd.startTime?.toDate?.() || (sd.startTime ? new Date(sd.startTime) : null);
                                const e = sd.endTime?.toDate?.() || (sd.endTime ? new Date(sd.endTime) : null);
                                if (!uid || !s || !e) return;
                                if (selectedIds.length && !selectedIds.includes(uid)) return;
                                const days = dayNumbersInRange(s, e);
                                if (!days.length) return;
                                const set = specialDutyDaySetMap.get(uid) || new Set();
                                days.forEach(n => set.add(n));
                                specialDutyDaySetMap.set(uid, set);
                            });
                        } catch (e) {}

                        const buildRow = (user) => {
                            const uid = user.id;
                            const entry = byUser.get(uid) || { days: new Map() };
                            let attendDays = 0; let totalMinutes = 0;
                            let lateCount = 0; let lateMinutes = 0; let earlyCount = 0; let earlyMinutes = 0;
                            const tds = [`<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800">${user.name || usersMap[uid] || 'æœªçŸ¥ç”¨æˆ¶'}</td>`];
                            for (let i = 1; i <= daysInMonth; i++) {
                                const dObj = entry.days.get(i) || { start: null, end: null };
                                const hasStart = !!dObj.start; const hasEnd = !!dObj.end;
                                const cls = hasStart && hasEnd ? 'bg-green-50' : (hasStart || hasEnd ? 'bg-yellow-50' : '');
                                let text = '--';
                                if (hasStart && hasEnd) text = `${fmtHM(dObj.start)}~${fmtHM(dObj.end)}`;
                                else if (hasStart) text = `${fmtHM(dObj.start)}`;
                                else if (hasEnd) text = `${fmtHM(dObj.end)}`;
                                if (hasStart || hasEnd) attendDays++;
                                if (hasStart && hasEnd) {
                                    totalMinutes += Math.max(0, (dObj.end - dObj.start) / 60000);
                                    const workStart = new Date(startOfMonth.getFullYear(), startOfMonth.getMonth(), i, 9, 0, 0);
                                    const workEnd = new Date(startOfMonth.getFullYear(), startOfMonth.getMonth(), i, 17, 30, 0);
                                    if (dObj.start > workStart) { lateCount++; lateMinutes += Math.round((dObj.start - workStart) / 60000); }
                                    if (dObj.end < workEnd) { earlyCount++; earlyMinutes += Math.round((workEnd - dObj.end) / 60000); }
                                }
                                tds.push(`<td class="px-2 py-1 text-center text-xs ${cls}">${text}</td>`);
                            }
                            const totalHours = (totalMinutes / 60).toFixed(2);
                            const leaveDays = (leaveDaySetMap.get(uid)?.size) || 0;
                            const dutyDays = (specialDutyDaySetMap.get(uid)?.size) || 0;
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${attendDays}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${totalHours}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${lateCount}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${(lateMinutes/60).toFixed(2)}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${earlyCount}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${(earlyMinutes/60).toFixed(2)}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${leaveDays}</td>`);
                            const rmap = window.__hr_leave_reason_days_map?.get(uid);
                            const sickDays = rmap ? rmap.sick.size : 0;
                            const personalDays = rmap ? rmap.personal.size : 0;
                            const otherDays = rmap ? rmap.other.size : 0;
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${sickDays}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${personalDays}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${otherDays}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${dutyDays}</td>`);
                            return `<tr>${tds.join('')}</tr>`;
                        };

                        const rows = [];
                        const picked = selectedIds.length ? usersArr.filter(u => selectedIds.includes(u.id)) : usersArr;
                        picked.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(u => rows.push(buildRow(u)));
                        const extraCols = 12; // 1(äººå“¡) + 11 çµ±è¨ˆæ¬„ä½
                        tbodyEl.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="${daysInMonth + extraCols}" class="px-6 py-4 text-center text-gray-500">ç„¡è³‡æ–™</td></tr>`;
                        try { lucide.createIcons(); } catch(e) {}
                    } catch (err) {
                        console.error('è®€å–æœˆå ±è¡¨å¤±æ•—', err);
                        tbodyEl.innerHTML = `<tr><td colspan="32" class="px-6 py-4 text-center text-red-500">è®€å–ç´€éŒ„å¤±æ•—ã€‚</td></tr>`;
                    }
                };

                getDocs(usersRef).then((qs) => {
                    const users = [];
                    qs.forEach(doc => { const data = doc.data() || {}; users.push({ id: doc.id, name: data.name || data.displayName || data.account || data.email || doc.id }); });
                    usersArr = users;
                    usersMap = users.reduce((acc, u) => { acc[u.id] = u.name; return acc; }, {});
                    users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                        const option = document.createElement('option'); option.value = user.id; option.textContent = user.name; option.selected = true; userSelect.appendChild(option);
                    });
                    const chkAll = document.getElementById('select-all-users');
                    if (chkAll) chkAll.checked = true;
                    updateSelectedUsersLabel();
                    loadMonthlyReport();
                });

                userSelect.addEventListener('change', () => { syncSelectAllCheckbox(); updateSelectedUsersLabel(); loadMonthlyReport(); });
                const chkAll = document.getElementById('select-all-users');
                chkAll && chkAll.addEventListener('change', () => {
                    const checked = chkAll.checked;
                    Array.from(userSelect.options).forEach(opt => { opt.selected = checked; });
                    updateSelectedUsersLabel();
                    loadMonthlyReport();
                });
                monthInput.addEventListener('change', loadMonthlyReport);

                const btnPrint = document.getElementById('btn-print-monthly');
                const btnExport = document.getElementById('btn-export-excel');
                btnPrint.addEventListener('click', printMonthlyReport);
                btnExport.addEventListener('click', exportMonthlyToExcel);

                function getSelectedUserLabel() {
                    const sel = document.getElementById('monthly-user-select');
                    const names = Array.from(sel.selectedOptions).map(o => o.textContent);
                    if (!names.length || names.length === sel.options.length) return 'å…¨éƒ¨äººå“¡';
                    const shown = names.slice(0, 5).join('ã€');
                    return names.length > 5 ? `${shown} ç­‰${names.length}äºº` : shown;
                }
                function updateSelectedUsersLabel() {
                    const labelEl = document.getElementById('selected-users-label');
                    if (!labelEl) return;
                    labelEl.textContent = getSelectedUserLabel();
                }
                function syncSelectAllCheckbox() {
                    const sel = document.getElementById('monthly-user-select');
                    const chkAll = document.getElementById('select-all-users');
                    if (!sel || !chkAll) return;
                    const allSelected = Array.from(sel.options).every(o => o.selected);
                    chkAll.checked = allSelected;
                }

                async function ensureXLSX() {
                    if (window.XLSX) return true;
                    return new Promise((resolve) => {
                        const s = document.createElement('script');
                        s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                        s.onload = () => resolve(true);
                        s.onerror = () => resolve(false);
                        document.head.appendChild(s);
                    });
                }

                function tableToCSV(table) {
                    let csv = '';
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th,td');
                        const values = Array.from(cells).map(cell => '"' + (cell.innerText || '').replace(/"/g, '""') + '"');
                        csv += values.join(',') + '\r\n';
                    });
                    return csv;
                }

                async function exportMonthlyToExcel() {
                    try {
                        const ok = await ensureXLSX();
                        const ymStr = monthInput.value || defaultMonth;
                        const userLabel = getSelectedUserLabel();
                        const filename = `å‡ºå‹¤æœˆå ±è¡¨_${ymStr}_${userLabel}.xlsx`;
                        const table = document.getElementById('attendance-monthly-table');
                        if (ok && window.XLSX && window.XLSX.utils && window.XLSX.writeFile) {
                            const wb = XLSX.utils.table_to_book(table, { sheet: 'æœˆå ±è¡¨' });
                            XLSX.writeFile(wb, filename);
                        } else {
                            const csv = tableToCSV(table);
                            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = `å‡ºå‹¤æœˆå ±è¡¨_${ymStr}_${userLabel}.csv`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        }
                    } catch (err) {
                        console.error('exportMonthlyToExcel error', err);
                        showToast && showToast('åŒ¯å‡ºå¤±æ•—', true);
                    }
                }

                function printMonthlyReport() {
                    try {
                        const ymStr = monthInput.value || defaultMonth;
                        const userLabel = getSelectedUserLabel();
                        const table = document.getElementById('attendance-monthly-table');
                        const [yStr, mStr] = (ymStr || '').split('-');
                        const year = Number(yStr);
                        const monthNum = Number(mStr);
                        const daysInMonth = new Date(year, monthNum, 0).getDate();
                        const extraCols = 12;
                        const targetBase = 31;
                        let scale = targetBase / (daysInMonth + extraCols);
                        scale = Math.max(0.55, Math.min(0.95, scale));
                        const html = `<!doctype html><html><head><meta charset="utf-8"><title>å‡ºå‹¤æœˆå ±è¡¨</title>
                        <style>
                            @page { size: A4 landscape; margin: 10mm; }
                            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            body { font-family: system-ui,-apple-system,Segoe UI,Roboto,\"Helvetica Neue\",Arial,\"Noto Sans\",sans-serif; color: #111; }
                            h1 { font-size: 14px; margin-bottom: 6px; }
                            table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                            thead th { background: #f9fafb; }
                            th, td { border: 1px solid #d1d5db; padding: 2px 3px; font-size: 10px; }
                            th:first-child, td:first-child { text-align: left; }
                            th:not(:first-child), td:not(:first-child) { text-align: center; white-space: nowrap; }
                            tr { page-break-inside: avoid; }
                            #print-wrap { transform: scale(${scale}); transform-origin: top left; width: calc(100% / ${scale}); }
                        </style>
                        </head><body>
                        <h1>å‡ºå‹¤æœˆå ±è¡¨ï¼š${ymStr}ï¼ˆ${userLabel}ï¼‰</h1>
                        <div id="print-wrap">${table.outerHTML}</div>
                        </body></html>`;
                        const w = window.open('', '_blank');
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                        w.focus();
                        w.print();
                    } catch (err) {
                        console.error('printMonthlyReport error', err);
                        showToast && showToast('åˆ—å°å¤±æ•—', true);
                    }
                }
            }

            // äººäº‹ > æ‰“å¡åˆ—è¡¨ï¼šè¤‡è£½ã€Œæ‰“å¡ç´€éŒ„ã€ä¸¦æä¾›å¸³è™Ÿç¯©é¸ï¼ˆå«ã€Œæ‰€æœ‰å¸³è™Ÿã€ï¼‰
            function renderHRClockList(container) {
                const today = new Date().toISOString().split('T')[0];
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex items-center flex-wrap gap-2">
                            <label for="hr-record-user" class="text-sm font-medium">å¸³è™Ÿ:</label>
                            <select id="hr-record-user" class="border border-gray-300 rounded-md px-2 py-1">
                                <option value="__ALL__">æ‰€æœ‰å¸³è™Ÿ</option>
                            </select>
                            <label for="hr-record-date" class="text-sm font-medium">ç¯©é¸æ—¥æœŸ:</label>
                            <input type="date" id="hr-record-date" value="${today}" class="border border-gray-300 rounded-md px-2 py-1">
                            <button id="hr-open-month-report" class="ml-2 px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">æœˆå ±è¡¨</button>
                        </div>
                        <div id="hr-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å€™...</div>
                        </div>
                    </div>
                `;

                try { lucide.createIcons(); } catch(e) {}

                const listElInit = document.getElementById('hr-records-list');
                let tries = 0; const maxTries = 120; // ~12sï¼ˆGitHub Pages åˆå§‹åŒ–å¯èƒ½è¼ƒæ…¢ï¼‰
                const waitReady = () => {
                    const dbReady = !!window.__db;
                    const fsReady = !!window.__fs && !!window.__fs.collection && !!window.__fs.query && !!window.__fs.onSnapshot;
                    if (dbReady && fsReady) {
                        start();
                    } else if (tries < maxTries) {
                        tries++; setTimeout(waitReady, 100);
                    } else {
                        if (listElInit) listElInit.innerHTML = '<div class="text-center text-red-500 p-4">ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
                    }
                };
                // è‹¥å…¶ä»–è…³æœ¬åœ¨ç¨å¾Œæ‰å®Œæˆåˆå§‹åŒ–ï¼Œé€éäº‹ä»¶é€šçŸ¥é‡æ–°é–‹å§‹
                try { window.addEventListener('firebase-ready', () => { try { start(); } catch (e) {} }); } catch (e) {}
                waitReady();

                function start() {
                    const db = window.__db; const fs = window.__fs || {};
                    const { collection, query, where, onSnapshot, getDocs, Timestamp } = fs;

                    const userSelect = document.getElementById('hr-record-user');
                    const dateInput = document.getElementById('hr-record-date');
                    const monthBtn = document.getElementById('hr-open-month-report');

                    // è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®ä¾›ä¸‹æ‹‰é¸æ“‡ï¼ˆå„ªå…ˆ Firestoreï¼Œå¤±æ•—æ™‚ä½¿ç”¨å¿«å– fallbackï¼‰
                    const usersRef = collection(db, 'users');
                    const userMap = {};
                    (async () => {
                        let loaded = false;
                        try {
                            const qs = await (getDocs ? getDocs(usersRef) : Promise.resolve(null));
                            if (qs) {
                                const users = [];
                                qs.forEach(doc => {
                                    const data = doc.data() || {};
                                    const name = data.name || data.displayName || data.account || data.email || doc.id;
                                    users.push({ id: doc.id, name });
                                    userMap[doc.id] = name;
                                });
                                users.sort((a,b) => String(a.name).localeCompare(String(b.name), 'zh-TW'));
                                users.forEach(u => {
                                    // é¿å…é‡è¤‡åŠ å…¥
                                    if (![...userSelect.options].some(o => o.value === u.id)) {
                                        const opt = document.createElement('option');
                                        opt.value = u.id; opt.textContent = `${u.name}`;
                                        userSelect.appendChild(opt);
                                    }
                                });
                                loaded = true;
                            }
                        } catch(e) { console.warn('è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®å¤±æ•—ï¼ˆFirestoreï¼‰', e); }

                        // è‹¥ Firestore è®€å–å¤±æ•—æˆ–å°šæœªè¼‰å…¥ï¼Œå˜—è©¦ä½¿ç”¨å¿«å–å‡½å¼ï¼ˆjs/calendar.jsï¼‰
                        if (!loaded) {
                            try {
                                if (typeof window.fetchUsersOnce === 'function') {
                                    const cached = await window.fetchUsersOnce();
                                    const users = Object.keys(cached).map(id => ({ id, name: cached[id] }));
                                    users.sort((a,b) => String(a.name).localeCompare(String(b.name), 'zh-TW'));
                                    users.forEach(u => {
                                        if (![...userSelect.options].some(o => o.value === u.id)) {
                                            const opt = document.createElement('option');
                                            opt.value = u.id; opt.textContent = `${u.name}`;
                                            userSelect.appendChild(opt);
                                        }
                                        userMap[u.id] = u.name;
                                    });
                                    loaded = true;
                                }
                            } catch(e) { console.warn('è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®å¤±æ•—ï¼ˆå¿«å– fallbackï¼‰', e); }
                        }
                    })();

                    let unsubscribe = null;
                    const loadRecords = () => {
                        if (typeof unsubscribe === 'function') { try { unsubscribe(); } catch(e) {} }
                        const selectedDate = new Date(dateInput.value);
                        const startOfDay = new Date(selectedDate); startOfDay.setHours(0,0,0,0);
                        const endOfDay = new Date(selectedDate); endOfDay.setHours(23,59,59,999);
                        const recordsRef = collection(db, 'clockInRecords');
                        const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                        const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                        const sel = userSelect.value || '__ALL__';
                        const constraints = [where('timestamp', '>=', startTS), where('timestamp', '<=', endTS)];
                        if (sel !== '__ALL__') constraints.unshift(where('userId', '==', sel));
                        const q = query(recordsRef, ...constraints);

                        unsubscribe = onSnapshot(q, (querySnapshot) => {
                            const listEl = document.getElementById('hr-records-list'); if (!listEl) return;
                            if (querySnapshot.empty) { listEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æ—¥ç„¡æ‰“å¡ç´€éŒ„</p>`; return; }
                            const records = []; querySnapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                            const filtered = records.filter(r => {
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                                if (!ts) return false; return ts >= startOfDay && ts <= endOfDay;
                            }).sort((a,b) => {
                                const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                                const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                                return tb - ta;
                            });

                            // ç•¶è¼‰å…¥ users é›†åˆå¤±æ•—æˆ–å°šæœªè¼‰å…¥æ™‚ï¼Œå‹•æ…‹ä»¥ä»Šæ—¥ç´€éŒ„è£œé½Šå¸³è™Ÿé¸é …
                            try {
                                if (userSelect && userSelect.options.length <= 1) {
                                    const ids = new Set(filtered.map(r => r.userId).filter(Boolean));
                                    ids.forEach(uid => {
                                        const name = userMap[uid] || (filtered.find(r => r.userId === uid)?.userName) || uid;
                                        const opt = document.createElement('option');
                                        opt.value = uid; opt.textContent = name;
                                        userSelect.appendChild(opt);
                                        userMap[uid] = name;
                                    });
                                }
                            } catch (e) { /* ignore */ }

                            listEl.innerHTML = '';
                            filtered.forEach(record => {
                                const card = document.createElement('div');
                                card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
                                const statusText = getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null);
                                const statusColor = getStatusColor(statusText);
                                const tsText = formatDate(record.timestamp);
                                const displayName = userMap[record.userId] || record.userName || 'æœªçŸ¥ä½¿ç”¨è€…';
                                card.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                            <p class="text-sm text-gray-600">${tsText}</p>
                                            <p class="text-xs text-gray-500">ä½¿ç”¨è€…ï¼š${displayName}</p>
                                        </div>
                                    </div>
                                    <div class="mt-2 flex space-x-2 overflow-x-auto">
                                        <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                            data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                            data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                            <i data-lucide="image"></i> ç…§ç‰‡ (${(record.photoUrls?.length || 0)})
                                        </button>
                                        <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                            <i data-lucide="map-pin"></i> åœ°åœ–
                                        </button>
                                    </div>
                                `;
                                listEl.appendChild(card);
                            });

                            try { lucide.createIcons(); } catch(e) {}

                            document.querySelectorAll('.map-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const lat = parseFloat(e.currentTarget.dataset.lat);
                                    const lng = parseFloat(e.currentTarget.dataset.lng);
                                    if (lat && lng) openMapModal(lat, lng); else showToast('ç„¡ä½ç½®è³‡è¨Šå¯é¡¯ç¤º', true);
                                });
                            });

                            document.querySelectorAll('.photo-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                    const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                    openPhotoModal(photos, descriptions);
                                });
                            });
                        }, (error) => {
                            console.error('HR è®€å–æ‰“å¡ç´€éŒ„å¤±æ•—', error);
                            const listEl = document.getElementById('hr-records-list');
                            if (listEl) {
                                const hint = (error?.code === 'failed-precondition') ? 'å¯èƒ½éœ€è¦å»ºç«‹è¤‡åˆç´¢å¼•ï¼ˆuserId + timestampï¼‰ã€‚' : 'è«‹ç¢ºèª Firestore è¦å‰‡èˆ‡ç¶²è·¯ç‹€æ³ã€‚';
                                listEl.innerHTML = `<div class="text-center text-red-500 p-4">è®€å–ç´€éŒ„å¤±æ•—ã€‚${hint}</div>`;
                            }
                        });
                    };

                    dateInput.addEventListener('change', loadRecords);
                    userSelect.addEventListener('change', loadRecords);
                    loadRecords();

                    // é˜²è­·ï¼šè‹¥æœ¬åœ°å‡½å¼å­˜åœ¨ä½†æœªç¶åˆ° windowï¼Œè£œç¶ä¸€æ¬¡
                    try {
                        if (typeof window.renderPersonalMonthlyReport !== 'function' && typeof renderPersonalMonthlyReport === 'function') {
                            window.renderPersonalMonthlyReport = renderPersonalMonthlyReport;
                        }
                    } catch (_) {}

                    // HR æœˆå ±è¡¨ï¼šéœ€é¸æ“‡ç‰¹å®šä½¿ç”¨è€…å¾Œé–‹å•Ÿæœˆä»½é¸æ“‡
                    monthBtn?.addEventListener('click', () => {
                        const sel = userSelect.value || '__ALL__';
                        if (sel === '__ALL__') { showToast('è«‹å…ˆé¸æ“‡ç‰¹å®šå¸³è™Ÿ', true); return; }
                        const userName = userMap[sel] || sel;
                        const now = new Date();
                        const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                        modal.innerHTML = `
                            <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md overflow-hidden">
                                <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between">
                                    <h3 class="font-semibold">é¸æ“‡æœˆä»½ï¼ˆ${userName}ï¼‰</h3>
                                    <button class="close-month-modal"><i data-lucide="x" class="w-5 h-5"></i></button>
                                </div>
                                <div class="p-4 space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">æœˆä»½</label>
                                        <input type="month" id="hr-month-input" value="${ym}" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    </div>
                                    <div class="flex justify-end space-x-2">
                                        <button class="close-month-modal px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">å–æ¶ˆ</button>
                                        <button id="hr-gen-month-report" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ç”Ÿæˆæœˆå ±è¡¨</button>
                                    </div>
                                </div>
                            </div>`;
                        document.body.appendChild(modal);
                        try { lucide.createIcons(); } catch(e) {}
                        modal.querySelectorAll('.close-month-modal').forEach(btn => btn.addEventListener('click', () => document.body.removeChild(modal)));
                        modal.querySelector('#hr-gen-month-report').addEventListener('click', async () => {
                            const mi = document.getElementById('hr-month-input').value || ym;
                            if (!mi) { showToast && showToast('è«‹é¸æ“‡æœˆä»½', true); return; }
                            document.body.removeChild(modal);
                            try {
                                if (typeof window.renderPersonalMonthlyReport === 'function') {
                                    await window.renderPersonalMonthlyReport(sel, userName, mi);
                                } else {
                                    showToast && showToast('ç„¡æ³•æ‰¾åˆ°å€‹äººæœˆå ±è¡¨åŠŸèƒ½', true);
                                }
                            } catch (e) {
                                console.error('ç”Ÿæˆå€‹äººæœˆå ±è¡¨å¤±æ•—', e);
                                showToast && showToast('ç”Ÿæˆå€‹äººæœˆå ±è¡¨å¤±æ•—', true);
                            }
                        });
                    });
                }
            }

            // äººäº‹ > æœˆå ±è¡¨å­åˆ†é ï¼šæ”¹ç‚ºåˆ—è¡¨é¡¯ç¤ºï¼ˆå§“åï½œæœˆå ±è¡¨ç”Ÿæˆï¼‰
            function renderHRMonthly(container) {
                // å·²ä¸‹ç·šï¼šä¿ç•™å‡½å¼ç°½åé¿å…èˆŠé€£çµå ±éŒ¯
                container.innerHTML = `<div class="p-4 text-gray-500">ã€Œäººäº‹/æœˆå ±è¡¨ã€åŠŸèƒ½å·²ç§»é™¤ã€‚</div>`;
                return;
                const today = new Date();
                const defaultMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                container.innerHTML = `
                    <div class="p-4 space-y-2">
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto border border-gray-200 rounded-md">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left px-3 py-2 border-b">å§“å</th>
                                        <th class="text-left px-3 py-2 border-b">æœˆå ±è¡¨</th>
                                    </tr>
                                </thead>
                                <tbody id="hr-monthly-list"></tbody>
                            </table>
                        </div>
                        <div class="text-xs text-gray-500">æç¤ºï¼šé»æ“Šã€Œç”Ÿæˆã€é¸æ“‡æœˆä»½å¾Œï¼Œæœƒç”¢å‡ºè©²äººå“¡è©²æœˆä»½å¯åˆ—å°çš„å€‹äººæœˆå ±è¡¨ã€‚</div>
                    </div>`;
                try { lucide.createIcons(); } catch(e) {}

                const db = window.__db;
                const { collection, getDocs } = window.__fs || {};
                if (!db || !collection || !getDocs) {
                    container.innerHTML = '<div class="p-4 text-red-600">ç³»çµ±æœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
                    return;
                }

                const usersRef = collection(db, 'users');
                const tbody = container.querySelector('#hr-monthly-list');
                const users = [];

                getDocs(usersRef).then((qs) => {
                    qs.forEach(doc => {
                        const data = doc.data() || {};
                        const name = data.name || data.displayName || data.account || data.email || doc.id;
                        users.push({ id: doc.id, name });
                    });
                    users.sort((a,b) => String(a.name).localeCompare(String(b.name), 'zh-Hant'));
                    users.forEach(u => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-3 py-2 border-b">${u.name}</td>
                            <td class="px-3 py-2 border-b">
                                <button class="gen-month-btn px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700" data-userid="${u.id}" data-username="${u.name}">ç”Ÿæˆ</button>
                            </td>`;
                        tbody.appendChild(tr);
                    });
                    bindGenButtons();
                }).catch(e => {
                    console.warn('è¼‰å…¥äººå“¡å¤±æ•—', e);
                    tbody.innerHTML = '<tr><td class="px-3 py-2 text-red-600" colspan="2">è¼‰å…¥äººå“¡å¤±æ•—</td></tr>';
                });

                // é˜²è­·ï¼šè‹¥æœ¬åœ°å‡½å¼å­˜åœ¨ä½†æœªç¶åˆ° windowï¼Œè£œç¶ä¸€æ¬¡
                try {
                    if (typeof window.renderPersonalMonthlyReport !== 'function' && typeof renderPersonalMonthlyReport === 'function') {
                        window.renderPersonalMonthlyReport = renderPersonalMonthlyReport;
                    }
                } catch (_) {}

                function openUserMonthModal(userId, userName) {
                    const now = new Date();
                    const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md overflow-hidden">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between">
                                <h3 class="font-semibold">é¸æ“‡æœˆä»½</h3>
                                <button class="close-month-modal"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">æœˆä»½</label>
                                    <input type="month" id="month-input" value="${ym}" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button class="close-month-modal px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button id="gen-user-month-report" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ç”Ÿæˆæœˆå ±è¡¨</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    try { lucide.createIcons(); } catch(e) {}
                    modal.querySelectorAll('.close-month-modal').forEach(btn => btn.addEventListener('click', () => document.body.removeChild(modal)));
                    modal.querySelector('#gen-user-month-report').addEventListener('click', async () => {
                        const mi = document.getElementById('month-input').value || defaultMonth;
                        if (!mi) { showToast && showToast('è«‹é¸æ“‡æœˆä»½', true); return; }
                        document.body.removeChild(modal);
                        try {
                            if (typeof window.renderPersonalMonthlyReport === 'function') {
                                await window.renderPersonalMonthlyReport(userId, userName, mi);
                            } else {
                                showToast && showToast('ç„¡æ³•æ‰¾åˆ°å€‹äººæœˆå ±è¡¨åŠŸèƒ½', true);
                            }
                        } catch (e) {
                            console.error('ç”Ÿæˆå€‹äººæœˆå ±è¡¨å¤±æ•—', e);
                            showToast && showToast('ç”Ÿæˆå€‹äººæœˆå ±è¡¨å¤±æ•—', true);
                        }
                    });
                }

                function bindGenButtons() {
                    container.querySelectorAll('.gen-month-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const uid = btn.dataset.userid;
                            const uname = btn.dataset.username;
                            openUserMonthModal(uid, uname);
                        });
                    });
                }
            }

            // ç¾¤çµ„åˆ†é ï¼šäººå“¡åœ°åœ–ã€å‡ºå‹¤ç´€éŒ„ï¼ˆåƒ…é¡¯ç¤ºæŒ‡å®šæˆå“¡ï¼‰
            function renderGroup(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="map" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'map' || !subPage ? 'active' : ''}">äººå“¡åœ°åœ–</button>
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">å‡ºå‹¤ç´€éŒ„</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'attendance') {
                    renderGroupAttendance(subPageContent);
                } else {
                    renderGroupMap(subPageContent);
                }
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('group', btn.dataset.subtab)));
            }

            function renderGroupMap(container) {
                container.innerHTML = `
                    <div class="h-full w-full relative">
                        <div id="group-map" class="h-full w-full"></div>
                        <div id="group-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
<button id="group-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>å›åˆ°å…¬å¸
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-2">
                            <div id="group-user-list" class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg max-h-[150px] overflow-y-auto p-2 space-y-2"></div>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                if (state.googleMapsLoaded) {
                    initGroupMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) { clearInterval(interval); initGroupMap(); }
                    }, 100);
                }
            }

            async function initGroupMap() {
                const mapDiv = document.getElementById('group-map');
                const mapLoader = document.getElementById('group-map-loader');
                if (!mapDiv || !mapLoader) return;
                let mapCenter = { lat: 25.0330, lng: 121.5654 };
                try {
                    const docSnap = await getDoc(doc(db, "settings", "location"));
                    if (docSnap.exists()) {
                        const s = docSnap.data();
                        if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                            mapCenter = { lat: s.companyLat, lng: s.companyLng };
                        }
                    }
                } catch (e) { console.warn("è¼‰å…¥å…¬å¸ä½ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä¸­å¿ƒé»", e); }
                state.groupMap = new google.maps.Map(mapDiv, { center: mapCenter, zoom: 12, disableDefaultUI: true, zoomControl: true, mapId: 'DEMO_MAP_ID' });
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('group-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.groupMap.panTo(state.companyCenter);
                            state.groupMap.setZoom(14);
                        } else {
                            showToast('å°šæœªè¨­å®šå…¬å¸åº§æ¨™', true);
                        }
                    });
                }
                mapLoader.classList.add('hide');
                listenForGroupUserLocations();
            }

            async function listenForGroupUserLocations() {
                const allowedUserIds = await loadJuniorManagerAllowedUsers(state.currentUserData.id);
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));
                const unsubscribe = onSnapshot(q, async (querySnapshot) => {
                    const listEl = document.getElementById('group-user-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    if (!Array.isArray(allowedUserIds) || allowedUserIds.length === 0) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-2">å°šæœªç”±ç®¡ç†å“¡è¨­å®šå¯æŸ¥çœ‹äººå“¡</p>`;
                        return;
                    }
                    // æ¸…é™¤èˆŠæ¨™è¨˜
                    (state.groupMarkers || []).forEach(m => m.map = null);
                    state.groupMarkers = [];

                    const users = [];
                    querySnapshot.forEach(doc => { const data = { id: doc.id, ...doc.data() }; if (allowedUserIds.includes(data.id)) users.push(data); });
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {}
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    const latestMap = {};
                    try {
                        await Promise.all(visibleUsersList.map(async (u) => {
                            const recQ = query(
                                collection(db, 'clockInRecords'),
                                where('userId', '==', u.id),
                                orderBy('timestamp', 'desc'),
                                limit(1)
                            );
                            const snap = await getDocs(recQ);
                            if (!snap.empty) {
                                latestMap[u.id] = snap.docs[0].data();
                            }
                        }));
                    } catch (e) {}
                    visibleUsersList.sort((a, b) => {
                        const recA = latestMap[a.id];
                        const recB = latestMap[b.id];
                        const statusA = recA ? getStatusDisplayText(recA.type || 'æœªçŸ¥', recA.locationName || null, recA.dutyType || null) : getStatusDisplayText(a.clockInStatus || 'æœªæ‰“å¡', a.lastLocation?.address, a.dutyType);
                        const statusB = recB ? getStatusDisplayText(recB.type || 'æœªçŸ¥', recB.locationName || null, recB.dutyType || null) : getStatusDisplayText(b.clockInStatus || 'æœªæ‰“å¡', b.lastLocation?.address, b.dutyType);
                        if (statusA.includes('ä¸Šç­ä¸­') && !statusB.includes('ä¸Šç­ä¸­')) return -1;
                        if (!statusA.includes('ä¸Šç­ä¸­') && statusB.includes('ä¸Šç­ä¸­')) return 1;
                        if (statusA.includes('ä¸Šç­ä¸­') && statusB.includes('ä¸Šç­ä¸­')) {
                            const timeA = (recA?.timestamp?.toDate?.() || (a.lastClockInTime?.toDate?.() || new Date(0)));
                            const timeB = (recB?.timestamp?.toDate?.() || (b.lastClockInTime?.toDate?.() || new Date(0)));
                            return timeA - timeB;
                        }
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    });
                    visibleUsersList.forEach(user => {
                        const hasLocation = user.lastLocation && user.lastLocation.latitude;
                        const userElement = document.createElement('div');
                        userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                        const latest = latestMap[user.id] || null;
                        const locText = latest?.locationName || ((['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(user.clockInStatus) && user.outboundLocation) ? user.outboundLocation : user.lastLocation?.address);
                        const statusText = latest ? getStatusDisplayText(latest.type || 'æœªçŸ¥', latest.locationName || null, latest.dutyType || null)
                                                  : (getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locText, user.dutyType) || 'æœªæ‰“å¡');
                        const latestTime = latest ? (latest.timestamp?.toDate?.() || (latest.timestamp ? new Date(latest.timestamp) : null))
                                                  : (user.lastClockInTime?.toDate?.() || null);
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-sm text-gray-800">${user.name}</p>
                                    <p class="text-xs text-gray-500">${statusText}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${latestTime ? 'æœ€è¿‘ç‹€æ…‹æ™‚é–“ï¼š' + timeAgo(latestTime) : 'ç„¡ç´€éŒ„'}</span>
                        `;
                        listEl.appendChild(userElement);
                        if (hasLocation) {
                            const position = { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                            const markerIcon = document.createElement('img');
                            markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`;
                            markerIcon.className = "w-9 h-9 rounded-full border-2 border-white shadow-md object-cover";
                            const marker = new AdvancedMarkerElement({ position, map: state.groupMap, title: user.name, content: markerIcon });
                            const infoWindow = new google.maps.InfoWindow({ content: `
                                <div class="p-1">
                                    <p class="font-bold">${user.name}</p>
                                    <p>ç‹€æ…‹: ${statusText}</p>
                                    <p>æœ€è¿‘ç‹€æ…‹æ™‚é–“: ${latestTime ? formatDateTime(latestTime) : 'N/A'}</p>
                                </div>` });
                            marker.addListener('click', () => infoWindow.open({ anchor: marker, map: state.groupMap }));
                            userElement.addEventListener('click', () => { state.groupMap.panTo(position); state.groupMap.setZoom(17); infoWindow.open({ anchor: marker, map: state.groupMap }); });
                            state.groupMarkers.push(marker);
                        }
                    });
                });
                state.activeListeners.push(unsubscribe);
            }

            function renderGroupAttendance(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="group-user-select" class="text-sm font-medium">é¸æ“‡äººå“¡:</label>
                                <select id="group-user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">ç”±ç®¡ç†å“¡æŒ‡å®šåå–®</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="group-record-date" class="text-sm font-medium">é¸æ“‡æ—¥æœŸ:</label>
                                <input type="date" id="group-record-date" value="${new Date().toISOString().split('T')[0]}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                        </div>
                        <div id="group-attendance-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>
                        </div>
                    </div>`;

                const userSelect = document.getElementById('group-user-select');
                const dateInput = document.getElementById('group-record-date');

                loadJuniorManagerAllowedUsers(state.currentUserData.id).then(ids => {
                    if (!ids || ids.length === 0) return;
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((qs) => {
                        const users = [];
                        qs.forEach(doc => { const d = { id: doc.id, ...doc.data() }; if (ids.includes(d.id)) users.push(d); });
                        users.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(u => {
                            const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.name; userSelect.appendChild(opt);
                        });
                        const loadRecords = () => renderAttendanceRecordsList('group-attendance-records-list', userSelect.value, dateInput.value, ids);
                        userSelect.addEventListener('change', loadRecords);
                        dateInput.addEventListener('change', loadRecords);
                        loadRecords();
                    });
                });
            }

            // æˆ‘çš„ç­è¡¨å­åˆ†é ï¼šé¡¯ç¤ºæœ¬æœˆä¸Šç­æ—¥æœŸèˆ‡æ’å®šæ™‚é–“èˆ‡ç‹€æ…‹ï¼Œå«æœˆä»½åˆ‡æ›èˆ‡å¿«æ·é€£çµ
            function renderClockInSchedule(container) {
                // å·²ä¸‹ç·šï¼šæ­¤åŠŸèƒ½ä¸å†æä¾›
                container.innerHTML = `<div class="p-8 text-center text-gray-500">ã€Œæˆ‘çš„ç­è¡¨ã€å·²ç§»é™¤ï¼Œè«‹æ”¹ç”¨å…¶ä»–åŠŸèƒ½ã€‚</div>`;
                return;
                const now = new Date();
                let viewYear = now.getFullYear();
                let viewMonth = now.getMonth(); // 0-based

                // è®€å–å‡æ—¥è¨­å®šä»¥æ±ºå®šé è¨­æ˜¯å¦ç‚ºå·¥ä½œæ—¥ï¼ˆæ–¼ render() æ™‚å‹•æ…‹è®€å–æœ€æ–°å¿«å–ï¼‰
                const getIsHoliday = async () => {
                    try { if (typeof fetchHolidaySettingsOnce === 'function') await fetchHolidaySettingsOnce(); } catch (e) {}
                    const holidaySettings = window.__holidaySettingsCache || { weekendIsHoliday: false, holidays: [] };
                    const holidaysSet = new Set(holidaySettings.holidays || []);
                    return (date) => {
                        const ymd = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                        const weekend = date.getDay() === 0 || date.getDay() === 6;
                        return holidaysSet.has(ymd) || (holidaySettings.weekendIsHoliday && weekend);
                    };
                };

                const renderShell = () => {
                    container.innerHTML = `
                        <div class="p-4 space-y-4 h-full">
                            <div class="bg-white rounded-lg shadow-sm border p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">
                                        æˆ‘çš„ç­è¡¨ï¼ˆ<span id="schedule-month-label">${viewYear}å¹´${viewMonth+1}æœˆ</span>ï¼‰
                                    </h2>
                                    <div class="flex items-center gap-2">
                                        <button id="prev-month" class="px-2 py-1 border rounded hover:bg-gray-100 text-sm">ä¸Šä¸€æœˆ</button>
                                        <button id="today-month" class="px-2 py-1 border rounded hover:bg-gray-100 text-sm">å›åˆ°ç•¶æœˆ</button>
                                        <button id="next-month" class="px-2 py-1 border rounded hover:bg-gray-100 text-sm">ä¸‹ä¸€æœˆ</button>
                                    </div>
                                </div>
                                <div class="overflow-auto">
                                    <table class="w-full border border-gray-300 text-sm">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="border px-2 py-1">æ—¥æœŸ(DD)</th>
                                                <th class="border px-2 py-1">æ˜ŸæœŸ</th>
                                                <th class="border px-2 py-1">æ’å®šä¸Šç­æ™‚é–“</th>
                                                <th class="border px-2 py-1">æ’å®šä¸‹ç­æ™‚é–“</th>
                                                <th class="border px-2 py-1">ç‹€æ…‹</th>
                                                <th class="border px-2 py-1">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="my-schedule-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`;
                };

                const fetchWorkdays = async (ymKey) => {
                    const db = window.__db; const { doc, getDoc } = window.__fs;
                    let daysMap = {};
                    const [yearStr, monthStr] = (ymKey || '').split('-');
                    const makeYmd = (d) => `${yearStr}-${monthStr}-${String(Number(d)).padStart(2,'0')}`;
                    const applyArrayDays = (arr) => {
                        if (!Array.isArray(arr)) return;
                        arr.forEach(n => {
                            const ymd = makeYmd(n);
                            // è‹¥è©²æ—¥å°šæœªæœ‰è¨­å®šï¼Œå¥—ç”¨é è¨­æ™‚æ®µï¼Œè®“ç­è¡¨èƒ½é¡¯ç¤ºç‚ºä¸Šç­æ—¥
                            if (!daysMap[ymd]) {
                                daysMap[ymd] = { start: '09:00', end: '17:30' };
                            }
                        });
                    };
                    try {
                        // å…¨åŸŸè¨­å®šï¼šsettings/workdays_YYYY-MM
                        const settingsDocSnap = await getDoc(doc(db, 'settings', `workdays_${ymKey}`));
                        if (settingsDocSnap.exists()) {
                            const sd = settingsDocSnap.data();
                            if (sd && sd.days) {
                                if (typeof sd.days === 'object' && !Array.isArray(sd.days)) {
                                    daysMap = { ...sd.days };
                                } else if (Array.isArray(sd.days)) {
                                    applyArrayDays(sd.days);
                                }
                            }
                        }
                    } catch (e) { console.warn('è®€å–å…¨åŸŸä¸Šç­è¨­å®šå¤±æ•—', e); }
                    try {
                        // å€‹äººè¦†è“‹ï¼šusers/{uid}/workdays/{YYYY-MM}
                        const user = window.__auth?.currentUser;
                        if (user) {
                            const userDocSnap = await getDoc(doc(db, 'users', user.uid, 'workdays', ymKey));
                            if (userDocSnap.exists()) {
                                const ud = userDocSnap.data();
                                if (ud && ud.days) {
                                    if (typeof ud.days === 'object' && !Array.isArray(ud.days)) {
                                        daysMap = { ...daysMap, ...ud.days };
                                    } else if (Array.isArray(ud.days)) {
                                        // é™£åˆ—ä»£è¡¨ã€Œä¸Šç­è¨­å®šã€é é¢é¸å–çš„æ—¥æœŸï¼ˆç„¡æ™‚é–“ï¼‰ï¼Œè½‰ç‚ºé è¨­æ™‚æ®µ
                                        applyArrayDays(ud.days);
                                    }
                                }
                            }
                        }
                    } catch (e) { console.warn('è®€å–å€‹äººä¸Šç­è¨­å®šå¤±æ•—', e); }
                    return daysMap;
                };

                const fetchDutiesAndRoster = async (year, month) => {
                    const db = window.__db; const { collection, where, query, getDocs } = window.__fs || {};
                    const startOfMonth = new Date(year, month, 1, 0, 0, 0, 0);
                    const endOfMonth = new Date(year, month + 1, 0, 23, 59, 59, 999);
                    // ç‰¹æ®Šå‹¤å‹™ï¼ˆæ´»å‹•/æ”¯æ´ç­‰ï¼‰
                    let duties = [];
                    try {
                        const dq = query(collection(db, 'specialDuties'), where('userId','==', state.currentUser.uid));
                        const ds = await getDocs(dq);
                        ds.forEach(doc => duties.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('è®€å–ç‰¹æ®Šå‹¤å‹™å¤±æ•—', e); }
                    // å€¼ç­åå–®ï¼ˆé€±äº” rosterï¼‰
                    let fridayDutyRoster = {};
                    try {
                        const { doc, getDoc } = window.__fs || {};
                        const settingsRef = doc(db, 'settings', 'general');
                        const settingsSnap = await getDoc(settingsRef);
                        fridayDutyRoster = settingsSnap.exists() ? (settingsSnap.data().fridayDutyRoster || {}) : {};
                    } catch (e) { console.warn('è®€å–å€¼ç­åå–®å¤±æ•—', e); }
                    // è«‹å‡è³‡æ–™ï¼ˆè¦†è“‹è©²æœˆä»»ä½•ä¸€å¤©ï¼‰
                    let leaves = [];
                    try {
                        const lq = query(collection(db, 'leaves'), where('userId','==', state.currentUser.uid));
                        const ls = await getDocs(lq);
                        ls.forEach(doc => leaves.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('è®€å–è«‹å‡å¤±æ•—', e); }
                    return { duties, fridayDutyRoster, leaves, startOfMonth, endOfMonth };
                };

                const render = async () => {
                    const ymKey = `${viewYear}-${String(viewMonth + 1).padStart(2, '0')}`;
                    renderShell();
                    const labelEl = container.querySelector('#schedule-month-label');
                    if (labelEl) labelEl.textContent = `${viewYear}å¹´${viewMonth+1}æœˆ`;
                    const bodyEl = container.querySelector('#my-schedule-body');
                    const daysMap = await fetchWorkdays(ymKey);
                    const { duties, fridayDutyRoster, leaves } = await fetchDutiesAndRoster(viewYear, viewMonth);
                    const isHoliday = await getIsHoliday();
                    const weekdayZh = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
                    bodyEl.innerHTML = '';
                    const myUid = state.currentUser?.uid;
                    const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                    const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dayStart = new Date(viewYear, viewMonth, d, 0, 0, 0, 0);
                        const dayEnd = new Date(viewYear, viewMonth, d, 23, 59, 59, 999);
                        const w = dayStart.getDay();
                        const ymd = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const defaultIsWorkday = !isHoliday(dayStart) && (w >= 1 && w <= 4); // é€±ä¸€~é€±å››ç‚ºä¸Šç­æ—¥ï¼›é€±äº”ä¸ç®—ä¸Šç­æ—¥
                        const existing = daysMap && daysMap[ymd] ? daysMap[ymd] : null;
                        // é€±äº”ä¸€å¾‹ä¸ä¾æ“šä¸Šç­è¨­å®šé¡¯ç¤ºç‚ºä¸Šç­æ—¥
                        const startDefault = (w === 5) ? '' : (existing?.start || (defaultIsWorkday ? '09:00' : ''));
                        const endDefault = (w === 5) ? '' : (existing?.end || (defaultIsWorkday ? '17:30' : ''));

                        // ç‹€æ…‹åˆ¤æ–·ï¼šè«‹å‡æ—¥å„ªå…ˆï¼Œå…¶æ¬¡å€¼ç­æ—¥ï¼Œå†æ¬¡æ´»å‹•æ”¯æ´ï¼Œå¦å‰‡ä¸Šç­æ—¥
                        const isLeave = Array.isArray(leaves) && leaves.some(l => {
                            const s = l.startTime?.toDate?.() || (l.startTime ? new Date(l.startTime) : null);
                            const e = l.endTime?.toDate?.() || (l.endTime ? new Date(l.endTime) : null);
                            if (!s || !e) return false;
                            return s <= dayEnd && e >= dayStart; // overlap
                        });
                        const arr = fridayDutyRoster[ymd] || [];
                        const normalize = (s) => (s || '').trim();
                        const isRosterDuty = Array.isArray(arr) && (arr.includes(myUid) || arr.some(n => normalize(n) === normalize(myName)));
                        const isSpecialDuty = duties.some(di => {
                            const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                            const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                            if (!s || !e) return false;
                            return s <= dayEnd && e >= dayStart; // overlap
                        });

                        // é¡¯ç¤ºæ¢ä»¶ï¼š
                        // - å‡æ—¥å„ªå…ˆï¼šå‡æ—¥ä¸é¡¯ç¤ºã€Œä¸Šç­æ—¥ã€ï¼Œä½†è‹¥ç‚ºå€¼ç­æˆ–æ´»å‹•æ”¯æ´ï¼Œä»å¯é¡¯ç¤º
                        // - å¹³æ—¥ï¼šé€±ä¸€~é€±å››ç‚ºä¸Šç­æ—¥ï¼›é€±äº”åƒ…é¡¯ç¤ºå€¼ç­æˆ–æ´»å‹•æ”¯æ´
                        const isWeekdayWork = Boolean(startDefault) || Boolean(endDefault); // åƒ…é€±ä¸€~é€±å››å¯èƒ½ç‚º true
                        const shouldShow = isRosterDuty || isSpecialDuty || (isWeekdayWork && !isHoliday(dayStart));
                        if (!shouldShow) continue;

                        let statusLabel = 'ä¸Šç­æ—¥';
                        if (isLeave) statusLabel = 'è«‹å‡æ—¥';
                        else if (isRosterDuty) statusLabel = 'å€¼ç­æ—¥';
                        else if (isSpecialDuty) statusLabel = 'æ´»å‹•æ”¯æ´';

                        const isFuture = dayStart > endOfToday;
                        // å€¼ç­æ—¥ä¸€å¾‹é¡¯ç¤º 09:00~17:30ï¼ˆå³ä¾¿é€±äº”ä¸æ˜¯é è¨­ä¸Šç­æ—¥ï¼‰
                        const startDisp = isRosterDuty ? '09:00' : (startDefault || '');
                        const endDisp = isRosterDuty ? '17:30' : (endDefault || '');
                        const actionHtml = isFuture
                            ? `--`
                            : `<button class="open-day-records px-2 py-1 bg-indigo-600 text-white rounded text-xs" data-date="${ymd}">æŸ¥çœ‹ç•¶æ—¥æ‰“å¡ç´€éŒ„</button>`;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="border px-2 py-1 text-center">${String(d).padStart(2,'0')}</td>
                            <td class="border px-2 py-1 text-center">${weekdayZh[w]}</td>
                            <td class="border px-2 py-1 text-center">${startDisp || '--:--'}</td>
                            <td class="border px-2 py-1 text-center">${endDisp || '--:--'}</td>
                            <td class="border px-2 py-1 text-center">${statusLabel}</td>
                            <td class="border px-2 py-1 text-center">${actionHtml}</td>
                        `;
                        bodyEl.appendChild(tr);
                    }

                    if (!bodyEl.children.length) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td class="border px-2 py-3 text-center text-gray-500" colspan="6">æœ¬æœˆç„¡ä¸Šç­æ—¥</td>`;
                        bodyEl.appendChild(tr);
                    }

                    // ç¶å®šå¿«æ·é€£çµäº‹ä»¶
                    container.querySelectorAll('.open-day-records').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const ymd = e.currentTarget.dataset.date;
                            try { localStorage.setItem('__records_target_date', ymd); } catch (err) {}
                            showPage('clock-in', 'records');
                        });
                    });

                    // ç¶å®šæœˆä»½åˆ‡æ›
                    const prevBtn = container.querySelector('#prev-month');
                    const nextBtn = container.querySelector('#next-month');
                    const todayBtn = container.querySelector('#today-month');
                    prevBtn?.addEventListener('click', () => { viewMonth--; if (viewMonth < 0) { viewMonth = 11; viewYear--; } render(); });
                    nextBtn?.addEventListener('click', () => { viewMonth++; if (viewMonth > 11) { viewMonth = 0; viewYear++; } render(); });
                    todayBtn?.addEventListener('click', () => { viewYear = now.getFullYear(); viewMonth = now.getMonth(); render(); });
                };

                render().then(() => { try { lucide.createIcons(); } catch(e) {} });
            }

            // å…±ç”¨ï¼šå‡ºå‹¤ç´€éŒ„åˆ—è¡¨æ¸²æŸ“ï¼ˆæ”¯æ´æŒ‡å®šç”¨æˆ¶ç™½åå–®ï¼‰
            async function renderAttendanceRecordsList(containerId, selectedUserId, selectedDateStr, allowedUserIds = null) {
                const container = document.getElementById(containerId);
                if (!container) { console.warn('renderAttendanceRecordsList: æ‰¾ä¸åˆ°å®¹å™¨', containerId); return; }
                const selectedDate = new Date(selectedDateStr);
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);
                const recordsRef = collection(db, 'clockInRecords');
                let q;
                const { Timestamp } = window.__fs || {};
                const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                if (selectedUserId === 'all') {
                    q = query(recordsRef, where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                } else {
                    q = query(recordsRef, where('userId', '==', selectedUserId), where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                }

                container.innerHTML = `<div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>`;
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = `<p class="text-center text-gray-500 p-4">ç„¡æ‰“å¡ç´€éŒ„</p>`;
                    return;
                }
                const records = [];
                querySnapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const usersMap = {};
                usersSnapshot.forEach(doc => { usersMap[doc.id] = doc.data().name; });

                container.innerHTML = '';
                records
                    .filter(r => !allowedUserIds || allowedUserIds.includes(r.userId))
                    .sort((a,b) => {
                        const timeA = a.timestamp?.toDate?.() || new Date(0);
                        const timeB = b.timestamp?.toDate?.() || new Date(0);
                        return timeB - timeA;
                    })
                    .forEach(record => {
                        const time = record.timestamp?.toDate?.() || new Date();
                        const userName = usersMap[record.userId] || 'æœªçŸ¥ç”¨æˆ¶';
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold">${userName}</div>
                                    <div class="text-sm text-gray-500">${time.toLocaleString('zh-TW')}</div>
                                    <div class="mt-1 flex items-center">
<span class="px-2 py-0.5 rounded text-sm ${getStatusBgColor(getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null))}">${getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null)}</span>
                        ${record.location && typeof record.location.latitude === 'number' && typeof record.location.longitude === 'number' ? `<span class="ml-2 text-sm text-gray-500">${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</span>` : ''}
                                    </div>
                                    <div class="mt-1 text-xs text-gray-500">è£ç½®ID: ${record.deviceId || 'æœªçŸ¥'}</div>
                                </div>
                                <div class="flex space-x-2 items-start"></div>
                            </div>
                            <div class="mt-2 flex space-x-2 overflow-x-auto items-center">
                                ${record.photoUrls && record.photoUrls.length > 0 ? `
                                    <button class="photo-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> ç…§ç‰‡ (${record.photoUrls.length})
                                    </button>
                                ` : ''}
                                ${record.location ? `
                                    <button class="map-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-lat="${record.location.latitude}" 
                                        data-lng="${record.location.longitude}">
                                        <i data-lucide="map-pin"></i> åœ°åœ–
                                    </button>
                                ` : ''}
                                <!-- Admin controls: edit/delete -->
                                <span class="admin-controls hidden" data-record-id="${record.id}" data-record='${encodeURIComponent(JSON.stringify({
                                    id: record.id,
                                    type: record.type,
                                    timeISO: (record.timestamp?.toDate?.() || new Date()).toISOString(),
                                    lat: record.location?.latitude ?? null,
                                    lng: record.location?.longitude ?? null,
                                    locationName: record.locationName || '',
                                    dutyType: record.dutyType || ''
                                }))}'>
                                    <button class="edit-record-btn bg-yellow-500 text-white px-2 py-1 rounded text-sm">
                                        <i data-lucide="pencil"></i> ç·¨è¼¯
                                    </button>
                                    <button class="delete-record-btn bg-red-600 text-white px-2 py-1 rounded text-sm">
                                        <i data-lucide="trash-2"></i> åˆªé™¤
                                    </button>
                                </span>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                lucide.createIcons();
                container.querySelectorAll('.map-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lat = parseFloat(e.currentTarget.dataset.lat);
                        const lng = parseFloat(e.currentTarget.dataset.lng);
                        if(lat && lng) openMapModal(lat, lng);
                        else showToast('ç„¡ä½ç½®è³‡è¨Šå¯é¡¯ç¤º', true);
                    });
                });
                container.querySelectorAll('.photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                        const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                        openPhotoModal(photos, descriptions);
                    });
                });

                // é¡¯ç¤ºä¸¦ç¶å®šç®¡ç†å“¡æ§åˆ¶æŒ‰éˆ•
                (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)).then(isAdmin => {
                    if (!isAdmin) return;
                    container.querySelectorAll('.admin-controls').forEach(ctrl => ctrl.classList.remove('hidden'));
                    container.querySelectorAll('.edit-record-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            try {
                                const parent = e.currentTarget.closest('.admin-controls');
                                const recordData = JSON.parse(decodeURIComponent(parent.dataset.record || '%7B%7D'));
                                openEditRecordModal(recordData);
                            } catch (err) {
                                console.error('openEditRecordModal parse error', err);
                                showToast('è¼‰å…¥ç´€éŒ„å¤±æ•—', true);
                            }
                        });
                    });
                    container.querySelectorAll('.delete-record-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            try {
                                const parent = e.currentTarget.closest('.admin-controls');
                                const recordId = parent.dataset.recordId;
                                if (!recordId) return;
                                const ok = confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‡ºå‹¤ç´€éŒ„ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚');
                                if (!ok) return;
                                const { doc, deleteDoc } = window.__fs;
                                const db = window.__db;
                                await deleteDoc(doc(db, 'clockInRecords', recordId));
                                showToast('åˆªé™¤æˆåŠŸ');
                                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                                const selectedUserId = document.getElementById('user-select')?.value || 'all';
                                const selectedDateStr = document.getElementById('record-date')?.value || new Date().toISOString().split('T')[0];
                                await renderAttendanceRecordsList('attendance-records-list', selectedUserId, selectedDateStr);
                            } catch (err) {
                                console.error('delete clockInRecord error', err);
                                showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true);
                            }
                        });
                    });
                });
            }

            // ç‹€æ…‹æ–‡å­—å°æ‡‰åº•è‰²ï¼ˆæ¯æ—¥å¡ç‰‡åˆ—è¡¨ç”¨ï¼‰
            function getStatusBgColor(typeOrText) {
                const s = String(typeOrText || '').toLowerCase();
                if (s.includes('ä¸Šç­') || s.includes('è¿”å›') || s.includes('åœ¨è¾¦')) return 'bg-green-100 text-green-800';
                if (s.includes('ä¸‹ç­')) return 'bg-red-100 text-red-800';
                if (s.includes('å¤–å‡º') || s.includes('æŠµé”') || s.includes('é›¢é–‹')) return 'bg-blue-100 text-blue-800';
                if (s.includes('è«‹å‡')) return 'bg-orange-100 text-orange-800';
                if (s.includes('ç‰¹æ®Šå‹¤å‹™')) return 'bg-indigo-100 text-indigo-800';
                return 'bg-gray-100 text-gray-800';
            }

            // è®€å–åˆéšä¸»ç®¡å¯è¦‹ç”¨æˆ¶è¨­å®š
            async function loadJuniorManagerAllowedUsers(managerUserId) {
                try {
                    const docRef = doc(db, 'settings', 'group');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data?.managerGroups?.[managerUserId] || [];
                    }
                } catch (e) { console.error('loadJuniorManagerAllowedUsers error', e); }
                return [];
            }
            
            function renderTrackingMap(container) {
                container.innerHTML = `
                    <div class="h-full w-full relative">
                        <div id="tracking-map" class="h-full w-full"></div>
                        <div id="tracking-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
<button id="tracking-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>å›åˆ°å…¬å¸
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-2">
                            <div id="user-tracking-list" class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg max-h-[150px] overflow-y-auto p-2 space-y-2">
                                <!-- User list will be populated here -->
                            </div>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                if (state.googleMapsLoaded) {
                    initTrackingMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) {
                            clearInterval(interval);
                            initTrackingMap();
                        }
                    }, 100);
                }
            }

            async function initTrackingMap() {
                const mapDiv = document.getElementById('tracking-map');
                const mapLoader = document.getElementById('tracking-map-loader');
                if (!mapDiv || !mapLoader) return;

                let mapCenter = { lat: 25.0330, lng: 121.5654 };
                try {
                    const docSnap = await getDoc(doc(db, "settings", "location"));
                    if (docSnap.exists()) {
                        const s = docSnap.data();
                        if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                            mapCenter = { lat: s.companyLat, lng: s.companyLng };
                        }
                    }
                } catch (e) { console.warn("è¼‰å…¥å…¬å¸ä½ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä¸­å¿ƒé»", e); }
                
                state.trackingMap = new google.maps.Map(mapDiv, {
                    center: mapCenter,
                    zoom: 12,
                    disableDefaultUI: true,
                    zoomControl: true,
                    mapId: 'DEMO_MAP_ID' // Required for Advanced Markers
                });
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('tracking-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.trackingMap.panTo(state.companyCenter);
                            state.trackingMap.setZoom(14);
                        } else {
                            showToast('å°šæœªè¨­å®šå…¬å¸åº§æ¨™', true);
                        }
                    });
                }

                mapLoader.classList.add('hide');
                listenForUserLocations();
            }
            
            function renderTrackingAttendance(container) {
                // ä½¿ç”¨ã€Œæ¯æ—¥å¡ç‰‡åˆ—è¡¨ã€è¦–åœ–ï¼ˆç§»é™¤ã€Œæœˆå ±è¡¨ã€æŒ‰éˆ•ï¼‰
                    const defaultDateStr = (function(){
                        try { return localStorage.getItem('__records_target_date') || new Date().toISOString().split('T')[0]; }
                        catch(e) { return new Date().toISOString().split('T')[0]; }
                    })();
                    container.innerHTML = `
                        <div class="p-4 space-y-4">
                            <div class="flex flex-wrap items-center gap-4 mb-4">
                                <div class="flex items-center space-x-2">
                                    <label for="user-select" class="text-sm font-medium">é¸æ“‡äººå“¡:</label>
                                    <select id="user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                        <option value="all">å…¨éƒ¨äººå“¡</option>
                                    </select>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label for="record-date" class="text-sm font-medium">æ—¥æœŸ:</label>
                                    <input type="date" id="record-date" value="${defaultDateStr}" class="border border-gray-300 rounded-md px-2 py-1">
                                </div>
                                <div class="flex items-center space-x-2 ml-auto">
                                    <button id="btn-all-monthly" class="bg-indigo-600 text-white px-3 py-1 rounded flex items-center">
                                        <i data-lucide="table" class="w-4 h-4 mr-1"></i> å…¨å“¡æœˆå ±è¡¨
                                    </button>
                                </div>
                            </div>
                            <div id="attendance-records-list" class="space-y-3"></div>
                        </div>
                    `;
                    try { lucide.createIcons(); } catch(e) {}

                    const userSelect = document.getElementById('user-select');
                    const dateInput = document.getElementById('record-date');
                    const usersRef = collection(db, 'users');
                    let allowedUserIds = null;

                    (async () => {
                        try {
                            const uid = state?.currentUser?.uid;
                            const role = state?.currentUserData?.role;
                            if (role === 'juniorManager' && uid) {
                                allowedUserIds = await loadJuniorManagerAllowedUsers(uid);
                            }
                        } catch (err) { console.warn('è®€å–åˆéšä¸»ç®¡å…è¨±åå–®å¤±æ•—', err); }

                        const qs = await getDocs(usersRef);
                        const arr = [];
                        qs.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
                        arr.sort((a,b) => (a.name || '').localeCompare(b.name || '', 'zh-Hant')).forEach(u => {
                            const opt = document.createElement('option');
                            opt.value = u.id;
                            opt.textContent = u.name || u.id;
                            userSelect.appendChild(opt);
                        });

                        // é è¨­é¸æ“‡ã€Œå…¨éƒ¨äººå“¡ã€ï¼Œä¸å†æ²¿ç”¨å‰æ¬¡é¸æ“‡
                        userSelect.value = 'all';
                        await renderAttendanceRecordsList('attendance-records-list', userSelect.value, dateInput.value, allowedUserIds);
                    })().catch(err => { console.error('åˆå§‹åŒ–æ¯æ—¥åˆ—è¡¨å¤±æ•—', err); });

                    userSelect.addEventListener('change', () => {
                        try { localStorage.setItem('__records_target_user', userSelect.value); } catch(e) {}
                        renderAttendanceRecordsList('attendance-records-list', userSelect.value, dateInput.value, allowedUserIds);
                    });
                    dateInput.addEventListener('change', () => {
                        try { localStorage.setItem('__records_target_date', dateInput.value); } catch(e) {}
                        renderAttendanceRecordsList('attendance-records-list', userSelect.value, dateInput.value, allowedUserIds);
                    });

                    // è¿½è¹¤åˆ†é ï¼šå…¨å“¡æœˆå ±è¡¨ï¼ˆç”Ÿæˆèˆ‡å€‹äººæ‰“å¡æœˆå ±è¡¨ç›¸åŒæ ¼å¼ï¼Œå…¨éƒ¨å¸³è™Ÿï¼‰
                    const btnAllMonthly = document.getElementById('btn-all-monthly');
                    btnAllMonthly?.addEventListener('click', () => {
                        try {
                            const today = new Date();
                            const defaultMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                            const ymStr = window.prompt('è«‹è¼¸å…¥æœˆä»½ (YYYY-MM)', defaultMonth);
                            if (!ymStr || !/^\d{4}-\d{2}$/.test(ymStr)) {
                                showToast && showToast('æœˆä»½æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ YYYY-MM', true);
                                return;
                            }
                            if (typeof window.renderAllMonthlyReports === 'function') {
                                window.renderAllMonthlyReports(ymStr);
                            } else {
                                showToast && showToast('ç³»çµ±æœªæº–å‚™å…¨å“¡æœˆå ±è¡¨åŠŸèƒ½', true);
                            }
                        } catch (e) {
                            console.error('é–‹å•Ÿå…¨å“¡æœˆå ±è¡¨å¤±æ•—', e);
                            showToast && showToast('é–‹å•Ÿå…¨å“¡æœˆå ±è¡¨å¤±æ•—', true);
                        }
                    });
                    return; // ä¸é€²å…¥æœˆå ±è¡¨ç¨‹å¼ç¢¼
                }

                // ä»¥ä¸‹ä¿ç•™åŸå…ˆã€Œæœˆå ±è¡¨ã€è¦–åœ–ç¨‹å¼ç¢¼ï¼ˆåƒ…åœ¨ isMonthly æ™‚åŸ·è¡Œï¼‰
                if (false) { // å·²åœç”¨æœˆå ±è¡¨è¦–åœ–ï¼Œé¿å…åœ¨å‡½å¼å¤–åŸ·è¡Œé€ æˆéŒ¯èª¤
                const today = new Date();
                const defaultMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="monthly-user-select" class="text-sm font-medium">é¸æ“‡äººå“¡:</label>
                                <select id="monthly-user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">å…¨éƒ¨äººå“¡</option>
                                    <!-- äººå“¡é¸é …å°‡å‹•æ…‹æ·»åŠ  -->
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="monthly-month" class="text-sm font-medium">é¸æ“‡æœˆä»½:</label>
                                <input type="month" id="monthly-month" value="${defaultMonth}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                            <div class="flex items-center space-x-2 ml-auto">
                                <button id="btn-print-monthly" class="bg-gray-700 text-white px-3 py-1 rounded flex items-center">
                                    <i data-lucide="printer" class="w-4 h-4 mr-1"></i> åˆ—å°
                                </button>
                                <button id="btn-export-excel" class="bg-blue-600 text-white px-3 py-1 rounded flex items-center">
                                    <i data-lucide="download" class="w-4 h-4 mr-1"></i> åŒ¯å‡ºExcel
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <table id="attendance-monthly-table" class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50" id="attendance-monthly-thead"></thead>
                                <tbody id="attendance-monthly-tbody" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="32" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex items-center justify-center">
                                            <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                            è¼‰å…¥ä¸­...
                                        </div>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}

                const usersRef = collection(db, "users");
                const userSelect = document.getElementById('monthly-user-select');
                const monthInput = document.getElementById('monthly-month');
                const theadEl = document.getElementById('attendance-monthly-thead');
                const tbodyEl = document.getElementById('attendance-monthly-tbody');

                let usersArr = [];
                let usersMap = {};

                const fmtHM = (d) => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

                const renderHeader = (daysInMonth) => {
                    const cols = ['<tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äººå“¡</th>'];
                    for (let i = 1; i <= daysInMonth; i++) {
                        cols.push(`<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${String(i).padStart(2,'0')}</th>`);
                    }
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">å‡ºå‹¤æ—¥æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½å·¥æ™‚(å°æ™‚)</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">è«‹å‡æ—¥æ•¸</th>');
                    cols.push('<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ç‰¹æ®Šå‹¤å‹™æ—¥æ•¸</th>');
                    cols.push('</tr>');
                    theadEl.innerHTML = cols.join('');
                };

                const loadMonthlyReport = async () => {
                    const ymStr = monthInput.value || defaultMonth;
                    const [yStr, mStr] = ymStr.split('-');
                    const year = Number(yStr);
                    const month = Number(mStr) - 1; // 0-based
                    const startOfMonth = new Date(year, month, 1, 0, 0, 0, 0);
                    const endOfMonth = new Date(year, month + 1, 0, 23, 59, 59, 999);
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    renderHeader(daysInMonth);

                    const selectedUserId = userSelect.value;
                    const recordsRef = collection(db, "clockInRecords");
                    const { Timestamp } = window.__fs || {};
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfMonth) : startOfMonth;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfMonth) : endOfMonth;
                    let q;
                    if (selectedUserId === 'all') {
                        q = query(recordsRef, where("timestamp", ">=", startTS), where("timestamp", "<=", endTS));
                    } else {
                        q = query(recordsRef, where("userId", "==", selectedUserId), where("timestamp", ">=", startTS), where("timestamp", "<=", endTS));
                    }

                    tbodyEl.innerHTML = `<tr><td colspan="32" class="px-6 py-4 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>è¼‰å…¥ä¸­...</div></td></tr>`;

                    try {
                        const snap = await getDocs(q);
                        const byUser = new Map(); // userId -> { days: Map<day, {start:Date|null, end:Date|null}> }
                        snap.forEach(d => {
                            const r = d.data();
                            const uid = r.userId;
                            const dt = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!uid || !dt) return;
                            const day = dt.getDate();
                            const entry = byUser.get(uid) || { days: new Map() };
                            const dayObj = entry.days.get(day) || { start: null, end: null };
                            if (r.type === 'ä¸Šç­') {
                                if (!dayObj.start || dt < dayObj.start) dayObj.start = dt;
                            }
                            if (r.type === 'ä¸‹ç­' || r.type === 'è‡ªå‹•ä¸‹ç­') {
                                if (!dayObj.end || dt > dayObj.end) dayObj.end = dt;
                            }
                            entry.days.set(day, dayObj);
                            byUser.set(uid, entry);
                        });

                        // è¨ˆç®—è½åœ¨æœ¬æœˆçš„æ—¥æœŸé›†åˆï¼ˆè«‹å‡ã€ç‰¹æ®Šå‹¤å‹™ï¼‰
                        const dayNumbersInRange = (start, end) => {
                            if (!start || !end) return [];
                            const cs = new Date(Math.max(start.getTime(), startOfMonth.getTime()));
                            const ce = new Date(Math.min(end.getTime(), endOfMonth.getTime()));
                            cs.setHours(12,0,0,0); ce.setHours(12,0,0,0);
                            const out = [];
                            for (let d = new Date(cs); d <= ce; d.setDate(d.getDate() + 1)) {
                                out.push(d.getDate());
                            }
                            return out;
                        };

                        // è®€å–è«‹å‡ï¼ˆåƒ…è¨ˆå…¥å·²æ ¸å‡†ï¼‰
                        const leaveDaySetMap = new Map(); // userId -> Set(dayNumbers)
                        try {
                            const leavesRef = collection(db, 'leaves');
                            let qLeaves;
                            if (selectedUserId === 'all') {
                                qLeaves = query(leavesRef, where('status','==','approved'));
                            } else {
                                qLeaves = query(leavesRef, where('status','==','approved'), where('userId','==', selectedUserId));
                            }
                            const leavesSnap = await getDocs(qLeaves);
                            leavesSnap.forEach(doc => {
                                const lv = doc.data();
                                const uid = lv.userId || lv.uid || (lv.user && lv.user.id);
                                if (!uid) return;
                                const s = (lv.startTime && lv.startTime.toDate?.()) || (lv.startTime ? new Date(lv.startTime) : (lv.leaveStartTime && lv.leaveStartTime.toDate?.()) || (lv.leaveStartTime ? new Date(lv.leaveStartTime) : null));
                                const e = (lv.endTime && lv.endTime.toDate?.()) || (lv.endTime ? new Date(lv.endTime) : (lv.leaveEndTime && lv.leaveEndTime.toDate?.()) || (lv.leaveEndTime ? new Date(lv.leaveEndTime) : null));
                                if (!s || !e) return;
                                const days = dayNumbersInRange(s, e);
                                if (!days.length) return;
                                const set = leaveDaySetMap.get(uid) || new Set();
                                days.forEach(n => set.add(n));
                                leaveDaySetMap.set(uid, set);
                            });
                        } catch (e) { /* ignore leave load errors */ }

                        // è®€å–ç‰¹æ®Šå‹¤å‹™ï¼ˆè·¨æœˆä»¥ startTime æˆ– endTime è½åœ¨æœ¬æœˆå³è¨ˆå…¥ï¼‰
                        const specialDutyDaySetMap = new Map(); // userId -> Set(dayNumbers)
                        try {
                            const sdRef = collection(db, 'specialDuties');
                            const startTS2 = Timestamp?.fromDate ? Timestamp.fromDate(startOfMonth) : startOfMonth;
                            const endTS2 = Timestamp?.fromDate ? Timestamp.fromDate(endOfMonth) : endOfMonth;
                            let q1, q2;
                            if (selectedUserId === 'all') {
                                q1 = query(sdRef, where('startTime','>=', startTS2), where('startTime','<=', endTS2));
                                q2 = query(sdRef, where('endTime','>=', startTS2), where('endTime','<=', endTS2));
                            } else {
                                q1 = query(sdRef, where('userId','==', selectedUserId), where('startTime','>=', startTS2), where('startTime','<=', endTS2));
                                q2 = query(sdRef, where('userId','==', selectedUserId), where('endTime','>=', startTS2), where('endTime','<=', endTS2));
                            }
                            const sdDocs = new Map();
                            for (const qq of [q1, q2]) {
                                const sSnap = await getDocs(qq);
                                sSnap.forEach(doc => { sdDocs.set(doc.id, doc.data()); });
                            }
                            sdDocs.forEach(sd => {
                                const uid = sd.userId;
                                const s = sd.startTime?.toDate?.() || (sd.startTime ? new Date(sd.startTime) : null);
                                const e = sd.endTime?.toDate?.() || (sd.endTime ? new Date(sd.endTime) : null);
                                if (!uid || !s || !e) return;
                                const days = dayNumbersInRange(s, e);
                                if (!days.length) return;
                                const set = specialDutyDaySetMap.get(uid) || new Set();
                                days.forEach(n => set.add(n));
                                specialDutyDaySetMap.set(uid, set);
                            });
                        } catch (e) { /* ignore special duty load errors */ }

                        const buildRow = (user) => {
                            const uid = user.id;
                            const entry = byUser.get(uid) || { days: new Map() };
                            let attendDays = 0;
                            let totalMinutes = 0;
                            const tds = [`<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800">${user.name || usersMap[uid] || 'æœªçŸ¥ç”¨æˆ¶'}</td>`];
                            for (let i = 1; i <= daysInMonth; i++) {
                                const dObj = entry.days.get(i) || { start: null, end: null };
                                const hasStart = !!dObj.start;
                                const hasEnd = !!dObj.end;
                                const cls = hasStart && hasEnd ? 'bg-green-50' : (hasStart || hasEnd ? 'bg-yellow-50' : '');
                                let text = '--';
                                if (hasStart && hasEnd) text = `${fmtHM(dObj.start)}~${fmtHM(dObj.end)}`;
                                else if (hasStart) text = `${fmtHM(dObj.start)}`;
                                else if (hasEnd) text = `${fmtHM(dObj.end)}`;
                                if (hasStart || hasEnd) attendDays++;
                                if (hasStart && hasEnd) totalMinutes += Math.max(0, (dObj.end - dObj.start) / 60000);
                                tds.push(`<td class="px-2 py-1 text-center text-xs ${cls}">${text}</td>`);
                            }
                            const totalHours = (totalMinutes / 60).toFixed(2);
                            const leaveDays = (leaveDaySetMap.get(uid)?.size) || 0;
                            const dutyDays = (specialDutyDaySetMap.get(uid)?.size) || 0;
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${attendDays}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${totalHours}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${leaveDays}</td>`);
                            tds.push(`<td class="px-3 py-2 text-center text-sm">${dutyDays}</td>`);
                            return `<tr>${tds.join('')}</tr>`;
                        };

                        const rows = [];
                        if (selectedUserId === 'all') {
                            // é¡¯ç¤ºæ‰€æœ‰äººå“¡ï¼ˆå³ä½¿è©²æœˆç„¡ç´€éŒ„ä¹Ÿé¡¯ç¤ºï¼‰
                            const sorted = [...usersArr].sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
                            sorted.forEach(u => rows.push(buildRow(u)));
                        } else {
                            const user = usersArr.find(u => u.id === selectedUserId);
                            if (user) rows.push(buildRow(user));
                        }
                        tbodyEl.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="${daysInMonth + 5}" class="px-6 py-4 text-center text-gray-500">ç„¡è³‡æ–™</td></tr>`;
                        try { lucide.createIcons(); } catch(e) {}
                    } catch (err) {
                        console.error('è®€å–æœˆå ±è¡¨å¤±æ•—', err);
                        tbodyEl.innerHTML = `<tr><td colspan="32" class="px-6 py-4 text-center text-red-500">è®€å–ç´€éŒ„å¤±æ•—ã€‚</td></tr>`;
                    }
                };

                getDocs(usersRef).then((qs) => {
                    const users = [];
                    qs.forEach(doc => { users.push({ id: doc.id, ...doc.data() }); });
                    usersArr = users;
                    usersMap = users.reduce((acc, u) => { acc[u.id] = u.name; return acc; }, {});
                    users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        userSelect.appendChild(option);
                    });
                    loadMonthlyReport();
                });

                userSelect.addEventListener('change', loadMonthlyReport);
                monthInput.addEventListener('change', loadMonthlyReport);

                // åŒ¯å‡º Excelï¼ˆå„ªå…ˆ XLSXï¼Œå¤±æ•—å›é€€ CSVï¼‰èˆ‡åˆ—å°
                const btnPrint = document.getElementById('btn-print-monthly');
                const btnExport = document.getElementById('btn-export-excel');
                btnPrint.addEventListener('click', printMonthlyReport);
                btnExport.addEventListener('click', exportMonthlyToExcel);

                function getSelectedUserLabel() {
                    const sel = document.getElementById('monthly-user-select');
                    const opt = sel.options[sel.selectedIndex];
                    return opt ? opt.textContent : 'å…¨éƒ¨äººå“¡';
                }

                async function ensureXLSX() {
                    if (window.XLSX) return true;
                    return new Promise((resolve) => {
                        const s = document.createElement('script');
                        s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                        s.onload = () => resolve(true);
                        s.onerror = () => resolve(false);
                        document.head.appendChild(s);
                    });
                }

                function tableToCSV(table) {
                    let csv = '';
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th,td');
                        const values = Array.from(cells).map(cell => '"' + (cell.innerText || '').replace(/"/g, '""') + '"');
                        csv += values.join(',') + '\r\n';
                    });
                    return csv;
                }

                async function exportMonthlyToExcel() {
                    try {
                        const ok = await ensureXLSX();
                        const ymStr = monthInput.value || defaultMonth;
                        const userLabel = getSelectedUserLabel();
                        const filename = `å‡ºå‹¤æœˆå ±è¡¨_${ymStr}_${userLabel}.xlsx`;
                        const table = document.getElementById('attendance-monthly-table');
                        if (ok && window.XLSX && window.XLSX.utils && window.XLSX.writeFile) {
                            const wb = XLSX.utils.table_to_book(table, { sheet: 'æœˆå ±è¡¨' });
                            XLSX.writeFile(wb, filename);
                        } else {
                            const csv = tableToCSV(table);
                            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = `å‡ºå‹¤æœˆå ±è¡¨_${ymStr}_${userLabel}.csv`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        }
                    } catch (err) {
                        console.error('exportMonthlyToExcel error', err);
                        showToast && showToast('åŒ¯å‡ºå¤±æ•—', true);
                    }
                }

                function printMonthlyReport() {
                    try {
                        const ymStr = monthInput.value || defaultMonth;
                        const userLabel = getSelectedUserLabel();
                        const table = document.getElementById('attendance-monthly-table');
                        // ä¾æœˆä»½å¤©æ•¸å‹•æ…‹ç¸®æ”¾ï¼Œç›®æ¨™ç‚ºåˆ—å°æ™‚ã€Œä¸€æ¬„å¯¬ã€
                        const [yStr, mStr] = (ymStr || '').split('-');
                        const year = Number(yStr);
                        const monthNum = Number(mStr); // 1-based
                        const daysInMonth = new Date(year, monthNum, 0).getDate();
                        const extraCols = 5; // äººå“¡ + å‡ºå‹¤ + ç¸½å·¥æ™‚ + è«‹å‡ + ç‰¹æ®Šå‹¤å‹™
                        const targetBase = 31; // ä»¥ 31 å¤©ç‚ºåŸºæº–
                        let scale = targetBase / (daysInMonth + extraCols);
                        scale = Math.max(0.55, Math.min(0.95, scale));
                        const html = `<!doctype html><html><head><meta charset="utf-8"><title>å‡ºå‹¤æœˆå ±è¡¨</title>
                        <style>
                            @page { size: A4 landscape; margin: 10mm; }
                            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            body { font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif; color: #111; }
                            h1 { font-size: 14px; margin-bottom: 6px; }
                            table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                            thead th { background: #f9fafb; }
                            th, td { border: 1px solid #d1d5db; padding: 2px 3px; font-size: 10px; }
                            th:first-child, td:first-child { text-align: left; }
                            th:not(:first-child), td:not(:first-child) { text-align: center; white-space: nowrap; }
                            tr { page-break-inside: avoid; }
                            #print-wrap { transform: scale(${scale}); transform-origin: top left; width: calc(100% / ${scale}); }
                        </style>
                        </head><body>
                        <h1>å‡ºå‹¤æœˆå ±è¡¨ï¼š${ymStr}ï¼ˆ${userLabel}ï¼‰</h1>
                        <div id="print-wrap">${table.outerHTML}</div>
                        </body></html>`;
                        const w = window.open('', '_blank');
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                        w.focus();
                        w.print();
                    } catch (err) {
                        console.error('printMonthlyReport error', err);
                        showToast && showToast('åˆ—å°å¤±æ•—', true);
                    }
                }
                } // åœç”¨æœˆå ±è¡¨è¦–åœ–çµæŸ
            }
            
            function renderTrackingLeave(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="leave-status-filter" class="text-sm font-medium">å¯©æ ¸ç‹€æ…‹:</label>
                                <select id="leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>å…¨éƒ¨</option>
                                    <option value="pending">å¾…å¯©æ ¸</option>
                                    <option value="approved">å·²æ ¸å‡†</option>
                                    <option value="rejected">å·²æ‹’çµ•</option>
                                    <option value="canceled">å·²å–æ¶ˆ</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="leave-date-filter" class="text-sm font-medium">æ—¥æœŸ:</label>
                                <input type="date" id="leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="leave-show-deleted" class="rounded" />
                                <span class="text-sm font-medium">é¡¯ç¤ºå·²åˆªé™¤</span>
                            </label>
                            <button id="leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>æœå°‹
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è«‹å‡äºº</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äº‹ç”±</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é–‹å§‹æ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çµæŸæ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    è¼‰å…¥ä¸­...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="no-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è«‹å‡è¨˜éŒ„</p>
                        </div>
                    </div>
                `;
                
                lucide.createIcons();
                
                // ç²å–å…ƒç´ 
                const statusFilter = document.getElementById('leave-status-filter');
                const dateFilter = document.getElementById('leave-date-filter');
                const searchBtn = document.getElementById('leave-search-btn');
                const showDeletedChk = document.getElementById('leave-show-deleted');

                // å–å¾— Firestore å¿«æ·åƒè€ƒï¼ˆå¾ŒçºŒå¤šè™•ä½¿ç”¨ï¼‰
                const db = window.__db; 
                const { collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, serverTimestamp } = window.__fs;

                // è®€å–ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦ç‚ºç®¡ç†å“¡
                let isAdmin = false;
                (async () => {
                    try {
                        const uid = window.__auth?.currentUser?.uid;
                        if (uid) {
                            const userSnap = await getDoc(doc(db, 'users', uid));
                            if (userSnap.exists()) {
                                const role = userSnap.data().role;
                                isAdmin = role === 'admin';
                            }
                        }
                    } catch (err) {
                        console.warn('è®€å–ä½¿ç”¨è€…è§’è‰²å¤±æ•—', err);
                    } finally {
                        // åˆå§‹åŠ è¼‰æ•¸æ“š
                        loadLeaveRecords();
                    }
                })();
                
                // æ·»åŠ æœå°‹æŒ‰éˆ•äº‹ä»¶
                searchBtn.addEventListener('click', () => {
                    loadLeaveRecords();
                });
                // é¡¯ç¤ºå·²åˆªé™¤å‹¾é¸äº‹ä»¶
                showDeletedChk.addEventListener('change', () => {
                    loadLeaveRecords();
                });
                
                // åŠ è¼‰è«‹å‡è¨˜éŒ„
                function loadLeaveRecords() {
                    const recordsList = document.getElementById('leave-records-list');
                    const noRecordsMsg = document.getElementById('no-leave-records');
                    
                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    è¼‰å…¥ä¸­...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                    
                    // ç²å–éæ¿¾æ¢ä»¶
                    const status = statusFilter.value;
                    const date = dateFilter.value;
                    
                    // æ§‹å»ºæŸ¥è©¢
                    let leavesQuery = collection(db, 'leaves');
                    
                    // å¦‚æœé¸æ“‡äº†ç‰¹å®šç‹€æ…‹
                    if (status !== 'all') {
                        leavesQuery = query(leavesQuery, where('status', '==', status));
                    }

                    // æŒ‰å‰µå»ºæ™‚é–“æ’åº
                    leavesQuery = query(leavesQuery, orderBy('createdAt', 'desc'));

                    // åŸ·è¡ŒæŸ¥è©¢
                    getDocs(leavesQuery).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }
                        
                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';
                        
                        // æ—¥æœŸéæ¿¾
                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }
                        
                        let hasRecords = false;
                        
                        querySnapshot.forEach((docSnap) => {
                            const leave = docSnap.data();
                            const leaveId = docSnap.id;
                            const isDeleted = !!leave.deleted;
                            
                            // è‹¥æœªå‹¾é¸é¡¯ç¤ºå·²åˆªé™¤ï¼Œå‰‡éæ¿¾æ‰ deleted è¨˜éŒ„
                            if (!showDeletedChk.checked && isDeleted) {
                                return;
                            }
                            
                            // å¦‚æœé¸æ“‡äº†æ—¥æœŸï¼Œæª¢æŸ¥è«‹å‡æ™‚é–“æ˜¯å¦åœ¨æ‰€é¸æ—¥æœŸç¯„åœå…§
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                
                                // æª¢æŸ¥è«‹å‡æ™‚é–“æ˜¯å¦èˆ‡æ‰€é¸æ—¥æœŸæœ‰é‡ç–Š
                                if (!(startTime < nextDay && endTime > selectedDate)) {
                                    return; // è·³éä¸ç¬¦åˆæ—¥æœŸæ¢ä»¶çš„è¨˜éŒ„
                                }
                            }
                            
                            hasRecords = true;
                            
                            const startTime = leave.startTime.toDate().toLocaleString('zh-TW');
                            const endTime = leave.endTime.toDate().toLocaleString('zh-TW');
                            
                            let statusBadge = '';
                            switch (leave.status) {
                                case 'pending':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">å¾…å¯©æ ¸</span>';
                                    break;
                                case 'approved':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">å·²æ ¸å‡†</span>';
                                    break;
                                case 'rejected':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">å·²æ‹’çµ•</span>';
                                    break;
                                case 'canceled':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">å·²å–æ¶ˆ</span>';
                                    break;
                                default:
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">æœªçŸ¥</span>';
                            }
                            
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            
                            let actionButtons = '';
                            if (leave.status === 'pending') {
                                actionButtons += `
                                    <button data-leave-id="${leaveId}" data-action="approve" class="text-green-600 hover:text-green-900 mr-3">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    </button>
                                    <button data-leave-id="${leaveId}" data-action="reject" class="text-red-600 hover:text-red-900">
                                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                                    </button>
                                `;
                            }
                            if (isAdmin) {
                                actionButtons += `
                                    <button data-leave-id="${leaveId}" data-action="${isDeleted ? 'restore' : 'delete'}" class="text-gray-600 hover:text-gray-900 ml-3">
                                        <i data-lucide="${isDeleted ? 'rotate-ccw' : 'trash-2'}" class="w-5 h-5"></i>
                                    </button>
                                `;
                            }
                            
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">${leave.userName || 'æœªçŸ¥ç”¨æˆ¶'}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || 'ç„¡äº‹ç”±'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${statusBadge}
                                    ${isDeleted ? '<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-500">å·²åˆªé™¤</span>' : ''}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    ${actionButtons}
                                </td>
                            `;
                            
                            recordsList.appendChild(row);
                        });
                        
                        lucide.createIcons();
                        
                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                        
                        // æ·»åŠ æ“ä½œæŒ‰éˆ•äº‹ä»¶ï¼ˆå¯©æ ¸ï¼åˆªé™¤ï¼é‚„åŸï¼‰
                        document.querySelectorAll('[data-leave-id]').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const leaveId = e.currentTarget.dataset.leaveId;
                                const action = e.currentTarget.dataset.action;
                                
                                try {
                                    showLoading(true);
                                    
                                    // ç²å–è«‹å‡è¨˜éŒ„
                                    const leaveDocSnap = await getDoc(doc(db, 'leaves', leaveId));
                                    if (!leaveDocSnap.exists()) {
                                        showToast('æ‰¾ä¸åˆ°è«‹å‡è¨˜éŒ„', true);
                                        return;
                                    }
                                    const leaveData = leaveDocSnap.data();
                                    const userId = leaveData.userId;
                                    
                                    if (action === 'approve' || action === 'reject') {
                                        // æ›´æ–°è«‹å‡è¨˜éŒ„ç‹€æ…‹ï¼ˆå¯©æ ¸ï¼‰
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            status: action === 'approve' ? 'approved' : 'rejected',
                                            reviewedAt: serverTimestamp(),
                                            reviewedBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        // å¦‚æœæ ¸å‡†ï¼Œæ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                                        if (action === 'approve') {
                                            await updateDoc(doc(db, 'users', userId), { leaveStatus: 'approved' });
                                        }
                                        showToast(`å·²${action === 'approve' ? 'æ ¸å‡†' : 'æ‹’çµ•'}è«‹å‡ç”³è«‹`);
                                    } else if (action === 'delete') {
                                        // è»Ÿåˆªé™¤
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            deleted: true,
                                            deletedAt: serverTimestamp(),
                                            deletedBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        showToast('å·²æ¨™è¨˜ç‚ºåˆªé™¤');
                                    } else if (action === 'restore') {
                                        // é‚„åŸ
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            deleted: false,
                                            restoredAt: serverTimestamp(),
                                            restoredBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        showToast('å·²é‚„åŸåˆªé™¤æ¨™è¨˜');
                                    }
                                    
                                    // é‡æ–°åŠ è¼‰è¨˜éŒ„
                                    loadLeaveRecords();
                                } catch (error) {
                                    console.error('è™•ç†è«‹å‡ç”³è«‹å¤±æ•—:', error);
                                    showToast('è™•ç†è«‹å‡ç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                                } finally {
                                    showLoading(false);
                                }
                            });
                        });
                    }).catch(error => {
                        console.error('ç²å–è«‹å‡è¨˜éŒ„å¤±æ•—:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-red-500">
                                    è®€å–è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            function renderTrackingReports(container) {
                container.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-report="personal" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 active">å€‹äººæ—¥å ±è¡¨</button>
                        <button data-report="all" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600">å…¨é«”æœˆå ±è¡¨</button>
                    </div>
                    <div id="report-content" class="p-4">
                        <div class="text-center">
                            <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">å ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­</h2>
                            <p class="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                
                container.querySelectorAll('.report-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        container.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const reportType = btn.dataset.report;
                        const reportContent = document.getElementById('report-content');
                        
                        reportContent.innerHTML = `
                            <div class="text-center">
                                <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h2 class="text-xl font-semibold text-gray-700 mb-2">${reportType === 'personal' ? 'å€‹äººæ—¥å ±è¡¨' : 'å…¨é«”æœˆå ±è¡¨'}åŠŸèƒ½é–‹ç™¼ä¸­</h2>
                                <p class="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                            </div>
                        `;
                        lucide.createIcons();
                    });
                });
            }

            async function listenForUserLocations() {
                // ç­‰å¾…åœ°åœ–èˆ‡ Google ç‰©ä»¶æº–å‚™å®Œæˆï¼Œé¿å…ã€Œgoogle æœªå®šç¾©ã€éŒ¯èª¤
                if (!window.google || !state.googleMapsLoaded || !state.trackingMap) {
                    // è‹¥åœ°åœ–å°šæœªè¼‰å…¥ï¼Œè¼ªè©¢ç›´åˆ°è¼‰å…¥å¾Œå†å•Ÿå‹•ç›£è½
                    const pollId = setInterval(() => {
                        if (window.google && state.googleMapsLoaded && state.trackingMap) {
                            clearInterval(pollId);
                            try { listenForUserLocations(); } catch(e) {}
                        }
                    }, 200);
                    return;
                }
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                const fs = window.__fs; const db = window.__db;
                if (!fs || !db || typeof fs.onSnapshot !== 'function') {
                    console.warn('Firestore æœªåˆå§‹åŒ–ï¼Œå»¶å¾Œå•Ÿå‹•äººå“¡ä½ç½®ç›£è½');
                    document.addEventListener('firebase-ready', () => { try { listenForUserLocations(); } catch (e) {} }, { once: true });
                    const waitId = setInterval(() => {
                        if (window.__fs && typeof window.__fs.onSnapshot === 'function' && window.__db) {
                            clearInterval(waitId);
                            try { listenForUserLocations(); } catch (e) {}
                        }
                    }, 200);
                    return;
                }
                const { collection, query, orderBy, onSnapshot, getDocs } = fs;
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));

                const handleSnapshot = (querySnapshot) => {
                    state.trackingMarkers.forEach(marker => marker.map = null);
                    state.trackingMarkers = [];

                    const userListEl = document.getElementById('user-tracking-list');
                    if (!userListEl) return;
                    userListEl.innerHTML = '';

                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

                    // ä¾ä¸€èˆ¬è¨­å®šéæ¿¾å¯è¦‹äººå“¡
                    let visibilityMap = {};
                    try {
                        const saved = localStorage.getItem('app_general_settings');
                        if (saved) {
                            const settings = JSON.parse(saved);
                            visibilityMap = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn('è¼‰å…¥å¯è¦‹äººå“¡è¨­å®šå¤±æ•—', e);
                    }
                    const filteredUsers = users.filter(u => visibilityMap[u.id] !== false);

                    if (filteredUsers.length === 0) {
                        userListEl.innerHTML = `<p class="text-center text-gray-500 p-2">æ²’æœ‰ä½¿ç”¨è€…å¯è¿½è¹¤</p>`;
                        return;
                    }

                    // è®€å–æ¯ä½ä½¿ç”¨è€…æœ€æ–°æ‰“å¡ç´€éŒ„ï¼Œä¸¦ä»¥æ­¤é¡¯ç¤ºèˆ‡æ’åº
                    const { collection: fsCollection, query: fsQuery, where, orderBy: fsOrderBy, limit, getDocs } = window.__fs || {};
                    const dbRef = window.__db || null;

                    const augmentedPromises = filteredUsers.map(async (user) => {
                        let latestRecord = null;
                        try {
                            if (fsCollection && fsQuery && where && fsOrderBy && limit && getDocs && dbRef) {
                                const recQ = fsQuery(
                                    fsCollection(dbRef, 'clockInRecords'),
                                    where('userId', '==', user.id),
                                    fsOrderBy('timestamp', 'desc'),
                                    limit(1)
                                );
                                const snap = await getDocs(recQ);
                                if (!snap.empty) {
                                    latestRecord = snap.docs[0].data();
                                }
                            }
                        } catch (e) {
                            console.warn('å–å¾—æœ€æ–°æ‰“å¡ç´€éŒ„å¤±æ•—', e);
                        }

                        // ç‹€æ…‹æ–‡å­—èˆ‡æ™‚é–“ï¼šå„ªå…ˆä½¿ç”¨æœ€æ–°ç´€éŒ„ï¼Œå¦å‰‡å›é€€ user æ¬„ä½
                        const recordType = latestRecord?.type || user.clockInStatus || user.status || 'æœªæ‰“å¡';
                        const recordLocationName = latestRecord?.locationName || user.lastLocation?.address || null;
                        const dutyType = latestRecord?.dutyType || null;
                        const statusText = getStatusDisplayText(recordType, recordLocationName, dutyType);
                        const ts = latestRecord?.timestamp && latestRecord.timestamp.toDate ? latestRecord.timestamp.toDate() : (latestRecord?.timestamp ? new Date(latestRecord.timestamp) : (user.lastClockInTime?.toDate ? user.lastClockInTime.toDate() : null));

                        return {
                            ...user,
                            __statusText: statusText,
                            __lastStatusTime: ts,
                            __latestRecord: latestRecord || null
                        };
                    });

                    Promise.all(augmentedPromises).then((augmentedUsers) => {
                        // æ’åºå°é½Šã€Œæ‰€æœ‰åŒä»ç‹€æ…‹ã€ï¼šç‹€æ…‹å„ªå…ˆç´š -> æœ€è¿‘æ›´æ–°æ™‚é–“(æ–°â†’èˆŠ) -> å§“å
                        const statusPriority = (u) => {
                        const display = u.__statusText || getStatusDisplayText(u.clockInStatus || 'æœªæ‰“å¡', ((['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(u.clockInStatus) && u.outboundLocation) ? u.outboundLocation : (u.lastLocation?.address || null)), u.dutyType);
                            let isLeave = (u.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (display.includes('è«‹å‡'));
                            if (!isLeave) {
                                const leave = u.leaveStatus || '';
                                if (leave === 'approved' || leave === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (u.leaveStartTime && u.leaveEndTime) {
                                        const leaveStart = u.leaveStartTime.toDate ? u.leaveStartTime.toDate() : new Date(u.leaveStartTime);
                                        const leaveEnd = u.leaveEndTime.toDate ? u.leaveEndTime.toDate() : new Date(u.leaveEndTime);
                                        isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                    }
                                }
                            }
                            if (display.includes('ä¸Šç­') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 1;
                            if (display.includes('è¿”å›') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 2;
                            if (display.startsWith('å¤–å‡º-')) return 3;
                            if (display.startsWith('æŠµé”-')) return 4;
                            if (display.startsWith('é›¢é–‹-')) return 5;
                            if (isLeave) return 6;
                            if (display.includes('å·²ä¸‹ç­')) return 7;
                            return 8;
                        };

                        augmentedUsers.sort((a, b) => {
                            const prA = statusPriority(a);
                            const prB = statusPriority(b);
                            if (prA !== prB) return prA - prB;
                            const tA = a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0);
                            const tB = b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0);
                            if (tA.getTime() !== tB.getTime()) return tB - tA;
                            return (a.name || '').localeCompare(b.name || '', 'zh-Hant');
                        });

                        // ç”Ÿæˆåˆ—è¡¨èˆ‡åœ°åœ–æ¨™è¨˜
                        augmentedUsers.forEach(user => {
                            const recLoc = user.__latestRecord?.location || null;
                            const recLat = recLoc && typeof recLoc.latitude === 'number' ? recLoc.latitude : (user.__latestRecord?.locationLat ?? null);
                            const recLng = recLoc && typeof recLoc.longitude === 'number' ? recLoc.longitude : (user.__latestRecord?.locationLng ?? null);
                            const hasRecordLocation = typeof recLat === 'number' && typeof recLng === 'number';
                            const hasLastLocation = user.lastLocation && typeof user.lastLocation.latitude === 'number' && typeof user.lastLocation.longitude === 'number';
                            const hasLocation = hasRecordLocation || hasLastLocation;

                            const userElement = document.createElement('div');
                            userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                            const statusColorClass = getStatusColor(user.__statusText || 'æœªæ‰“å¡');
                            userElement.innerHTML = `
                                <div class="flex items-center">
                                    <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.name || 'U').charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                    <div>
                                        <p class="font-medium text-sm text-gray-800">${user.name || 'æœªçŸ¥ç”¨æˆ¶'}</p>
                                        <p class="text-xs font-semibold ${statusColorClass}">${user.__statusText || 'æœªæ‰“å¡'}</p>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-400">${user.__lastStatusTime ? 'æœ€è¿‘ç‹€æ…‹æ™‚é–“ï¼š' + timeAgo(user.__lastStatusTime) : 'ç„¡ç´€éŒ„'}</span>
                            `;
                            userListEl.appendChild(userElement);

                            if (hasLocation) {
                                const position = hasRecordLocation
                                    ? { lat: recLat, lng: recLng }
                                    : { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                                const markerIcon = document.createElement('img');
                                markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${(user.name || 'U').charAt(0)}`;
                                markerIcon.className = "w-9 h-9 rounded-full border-2 border-white shadow-md object-cover";

                                const marker = new AdvancedMarkerElement({
                                    position,
                                    map: state.trackingMap,
                                    title: user.name || '',
                                    content: markerIcon,
                                });

                                const locationName = user.__latestRecord?.locationName
                                    || ((['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(user.clockInStatus) ? (user.outboundLocation || '') : ''))
                                    || (user.lastLocation?.address || '');
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `
                                        <div class="p-1">
                                            <p class="font-bold">${user.name || 'æœªçŸ¥ç”¨æˆ¶'}</p>
                                            <p>ç‹€æ…‹: ${user.__statusText || 'æœªæ‰“å¡'}</p>
                                            <p>æœ€è¿‘ç‹€æ…‹æ™‚é–“: ${user.__lastStatusTime ? formatDateTime(user.__lastStatusTime) : 'N/A'}</p>
                                            ${locationName ? `<p>æ‰“å¡åœ°é»: ${locationName}</p>` : ''}
                                        </div>
                                    `
                                });

                                marker.addListener('click', () => {
                                    infoWindow.open({ anchor: marker, map: state.trackingMap });
                                });

                                userElement.addEventListener('click', () => {
                                    state.trackingMap.panTo(position);
                                    state.trackingMap.setZoom(17);
                                    infoWindow.open({ anchor: marker, map: state.trackingMap });
                                });

                                state.trackingMarkers.push(marker);
                            }
                        });
                    });
                };

                if (typeof onSnapshot === 'function') {
                    const unsubscribe = onSnapshot(q, handleSnapshot);
                    state.activeListeners.push(unsubscribe);
                } else {
                    console.warn('onSnapshot ä¸å¯ç”¨ï¼Œæ”¹ç”¨è¼ªè©¢æ›´æ–°äººå“¡åˆ—è¡¨');
                    if (state.trackingPoller) clearInterval(state.trackingPoller);
                    const poll = async () => {
                        try {
                            const snap = await getDocs(q);
                            handleSnapshot(snap);
                        } catch (e) {
                            console.warn('è¼ªè©¢äººå“¡åˆ—è¡¨å¤±æ•—', e);
                        }
                    };
                    // ç«‹å³è¼‰å…¥ä¸€æ¬¡ï¼Œä¹‹å¾Œæ¯ 10 ç§’è¼ªè©¢
                    poll();
                    state.trackingPoller = setInterval(poll, 10000);
                }
            }


            function renderSettings(subPage) {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">å¸³è™Ÿåˆ—è¡¨</button>
                        <button data-subtab="rules" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'rules' ? 'active' : ''}">è¨ˆé»è¦å‰‡</button>
                        <button data-subtab="general" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'general' ? 'active' : ''}">ä¸€èˆ¬è¨­å®š</button>
                        <button data-subtab="location" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'location' ? 'active' : ''}">å®šä½ä½ç½®</button>
                        <button data-subtab="workdays" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'workdays' ? 'active' : ''}">ä¸Šç­è¨­å®š</button>
                        <button data-subtab="group" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'group' ? 'active' : ''}">ç¾¤çµ„è¨­å®š</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                // è‹¥ Firestore å°šæœªåˆå§‹åŒ–ï¼Œé¡¯ç¤ºæç¤ºä¸¦ç­‰å¾…å°±ç·’äº‹ä»¶å¾Œå†æ¸²æŸ“
                const targetSub = subPage || 'accounts';
                const needDb = ['accounts','rules','general','location','workdays','group'];
                if (!window.__db && needDb.includes(targetSub)) {
                    subPageContent.innerHTML = '<div class="p-4 text-gray-500">æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«â€¦</div>';
                    window.addEventListener('firebase-ready', () => renderSettings(targetSub), { once: true });
                    return;
                }
                if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else if (subPage === 'rules') {
                    renderSettingsRules(subPageContent);
                } else if (subPage === 'general') {
                    renderSettingsGeneral(subPageContent);
                } else if (subPage === 'location') {
                    renderSettingsLocation(subPageContent);
                } else if (subPage === 'workdays') {
                    renderSettingsWorkdays(subPageContent);
                } else if (subPage === 'group') {
                    renderSettingsGroup(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('settings', btn.dataset.subtab)));
            }

            function renderSettingsGroup(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <h2 class="text-lg font-semibold">ç¾¤çµ„è¨­å®š</h2>
                        <p class="text-sm text-gray-600">å°‡åˆéšä¸»ç®¡é—œè¯è‡³å¯æŸ¥çœ‹çš„å“¡å·¥åå–®ã€‚</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="manager-select-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">é¸æ“‡ç®¡ç†è€…</h3>
                                <select id="manager-user-select" class="w-full border border-gray-300 rounded-md px-2 py-1"></select>
                            </div>
                            <div id="allowed-users-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">å¯æŸ¥çœ‹å“¡å·¥</h3>
                                <div id="allowed-users-list" class="space-y-2"></div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="save-group-settings" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initSettingsGroupUI();
            }

            async function initSettingsGroupUI() {
                const db = window.__db;
                const managerSelect = document.getElementById('manager-user-select');
                const allowedList = document.getElementById('allowed-users-list');
                const usersRef = collection(db, 'users');
                const qs = await getDocs(usersRef);
                const users = [];
                qs.forEach(docSnap => users.push({ id: docSnap.id, ...docSnap.data() }));
                const managers = users.filter(u => u.role === 'junior_manager');
                managers.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(m => {
                    const opt = document.createElement('option'); opt.value = m.id; opt.textContent = `${m.name}`; managerSelect.appendChild(opt);
                });

                const renderAllowedUsers = async () => {
                    allowedList.innerHTML = '';
                    const selectedManagerId = managerSelect.value;
                    const allowedIds = await loadJuniorManagerAllowedUsers(selectedManagerId);
                    users.filter(u => u.role === 'user').sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(u => {
                        const row = document.createElement('label');
                        row.className = 'flex items-center justify-between bg-white p-2 rounded border';
                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.checked = allowedIds.includes(u.id);
                        chk.dataset.userid = u.id;
                        row.appendChild(document.createTextNode(u.name));
                        row.appendChild(chk);
                        allowedList.appendChild(row);
                    });
                };
                managerSelect.addEventListener('change', renderAllowedUsers);
                await renderAllowedUsers();

                document.getElementById('save-group-settings').addEventListener('click', async () => {
                    const selectedManagerId = managerSelect.value;
                    const checkboxes = allowedList.querySelectorAll('input[type="checkbox"]');
                    const allowedIds = Array.from(checkboxes).filter(c => c.checked).map(c => c.dataset.userid);
                    const docRef = doc(db, 'settings', 'group');
                    const existingSnap = await getDoc(docRef);
                    const baseData = existingSnap.exists() ? existingSnap.data() : {};
                    const newData = { ...baseData, managerGroups: { ...(baseData.managerGroups || {}), [selectedManagerId]: allowedIds } };
                    await setDoc(docRef, newData, { merge: true });
                    showToast('ç¾¤çµ„è¨­å®šå·²å„²å­˜');
                });
            }
            
            function renderSettingsAccounts(container) {
                const db = window.__db;
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-user-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢å¸³è™Ÿ
                        </button>
                        <button id="reset-points-btn" class="w-full bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-yellow-700 mb-4 flex items-center justify-center">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>é‡ç½®æ‰€æœ‰ç”¨æˆ¶é»æ•¸ç‚º0
                        </button>
                        <div id="user-list" class="space-y-2"></div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
                document.getElementById('reset-points-btn').addEventListener('click', resetAllUserPoints);

                const userList = document.getElementById('user-list');
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    userList.innerHTML = '';
                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                    state.users = users; // Update global state

                    if (users.length === 0) {
                        userList.innerHTML = `<p class="text-center text-gray-500 p-4">å°šæœªå»ºç«‹ä»»ä½•å¸³è™Ÿ</p>`;
                        return;
                    }

                    users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-gray-800">${user.name}</p>
                                    <p class="text-sm text-gray-500">${user.email}</p>
                                    <div class="flex items-center">
                                        <p class="text-xs text-gray-400 mr-2">${user.phone || ''}</p>
                                        <span class="text-xs px-2 py-1 rounded-full ${
  user.role === 'admin' ? 'bg-red-100 text-red-700' : 
  user.role === 'manager' ? 'bg-purple-100 text-purple-700' : 
  'bg-blue-100 text-blue-700'
}">${
  user.role === 'admin' ? 'ç®¡ç†å“¡' : 
  user.role === 'manager' ? 'é«˜éšä¸»ç®¡' : 
  'å…§å‹¤'
}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-userid="${user.id}" class="edit-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-userid="${user.id}" class="delete-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>`;
                        // è¦†å¯«è§’è‰²å¾½ç« å‘ˆç¾ï¼šä½¿ç”¨ roleLabel èˆ‡ roleBadgeClass
                        const badgeSpan = userElement.querySelector('span.text-xs.px-2.py-1.rounded-full');
                        if (badgeSpan) {
                            badgeSpan.className = `text-xs px-2 py-1 rounded-full ${roleBadgeClass(user.role)}`;
                            badgeSpan.textContent = roleLabel(user.role);
                        }
                        userList.appendChild(userElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToEdit = state.users.find(u => u.id === userId);
                        if (userToEdit) openUserModal(userToEdit);
                    }));

                    document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToDelete = state.users.find(u => u.id === userId);
                        if (userToDelete && confirm(`ç¢ºå®šè¦åˆªé™¤ ${userToDelete.name} çš„å¸³è™Ÿè³‡æ–™å—ï¼Ÿ\næ³¨æ„ï¼šæ­¤æ“ä½œåªæœƒåˆªé™¤è³‡æ–™åº«ç´€éŒ„ï¼Œä¸æœƒåˆªé™¤ä½¿ç”¨è€…çš„ç™»å…¥æ¬Šé™ã€‚`)) {
                            try {
                                showLoading(true);
                                await deleteDoc(doc(db, "users", userId));
                                showToast("å¸³è™Ÿè³‡æ–™åˆªé™¤æˆåŠŸ");
                            } catch (error) {
                                console.error("Error deleting user document:", error);
                                showToast("åˆªé™¤å¤±æ•—", true);
                            } finally {
                                showLoading(false);
                            }
                        }
                    }));
                });
                state.activeListeners.push(unsubscribe);
            }

            function renderSettingsGeneral(container) {
                const db = window.__db;
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">å„€è¡¨æ¿è¨­å®š</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label for="show-employee-status" class="text-gray-700">é¡¯ç¤ºå“¡å·¥ç‹€æ…‹</label>
                                    <label class="switch">
                                        <input type="checkbox" id="show-employee-status" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4" id="admin-overtime-section" style="display: none;">
                            <h3 class="font-bold text-lg mb-4">ç®¡ç†å“¡åŠŸèƒ½</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="text-gray-700 font-medium">æª¢æŸ¥è¶…æ™‚ç‹€æ…‹</label>
                                        <p class="text-sm text-gray-500">æª¢æŸ¥æ‰€æœ‰å“¡å·¥æ˜¯å¦æœ‰è¶…éå·¥ä½œæ™‚æ•¸çš„æƒ…æ³</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="check-overtime-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                            <i data-lucide="clock" class="w-4 h-4 mr-2"></i>æª¢æŸ¥è¶…æ™‚
                                        </button>
                                        <button id="test-overtime-btn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 flex items-center">
                                            <i data-lucide="test-tube" class="w-4 h-4 mr-2"></i>æ¸¬è©¦è¶…æ™‚
                                        </button>
                                    </div>
                                </div>
                                <div id="overtime-results" class="hidden">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                        <h4 class="font-medium text-yellow-800 mb-2">è¶…æ™‚å“¡å·¥åˆ—è¡¨</h4>
                                        <div id="overtime-list" class="space-y-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">é¡¯ç¤ºæ‰€æœ‰å¸³è™Ÿ</h3>
                            <p class="text-sm text-gray-600 mb-4">å‹¾é¸è¦åœ¨å„€è¡¨æ¿ã€Œæ‰€æœ‰åŒä»ç‹€æ…‹ã€ä¸­é¡¯ç¤ºçš„å¸³è™Ÿ</p>
                            <div id="user-display-settings" class="space-y-2">
                                <div class="flex items-center justify-between p-2 border-b">
                                    <label class="text-gray-700 font-medium">å¸³è™Ÿåç¨±</label>
                                    <label class="text-gray-700 font-medium">é¡¯ç¤º</label>
                                </div>
                                <div class="flex justify-center items-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                                    <span class="ml-2 text-gray-600">è¼‰å…¥ä¸­...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">ã€Œç¤¾å€äººå“¡ç‹€æ³ã€æŒ‰éˆ•å¯è¦‹äººå“¡</h3>
                            <p class="text-sm text-gray-600 mb-4">å‹¾é¸å¯åœ¨å„€è¡¨æ¿çœ‹åˆ°ã€Œç¤¾å€äººå“¡ç‹€æ³ã€æŒ‰éˆ•çš„å¸³è™Ÿ</p>
                            <div id="community-status-settings" class="space-y-2">
                                <div class="flex items-center justify-between p-2 border-b">
                                    <label class="text-gray-700 font-medium">å¸³è™Ÿåç¨±</label>
                                    <label class="text-gray-700 font-medium">å¯è¦‹</label>
                                </div>
                                <div class="flex justify-center items-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                                    <span class="ml-2 text-gray-600">è¼‰å…¥ä¸­...</span>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-general-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜è¨­å®š
                        </button>
                    </div>`;
                
                lucide.createIcons();
                
                // å¾ Firebase è®€å–è¨­å®š
                const settingsRef = doc(db, "settings", "general");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('show-employee-status').checked = settings.showEmployeeStatus !== false;
                        
                        
                        
                        // è¼‰å…¥ä½¿ç”¨è€…é¡¯ç¤ºè¨­å®š
                        loadUserDisplaySettings(settings.visibleUsers || {});
                        // è¼‰å…¥ã€Œç¤¾å€äººå“¡ç‹€æ³ã€æŒ‰éˆ•å¯è¦‹åå–®
                        loadCommunityStatusAllowedUsers(Array.isArray(settings.communityStatusAllowedUsers) ? settings.communityStatusAllowedUsers : []);
                    } else {
                        // å¦‚æœè¨­å®šä¸å­˜åœ¨ï¼Œè¼‰å…¥é è¨­å€¼ï¼ˆå…¨éƒ¨é¡¯ç¤ºï¼‰
                        loadUserDisplaySettings({});
                        loadCommunityStatusAllowedUsers([]);
                    }
                }).catch(error => {
                    console.error("Error getting general settings:", error);
                    showToast("ç„¡æ³•è®€å–è¨­å®š", true);
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä»ç„¶è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
                    loadUserDisplaySettings({});
                    loadCommunityStatusAllowedUsers([]);
                });
                
                // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨ä¸¦è¨­å®šé¡¯ç¤ºç‹€æ…‹
                function loadUserDisplaySettings(visibleUsers) {
                    const userDisplayContainer = document.getElementById('user-display-settings');
                    
                    // ç²å–æ‰€æœ‰ä½¿ç”¨è€…
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((querySnapshot) => {
                        // æ¸…é™¤è¼‰å…¥ä¸­çš„æç¤º
                        userDisplayContainer.innerHTML = `
                            <div class="flex items-center justify-between p-2 border-b">
                                <label class="text-gray-700 font-medium">å¸³è™Ÿåç¨±</label>
                                <label class="text-gray-700 font-medium">é¡¯ç¤º</label>
                            </div>
                        `;
                        
                        // æ·»åŠ å…¨é¸/å–æ¶ˆå…¨é¸é¸é …
                        const selectAllDiv = document.createElement('div');
                        selectAllDiv.className = 'flex items-center justify-between p-2 border-b bg-gray-50';
                        selectAllDiv.innerHTML = `
                            <label for="select-all-users" class="text-gray-700 font-medium">å…¨é¸/å–æ¶ˆå…¨é¸</label>
                            <label class="switch">
                                <input type="checkbox" id="select-all-users">
                                <span class="slider round"></span>
                            </label>
                        `;
                        userDisplayContainer.appendChild(selectAllDiv);
                        
                        // ç²å–å…¨é¸/å–æ¶ˆå…¨é¸çš„checkbox
                        const selectAllCheckbox = document.getElementById('select-all-users');
                        
                        // æ·»åŠ ä½¿ç”¨è€…åˆ—è¡¨
                        const userCheckboxes = [];
                        querySnapshot.forEach((doc) => {
                            const userData = doc.data();
                            const userId = doc.id;
                            
                            // é è¨­å€¼ï¼šå¦‚æœvisibleUsersç‚ºç©ºæˆ–è©²ä½¿ç”¨è€…æœªè¨­å®šï¼Œå‰‡é¡¯ç¤º
                            const isVisible = visibleUsers[userId] !== false;
                            
                            const userDiv = document.createElement('div');
                            userDiv.className = 'flex items-center justify-between p-2 border-b';
                            userDiv.innerHTML = `
                                <label for="user-${userId}" class="text-gray-700">${userData.name || userData.email || 'æœªå‘½åä½¿ç”¨è€…'}</label>
                                <label class="switch">
                                    <input type="checkbox" id="user-${userId}" data-user-id="${userId}" class="user-visibility-checkbox" ${isVisible ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            `;
                            userDisplayContainer.appendChild(userDiv);
                            
                            // å°‡checkboxåŠ å…¥é™£åˆ—ï¼Œä»¥ä¾¿å¾ŒçºŒå…¨é¸/å–æ¶ˆå…¨é¸æ“ä½œ
                            const checkbox = userDiv.querySelector(`#user-${userId}`);
                            userCheckboxes.push(checkbox);
                        });
                        
                        // è¨­å®šå…¨é¸/å–æ¶ˆå…¨é¸çš„åŠŸèƒ½
                        selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                        selectAllCheckbox.addEventListener('change', () => {
                            const isChecked = selectAllCheckbox.checked;
                            userCheckboxes.forEach(cb => {
                                cb.checked = isChecked;
                            });
                        });
                        
                        // ç•¶å€‹åˆ¥checkboxè®Šæ›´æ™‚ï¼Œæ›´æ–°å…¨é¸checkboxçš„ç‹€æ…‹
                        userCheckboxes.forEach(cb => {
                            cb.addEventListener('change', () => {
                                selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                            });
                        });
                        
                    }).catch(error => {
                        console.error("Error getting users:", error);
                        userDisplayContainer.innerHTML = `
                            <div class="p-4 text-center text-red-600">
                                <p>ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨</p>
                                <p class="text-sm">${error.message}</p>
                            </div>
                        `;
                    });
                }
                
                // è¼‰å…¥ã€Œç¤¾å€äººå“¡ç‹€æ³ã€æŒ‰éˆ•å¯è¦‹äººå“¡
                function loadCommunityStatusAllowedUsers(allowedUserIds) {
                    const container = document.getElementById('community-status-settings');
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((querySnapshot) => {
                        container.innerHTML = `
                            <div class="flex items-center justify-between p-2 border-b">
                                <label class="text-gray-700 font-medium">å¸³è™Ÿåç¨±</label>
                                <label class="text-gray-700 font-medium">å¯è¦‹</label>
                            </div>
                        `;

                        const selectAllDiv = document.createElement('div');
                        selectAllDiv.className = 'flex items-center justify-between p-2 border-b bg-gray-50';
                        selectAllDiv.innerHTML = `
                            <label for="select-all-community" class="text-gray-700 font-medium">å…¨é¸/å–æ¶ˆå…¨é¸</label>
                            <label class="switch">
                                <input type="checkbox" id="select-all-community">
                                <span class="slider round"></span>
                            </label>
                        `;
                        container.appendChild(selectAllDiv);

                        const selectAllCheckbox = document.getElementById('select-all-community');
                        const userCheckboxes = [];

                        querySnapshot.forEach((doc) => {
                            const userData = doc.data();
                            const userId = doc.id;
                            const isAllowed = Array.isArray(allowedUserIds) ? allowedUserIds.includes(userId) : false;
                            const row = document.createElement('div');
                            row.className = 'flex items-center justify-between p-2 border-b';
                            row.innerHTML = `
                                <label for="community-${userId}" class="text-gray-700">${userData.name || userData.email || 'æœªå‘½åä½¿ç”¨è€…'}</label>
                                <label class="switch">
                                    <input type="checkbox" id="community-${userId}" data-user-id="${userId}" class="community-btn-visible-checkbox" ${isAllowed ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            `;
                            container.appendChild(row);
                            userCheckboxes.push(row.querySelector(`#community-${userId}`));
                        });

                        selectAllCheckbox.checked = userCheckboxes.length > 0 && userCheckboxes.every(cb => cb.checked);
                        selectAllCheckbox.addEventListener('change', () => {
                            const isChecked = selectAllCheckbox.checked;
                            userCheckboxes.forEach(cb => { cb.checked = isChecked; });
                        });

                        userCheckboxes.forEach(cb => {
                            cb.addEventListener('change', () => {
                                selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                            });
                        });
                    }).catch(error => {
                        console.error('Error getting users for community status settings:', error);
                        container.innerHTML = `
                            <div class="p-4 text-center text-red-600">
                                <p>ç„¡æ³•è¼‰å…¥åå–®</p>
                                <p class="text-sm">${error.message}</p>
                            </div>
                        `;
                    });
                }
                
                // å„²å­˜è¨­å®š
                document.getElementById('save-general-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const showEmployeeStatus = document.getElementById('show-employee-status').checked;
                        
                        
                        // æ”¶é›†ä½¿ç”¨è€…é¡¯ç¤ºè¨­å®š
                        const visibleUsers = {};
                        document.querySelectorAll('.user-visibility-checkbox').forEach(checkbox => {
                            const userId = checkbox.dataset.userId;
                            // åªå„²å­˜æœªå‹¾é¸çš„ä½¿ç”¨è€…ï¼ˆé è¨­ç‚ºé¡¯ç¤ºï¼‰
                            if (!checkbox.checked) {
                                visibleUsers[userId] = false;
                            }
                        });
                        
                        // æ”¶é›†ã€Œç¤¾å€äººå“¡ç‹€æ³ã€æŒ‰éˆ•å¯è¦‹åå–®
                        const communityStatusAllowedUsers = Array.from(document.querySelectorAll('.community-btn-visible-checkbox'))
                            .filter(cb => cb.checked)
                            .map(cb => cb.dataset.userId);
                        
                        // å„²å­˜åˆ° Firebase
                        await setDoc(doc(db, "settings", "general"), {
                            showEmployeeStatus,
                            
                            visibleUsers,
                            communityStatusAllowedUsers,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("è¨­å®šå·²å„²å­˜");
                    } catch (error) {
                        console.error("Error saving general settings:", error);
                        showToast("å„²å­˜è¨­å®šå¤±æ•—ï¼š" + error.message, true);
                    } finally {
                        showLoading(false);
                    }
                });
                
                
                
                // å…¨åŸŸå‡½æ•¸å·²å®šç¾©æ–¼æª”æ¡ˆé ‚ç«¯ï¼Œé€™è£¡ä¸å†é‡è¤‡å®£å‘Š
            }
            
            function renderSettingsLocation(container) {
                const db = window.__db;
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">å…¬å¸ä½ç½®è¨­å®š</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="company-lat" class="block text-sm font-medium text-gray-700">ç·¯åº¦</label>
                                        <input type="number" id="company-lat" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                    <div>
                                        <label for="company-lng" class="block text-sm font-medium text-gray-700">ç¶“åº¦</label>
                                        <input type="number" id="company-lng" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                </div>
                                <div>
                                    <label for="company-radius" class="block text-sm font-medium text-gray-700">æœ‰æ•ˆæ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                                    <input type="number" id="company-radius" min="10" max="1000" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="mark-abnormal-location" class="text-gray-700">æ¨™è¨˜ç•°å¸¸ä½ç½®</label>
                                    <label class="switch">
                                        <input type="checkbox" id="mark-abnormal-location" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">å…¶ä»–æ‰“å¡ä½ç½®</h3>
                            <div id="other-locations" class="space-y-4">
                                <!-- å…¶ä»–ä½ç½®æœƒå‹•æ…‹æ·»åŠ åœ¨é€™è£¡ -->
                            </div>
                            <button id="add-location-btn" class="w-full mt-4 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>æ–°å¢ä½ç½®
                            </button>
                        </div>
                        
                        <button id="save-location-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜è¨­å®š
                        </button>
                    </div>`;
                
                lucide.createIcons();
                
                // å¾ Firebase è®€å–è¨­å®š
                const settingsRef = doc(db, "settings", "location");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('company-lat').value = settings.companyLat || '';
                        document.getElementById('company-lng').value = settings.companyLng || '';
                        document.getElementById('company-radius').value = settings.companyRadius || 100;
                        document.getElementById('mark-abnormal-location').checked = settings.markAbnormalLocation !== false;
                        
                        // æ¸²æŸ“å…¶ä»–ä½ç½®
                        renderOtherLocations(settings.otherLocations || []);
                    }
                }).catch(error => {
                    console.error("Error getting location settings:", error);
                    showToast("ç„¡æ³•è®€å–ä½ç½®è¨­å®š", true);
                });
                
                // æ¸²æŸ“å…¶ä»–ä½ç½®
                function renderOtherLocations(locations) {
                    const container = document.getElementById('other-locations');
                    container.innerHTML = '';
                    
                    if (locations.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">å°šæœªè¨­å®šå…¶ä»–ä½ç½®</p>';
                        return;
                    }
                    
                    locations.forEach((location, index) => {
                        const locationEl = document.createElement('div');
                        locationEl.className = 'bg-gray-50 p-3 rounded-md border';
                        locationEl.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">${location.name || `ä½ç½® ${index + 1}`}</h4>
                                <button class="delete-location-btn text-red-500" data-index="${index}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-xs text-gray-500">åç¨±</label>
                                    <input type="text" class="location-name w-full px-2 py-1 border rounded-md text-sm" value="${location.name || ''}" placeholder="ä½ç½®åç¨±">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">åŠå¾‘ (å…¬å°º)</label>
                                    <input type="number" class="location-radius w-full px-2 py-1 border rounded-md text-sm" value="${location.radius || 100}" min="10" max="1000">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-500">ç·¯åº¦</label>
                                    <input type="number" class="location-lat w-full px-2 py-1 border rounded-md text-sm" value="${location.lat || ''}" step="0.000001">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">ç¶“åº¦</label>
                                    <input type="number" class="location-lng w-full px-2 py-1 border rounded-md text-sm" value="${location.lng || ''}" step="0.000001">
                                </div>
                            </div>
                        `;
                        container.appendChild(locationEl);
                    });
                    
                    lucide.createIcons();
                    
                    // åˆªé™¤ä½ç½®æŒ‰éˆ•äº‹ä»¶
                    document.querySelectorAll('.delete-location-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.dataset.index);
                            const settingsRef = doc(db, "settings", "location");
                            getDoc(settingsRef).then((docSnap) => {
                                if (docSnap.exists()) {
                                    const settings = docSnap.data();
                                    const otherLocations = settings.otherLocations || [];
                                    otherLocations.splice(index, 1);
                                    renderOtherLocations(otherLocations);
                                }
                            });
                        });
                    });
                }
                
                // æ–°å¢ä½ç½®æŒ‰éˆ•äº‹ä»¶
                document.getElementById('add-location-btn').addEventListener('click', () => {
                    const settingsRef = doc(db, "settings", "location");
                    getDoc(settingsRef).then((docSnap) => {
                        const settings = docSnap.exists() ? docSnap.data() : {};
                        const otherLocations = settings.otherLocations || [];
                        otherLocations.push({
                            name: `ä½ç½® ${otherLocations.length + 1}`,
                            lat: '',
                            lng: '',
                            radius: 100
                        });
                        renderOtherLocations(otherLocations);
                    });
                });
                
                // å„²å­˜è¨­å®š
                document.getElementById('save-location-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const companyLat = parseFloat(document.getElementById('company-lat').value);
                        const companyLng = parseFloat(document.getElementById('company-lng').value);
                        const companyRadius = parseInt(document.getElementById('company-radius').value);
                        const markAbnormalLocation = document.getElementById('mark-abnormal-location').checked;
                        
                        // æ”¶é›†å…¶ä»–ä½ç½®è³‡æ–™
                        const otherLocations = [];
                        document.querySelectorAll('#other-locations > div').forEach(el => {
                            const name = el.querySelector('.location-name').value;
                            const lat = parseFloat(el.querySelector('.location-lat').value);
                            const lng = parseFloat(el.querySelector('.location-lng').value);
                            const radius = parseInt(el.querySelector('.location-radius').value);
                            
                            if (name && !isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
                                otherLocations.push({ name, lat, lng, radius });
                            }
                        });
                        
                        await setDoc(doc(db, "settings", "location"), {
                            companyLat,
                            companyLng,
                            companyRadius,
                            markAbnormalLocation,
                            otherLocations,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("ä½ç½®è¨­å®šå·²å„²å­˜");
                    } catch (error) {
                        console.error("Error saving location settings:", error);
                        showToast("å„²å­˜ä½ç½®è¨­å®šå¤±æ•—", true);
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            function renderSettingsWorkdays(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg">ä¸Šç­è¨­å®šï¼ˆæ¯äººæ¯æœˆï¼‰</h3>
                                <div class="flex items-center space-x-2">
                                    <button id="prev-month" class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                        <i data-lucide="chevrons-left" class="w-4 h-4"></i>
                                    </button>
                                    <span id="workdays-month-label" class="font-semibold"></span>
                                    <button id="next-month" class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                        <i data-lucide="chevrons-right" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">ç‚ºç›®å‰ç™»å…¥è€…è¨­å®šæŒ‡å®šæœˆä»½çš„ä¸Šç­æ—¥ã€‚</p>
                            <div id="workdays-grid" class="grid grid-cols-7 gap-2"></div>
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <button id="select-weekdays" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200">é¸å–é€±ä¸€è‡³é€±äº”</button>
                                <button id="clear-selection" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200">æ¸…é™¤é¸å–</button>
                            </div>
                            <button id="save-workdays" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜æœ¬æœˆä¸Šç­æ—¥
                            </button>
                        </div>
                    </div>`;

                lucide.createIcons();

                const { doc, getDoc, setDoc, serverTimestamp } = window.__fs || {};
                const db = window.__db;
                const user = window.__auth?.currentUser;
                if (!user) {
                    showToast('è«‹å…ˆç™»å…¥', true);
                    return;
                }

                let targetYear, targetMonth; // 0-based month
                const gridEl = document.getElementById('workdays-grid');
                const labelEl = document.getElementById('workdays-month-label');

                function setMonth(date) {
                    targetYear = date.getFullYear();
                    targetMonth = date.getMonth();
                    labelEl.textContent = `${targetYear}å¹´${String(targetMonth + 1).padStart(2,'0')}æœˆ`;
                    renderMonthGrid();
                    loadWorkdays();
                    // è¼‰å…¥æœ¬æœˆé€±äº”å€¼ç­äººå“¡
                    loadFridayDuty?.();
                }

                function daysInMonth(y, m0) {
                    return new Date(y, m0 + 1, 0).getDate();
                }

                function renderMonthGrid(selectedDays = new Set()) {
                    gridEl.innerHTML = '';
                    // Weekday headers
                    const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    weekdays.forEach(w => {
                        const h = document.createElement('div');
                        h.className = 'text-center text-gray-500 text-sm';
                        h.textContent = w;
                        gridEl.appendChild(h);
                    });
                    // First day offset
                    const firstDay = new Date(targetYear, targetMonth, 1).getDay();
                    for (let i = 0; i < firstDay; i++) {
                        const empty = document.createElement('div');
                        gridEl.appendChild(empty);
                    }
                    const dim = daysInMonth(targetYear, targetMonth);
                    for (let d = 1; d <= dim; d++) {
                        const cell = document.createElement('button');
                        cell.className = 'border rounded p-2 text-center hover:bg-gray-50';
                        cell.dataset.day = String(d);
                        const dow = new Date(targetYear, targetMonth, d).getDay();
                        const isSelected = selectedDays.has(d);
                        cell.innerHTML = `
                            <div class="text-xs text-gray-500">${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dow]}</div>
                            <div class="text-lg">${d}</div>
                        `;
                        if (isSelected) {
                            cell.classList.add('bg-blue-100','border-blue-400');
                        }
                        cell.addEventListener('click', () => {
                            cell.classList.toggle('bg-blue-100');
                            cell.classList.toggle('border-blue-400');
                        });
                        gridEl.appendChild(cell);
                    }
                }

                async function loadWorkdays() {
                    try {
                        const ymId = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}`;
                        const ref = doc(db, 'users', user.uid, 'workdays', ymId);
                        const snap = await getDoc(ref);
                        const selected = new Set();
                        if (snap.exists()) {
                            const data = snap.data();
                            (data.days || []).forEach(n => selected.add(Number(n)));
                        }
                        renderMonthGrid(selected);
                    } catch (err) {
                        console.error('è¼‰å…¥ä¸Šç­æ—¥è¨­å®šå¤±æ•—:', err);
                        renderMonthGrid(new Set());
                        showToast('è¼‰å…¥ä¸Šç­æ—¥è¨­å®šå¤±æ•—', true);
                    }
                }

                function getSelectedDays() {
                    const selected = [];
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        if (btn.classList.contains('bg-blue-100')) {
                            selected.push(Number(btn.dataset.day));
                        }
                    });
                    return selected;
                }

                document.getElementById('prev-month').addEventListener('click', () => {
                    const d = new Date(targetYear, targetMonth - 1, 1);
                    setMonth(d);
                });
                document.getElementById('next-month').addEventListener('click', () => {
                    const d = new Date(targetYear, targetMonth + 1, 1);
                    setMonth(d);
                });
                document.getElementById('select-weekdays').addEventListener('click', () => {
                    // Select Mon-Fri
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        const day = Number(btn.dataset.day);
                        const dow = new Date(targetYear, targetMonth, day).getDay();
                        if (dow >= 1 && dow <= 5) {
                            btn.classList.add('bg-blue-100','border-blue-400');
                        } else {
                            btn.classList.remove('bg-blue-100','border-blue-400');
                        }
                    });
                });
                document.getElementById('clear-selection').addEventListener('click', () => {
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        btn.classList.remove('bg-blue-100','border-blue-400');
                    });
                });

                document.getElementById('save-workdays').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const days = getSelectedDays();
                        const ymId = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}`;
                        const ref = doc(db, 'users', user.uid, 'workdays', ymId);
                        await setDoc(ref, { days, updatedAt: serverTimestamp() }, { merge: true });
                        showToast('æœ¬æœˆä¸Šç­æ—¥å·²å„²å­˜');
                    } catch (err) {
                        console.error('å„²å­˜ä¸Šç­æ—¥å¤±æ•—:', err);
                        showToast('å„²å­˜ä¸Šç­æ—¥å¤±æ•—', true);
                    } finally {
                        showLoading(false);
                    }
                });

                // å‹•æ…‹æ’å…¥é€±äº”å€¼ç­åå–®ï¼ˆåˆ†é€±è¨­å®šï¼‰
                try {
                    const root = container.querySelector('.p-4');
                    const dutyHTML = `
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg">æŒ‡å®šæœˆä»½æ¯é€±äº”å€¼ç­åå–®ï¼ˆåˆ†é€±è¨­å®šï¼‰</h3>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">æ¯é€±å–®ç¨è¨­å®šï¼Œè«‹å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡å€¼ç­äººå“¡ï¼ˆå¯å¤šé¸ï¼‰ï¼Œä¸è¦æ‰‹å¯«è¼¸å…¥ã€‚</p>
                            <div id="friday-roster-list" class="space-y-2"></div>
                            <div class="flex items-center justify-end mt-2">
                                <button id="save-friday-roster" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜æŒ‡å®šæœˆä»½å€¼ç­åå–®
                                </button>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">å·²å„²å­˜ï¼š<span id="friday-duty-display"></span></div>
                        </div>`;
                    root?.insertAdjacentHTML('beforeend', dutyHTML);
                    lucide.createIcons();
                } catch(e) { console.warn('æ’å…¥é€±äº”å€¼ç­äººå“¡å€å¡Šå¤±æ•—', e); }

                // ä¾›å€¼ç­åå–®é¸æ“‡ä½¿ç”¨ï¼šæ‰€æœ‰ä½¿ç”¨è€…ï¼ˆUID èˆ‡å§“åï¼‰
                let allUsers = [];
                let uidToName = {};
                let nameToUid = {};

                async function loadAllUserNames() { // ä¿ç•™èˆŠå‡½å¼åï¼Œå¯¦éš›å›å‚³ UID/å§“å
                    try {
                        if (typeof getDocs !== 'function' || typeof collection !== 'function') {
                            allUsers = []; uidToName = {}; nameToUid = {};
                            return;
                        }
                        const snap = await getDocs(collection(db, 'users'));
                        const usersArr = [];
                        const u2n = {}; const n2u = {};
                        snap.forEach(docu => {
                            const data = docu.data();
                            const uid = docu.id;
                            const name = (data.displayName || data.name || data.email || uid || '').toString().trim();
                            if (!name) return;
                            usersArr.push({ id: uid, name });
                            u2n[uid] = name;
                            n2u[name] = uid;
                        });
                        usersArr.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
                        allUsers = usersArr; uidToName = u2n; nameToUid = n2u;
                    } catch (e) {
                        console.warn('è®€å–æ‰€æœ‰å¸³è™Ÿå§“åå¤±æ•—', e);
                        allUsers = []; uidToName = {}; nameToUid = {};
                    }
                }

                // å·¥å…·ï¼šå–å¾—æŸæœˆæ‰€æœ‰é€±äº”æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
                function getFridaysInMonth(year, month0) {
                    const fridays = [];
                    const last = new Date(year, month0 + 1, 0).getDate();
                    for (let d = 1; d <= last; d++) {
                        const dt = new Date(year, month0, d);
                        if (dt.getDay() === 5) {
                            const y = dt.getFullYear();
                            const m = String(dt.getMonth() + 1).padStart(2, '0');
                            const dd = String(dt.getDate()).padStart(2, '0');
                            fridays.push(`${y}-${m}-${dd}`);
                        }
                    }
                    return fridays;
                }

                // å°‡åå–®æ¸²æŸ“æˆæ¯é€±å¤šé¸ä¸‹æ‹‰åˆ—ï¼ˆå€¼ç‚º UIDã€é¡¯ç¤ºå§“åï¼‰
                function renderFridayRosterList(rosterMap) {
                    const listEl = document.getElementById('friday-roster-list');
                    if (!listEl) return;
                    const fridays = getFridaysInMonth(targetYear, targetMonth);
                    listEl.innerHTML = '';
                    fridays.forEach((iso) => {
                        const presetArr = (rosterMap[iso] || []); // æ‡‰ç‚º UID é™£åˆ—ï¼ˆå·²æ–¼è¼‰å…¥æ™‚è½‰æ›ï¼‰
                        const row = document.createElement('div');
                        row.className = 'space-y-1';
                        const label = document.createElement('label');
                        label.className = 'block text-sm text-gray-700';
                        label.textContent = `${iso}ï¼ˆé€±äº”ï¼‰`;
                        const select = document.createElement('select');
                        select.className = 'w-full border border-gray-300 rounded-md px-3 py-2';
                        select.multiple = true;
                        select.setAttribute('data-iso', iso);
                        // å»ºç«‹é¸é …
                        (allUsers || []).forEach(u => {
                            const opt = document.createElement('option');
                            opt.value = u.id; // UID
                            opt.textContent = u.name; // é¡¯ç¤ºå§“å
                            if (presetArr.includes(u.id)) opt.selected = true;
                            select.appendChild(opt);
                        });
                        row.appendChild(label);
                        row.appendChild(select);
                        listEl.appendChild(row);
                    });
                }

                // é¡¯ç¤ºæ‘˜è¦æ–‡å­—
                function summarizeRosterDisplay(rosterMap) {
                    const fridays = getFridaysInMonth(targetYear, targetMonth);
                    const items = fridays
                        .filter(iso => (rosterMap[iso] || []).length > 0)
                        .map(iso => {
                            const ids = (rosterMap[iso] || []);
                            const names = ids.map(id => uidToName[id] || id);
                            return `${iso}ï¼š${names.join('ã€')}`;
                        });
                    return items.length ? items.join('ï¼›') : '';
                }

                // é€±äº”å€¼ç­åå–®è¼‰å…¥ï¼ˆå…¨åŸŸè¨­å®š settings/general.fridayDutyRosterï¼‰
                async function loadFridayDuty() {
                    try {
                        const settingsRef = doc(db, 'settings', 'general');
                        const snap = await getDoc(settingsRef);
                        const roster = snap.exists() ? (snap.data().fridayDutyRoster || {}) : {};

                        // å…ˆè¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…åå–®ï¼ˆå–å¾— UID/name å°ç…§ï¼‰
                        if (!allUsers || allUsers.length === 0) {
                            await loadAllUserNames();
                        }

                        // å°‡èˆŠè³‡æ–™ï¼ˆå§“åé™£åˆ—ï¼‰è½‰ç‚º UID é™£åˆ—
                        const convertToUidArr = (arr) => {
                            const a = Array.isArray(arr) ? arr : [];
                            const ids = a.map(v => nameToUid[v] || v).filter(Boolean);
                            // å»é‡
                            return Array.from(new Set(ids));
                        };

                        // è‡ªå‹•å¸¶å…¥åå–®ï¼šè‹¥æœ¬æœˆæœªå¡«ï¼Œå˜—è©¦æ²¿ç”¨ä¸Šå€‹æœˆåŒé€±æ¬¡çš„åå–®
                        const thisFridays = getFridaysInMonth(targetYear, targetMonth);
                        const prevDate = new Date(targetYear, targetMonth - 1, 1);
                        const prevFridays = getFridaysInMonth(prevDate.getFullYear(), prevDate.getMonth());
                        const renderMap = {};
                        // ä»¥è½‰æ›å¾Œçš„ UID é™£åˆ—å»ºç«‹æ¸²æŸ“è³‡æ–™
                        Object.keys(roster).forEach(k => { renderMap[k] = convertToUidArr(roster[k]); });
                        for (let i = 0; i < thisFridays.length; i++) {
                            const iso = thisFridays[i];
                            const prevIso = prevFridays[i];
                            const hasThis = Array.isArray(renderMap[iso]) && renderMap[iso].length > 0;
                            const hasPrev = prevIso && Array.isArray(roster[prevIso]) && convertToUidArr(roster[prevIso]).length > 0;
                            if (!hasThis && hasPrev) {
                                renderMap[iso] = convertToUidArr(roster[prevIso]);
                            }
                        }

                        renderFridayRosterList(renderMap);
                        const display = document.getElementById('friday-duty-display');
                        if (display) display.textContent = summarizeRosterDisplay(renderMap);
                    } catch (e) {
                        console.warn('è¼‰å…¥é€±äº”å€¼ç­åå–®å¤±æ•—', e);
                    }
                }

                function parseDutyNames(str) {
                    return (str || '')
                        .split(/[,ï¼Œã€\s]+/)
                        .map(s => s.trim())
                        .filter(s => s.length > 0);
                }

                const saveFridayBtn = document.getElementById('save-friday-roster');
                if (saveFridayBtn) {
                    saveFridayBtn.addEventListener('click', async () => {
                        try {
                            showLoading(true);
                            const settingsRef = doc(db, 'settings', 'general');
                            const snap = await getDoc(settingsRef);
                            const current = snap.exists() ? (snap.data().fridayDutyRoster || {}) : {};
                            const fridays = getFridaysInMonth(targetYear, targetMonth);
                            const updated = { ...current };
                            fridays.forEach(iso => {
                                const select = document.querySelector(`#friday-roster-list select[data-iso="${iso}"]`);
                                const ids = Array.from(select?.selectedOptions || []).map(o => o.value); // å­˜ UID
                                updated[iso] = ids;
                            });
                            await setDoc(settingsRef, { fridayDutyRoster: updated, updatedAt: serverTimestamp() }, { merge: true });
                            const display = document.getElementById('friday-duty-display');
                            if (display) display.textContent = summarizeRosterDisplay(updated);
                            showToast('æŒ‡å®šæœˆä»½é€±äº”å€¼ç­åå–®å·²å„²å­˜');
                        } catch (err) {
                            console.error('å„²å­˜é€±äº”å€¼ç­åå–®å¤±æ•—:', err);
                            showToast('å„²å­˜é€±äº”å€¼ç­åå–®å¤±æ•—', true);
                        } finally {
                            showLoading(false);
                        }
                    });
                }

                setMonth(new Date());
            }
            
            function renderSettingsRules(container) {
                const db = window.__db;
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-rule-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢è¦å‰‡
                        </button>
                        <div id="rule-list" class="space-y-2">è®€å–ä¸­...</div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-rule-btn').addEventListener('click', () => openRuleModal());

                const ruleList = document.getElementById('rule-list');
                const rulesRef = collection(db, "pointRules");
                const q = query(rulesRef, orderBy("reason"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    ruleList.innerHTML = '';
                    if (querySnapshot.empty) {
                        ruleList.innerHTML = `<p class="text-center text-gray-500 p-4">å°šæœªå»ºç«‹ä»»ä½•è¦å‰‡</p>`;
                        return;
                    }
                    querySnapshot.forEach(doc => {
                        const rule = { id: doc.id, ...doc.data() };
                        const pointsClass = rule.points > 0 ? 'text-green-600' : 'text-red-600';
                        const ruleElement = document.createElement('div');
                        ruleElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        ruleElement.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${rule.reason}</p>
                                <p class="text-sm text-gray-500">å°è±¡: ${rule.target}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg ${pointsClass}">${rule.points > 0 ? '+' : ''}${rule.points}</span>
                                <button data-ruleid="${rule.id}" class="edit-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-ruleid="${rule.id}" class="delete-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        ruleList.appendChild(ruleElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                         const ruleId = e.currentTarget.dataset.ruleid;
                         const ruleDoc = await getDoc(doc(db, "pointRules", ruleId));
                         if (ruleDoc.exists()) {
                            openRuleModal({ id: ruleId, ...ruleDoc.data() });
                         }
                    }));

                    document.querySelectorAll('.delete-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const ruleId = e.currentTarget.dataset.ruleid;
                        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¦å‰‡å—ï¼Ÿ')) {
                            await deleteDoc(doc(db, "pointRules", ruleId));
                            showToast("è¦å‰‡åˆªé™¤æˆåŠŸ");
                        }
                    }));

                });
                state.activeListeners.push(unsubscribe);
            }

            // --- Modals ---
            function openMapModal(lat, lng) {
                const modalId = `map-modal-${Date.now()}`;
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ä½ç½®è³‡è¨Š</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div id="modal-map" class="h-[300px] w-full"></div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                // Chrome requires secure context (https:// or localhost) for geolocation; inform user if not secure
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('éå®‰å…¨ä¾†æºï¼Œå¯èƒ½å°è‡´å®šä½æˆ–åœ°åœ–ç„¡æ³•ä½¿ç”¨');
                    showToast('æç¤ºï¼šè«‹ä»¥ https æˆ– localhost é–‹å•Ÿä»¥ä½¿ç”¨åœ°åœ–å®šä½', true);
                }
                if (window.google && window.google.maps) {
                    const mapDiv = document.getElementById('modal-map');
                    const map = new google.maps.Map(mapDiv, {
                        center: { lat, lng },
                        zoom: 17
                    });
                    
                    new google.maps.Marker({
                        position: { lat, lng },
                        map: map
                    });
                } else {
                    document.getElementById('modal-map').innerHTML = 
                        '<div class="p-4 text-center text-red-500">Google Maps å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
                }
            }
            
            function openPhotoModal(photos, descriptions) {
                const modalId = `photo-modal-${Date.now()}`;
                
                let contentHTML;
                if (photos && photos.length > 0) {
                    contentHTML = photos.map((url, index) => `
                        <div class="photo-slide">
                            <img src="${url}" class="max-h-[400px] max-w-full object-contain mx-auto" onerror="this.src='https://via.placeholder.com/400x300?text=ç…§ç‰‡è¼‰å…¥å¤±æ•—'">
                            <p class="text-center mt-2 text-gray-600">${descriptions[index] || ''}</p>
                        </div>
                    `).join('');
                } else {
                    contentHTML = '<div class="p-4 text-center text-gray-500">ç„¡ç…§ç‰‡</div>';
                }
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ç…§ç‰‡ç€è¦½</h3>
                                <div class="flex items-center gap-2">
                                    <button class="close-btn text-gray-500 hover:text-gray-700">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 photo-container">
                                ${contentHTML}
                            </div>
                            ${(photos?.length || 0) > 1 ? `
                            <div class="flex justify-center p-2 gap-2">
                                <button class="prev-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">ä¸Šä¸€å¼µ</button>
                                <button class="next-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">ä¸‹ä¸€å¼µ</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                // ä¸‹è¼‰åŠŸèƒ½å·²ç§»é™¤
                
                if ((photos?.length || 0) > 1) {
                    const slides = modal.querySelectorAll('.photo-slide');
                    let currentSlide = 0;
                    
                    slides.forEach((slide, index) => {
                        slide.style.display = index === 0 ? 'block' : 'none';
                    });
                    
                    modal.querySelector('.prev-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                    
                    modal.querySelector('.next-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide + 1) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                }
            }

            // æ–°å¢ï¼šç·¨è¼¯å‡ºå‹¤ç´€éŒ„å½ˆçª—
            function openEditRecordModal(record) {
                const modalId = `edit-record-modal-${Date.now()}`;
                const toDatetimeLocal = (iso) => {
                    try {
                        const d = iso ? new Date(iso) : new Date();
                        const pad = (n) => String(n).padStart(2, '0');
                        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    } catch {
                        return '';
                    }
                };
                const typeOptions = ['ä¸Šç­','ä¸‹ç­','å¤–å‡º','è¿”å›','æŠµé”','é›¢é–‹','è‡ªå‹•ä¸‹ç­'];
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[520px] bg-white rounded-lg shadow-xl">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ç·¨è¼¯å‡ºå‹¤ç´€éŒ„</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-4 space-y-3">
                                <div>
                                    <label class="text-sm">ç‹€æ…‹</label>
                                    <select id="edit-type" class="border rounded px-2 py-1 w-full">
                                        ${typeOptions.map(t => `<option value="${t}" ${t===record.type? 'selected':''}>${t}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm">æ™‚é–“</label>
                                    <input id="edit-time" type="datetime-local" value="${toDatetimeLocal(record.timeISO)}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-sm">ç·¯åº¦</label>
                                        <input id="edit-lat" type="number" step="0.000001" value="${record.lat ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                    <div>
                                        <label class="text-sm">ç¶“åº¦</label>
                                        <input id="edit-lng" type="number" step="0.000001" value="${record.lng ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm">åœ°é»åç¨±</label>
                                    <input id="edit-location-name" type="text" value="${record.locationName || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div>
                                    <label class="text-sm">å‹¤å‹™é¡å‹</label>
                                    <input id="edit-duty-type" type="text" value="${record.dutyType || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 p-4 border-t">
                                <button class="cancel-btn px-3 py-1 rounded bg-gray-200">å–æ¶ˆ</button>
                                <button class="save-btn px-3 py-1 rounded bg-blue-600 text-white">å„²å­˜</button>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modalEl = document.getElementById(modalId);
                const close = () => { modalEl?.remove(); };
                modalEl.querySelector('.close-btn')?.addEventListener('click', close);
                modalEl.querySelector('.cancel-btn')?.addEventListener('click', close);
                modalEl.querySelector('.save-btn')?.addEventListener('click', async () => {
                    try {
                        const db = window.__db; const { updateDoc, doc, GeoPoint, Timestamp } = window.__fs;
                        const type = document.getElementById('edit-type').value;
                        const timeStr = document.getElementById('edit-time').value;
                        const latStr = document.getElementById('edit-lat').value;
                        const lngStr = document.getElementById('edit-lng').value;
                        const locationName = document.getElementById('edit-location-name').value?.trim?.() || '';
                        const dutyType = document.getElementById('edit-duty-type').value?.trim?.() || '';
                        const allowed = ['ä¸Šç­','ä¸‹ç­','å¤–å‡º','è¿”å›','æŠµé”','é›¢é–‹','è‡ªå‹•ä¸‹ç­'];
                        if (!allowed.includes(type)) { showToast('ç‹€æ…‹ä¸åˆæ³•', true); return; }
                        const d = timeStr ? new Date(timeStr) : new Date();
                        const updateData = { type, timestamp: Timestamp.fromDate(d) };
                        const lat = latStr ? parseFloat(latStr) : null;
                        const lng = lngStr ? parseFloat(lngStr) : null;
                        if (typeof lat === 'number' && typeof lng === 'number' && !Number.isNaN(lat) && !Number.isNaN(lng)) {
                            updateData.location = new GeoPoint(lat, lng);
                        }
                        if (locationName) updateData.locationName = locationName.slice(0, 100);
                        if (dutyType) updateData.dutyType = dutyType.slice(0, 100);
                        await updateDoc(doc(db, 'clockInRecords', record.id), updateData);
                        showToast('æ›´æ–°æˆåŠŸ');
                        // ä¾ç•¶å‰é é¢è§¸ç™¼åˆ·æ–°ï¼šè¿½è¹¤æˆ–äººäº‹åˆ—è¡¨
                        try {
                            if (typeof loadAttendanceRecords === 'function') {
                                // è¿½è¹¤é é¢
                                loadAttendanceRecords();
                            } else if (typeof renderAttendanceRecordsList === 'function') {
                                // äººäº‹åˆ—è¡¨é é¢
                                const selectedUserId = document.getElementById('user-select')?.value || 'all';
                                const selectedDateStr = document.getElementById('record-date')?.value || new Date().toISOString().split('T')[0];
                                await renderAttendanceRecordsList('attendance-records-list', selectedUserId, selectedDateStr);
                            }
                        } catch (err) {
                            console.warn('åˆ·æ–°åˆ—è¡¨æ™‚ç™¼ç”Ÿå•é¡Œï¼š', err);
                        }
                        close();
                    } catch (e) {
                        console.error('update clockInRecord error', e);
                        showToast('æ›´æ–°å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–è³‡æ–™æ ¼å¼', true);
                    }
                });
            }

            function openUserModal(user = null) {
                const modalContainer = document.getElementById('modal-container');
                const modalId = `user-modal-${Date.now()}`;
                const isEditing = user !== null;
                const title = isEditing ? 'ç·¨è¼¯å¸³è™Ÿ' : 'æ–°å¢å¸³è™Ÿ';
                let newUserAvatarFile = null;
                let newUserAvatarBase64 = null;
                const close = () => document.getElementById(modalId)?.remove();

                const defaultAvatar = 'https://placehold.co/80x80/EFEFEF/333333?text=é ­åƒ';

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="user-form" class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar Section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="user-avatar-preview" src="${isEditing && user.avatarUrl ? user.avatarUrl : defaultAvatar}" class="w-20 h-20 rounded-full object-cover">
                                    <input type="file" id="user-avatar-upload" class="hidden" accept="image/*">
                                    <div class="flex space-x-2">
                                        <button type="button" id="user-upload-avatar-btn" class="text-sm px-3 py-1 bg-gray-200 rounded-md">ä¸Šå‚³ç…§ç‰‡</button>
                                
                                    </div>
                                </div>
                                
                                <!-- Form Fields -->
                                <div>
                                    <label for="user-name" class="block text-sm font-medium text-gray-700">å§“å (å¿…å¡«)</label>
                                    <input type="text" id="user-name" value="${isEditing ? user.name : ''}" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                 <div>
                                    <label for="user-phone" class="block text-sm font-medium text-gray-700">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                                    <input type="tel" id="user-phone" value="${isEditing ? user.phone || '' : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                 <div>
                                    <label for="user-lineid" class="block text-sm font-medium text-gray-700">Line ID</label>
                                    <input type="text" id="user-lineid" value="${isEditing ? user.lineId || '' : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶ / å¸³è™Ÿ (å¿…å¡«)</label>
                                    <input type="email" id="user-email" value="${isEditing ? user.email : ''}" ${isEditing ? 'disabled' : ''} class="w-full mt-1 px-3 py-2 border rounded-md ${isEditing ? 'bg-gray-100' : ''}" required>
                                </div>
                                ${!isEditing ? `
                                <div>
                                    <label for="user-password" class="block text-sm font-medium text-gray-700">è¨­å®šå¯†ç¢¼ (å¿…å¡«, è‡³å°‘6ä½æ•¸)</label>
                                    <input type="password" id="user-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="user-confirm-password" class="block text-sm font-medium text-gray-700">å†æ¬¡ç¢ºèªå¯†ç¢¼ (å¿…å¡«)</label>
                                    <input type="password" id="user-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                ` : ''}
                                <div>
                                    <label for="user-role" class="block text-sm font-medium text-gray-700">è§’è‰² (å¿…å¡«)</label>
                                    <select id="user-role" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="field" ${isEditing && user.role === 'field' ? 'selected' : ''}>å¤–å‹¤</option>
                                        <option value="user" ${isEditing && user.role === 'user' ? 'selected' : ''}>å…§å‹¤</option>
                                        <option value="junior_manager" ${isEditing && user.role === 'junior_manager' ? 'selected' : ''}>åˆéšä¸»ç®¡</option>
                                        <option value="manager" ${isEditing && user.role === 'manager' ? 'selected' : ''}>é«˜éšä¸»ç®¡</option>
                                        <option value="hr" ${isEditing && user.role === 'hr' ? 'selected' : ''}>äººäº‹</option>
                                        <option value="admin" ${isEditing && user.role === 'admin' ? 'selected' : ''}>ç®¡ç†å“¡</option>
                                    </select>
                                </div>

                                ${isEditing ? `
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="user-resigned" class="h-4 w-4" ${user.resigned ? 'checked' : ''} />
                                    <label for="user-resigned" class="text-sm text-gray-700">é›¢è·ï¼ˆåœç”¨ç™»å…¥ï¼‰</label>
                                </div>
                                <p class="text-xs text-gray-500">å•Ÿç”¨å¾Œæ­¤å¸³è™Ÿå°‡ç„¡æ³•ç™»å…¥ï¼Œä¸¦é¡¯ç¤ºã€Œæ‚¨å·²é›¢è·ã€ç„¡æ³•ç™»å…¥ã€ã€‚å–æ¶ˆå•Ÿç”¨å‰‡æ¢å¾©ã€‚</p>
                                ` : ''}

                                ${isEditing ? `
                                <div class="border-t pt-4 space-y-3">
                                    <h4 class="font-semibold mb-1">å¯†ç¢¼ç®¡ç†</h4>
                                    ${window.__auth?.currentUser?.uid === user.id ? `
                                    <div class="grid gap-2">
                                        <div>
                                            <label class="text-sm">ç›®å‰å¯†ç¢¼</label>
                                            <input id="curr-password" type="password" class="border rounded px-2 py-1 w-full" />
                                        </div>
                                        <div>
                                            <label class="text-sm">æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½ï¼‰</label>
                                            <input id="new-password" type="password" class="border rounded px-2 py-1 w-full" />
                                        </div>
                                        <div>
                                            <label class="text-sm">å†æ¬¡ç¢ºèªæ–°å¯†ç¢¼</label>
                                            <input id="confirm-new-password" type="password" class="border rounded px-2 py-1 w-full" />
                                        </div>
                                        <div class="flex justify-end">
                                            <button type="button" id="self-save-password-btn" class="px-3 py-1 rounded bg-blue-600 text-white">è®Šæ›´æˆ‘çš„å¯†ç¢¼</button>
                                        </div>
                                    </div>
                                    ` : `
                                    <div class="text-sm text-gray-600">ä½ æ­£åœ¨ç·¨è¼¯å…¶ä»–äººçš„å¸³è™Ÿï¼Œç„¡æ³•ç›´æ¥è®Šæ›´å…¶å¯†ç¢¼ã€‚</div>
                                    `}
                                    <div class="flex items-center gap-2">
                                        <button type="button" id="send-reset-email-btn" class="px-3 py-1 rounded bg-indigo-600 text-white" ${isEditing && user.email ? '' : 'disabled'}>å¯„é€é‡è¨­å¯†ç¢¼ä¿¡</button>
                                        ${isEditing && user.email ? `<span class="text-xs text-gray-500">${user.email}</span>` : '<span class="text-xs text-red-600">æ­¤å¸³è™Ÿæ²’æœ‰é›»å­éƒµä»¶ï¼Œç„¡æ³•å¯„é€</span>'}
                                    </div>
                                    <p id="password-section-error" class="text-red-500 text-sm"></p>
                                    <p id="password-section-success" class="text-green-600 text-sm"></p>
                                </div>
                                ` : ''}
                                
                                <p id="user-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2 flex-shrink-0">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">å„²å­˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                const userForm = document.getElementById('user-form');
                const errorEl = document.getElementById('user-form-error');
                const avatarPreview = document.getElementById('user-avatar-preview');
                const avatarUploadInput = document.getElementById('user-avatar-upload');

                // å£“ç¸®åœ–ç‰‡ç‚º Base64ï¼Œé™åˆ¶å¤§å°èˆ‡å°ºå¯¸
                const compressToBase64 = async (file, maxW = 320, maxH = 320, quality = 0.8) => {
                    return await new Promise((resolve, reject) => {
                        const img = new Image();
                        const url = URL.createObjectURL(file);
                        img.onload = () => {
                            try {
                                const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
                                const w = Math.max(1, Math.floor(img.width * ratio));
                                const h = Math.max(1, Math.floor(img.height * ratio));
                                const canvas = document.createElement('canvas');
                                canvas.width = w;
                                canvas.height = h;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, w, h);
                                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                                URL.revokeObjectURL(url);
                                resolve(dataUrl);
                            } catch (err) {
                                URL.revokeObjectURL(url);
                                reject(err);
                            }
                        };
                        img.onerror = (e) => {
                            URL.revokeObjectURL(url);
                            reject(e);
                        };
                        img.src = url;
                    });
                };

                // --- Avatar Logic ---
                // å…è¨±æ‰€æœ‰ç”¨æˆ¶ï¼ˆåŒ…æ‹¬ç·¨è¼¯ç¾æœ‰ç”¨æˆ¶ï¼‰ä¸Šå‚³é ­åƒ
                const uploadBtn = document.getElementById('user-upload-avatar-btn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => avatarUploadInput.click());
                }
                
                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        newUserAvatarFile = file;
                        try {
                            const base64 = await compressToBase64(file, 320, 320, 0.8);
                            // æª¢æŸ¥å¤§å°ï¼ˆç´„ç•¥æ›ç®— Base64 è‡³ä½å…ƒçµ„ï¼‰
                            const approxBytes = Math.floor(base64.length * 3 / 4);
                            if (approxBytes > 900 * 1024) {
                                showToast('ç…§ç‰‡éå¤§ï¼Œè«‹é¸æ“‡è¼ƒå°æª”æ¡ˆæˆ–é™ä½å“è³ª', true);
                                newUserAvatarBase64 = null;
                                return;
                            }
                            newUserAvatarBase64 = base64;
                            avatarPreview.src = base64;
                        } catch (err) {
                            console.warn('å£“ç¸®é ­åƒå¤±æ•—ï¼Œä½¿ç”¨åŸæª”é è¦½ï¼š', err);
                            avatarPreview.src = URL.createObjectURL(file);
                            newUserAvatarBase64 = null;
                        }
                    }
                });
                
                


                // --- Form Logic ---
                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                // --- Password Management (editing) ---
                if (isEditing) {
                    const sendResetBtn = document.getElementById('send-reset-email-btn');
                    if (sendResetBtn) {
                        sendResetBtn.addEventListener('click', async () => {
                            try {
                                const email = user.email;
                                if (!email) { showToast('æ­¤å¸³è™Ÿæœªè¨­å®šé›»å­éƒµä»¶ï¼Œç„¡æ³•å¯„é€é‡è¨­ä¿¡', true); return; }
                                showLoading(true);
                                await sendPasswordResetEmail(auth, email);
                                showToast(`å·²å¯„é€é‡è¨­å¯†ç¢¼ä¿¡è‡³ ${email}`);
                            } catch (err) {
                                console.error('send reset email error', err);
                                const msg = err?.message || 'å¯„é€é‡è¨­å¯†ç¢¼ä¿¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                                showToast(msg, true);
                            } finally {
                                showLoading(false);
                            }
                        });
                    }

                    const isSelf = window.__auth?.currentUser?.uid === user.id;
                    const selfSaveBtn = document.getElementById('self-save-password-btn');
                    if (isSelf && selfSaveBtn) {
                        selfSaveBtn.addEventListener('click', async () => {
                            try {
                                const currentUser = auth.currentUser;
                                if (!currentUser || currentUser.uid !== user.id) {
                                    showToast('æ‚¨åªèƒ½è®Šæ›´è‡ªå·±çš„å¯†ç¢¼', true);
                                    return;
                                }
                                const curr = document.getElementById('curr-password')?.value || '';
                                const np = document.getElementById('new-password')?.value || '';
                                const cp = document.getElementById('confirm-new-password')?.value || '';
                                if (np.length < 6) { showToast('æ–°å¯†ç¢¼è‡³å°‘ 6 ä½', true); return; }
                                if (np !== cp) { showToast('å…©æ¬¡æ–°å¯†ç¢¼ä¸ä¸€è‡´', true); return; }
                                showLoading(true);
                                const credential = EmailAuthProvider.credential(currentUser.email, curr);
                                await reauthenticateWithCredential(currentUser, credential);
                                await updatePassword(currentUser, np);
                                showToast('å¯†ç¢¼å·²æ›´æ–°');
                                const ids = ['curr-password','new-password','confirm-new-password'];
                                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                            } catch (err) {
                                console.error('update password error', err);
                                const msg = err?.code === 'auth/wrong-password' ? 'ç›®å‰å¯†ç¢¼éŒ¯èª¤' : (err?.message || 'è®Šæ›´å¯†ç¢¼å¤±æ•—');
                                showToast(msg, true);
                            } finally {
                                showLoading(false);
                            }
                        });
                    }
                }

                userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    // --- Form Data Collection ---
                    const name = document.getElementById('user-name').value;
                    const phone = document.getElementById('user-phone').value;
                    const lineId = document.getElementById('user-lineid').value;
                    const email = document.getElementById('user-email').value;
                    const role = document.getElementById('user-role').value;
                    
                    const updateData = { name, phone, lineId, role, email };

                    // ç·¨è¼¯æ¨¡å¼ï¼šåŒæ­¥é›¢è·ç‹€æ…‹
                    if (isEditing) {
                        const resignedEl = document.getElementById('user-resigned');
                        if (resignedEl) {
                            updateData.resigned = !!resignedEl.checked;
                        }
                    }

                    try {
                        let targetUserId = isEditing ? user.id : null;
                        let newAvatarUrl = isEditing ? user.avatarUrl : null;

                        // --- Password Validation (for new users) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const confirmPassword = document.getElementById('user-confirm-password').value;
                            if (password.length < 6) {
                                throw new Error("å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6å€‹å­—å…ƒã€‚");
                            }
                            if (password !== confirmPassword) {
                                throw new Error("å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ç›¸ç¬¦ã€‚");
                            }
                        }

                        // --- User Creation (if applicable) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const { initializeApp: initializeAppSecondary, deleteApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                            const secondaryApp = initializeAppSecondary(firebaseConfig, `secondary-app-${Date.now()}`);
                            const secondaryAuth = getAuth(secondaryApp);
                             try {
                                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                                targetUserId = userCredential.user.uid;
                                // ç¢ºä¿æ–°ç”¨æˆ¶çš„çæ‡²é»æ•¸é è¨­ç‚º0
                                updateData.points = 0;
                            } catch (creationError) {
                                if (creationError.code === 'auth/email-already-in-use') throw new Error('æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚');
                                else throw new Error('å»ºç«‹é©—è­‰å¸³è™Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                            } finally {
                                await signOut(secondaryAuth);
                                await deleteApp(secondaryApp);
                            }
                        }
                        
                        // --- Avatar Upload (if new avatar is set) ---
                        if (newUserAvatarFile) {
                            try {
                                if (newUserAvatarBase64) {
                                    newAvatarUrl = newUserAvatarBase64;
                                } else {
                                    // å¾Œå‚™ï¼šç›´æ¥è½‰ Base64ï¼ˆå¯èƒ½è¼ƒå¤§ï¼‰
                                    const reader = new FileReader();
                                    const base64Promise = new Promise((resolve, reject) => {
                                        reader.onload = () => resolve(reader.result);
                                        reader.onerror = () => reject(new Error('è®€å–æª”æ¡ˆå¤±æ•—'));
                                        reader.readAsDataURL(newUserAvatarFile);
                                    });
                                    const rawBase64 = await base64Promise;
                                    const approxBytes = Math.floor(rawBase64.length * 3 / 4);
                                    if (approxBytes > 900 * 1024) {
                                        throw new Error('ç…§ç‰‡éå¤§ï¼Œè«‹é¸æ“‡è¼ƒå°æª”æ¡ˆæˆ–é™ä½å“è³ª');
                                    }
                                    newAvatarUrl = rawBase64;
                                }
                                console.log('é ­åƒå·²è™•ç†ç‚º Base64 æ ¼å¼');
                            } catch (avatarError) {
                                console.error('é ­åƒè™•ç†éŒ¯èª¤:', avatarError);
                                showToast(avatarError.message || 'é ­åƒè™•ç†å¤±æ•—ï¼Œä½†æœƒç¹¼çºŒå„²å­˜å…¶ä»–è³‡æ–™', true);
                            }
                        }
                        updateData.avatarUrl = newAvatarUrl;

                        // --- Database Operation ---
                        if (isEditing) {
                            await updateDoc(doc(db, "users", targetUserId), updateData);
                            showToast("ä½¿ç”¨è€…è³‡æ–™æ›´æ–°æˆåŠŸ");
                        } else {
                            updateData.status = "æœªæ‰“å¡";
                            updateData.resigned = false; // æ–°å¢å¸³è™Ÿé è¨­ç‚ºå¯ç™»å…¥
                            updateData.createdAt = serverTimestamp();
                            await setDoc(doc(db, "users", targetUserId), updateData);
                            showToast("æ–°å¸³è™Ÿå»ºç«‹æˆåŠŸ");
                        }
                        
                        close();

                    } catch (error) {
                        console.error("User modal error:", error);
                        errorEl.textContent = error.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    } finally {
                        showLoading(false);
                    }
                });
            }

            // ç°¡æ˜“æç¤ºè¦–çª—ï¼ˆå°è¦–çª—ï¼‰
            function openInfoModal(title, message) {
                const modalId = `info-modal-${Date.now()}`;
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[420px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-4">
                                <p class="text-gray-700">${message}</p>
                            </div>
                            <div class="flex justify-end gap-2 p-4 border-t">
                                <button class="close-btn px-3 py-1 rounded bg-blue-600 text-white">çŸ¥é“äº†</button>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modal = document.getElementById(modalId);
                const close = () => modal?.remove();
                modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', close));
            }
            
            function openRuleModal(rule = null) {
                const modalId = `rule-modal-${Date.now()}`;
                const isEditing = rule !== null;
                const title = isEditing ? 'ç·¨è¼¯è¦å‰‡' : 'æ–°å¢è¦å‰‡';
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="rule-form" class="p-4 space-y-4">
                                <div>
                                    <label for="rule-reason" class="block text-sm font-medium text-gray-700">äº‹ç”±</label>
                                    <input type="text" id="rule-reason" value="${isEditing ? rule.reason : ''}" placeholder="ä¾‹å¦‚ï¼šé²åˆ°" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-points" class="block text-sm font-medium text-gray-700">é»æ•¸ (å¯ç‚ºè² æ•¸)</label>
                                    <input type="number" id="rule-points" value="${isEditing ? rule.points : ''}" placeholder="-1" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-target" class="block text-sm font-medium text-gray-700">é©ç”¨å°è±¡</label>
                                    <select id="rule-target" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="å€‹äºº" ${isEditing && rule.target === 'å€‹äºº' ? 'selected' : ''}>å€‹äºº</option>
                                        <option value="å…¨é«”" ${isEditing && rule.target === 'å…¨é«”' ? 'selected' : ''}>å…¨é«”</option>
                                    </select>
                                </div>
                                <p id="rule-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">å„²å­˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const ruleForm = document.getElementById('rule-form');
                const errorEl = document.getElementById('rule-form-error');

                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                ruleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    const reason = document.getElementById('rule-reason').value;
                    const points = Number(document.getElementById('rule-points').value);
                    const target = document.getElementById('rule-target').value;

                    if (!reason || isNaN(points)) {
                        errorEl.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚';
                        showLoading(false);
                        return;
                    }

                    try {
                        if (isEditing) {
                            const ruleRef = doc(db, "pointRules", rule.id);
                            await updateDoc(ruleRef, { reason, points, target });
                            showToast("è¦å‰‡æ›´æ–°æˆåŠŸ");
                        } else {
                            await addDoc(collection(db, "pointRules"), { reason, points, target });
                            showToast("æ–°è¦å‰‡æ–°å¢æˆåŠŸ");
                        }
                        close();
                    } catch (error) {
                        console.error("Rule modal error:", error);
                        errorEl.textContent = 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderProfileModal() {
                const modalId = `profile-modal-${Date.now()}`;
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">å€‹äººè³‡æ–™</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>

                            <div class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="modal-avatar" src="${state.currentUserData.avatarUrl || `https://placehold.co/80x80/EFEFEF/333333?text=${state.currentUserData.name.charAt(0)}`}" alt="Avatar" class="w-20 h-20 rounded-full object-cover">
                                    <label for="avatar-upload" class="cursor-pointer text-blue-600 hover:text-blue-800">
                                        æ›´æ›é ­åƒ
                                        <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                    </label>
                                </div>

                                <!-- Info -->
                                <div class="text-center">
                                    <p class="font-bold text-xl">${state.currentUserData.name}</p>
                                    <p class="text-gray-500">${state.currentUserData.email}</p>
                                </div>
                                
                                <!-- çæ‡²é»æ•¸ -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">çæ‡²é»æ•¸</h4>
                                    <p class="text-center text-3xl font-bold">${state.currentUserData.points || 0} é»</p>
                                </div>

                                <!-- æœªä¾†è«‹å‡ -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">è«‹å‡ç”³è«‹</h4>
                                    <div id="future-leaves" class="space-y-2"></div>
                                </div>
                            </div>

                            <div class="p-4 border-t">
                                <button id="logout-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">ç™»å‡º</button>
                                <p class="mt-2 text-center">
                                    <a href="#" id="privacy-policy-link" class="text-blue-600 underline">éš±ç§æ¬Šæ”¿ç­–</a>
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const changePasswordForm = document.getElementById('change-password-form');
                const logoutBtn = document.getElementById('logout-btn');
                const avatarUploadInput = document.getElementById('avatar-upload');
                const privacyLink = document.getElementById('privacy-policy-link');

                modal.querySelector('.close-btn').addEventListener('click', close);
                
                // æ·»åŠ ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
                logoutBtn.addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        await signOut(window.__auth);
                        showToast("å·²æˆåŠŸç™»å‡º");
                        window.location.reload();
                    } catch (error) {
                        console.error("ç™»å‡ºå¤±æ•—:", error);
                        showToast("ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", true);
                        showLoading(false);
                    }
                });

                // éš±ç§æ¬Šæ”¿ç­–é–‹çª—
                if (privacyLink) {
                    privacyLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openPrivacyPolicyWindow();
                    });
                }

                async function processAndUploadAvatar(file) {
                    if (!file) return;
                    showLoading(true);
                    try {
                        const maxBytes = 900 * 1024; // ç´„ 900KB ä¸Šé™
                        // å£“ç¸®ç‚º Blobï¼Œé¿å… Base64 é€ æˆè¡Œå‹•ç«¯è¨˜æ†¶é«”å£“åŠ›
                        let blob = await compressToBlob(file, 300, 'image/jpeg', 0.85);
                        if (!blob) throw new Error('åœ–ç‰‡å£“ç¸®å¤±æ•—');
                        // è‹¥ä»éå¤§ï¼Œå˜—è©¦å†é™ä½å“è³ªä¸€æ¬¡
                        if (blob.size > maxBytes) {
                            blob = await compressToBlob(file, 300, 'image/jpeg', 0.7);
                        }
                        if (blob.size > maxBytes) {
                            throw new Error('é¸æ“‡çš„åœ–ç‰‡éå¤§ï¼ˆéœ€å°æ–¼ç´„ 900KBï¼‰ï¼Œè«‹æ›è¼ƒå°çš„åœ–ç‰‡');
                        }

                        const storage = getStorage();
                        const avatarRef = ref(storage, `userAvatars/${state.currentUser.uid}.jpg`);
                        await uploadBytes(avatarRef, blob, { contentType: 'image/jpeg' });
                        const url = await getDownloadURL(avatarRef);

                        await updateDoc(doc(window.__db, 'users', state.currentUser.uid), { avatarUrl: url });
                        state.currentUserData.avatarUrl = url;
                        document.getElementById('modal-avatar').src = url;
                        const header = document.getElementById('header-avatar');
                        if (header) header.src = url;
                        showToast('é ­åƒæ›´æ–°æˆåŠŸ');
                    } catch (error) {
                        console.error('Avatar upload error:', error);
                        showToast('é ­åƒä¸Šå‚³å¤±æ•—: ' + (error.message || error), true);
                    } finally {
                        showLoading(false);
                    }
                }

                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    await processAndUploadAvatar(file);
                });

                
                // å£“ç¸®ä¸¦è½‰ Base64ï¼ˆData URLï¼‰
                async function compressToBase64(file, maxWidth) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('è®€å–åœ–ç‰‡å¤±æ•—'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                if (width > maxWidth) {
                                    height = Math.round((height * maxWidth) / width);
                                    width = maxWidth;
                                }
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                try {
                                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                                    resolve(dataUrl);
                                } catch (e) {
                                    reject(e);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                // æ–°å¢ï¼šå£“ç¸®ç‚º Blobï¼ˆè¡Œå‹•ç«¯æ›´ç©©å®šï¼Œé¿å… Base64 å¤§å­—ä¸²ï¼‰
                async function compressToBlob(file, maxWidth, mime = 'image/jpeg', quality = 0.85) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('è®€å–åœ–ç‰‡å¤±æ•—'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
                            img.src = event.target.result;
                            img.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    if (width > maxWidth) {
                                        height = Math.round((height * maxWidth) / width);
                                        width = maxWidth;
                                    }
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    if (canvas.toBlob) {
                                        canvas.toBlob((b) => {
                                            if (b) resolve(b); else reject(new Error('åœ–ç‰‡å£“ç¸®å¤±æ•—'));
                                        }, mime, quality);
                                    } else {
                                        // Fallback: ä»¥ DataURL è½‰ Blob
                                        const dataUrl = canvas.toDataURL(mime, quality);
                                        fetch(dataUrl).then(r => r.blob()).then(resolve).catch(reject);
                                    }
                                } catch (err) {
                                    reject(err);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                logoutBtn.addEventListener('click', async () => {
                    close();
                    await signOut(window.__auth);
                    showToast("æ‚¨å·²æˆåŠŸç™»å‡º");
                });

                // è¼‰å…¥è«‹å‡ç”³è«‹æ¸…å–®
                (async function loadFutureLeaves() {
                    const container = document.getElementById('future-leaves');
                    if (!container) return;
                    try {
                        const uid = state.currentUser?.uid;
                        if (!uid) {
                            container.innerHTML = '<div class="text-sm text-red-600">è«‹å…ˆç™»å…¥</div>';
                            return;
                        }
                        container.innerHTML = '<div class="text-sm text-gray-500">è¼‰å…¥ä¸­...</div>';
                        const now = new Date();
                        const q = query(
                            collection(window.__db, 'leaves'),
                            where('userId', '==', uid)
                        );
                        const snap = await getDocs(q);
                        const future = [];
                        snap.forEach(d => {
                            const l = d.data();
                            if (l.startTime && (l.startTime.toDate ? l.startTime.toDate() : new Date(l.startTime)) >= now) {
                                future.push({ id: d.id, ...l });
                            }
                        });
                        if (future.length === 0) {
                            container.innerHTML = '<div class="text-sm text-gray-500">æ²’æœ‰è«‹å‡ç”³è«‹</div>';
                            return;
                        }
                        future.sort((a, b) => (a.startTime.toDate ? a.startTime.toDate() : new Date(a.startTime)) - (b.startTime.toDate ? b.startTime.toDate() : new Date(b.startTime)));
                        const statusText = s => (
                            s === 'pending' ? 'å¾…å¯©æ ¸' : s === 'approved' ? 'å·²æ ¸å‡†' : s === 'rejected' ? 'å·²æ‹’çµ•' : 'æœªçŸ¥'
                        );
                        const statusClass = s => (
                            s === 'pending' ? 'bg-yellow-100 text-yellow-800' : s === 'approved' ? 'bg-green-100 text-green-800' : s === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
                        );
                        container.innerHTML = future.map(l => `
                            <div class="p-3 rounded-md border bg-white">
                                <div class="text-sm font-medium">
                                    ${l.reason || 'ç„¡äº‹ç”±'}
                                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full ${statusClass(l.status)}">${statusText(l.status)}</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">å¾ ${formatDateTime(l.startTime)} è‡³ ${formatDateTime(l.endTime)}</div>
                                <div class="text-xs text-gray-500">${l.reasonType || ''}</div>
                            </div>
                        `).join('');
                    } catch (e) {
                        console.error('è¼‰å…¥è«‹å‡ç”³è«‹å¤±æ•—:', e);
                        container.innerHTML = '<div class="text-sm text-red-600">è¼‰å…¥è«‹å‡ç”³è«‹å¤±æ•—</div>';
                    }
                })();
            }

            // é–‹æ–°è¦–çª—é¡¯ç¤ºéš±ç§æ¬Šæ”¿ç­–
            function openPrivacyPolicyWindow() {
                const appName = 'è¥¿åŒ—æ‰“å¡';
                const policyHtml = `<!doctype html>
 <html lang="zh-Hant">
 <head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>éš±ç§æ¬Šæ”¿ç­– - ${appName}</title>
   <style>
     body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', 'Helvetica Neue', Arial, 'Microsoft JhengHei', sans-serif; margin: 0; padding: 24px; line-height: 1.7; color: #1f2937; }
     .container { max-width: 800px; margin: 0 auto; }
     h1 { font-size: 1.5rem; margin-bottom: 12px; }
     h2 { font-size: 1.1rem; margin-top: 20px; margin-bottom: 8px; }
     h3 { font-size: 1rem; margin-top: 14px; margin-bottom: 6px; }
     p { margin: 8px 0; }
     ul { margin: 8px 0 8px 20px; }
     .muted { color: #6b7280; font-size: 0.9rem; }
     .divider { height: 1px; background: #e5e7eb; margin: 16px 0; }
   </style>
   </head>
   <body>
     <div class="container">
       <h1>éš±ç§æ¬Šæ”¿ç­–</h1>
       <p>è¥¿åŒ—æ‰“å¡ (ä»¥ä¸‹ç°¡ç¨±ã€Œæœ¬æ‡‰ç”¨ç¨‹å¼ã€) å°Šé‡ä¸¦ä¿è­·æ‰€æœ‰ä½¿ç”¨æœå‹™ç”¨æˆ¶çš„å€‹äººéš±ç§æ¬Šã€‚ç‚ºäº†çµ¦æ‚¨æä¾›æ›´æº–ç¢ºã€æ›´æœ‰å€‹æ€§åŒ–çš„æœå‹™ï¼Œæœ¬æ‡‰ç”¨ç¨‹å¼æœƒæŒ‰ç…§æœ¬éš±ç§æ¬Šæ”¿ç­–çš„è¦å®šä½¿ç”¨å’ŒæŠ«éœ²æ‚¨çš„å€‹äººè³‡è¨Šã€‚ä½†æœ¬æ‡‰ç”¨ç¨‹å¼å°‡ä»¥é«˜åº¦çš„å‹¤å‹‰ã€å¯©æ…ç¾©å‹™å°å¾…é€™äº›è³‡è¨Šã€‚é™¤æœ¬éš±ç§æ¬Šæ”¿ç­–å¦æœ‰è¦å®šå¤–ï¼Œåœ¨æœªå¾µå¾—æ‚¨äº‹å…ˆè¨±å¯çš„æƒ…æ³ä¸‹ï¼Œæœ¬æ‡‰ç”¨ç¨‹å¼ä¸æœƒå°‡é€™äº›è³‡è¨Šå°å¤–æŠ«éœ²æˆ–å‘ç¬¬ä¸‰æ–¹æä¾›ã€‚æœ¬æ‡‰ç”¨ç¨‹å¼æœƒä¸æ™‚æ›´æ–°æœ¬éš±ç§æ¬Šæ”¿ç­–ã€‚ æ‚¨åœ¨åŒæ„æœ¬æ‡‰ç”¨ç¨‹å¼æœå‹™ä½¿ç”¨å”è­°ä¹‹æ™‚ï¼Œå³è¦–ç‚ºæ‚¨å·²ç¶“åŒæ„æœ¬éš±ç§æ¬Šæ”¿ç­–å…¨éƒ¨å…§å®¹ã€‚</p>
       <p class="muted">ç”Ÿæ•ˆæ—¥æœŸï¼š 2025å¹´10æœˆ07æ—¥</p>

       <h2>1. è³‡è¨Šæ”¶é›†èˆ‡ä½¿ç”¨</h2>
       <p>ç‚ºäº†è®“æœ¬æ‡‰ç”¨ç¨‹å¼æ­£å¸¸é‹ä½œä¸¦æä¾›æ‚¨æ‰€éœ€çš„åŠŸèƒ½ï¼Œæˆ‘å€‘éœ€è¦è«‹æ±‚ä»¥ä¸‹æ¬Šé™ï¼Œä¸¦æ”¶é›†ç›¸é—œè³‡è¨Šï¼š</p>

       <h3>ç›¸æ©Ÿ (Camera) æ¬Šé™ï¼š</h3>
       <p>æœ¬æ‡‰ç”¨ç¨‹å¼éœ€è¦å­˜å–æ‚¨è£ç½®çš„ç›¸æ©Ÿã€‚æ­¤æ¬Šé™åƒ…ç”¨æ–¼ [è«‹åœ¨æ­¤è™•æ˜ç¢ºèªªæ˜ä½¿ç”¨ç›¸æ©Ÿçš„ç›®çš„ï¼Œä¾‹å¦‚ï¼šæƒæ QR Codeã€æ‹ç…§ä¸Šå‚³ç­‰]ã€‚æˆ‘å€‘ä¸æœƒåœ¨æ‚¨ä¸çŸ¥æƒ…çš„æƒ…æ³ä¸‹é–‹å•Ÿç›¸æ©Ÿï¼Œæ‰€æ‹æ”çš„ç…§ç‰‡æˆ–å½±ç‰‡åƒ…æœƒåœ¨æ‚¨çš„æ“ä½œä¸‹é€²è¡Œè™•ç†ï¼Œæˆ‘å€‘ä¸æœƒå„²å­˜æˆ–åˆ†äº«é€™äº›å…§å®¹ï¼Œé™¤éå¾—åˆ°æ‚¨çš„æ˜ç¢ºåŒæ„ã€‚</p>

       <h3>ç²¾ç¢ºä½ç½® (Precise Location) æ¬Šé™ï¼š</h3>
       <p>æœ¬æ‡‰ç”¨ç¨‹å¼éœ€è¦ç²å–æ‚¨è£ç½®çš„ç²¾ç¢ºä½ç½®è³‡è¨Š (GPS å’Œç¶²è·¯åŸºç¤)ã€‚æ­¤æ¬Šé™åƒ…ç”¨æ–¼ [è«‹åœ¨æ­¤è™•æ˜ç¢ºèªªæ˜ä½¿ç”¨å®šä½çš„ç›®çš„ï¼Œä¾‹å¦‚ï¼šåœ°åœ–å°èˆªã€ç´€éŒ„æ‰“å¡åœ°é»ç­‰]ã€‚æ‚¨çš„ä½ç½®è³‡è¨Šå°‡ç”¨æ–¼æå‡æ‚¨çš„ä½¿ç”¨è€…é«”é©—ï¼Œæˆ‘å€‘ä¸æœƒå°‡æ‚¨çš„ä½ç½®è³‡è¨Šç”¨æ–¼æœ¬åŠŸèƒ½ä»¥å¤–çš„å…¶ä»–ç›®çš„ï¼Œä¹Ÿä¸æœƒèˆ‡ä»»ä½•ç¬¬ä¸‰æ–¹åˆ†äº«æ‚¨çš„å€‹äººè»Œè·¡ã€‚</p>

       <p>æœ¬æ‡‰ç”¨ç¨‹å¼ä¸æœƒæ”¶é›†èˆ‡ä¸Šè¿°åŠŸèƒ½ç„¡é—œçš„ä»»ä½•å…¶ä»–å€‹äººå¯è­˜åˆ¥è³‡è¨Šã€‚</p>

       <h2>2. è³‡è¨ŠæŠ«éœ²</h2>
       <p>åœ¨å¦‚ä¸‹æƒ…æ³ä¸‹ï¼Œæœ¬æ‡‰ç”¨ç¨‹å¼å°‡ä¾æ“šæ‚¨çš„å€‹äººæ„é¡˜æˆ–æ³•å¾‹çš„è¦å®šå…¨éƒ¨æˆ–éƒ¨åˆ†åœ°æŠ«éœ²æ‚¨çš„å€‹äººè³‡è¨Šï¼š</p>
       <ul>
         <li>a) ç¶“æ‚¨äº‹å…ˆåŒæ„ï¼Œå‘ç¬¬ä¸‰æ–¹æŠ«éœ²ï¼›</li>
         <li>b) ç‚ºæä¾›æ‚¨æ‰€è¦æ±‚çš„ç”¢å“å’Œæœå‹™ï¼Œè€Œå¿…é ˆå’Œç¬¬ä¸‰æ–¹åˆ†äº«æ‚¨çš„å€‹äººè³‡è¨Šï¼›</li>
         <li>c) æ ¹æ“šæ³•å¾‹çš„æœ‰é—œè¦å®šï¼Œæˆ–è€…è¡Œæ”¿æˆ–å¸æ³•æ©Ÿæ§‹çš„è¦æ±‚ï¼Œå‘ç¬¬ä¸‰æ–¹æˆ–è€…è¡Œæ”¿ã€å¸æ³•æ©Ÿæ§‹æŠ«éœ²ï¼›</li>
       </ul>

       <h2>3. è³‡è¨Šå®‰å…¨</h2>
       <p>æˆ‘å€‘è‡´åŠ›æ–¼ä¿è­·æ‚¨çš„è³‡è¨Šå®‰å…¨ã€‚æˆ‘å€‘æ¡å–äº†é©ç•¶çš„ç®¡ç†ã€æŠ€è¡“å’Œå¯¦é«”å®‰å…¨æªæ–½ä¾†ä¿è­·æ‚¨çš„è³‡è¨Šï¼Œé˜²æ­¢æœªç¶“æˆæ¬Šçš„å­˜å–ã€ä½¿ç”¨ã€æŠ«éœ²ã€ä¿®æ”¹æˆ–éŠ·æ¯€ã€‚</p>

       <h2>4. å…’ç«¥éš±ç§</h2>
       <p>æˆ‘å€‘çš„æœå‹™ä¸é‡å°ä»»ä½•æœªæ»¿ 13 æ­²çš„å…’ç«¥ã€‚æˆ‘å€‘ä¸æœƒæ•…æ„æ”¶é›† 13 æ­²ä»¥ä¸‹å…’ç«¥çš„å€‹äººå¯è­˜åˆ¥è³‡è¨Šã€‚</p>

       <h2>5. éš±ç§æ¬Šæ”¿ç­–çš„è®Šæ›´</h2>
       <p>æˆ‘å€‘å¯èƒ½æœƒä¸æ™‚æ›´æ–°æˆ‘å€‘çš„éš±ç§æ¬Šæ”¿ç­–ã€‚å› æ­¤ï¼Œæˆ‘å€‘å»ºè­°æ‚¨å®šæœŸæŸ¥çœ‹æ­¤é é¢ä»¥äº†è§£ä»»ä½•è®Šæ›´ã€‚æˆ‘å€‘å°‡é€šéåœ¨æ­¤é é¢ä¸Šç™¼å¸ƒæ–°çš„éš±ç§æ¬Šæ”¿ç­–ä¾†é€šçŸ¥æ‚¨ä»»ä½•è®Šæ›´ã€‚</p>

       <h2>6. è¯çµ¡æˆ‘å€‘</h2>
       <p>å¦‚æœæ‚¨å°æˆ‘å€‘çš„éš±ç§æ¬Šæ”¿ç­–æœ‰ä»»ä½•ç–‘å•æˆ–å»ºè­°ï¼Œè«‹éš¨æ™‚èˆ‡æˆ‘å€‘è¯çµ¡ã€‚ é›»å­éƒµä»¶:nwcom.eason@gmail.com</p>
      </div>
    </body>
  </html>`;

                // å„ªå…ˆé–‹å•Ÿç¨ç«‹é é¢ï¼Œä½¿ç”¨çµ•å°ç¶²å€é¿å…ç›¸å°è·¯å¾‘è§£æå•é¡Œ
                const url = (window.location && window.location.origin ? window.location.origin : '') + '/privacy.html';
                const win = window.open(url, '_blank', 'width=800,height=900');
                if (win) {
                    try {
                        win.document.open();
                        win.document.write(policyHtml);
                        win.document.close();
                        return;
                    } catch (e) {
                        console.error('å¯«å…¥éš±ç§æ¬Šæ”¿ç­–è¦–çª—å…§å®¹å¤±æ•—:', e);
                    }
                }
                if (!win) {
                    // å¾Œå‚™æ–¹æ¡ˆï¼šä»¥ç«™å…§å½ˆçª—å‘ˆç¾
                    const modalId = `privacy-modal-${Date.now()}`;
                    const contentOnly = policyHtml.replace(/^[\s\S]*<body[^>]*>/i, '').replace(/<\/body>[\s\S]*$/i, '');
                    const modalHTML = `
                        <div id="${modalId}" class="modal-backdrop" style="overflow:auto;">
                          <div class="modal-content w-[95%] max-w-[900px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                              <h3 class="font-bold text-lg">éš±ç§æ¬Šæ”¿ç­– - è¥¿åŒ—æ‰“å¡</h3>
                              <button class="close-btn text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                              </button>
                            </div>
                            <div class="p-4 overflow-y-auto" style="max-height: 80vh;">
                              ${contentOnly}
                            </div>
                          </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    const backdrop = document.getElementById(modalId);
                    const closeBtn = backdrop.querySelector('.close-btn');
                    const close = () => backdrop.remove();
                    closeBtn.addEventListener('click', close);
                    backdrop.addEventListener('click', (e) => { if (e.target.id === modalId) close(); });
                    lucide.createIcons();
                }
            }

            // renderLeaveInfo å·²æ–¼ç¨å¾Œå€å¡Šå®šç¾©ç‚ºå®Œæ•´ç‰ˆæœ¬ï¼Œç§»é™¤é‡è¤‡å®£å‘Šä»¥é¿å…èªæ³•éŒ¯èª¤

            function openAvatarCameraModal(callback) {
                const modalId = `avatar-camera-modal-${Date.now()}`;
                let videoStream;
                
                const stopCamera = () => {
                    if (videoStream) videoStream.getTracks().forEach(track => track.stop());
                };
                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop" style="z-index: 60;">
                        <div class="modal-content w-[90%] max-w-md bg-black rounded-lg shadow-xl flex flex-col p-4 text-white">
                            <video id="avatar-video" playsinline autoplay muted class="w-full h-auto rounded-lg"></video>
                            <canvas id="avatar-canvas" class="hidden"></canvas>
                            <div class="flex justify-center mt-4">
                                <button id="avatar-capture-btn" class="w-16 h-16 bg-white rounded-full border-4 border-gray-500"></button>
                            </div>
                             <button id="avatar-cancel-btn" class="text-gray-400 mt-2">å–æ¶ˆ</button>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const video = document.getElementById('avatar-video');
                const canvas = document.getElementById('avatar-canvas');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
                    .then(stream => {
                        videoStream = stream;
                        video.muted = true;
                        video.srcObject = stream;
                        Promise.resolve(video.play()).catch(err => {
                            console.warn("avatar video.play() failed:", err);
                        });
                    }).catch(err => {
                        showToast("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ", true);
                        close();
                    });

                document.getElementById('avatar-capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        callback(blob);
                        close();
                    }, 'image/jpeg');
                });
                document.getElementById('avatar-cancel-btn').addEventListener('click', close);
            }

            function openCameraModal(type, location) {
                 const modalId = `camera-modal-${Date.now()}`;
                let videoStream;
                const capturedPhotos = []; // { blob, description }

                const stopCamera = () => {
                    if (videoStream) {
                        videoStream.getTracks().forEach(track => track.stop());
                    }
                };

                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[390px] h-[730px] bg-black rounded-2xl shadow-xl flex flex-col p-4 text-white">
                            <div id="camera-view" class="flex-grow relative flex items-center justify-center">
                                <video id="camera-video" playsinline autoplay muted class="w-full h-full object-cover rounded-lg"></video>
                                <canvas id="camera-canvas" class="hidden"></canvas>
                                <div id="camera-loader" class="absolute inset-0 flex items-center justify-center bg-black/50 pointer-events-none"><div class="loader"></div></div>
                            </div>
                            <div id="preview-view" class="hide flex-grow flex flex-col">
                                <img id="photo-preview" class="w-full h-auto flex-grow object-contain rounded-lg">
                                <input type="text" id="photo-description" class="w-full mt-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2" placeholder="è¼¸å…¥èªªæ˜ (30å­—å…§)" maxlength="30">
                            </div>

                            <div class="flex-shrink-0 pt-4">
                                <div id="capture-controls" class="flex items-center justify-between relative" style="z-index: 999;">
                                    <button id="switch-camera-btn" class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center">
                                        <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                                    </button>
                <button id="capture-btn" class="w-40 h-20 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center" style="z-index: 1000;">
                                        <i data-lucide="camera" class="w-10 h-10 text-gray-800"></i>
                                    </button>
                                    <div class="w-12 h-12"></div><!-- ç©ºç™½å…ƒç´ ä¿æŒå°ç¨± -->
                                </div>
                                <div id="confirm-controls" class="hide grid grid-cols-2 gap-2">
                                    <button id="add-another-btn" class="py-3 bg-gray-600 rounded-lg">æ‹ä¸‹ä¸€å¼µ</button>
                                    <button id="finish-btn" class="py-3 bg-red-600 rounded-lg font-semibold">å®Œæˆæ‰“å¡</button>
                                </div>
                            </div>
                             <div class="flex-shrink-0 text-center pt-2">
                                <button id="cancel-camera-btn" class="text-gray-400">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;

                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('camera-canvas');
                const cameraView = document.getElementById('camera-view');
                const previewView = document.getElementById('preview-view');
                const photoPreview = document.getElementById('photo-preview');
                const descriptionInput = document.getElementById('photo-description');
                const captureControls = document.getElementById('capture-controls');
                const confirmControls = document.getElementById('confirm-controls');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
                    .then(stream => {
                        videoStream = stream;
                        video.muted = true;
                        video.srcObject = stream;
                        Promise.resolve(video.play()).catch(err => {
                            console.warn("camera video.play() failed:", err);
                        });
                        document.getElementById('camera-loader').classList.add('hide');
                        
                        lucide.createIcons();
                        
                        let currentFacingMode = "environment";
                        document.getElementById('switch-camera-btn').addEventListener('click', async () => {
                            stopCamera();
                            document.getElementById('camera-loader').classList.remove('hide');
                            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
                            
                            try {
                                const newStream = await navigator.mediaDevices.getUserMedia({ 
                                    video: { facingMode: currentFacingMode }, 
                                    audio: false 
                                });
                                
                                videoStream = newStream;
                                video.muted = true;
                                video.srcObject = newStream;
                                try { await Promise.resolve(video.play()); } catch (e) { console.warn("camera switch video.play() failed:", e); }
                                document.getElementById('camera-loader').classList.add('hide');
                            } catch (error) {
                                console.error("åˆ‡æ›ç›¸æ©Ÿå¤±æ•—:", error);
                                showToast("åˆ‡æ›ç›¸æ©Ÿå¤±æ•—ï¼Œè«‹é‡è©¦", true);
                                document.getElementById('camera-loader').classList.add('hide');
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Camera error:", err);
                        showToast("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ", true);
                        close();
                    });

                document.getElementById('capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    // è¨­ç½®å›ºå®šå¯¬åº¦ï¼Œä½†ä¿æŒåŸå§‹æ¯”ä¾‹
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;
                    const targetWidth = 390;
                    const targetHeight = (videoHeight / videoWidth) * targetWidth;
                    
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    // ç¹ªè£½ä¸¦ä¿æŒåŸå§‹æ¯”ä¾‹
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // æ·»åŠ æµ®æ°´å°
                    context.font = '16px Arial';
                    context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    const now = new Date();
                    const dateTimeText = `${now.toLocaleDateString('zh-TW')} ${now.toLocaleTimeString('zh-TW')}`;
                const locationText = (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') ? `ä½ç½®: ${state.currentLocation.lat.toFixed(6)}, ${state.currentLocation.lng.toFixed(6)}` : 'ç„¡ä½ç½®è³‡è¨Š';
                    const userText = `${state.currentUserData.name} - ${type}æ‰“å¡`;
                    
                    // åœ¨åº•éƒ¨æ·»åŠ æµ®æ°´å°
                    context.fillText(dateTimeText, 10, canvas.height - 40);
                    context.fillText(locationText, 10, canvas.height - 20);
                    context.fillText(userText, 10, canvas.height - 60);
                    
                    photoPreview.src = canvas.toDataURL('image/jpeg');
                    cameraView.classList.add('hide');
                    previewView.classList.remove('hide');
                    captureControls.classList.add('hide');
                    confirmControls.classList.remove('hide');
                });
                
                const saveAndPrepareNext = () => {
                     canvas.toBlob(blob => {
                        if (!blob) {
                            showToast("ç…§ç‰‡è™•ç†å¤±æ•—", true);
                            return;
                        }
                        const description = descriptionInput.value;
                        capturedPhotos.push({ blob, description });
                        
                        descriptionInput.value = '';
                        cameraView.classList.remove('hide');
                        previewView.classList.add('hide');
                        captureControls.classList.remove('hide');
                        confirmControls.classList.add('hide');
                        showToast(`å·²å„²å­˜ ${capturedPhotos.length} å¼µç…§ç‰‡`);

                     }, 'image/jpeg', 0.8);
                };

                document.getElementById('add-another-btn').addEventListener('click', saveAndPrepareNext);

                document.getElementById('finish-btn').addEventListener('click', () => {
                    if (previewView.classList.contains('hide') === false) {
                         canvas.toBlob((blob) => {
                            if (blob) {
                                const description = descriptionInput.value;
                                capturedPhotos.push({ blob, description });
                            }
                            completeClockIn();
                         }, 'image/jpeg', 0.8);
                    } else {
                        completeClockIn();
                    }
                });

                const completeClockIn = async () => {
                    // ç¢ºä¿ Firestore å·²å°±ç·’ä¸¦æ–¼æœ¬åœ°ä½œç”¨åŸŸå–ç”¨
                    const fs = window.__fs || {};
                    const db = window.__db;
                    const { addDoc, collection, updateDoc, doc, getDoc, Timestamp, GeoPoint } = fs;
                    if (!db || typeof addDoc !== 'function' || typeof collection !== 'function') {
                        showToast('ç³»çµ±åˆå§‹åŒ–ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                        return;
                    }
                    if (capturedPhotos.length === 0) {
                        showToast("è«‹è‡³å°‘æ‹æ”ä¸€å¼µç…§ç‰‡", true);
                        return;
                    }
                    stopCamera();
                    showLoading(true);

                    try {
                        // åƒ…å…è¨±å®‰å…¨è¦å‰‡ä¸­çš„æ‰“å¡é¡å‹
                        const allowedTypes = ['ä¸Šç­','ä¸‹ç­','å¤–å‡º','è¿”å›','æŠµé”','é›¢é–‹','è‡ªå‹•ä¸‹ç­'];
                        if (!allowedTypes.includes(type)) {
                            console.warn('ä¸å…è¨±çš„æ‰“å¡é¡å‹ï¼Œå·²å–æ¶ˆå¯«å…¥ï¼š', type);
                            showToast('æ­¤æ‰“å¡é¡å‹ä¸æ”¯æ´ç´€éŒ„å¯«å…¥ï¼Œè«‹æ”¹ç”¨å°æ‡‰åŠŸèƒ½', true);
                            return;
                        }

                        // å‹¤å‹™æ™‚é–“æª¢æŸ¥ï¼šé–‹å§‹å‰ç¦æ­¢æ‰“å¡ï¼ŒçµæŸå¾Œæ¨™è¨˜è¶…æ™‚å·¡é‚
                        const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                        const dutyStart = toDate(state.currentUserData?.dutyStartTime);
                        const dutyEnd = toDate(state.currentUserData?.dutyEndTime);
                        const restrictedTypes = ['å¤–å‡º','æŠµé”','é›¢é–‹'];
                        let isOvertime = false;
                        if (restrictedTypes.includes(type) && (dutyStart || dutyEnd)) {
                            const now = new Date();
                            if (dutyStart && now < dutyStart) {
                                showToast(`å‹¤å‹™å°šæœªé–‹å§‹ï¼ˆ${dutyStart.toLocaleString('zh-TW')}ï¼‰ï¼Œä¸å¯æ‰“å¡`, true);
                                return;
                            }
                            if (dutyEnd && now > dutyEnd) {
                                isOvertime = true;
                            }
                        }

                        // å°‡ç…§ç‰‡è½‰æ›ç‚º Data URL ä¸¦å„²å­˜ï¼ˆæ¢å¾©åŸè¡Œç‚ºï¼‰
                        const photoPromises = capturedPhotos.map(async (photo) => {
                            return new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    resolve({
                                        url: reader.result,
                                        description: photo.description
                                    });
                                };
                                reader.readAsDataURL(photo.blob);
                            });
                        });

                        const uploadedPhotos = await Promise.all(photoPromises);
                        const limitedPhotos = Array.isArray(uploadedPhotos) ? uploadedPhotos.slice(0, 3) : [];
                        const hasInvalidPhoto = limitedPhotos.some(p => !p || typeof p.url !== 'string' || p.url.length === 0);
                        if (hasInvalidPhoto) {
                            throw new Error('ç…§ç‰‡ä¸Šå‚³å¤±æ•—æˆ–æ ¼å¼éŒ¯èª¤');
                        }
                        const photoUrls = limitedPhotos.map(p => p.url);
                        const descriptions = limitedPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));

                        // å®‰å…¨åº§æ¨™è™•ç†ï¼šè‹¥ç¼ºå°‘æˆ–ç‚ºå¾Œå‚™ï¼Œä½¿ç”¨ (0,0)
                        const safeLat = (location && typeof location.lat === 'number') ? location.lat : 0;
                        const safeLng = (location && typeof location.lng === 'number') ? location.lng : 0;

                        const uid = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                        if (!uid) {
                            throw new Error('æœªç™»å…¥æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…ï¼Œç„¡æ³•å¯«å…¥æ‰“å¡è¨˜éŒ„');
                        }
                        // ä½¿ç”¨æ—¢æœ‰ allowedTypesï¼ˆè‹¥å‰é¢å·²å®£å‘Šï¼‰ï¼Œå¦å‰‡å®£å‘Šä¸€æ¬¡
                        const __allowedTypes = (typeof allowedTypes !== 'undefined' && Array.isArray(allowedTypes))
                            ? allowedTypes
                            : ['ä¸Šç­','ä¸‹ç­','å¤–å‡º','è¿”å›','æŠµé”','é›¢é–‹','è‡ªå‹•ä¸‹ç­'];
                        if (!__allowedTypes.includes(type)) {
                            throw new Error('æ‰“å¡é¡å‹ä¸åˆæ³•');
                        }
                        if (photoUrls.length !== descriptions.length || photoUrls.length > 3) {
                            throw new Error('ç…§ç‰‡èˆ‡æè¿°æ•¸é‡ä¸ä¸€è‡´');
                        }
                        const deviceId = (typeof state.deviceId === 'string' && state.deviceId) ? state.deviceId.slice(0, 100) : 'unknown-device';
                        const recordData = {
                            userId: uid,
                            type: type,
                            timestamp: Timestamp.now(),
                            location: new GeoPoint(safeLat, safeLng),
                            photoUrls,
                            descriptions,
                            deviceId
                        };
                        if (isOvertime) {
                            recordData.dutyType = 'è¶…æ™‚å·¡é‚';
                        } else if (type === 'å¤–å‡º' && typeof state.dutyType === 'string' && state.dutyType) {
                            recordData.dutyType = state.dutyType.slice(0, 50);
                        }
                        if (type === 'å¤–å‡º') {
                            const locName = typeof location?.name === 'string' ? location.name : '';
                            if (locName) {
                                recordData.locationName = locName.slice(0, 100);
                            }
                        }
                        
                        try {
                            await addDoc(collection(db, "clockInRecords"), recordData);
                        } catch (e) {
                            console.error('æ–°å¢ clockInRecords å¤±æ•—ï¼š', e?.code, e?.message || e, { keys: Object.keys(recordData), type: recordData.type, locationIsGeoPoint: recordData.location instanceof GeoPoint, photosLen: recordData.photoUrls.length, descLen: recordData.descriptions.length });
                            throw e;
                        }

                        // é¦–æ¬¡æ‰“å¡è£ç½®IDå¯«å…¥ï¼šåƒ…ç•¶ä½¿ç”¨è€…å°šæœªæœ‰ firstClockInDeviceId
                        try {
                            const uid3 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            const userRef = doc(db, "users", uid3);
                            const userSnap = await getDoc(userRef);
                            const hasFirst = userSnap.exists() && userSnap.data().firstClockInDeviceId;
                            if (!hasFirst && type === 'ä¸Šç­') {
                                await updateDoc(userRef, { firstClockInDeviceId: state.deviceId || 'unknown-device' });
                            }
                        } catch (e) {
                            console.warn('å¯«å…¥é¦–æ¬¡æ‰“å¡è£ç½®IDå¤±æ•—', e);
                        }

                        const userUpdateData = {
                            status: type,
                            clockInStatus: type,
                            lastUpdated: Timestamp.now()
                        };
                        
                        // å¦‚æœæ˜¯å¤–å‡ºæ‰“å¡ï¼Œæ·»åŠ å¤–å‡ºåœ°é»åç¨±
                        if (type === 'å¤–å‡º') {
                            const locName2 = typeof location.name === 'string' ? location.name : '';
                            if (locName2) {
                                userUpdateData.outboundLocation = locName2.slice(0, 100);
                            }
                        }
                        // è¶…æ™‚å·¡é‚æ¨™è¨˜æˆ–å¤–å‡ºåŒæ­¥å‹¤å‹™é …ç›®ï¼ˆè‹¥æœ‰ï¼‰
                        if (isOvertime) {
                            userUpdateData.dutyType = 'è¶…æ™‚å·¡é‚';
                        } else if (type === 'å¤–å‡º' && state.dutyType) {
                            userUpdateData.dutyType = state.dutyType;
                        }
                        
                        try {
                            const uid2 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            await updateDoc(doc(db, "users", uid2), userUpdateData);
                        } catch (e) {
                            // è»Ÿå¤±æ•—ï¼šè‹¥ä½¿ç”¨è€…æ–‡ä»¶ä¸å­˜åœ¨æˆ–ç„¡æ¬Šé™ï¼Œä»è¦–ç‚ºæ‰“å¡æˆåŠŸ
                            console.warn('æ›´æ–° users ç‹€æ…‹å¤±æ•—ï¼ˆå°‡ä¸é˜»æ–·æ‰“å¡ï¼‰ï¼š', e?.code, e?.message || e);
                        }

                        // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                        state.clockInStatus = type;
                        
                        // å¦‚æœæ˜¯ä¸Šç­æ‰“å¡ï¼Œå•Ÿå‹•è‡ªå‹•ä¸‹ç­æ‰“å¡è¨ˆæ™‚å™¨
                        if (type === 'ä¸Šç­' && typeof startAutoClockOutTimer === 'function') {
                            // é‡æ–°è¼‰å…¥è¨­å®šä¸¦å•Ÿå‹•è¨ˆæ™‚å™¨
                            loadAutoClockOutSettings().then(() => {
                                startAutoClockOutTimer();
                            });
                        }
                        
                        // å¦‚æœæ˜¯ä¸‹ç­æ‰“å¡ï¼Œåœæ­¢è‡ªå‹•ä¸‹ç­æ‰“å¡è¨ˆæ™‚å™¨
                        if (type === 'ä¸‹ç­' && typeof stopAutoClockOutTimer === 'function') {
                            stopAutoClockOutTimer();
                        }
                        
                        // æ›´æ–°é é¢é¡¯ç¤º
                        updateStatusDisplay();
                        // ç«‹å³æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼Œç¢ºä¿é›¢é–‹/è¿”å›ç­‰å¾ªç’°æŒ‰éˆ•æ–‡å­—èˆ‡æ¨£å¼æ­£ç¢º
                        if (typeof updateButtonStatus === 'function') {
                            try { updateButtonStatus(); } catch (e) { console.warn('updateButtonStatus åŸ·è¡Œå¤±æ•—', e); }
                        }
                        
                        showToast(`${type}æ‰“å¡æˆåŠŸï¼`);
                        close();
                        // å®‰å…¨å°é ï¼šè‹¥ showPage ä¸å¯ç”¨å‰‡ç›´æ¥é‡ç¹ªæ‰“å¡é 
                        try {
                            if (typeof showPage === 'function') {
                                showPage('clock-in', 'location');
                            } else if (typeof renderClockIn === 'function') {
                                renderClockIn('location');
                            }
                        } catch (_navErr) {
                            console.warn('å°é å¤±æ•—ï¼Œä½†æ‰“å¡å·²æˆåŠŸï¼š', _navErr);
                        }

                    } catch (error) {
                        console.error("Clock in error:", error);
                        showToast("æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", true);
                    } finally {
                        showLoading(false);
                    }
                };

                document.getElementById('cancel-camera-btn').addEventListener('click', close);
            }

            // --- Google Maps ---
            function loadGoogleMapsScript() {
                if (window.google && state.googleMapsLoaded) return;
                
                window.initMap = () => { 
                    state.googleMapsLoaded = true; 
                    console.log("Google Maps API å·²æˆåŠŸåŠ è¼‰");
                };
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&v=weekly`;
                script.async = true;
                script.defer = true;
                
                script.onerror = () => {
                    console.error("Google Maps API åŠ è¼‰å¤±æ•—");
                    showToast("åœ°åœ–æœå‹™åŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–APIé‡‘é‘°", true);
                };
                
                document.head.appendChild(script);
            }
            
            // --- Helper functions ---
            function cleanupListeners() {
                state.activeListeners.forEach(unsubscribe => unsubscribe());
                state.activeListeners = [];
            }

            // ç§»é™¤èˆŠçš„ getStatusColor å‡½æ•¸ï¼Œä½¿ç”¨ dashboard-functions.js ä¸­çš„ç‰ˆæœ¬
            
            // æ¸²æŸ“è«‹å‡è³‡è¨Šï¼ˆç¬¬äºŒå€‹ç‰ˆæœ¬ï¼Œä½¿ç”¨çµ±ä¸€çš„åˆ¤æ–·é‚è¼¯ï¼‰
            function renderLeaveInfo(userData) {
                if (!userData) return 'ç›®å‰æ²’æœ‰è«‹å‡è¨˜éŒ„';
                let isLeave = userData.clockInStatus === 'è‡¨æ™‚è«‹å‡';
                if (!isLeave && (userData.leaveStatus === 'approved' || userData.leaveStatus === 'pending')) {
                    const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                    const startTime = toDate(userData.leaveStartTime);
                    const endTime = toDate(userData.leaveEndTime);
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    isLeave = !!(startTime && endTime && startTime <= todayEnd && endTime >= todayStart);
                }
                if (!isLeave) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šå‹¤å‹™
                    if (userData.clockInStatus === 'ç‰¹æ®Šå‹¤å‹™') {
                        const dutyName = userData.dutyName || 'æœªæŒ‡å®šå‹¤å‹™';
                        const location = userData.dutyLocation || 'æœªæŒ‡å®šåœ°é»';
                        
                        let startTimeStr = 'æœªæŒ‡å®šæ™‚é–“';
                        let endTimeStr = 'æœªæŒ‡å®šæ™‚é–“';
                        
                        if (userData.dutyStartTime) {
                            const startTime = userData.dutyStartTime.toDate ? 
                                userData.dutyStartTime.toDate() : 
                                new Date(userData.dutyStartTime);
                            startTimeStr = startTime.toLocaleString('zh-TW');
                        }
                        
                        if (userData.dutyEndTime) {
                            const endTime = userData.dutyEndTime.toDate ? 
                                userData.dutyEndTime.toDate() : 
                                new Date(userData.dutyEndTime);
                            endTimeStr = endTime.toLocaleString('zh-TW');
                        }
                        
                        return `
                            <div class="font-semibold text-lg">åŸ·è¡Œç‰¹æ®Šå‹¤å‹™</div>
                            <div class="mt-2">
                                <p><span class="font-medium">å‹¤å‹™åç¨±ï¼š</span>${dutyName}</p>
                                <p><span class="font-medium">å‹¤å‹™åœ°é»ï¼š</span>${location}</p>
                                <p><span class="font-medium">é–‹å§‹æ™‚é–“ï¼š</span>${startTimeStr}</p>
                                <p><span class="font-medium">çµæŸæ™‚é–“ï¼š</span>${endTimeStr}</p>
                            </div>
                        `;
                    }
                    return 'ç›®å‰æ²’æœ‰è«‹å‡è¨˜éŒ„';
                }
                const leaveStatus = userData.leaveStatus === 'approved' ? 'å·²è«‹å‡' : 'è«‹å‡ç”³è«‹';
                const reason = userData.leaveReason || 'æœªæŒ‡å®šåŸå› ';
                
                const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                const startTime = toDate(userData.leaveStartTime);
                const endTime = toDate(userData.leaveEndTime);
                const startTimeStr = startTime ? startTime.toLocaleString('zh-TW') : 'æœªæŒ‡å®šæ™‚é–“';
                const endTimeStr = endTime ? endTime.toLocaleString('zh-TW') : 'æœªæŒ‡å®šæ™‚é–“';
                
                return `
                    <div class="font-semibold text-lg">${leaveStatus}</div>
                    <div class="mt-2">
                        <p><span class="font-medium">äº‹ç”±ï¼š</span>${reason}</p>
                        <p><span class="font-medium">é–‹å§‹æ™‚é–“ï¼š</span>${startTimeStr}</p>
                        <p><span class="font-medium">çµæŸæ™‚é–“ï¼š</span>${endTimeStr}</p>
                    </div>
                `;
            }
            

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }
            // ä½¿å…¨åŸŸå¯ç”¨ï¼Œä»¥ä¾›å…¶ä»–è…³æœ¬å‘¼å«
            window.showToast = showToast;
            function openVoiceCallModal(targetUserId, stream) {
                const backdrop = document.createElement('div');
                backdrop.id = 'voice-call-backdrop';
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';

                const modal = document.createElement('div');
                modal.id = 'voice-call-modal';
                modal.className = 'fixed inset-0 flex items-center justify-center z-50';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg w-96 p-4';

                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold mb-2';
                const target = (window.state?.users || []).find(u => u.id === targetUserId);
                title.textContent = `èªéŸ³é€šè©±ï¼š${target?.name || target?.email || targetUserId}`;

                const statusEl = document.createElement('div');
                statusEl.className = 'text-sm text-gray-600 mb-3';
                statusEl.textContent = 'åˆå§‹åŒ–éº¥å…‹é¢¨â€¦';

                const audio = document.createElement('audio');
                audio.autoplay = true;
                audio.className = 'w-full mb-3';

                const controls = document.createElement('div');
                controls.className = 'grid grid-cols-2 gap-2';

                const muteBtn = document.createElement('button');
                muteBtn.className = 'px-3 py-2 rounded-md bg-gray-200 text-gray-700';
                muteBtn.textContent = 'éœéŸ³';

                const endBtn = document.createElement('button');
                endBtn.className = 'px-3 py-2 rounded-md bg-red-500 text-white';
                endBtn.textContent = 'çµæŸé€šè©±';

                controls.appendChild(muteBtn);
                controls.appendChild(endBtn);

                card.appendChild(title);
                card.appendChild(statusEl);
                card.appendChild(audio);
                card.appendChild(controls);
                modal.appendChild(card);
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);

                function close() {
                    try {
                        if (audio.srcObject) {
                            audio.srcObject.getTracks().forEach(t => t.stop());
                            audio.srcObject = null;
                        }
                    } catch (e) {}
                    backdrop.remove();
                    modal.remove();
                }
                backdrop.addEventListener('click', close);
                endBtn.addEventListener('click', close);

                let muted = false;
                muteBtn.addEventListener('click', () => {
                    muted = !muted;
                    muteBtn.textContent = muted ? 'å–æ¶ˆéœéŸ³' : 'éœéŸ³';
                    const track = audio.srcObject && audio.srcObject.getAudioTracks()[0];
                    if (track) track.enabled = !muted;
                });

                if (stream) {
                    audio.srcObject = stream;
                    statusEl.textContent = 'éº¥å…‹é¢¨å·²å•Ÿå‹•ï¼ˆåƒ…æœ¬æ©Ÿæ’­æ”¾ï¼Œå°šæœªé€£ç·šï¼‰';
                } else {
                    statusEl.textContent = 'ç„¡æ³•å–å¾—éº¥å…‹é¢¨ä¸²æµ';
                }
            }

            async function startVoiceCall(targetUserId) {
                // Secure context check for microphone APIs
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('éå®‰å…¨ä¾†æºï¼Œéº¥å…‹é¢¨å¯èƒ½ç„¡æ³•å•Ÿç”¨');
                    showToast('æç¤ºï¼šè«‹ä»¥ https æˆ– localhost é–‹å•Ÿä»¥ä½¿ç”¨èªéŸ³é€šè©±', true);
                }
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showToast('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³é€šè©± API', true);
                        return;
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    openVoiceCallModal(targetUserId, stream);
                    showToast('èªéŸ³é€šè©±åˆå§‹åŒ–å®Œæˆï¼ˆå°šæœªå»ºç«‹é€£ç·šï¼‰');
                } catch (e) {
                    console.error('å•Ÿå‹•èªéŸ³é€šè©±å¤±æ•—:', e);
                    const msg = (e && e.name === 'NotAllowedError')
                        ? 'å·²æ‹’çµ•éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±'
                        : (e && e.name === 'NotFoundError')
                            ? 'æ‰¾ä¸åˆ°å¯ç”¨çš„éŸ³è¨Šè£ç½®'
                            : 'ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™èˆ‡ä¾†æº';
                    showToast(msg, true);
                }
            }
            window.startVoiceCall = startVoiceCall;

            function timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " å¹´å‰";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " æœˆå‰";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " å¤©å‰";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " å°æ™‚å‰";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " åˆ†é˜å‰";
                return "å‰›å‰›";
            }
            
            function formatDate(timestamp) {
                if (!timestamp) return '';
                return timestamp.toDate().toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }

            // é€šç”¨æ—¥æœŸæ™‚é–“æ ¼å¼åŒ–ï¼šæ”¯æ´ Firestore Timestampã€Dateã€å­—ä¸²èˆ‡æ•¸å­—
            function formatDateTime(value) {
                if (!value) return '';
                let d;
                try {
                    if (value && typeof value.toDate === 'function') {
                        d = value.toDate();
                    } else if (value instanceof Date) {
                        d = value;
                    } else {
                        d = new Date(value);
                    }
                    if (isNaN(d.getTime())) return '';
                    return d.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    console.error('formatDateTime error:', e);
                    return '';
                }
            }


        // ç”¨æˆ¶å½ˆå‡ºè¦–çª—åŠŸèƒ½
        document.addEventListener('click', function(e) {
            // é—œé–‰å·²æ‰“é–‹çš„å½ˆå‡ºè¦–çª—
            if (!e.target.closest('.user-popup') && !e.target.closest('.user-name-btn')) {
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
            }
            
            // é»æ“Šç”¨æˆ¶åç¨±æ™‚é¡¯ç¤ºå½ˆå‡ºè¦–çª—
            if (e.target.classList.contains('user-name-btn') || e.target.closest('.user-name-btn')) {
                const nameBtn = e.target.classList.contains('user-name-btn') ? e.target : e.target.closest('.user-name-btn');
                const userId = nameBtn.dataset.userId;
                const userName = nameBtn.dataset.userName;
                const userPhone = nameBtn.dataset.userPhone;
                
                // é—œé–‰å·²æ‰“é–‹çš„å½ˆå‡ºè¦–çª—
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                // å‰µå»ºæ–°çš„å½ˆå‡ºè¦–çª—
                const popup = document.createElement('div');
                popup.className = 'user-popup fixed bg-white rounded-lg shadow-lg p-3 z-50';
                popup.style.width = '200px';
                
                // è¨ˆç®—ä½ç½® (åœ¨åç¨±ä¸‹æ–¹) ä¸¦é¿å…è¶…å‡ºè¦–çª—é‚Šç•Œ
                const rect = nameBtn.getBoundingClientRect();
                const popupWidth = 200; // èˆ‡ CSS å¯¬åº¦ä¸€è‡´
                const margin = 10; // èˆ‡é‚Šç•Œä¿æŒè·é›¢
                let left = rect.left;
                let top = rect.bottom + 5;

                // å³å´é‚Šç•Œæª¢æŸ¥
                if (left + popupWidth > window.innerWidth - margin) {
                    left = Math.max(margin, window.innerWidth - popupWidth - margin);
                }
                // å·¦å´é‚Šç•Œæª¢æŸ¥
                if (left < margin) {
                    left = margin;
                }

                // é ä¼°é«˜åº¦ä¸¦åšä¸‹é‚Šç•Œæª¢æŸ¥ï¼›è‹¥è¶…å‡ºå‰‡é¡¯ç¤ºåœ¨åç¨±ä¸Šæ–¹
                const estimatedHeight = 120; // å…§å®¹é«˜åº¦ä¼°ç®—
                if (top + estimatedHeight > window.innerHeight - margin) {
                    top = rect.top - estimatedHeight - 5;
                }
                // ä¸Šå´é‚Šç•Œæª¢æŸ¥
                if (top < margin) {
                    top = margin;
                }

                popup.style.left = `${left}px`;
                popup.style.top = `${top}px`;
                // å‹•æ…‹é™åˆ¶é«˜åº¦ä¸¦å…è¨±æ²å‹•
                const availableHeight = window.innerHeight - top - margin;
                popup.style.maxHeight = `${Math.max(80, availableHeight)}px`;
                popup.style.overflow = 'auto';
                
                // æ·»åŠ æŒ‰éˆ•ï¼ˆèªéŸ³é€šè©±ï¼‰
                popup.innerHTML = `
                    <div class="flex justify-center">
                        <button class="call-btn bg-purple-500 text-white py-1 px-2 rounded-md flex items-center justify-center" data-userid="${userId}">
                            <i data-lucide="mic" class="w-4 h-4 mr-1"></i>èªéŸ³é€šè©±
                        </button>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é é¢
                document.body.appendChild(popup);
                lucide.createIcons();
                
                // æ·»åŠ æŒ‰éˆ•äº‹ä»¶ï¼ˆèªéŸ³é€šè©±ï¼‰
                popup.querySelector('.call-btn').addEventListener('click', function() {
                    const targetUserId = this.dataset.userid;
                    if (targetUserId) {
                        startVoiceCall(targetUserId);
                    } else {
                        showToast('ç„¡å°è±¡è³‡è¨Š', true);
                    }
                });
                
                // LineèŠå¤©æŒ‰éˆ•å·²ç§»é™¤
            }
        });

        // --- Initial Load ---
        // --- Global Compatibility Shim ---
        // ç¢ºä¿åœ¨æ‰€æœ‰å‡½å¼ä½œç”¨åŸŸä¸­éƒ½èƒ½ä½¿ç”¨ mainContent / modalContainer
        // æŸäº›åŠŸèƒ½æ¨¡çµ„åœ¨ä¸åŒä½œç”¨åŸŸè¢«å®šç¾©ä¸¦ä½¿ç”¨é€™å…©å€‹è®Šæ•¸ï¼Œé€™è£¡æä¾›å…¨åŸŸå¯ç”¨çš„å¼•ç”¨
        var mainContent = document.getElementById('main-content');
        var modalContainer = document.getElementById('modal-container');
        window.mainContent = mainContent;
        window.modalContainer = modalContainer;

        document.addEventListener('DOMContentLoaded', () => {
             lucide.createIcons();
             showLoading(true);
             if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY" || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                document.getElementById('api-key-warning').classList.remove('hide');
                showLoading(false);
                console.error("API Keys are not configured. Please edit index.html"); 
            } else {
                initializeAppLogic();
            }
        });
    </script>
</body>
</html>




